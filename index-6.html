<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Adumbrations of data." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Visions, Voices, Data (old posts, page 6) | Visions, Voices, Data</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Visions-Voices-Data/index-6.html" rel="canonical">
<link href="." rel="prev" type="text/html">
<link href="index-5.html" rel="next" type="text/html"><!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript"></script><!--
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.min.js"
</script>
-->
<script async src="javascript/p5.min.js" type="text/javascript"></script>
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="/"><span id="blog-title">Visions, Voices, Data</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="/archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="/categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="/rss.xml">RSS feed</a></li>
<li class="nav-item dropdown"><a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Pages</a>
<div class="dropdown-menu"><a class="dropdown-item" href="https://necromuralist.github.io/">Cloistered Monkey</a> <a class="dropdown-item" href="/pages/giss/giss-yearly-anomalies-by-climate-zone">GISS Anomalies</a></div>
</li>
</ul>
<!-- DuckDuckGo custom search -->
<form action="https://duckduckgo.com/" class="navbar-form pull-left" id="search" method="get" name="search"><input name="sites" type="hidden" value="https://necromuralist.github.io/Visions-Voices-Data/"> <input name="k8" type="hidden" value="#444444"> <input name="k9" type="hidden" value="#D51920"> <input name="kt" type="hidden" value="h"> <input class="span2" maxlength="255" name="q" placeholder="Searchâ€¦" type="text"> <input style="visibility: hidden;display:none" type="submit" value="DuckDuckGo Search"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<div class="postindex">
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/tutorials/underfitting-and-overfitting-exercise/">Underfitting and Overfitting Exercise</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/underfitting-and-overfitting-exercise/" rel="bookmark"><time class="published dt-published" datetime="2020-02-18T10:11:19-08:00" itemprop="datePublished" title="2020-02-18 10:11">2020-02-18 10:11</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/underfitting-and-overfitting-exercise/#orgf2255a5">Beginning</a>
<ul>
<li><a href="/posts/tutorials/underfitting-and-overfitting-exercise/#org3f04f84">Imports</a>
<ul>
<li><a href="/posts/tutorials/underfitting-and-overfitting-exercise/#orgef7762e">Python</a></li>
<li><a href="/posts/tutorials/underfitting-and-overfitting-exercise/#org9a1fc49">PyPi</a></li>
<li><a href="/posts/tutorials/underfitting-and-overfitting-exercise/#org9c72cde">Others</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/underfitting-and-overfitting-exercise/#org357baa9">Set Up</a>
<ul>
<li><a href="/posts/tutorials/underfitting-and-overfitting-exercise/#org798bac6">Plottting</a></li>
<li><a href="/posts/tutorials/underfitting-and-overfitting-exercise/#org176088f">The Timer</a></li>
<li><a href="/posts/tutorials/underfitting-and-overfitting-exercise/#org0fb9924">Environment</a></li>
<li><a href="/posts/tutorials/underfitting-and-overfitting-exercise/#org72b2813">The Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/underfitting-and-overfitting-exercise/#org2a8eafa">Middle</a>
<ul>
<li><a href="/posts/tutorials/underfitting-and-overfitting-exercise/#org086fc0e">Preliminary 1: Specify Prediction Target</a></li>
<li><a href="/posts/tutorials/underfitting-and-overfitting-exercise/#org706d750">Preliminary 2: Create X</a></li>
<li><a href="/posts/tutorials/underfitting-and-overfitting-exercise/#org4c7942a">Preliminary 3: Specify and Fit Model</a>
<ul>
<li><a href="/posts/tutorials/underfitting-and-overfitting-exercise/#orga87fea3">A Linear Regression Model</a></li>
<li><a href="/posts/tutorials/underfitting-and-overfitting-exercise/#orge3f79a6">Decision Tree</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/underfitting-and-overfitting-exercise/#org59d13aa">Preliminary 4: Make Some Predictions</a></li>
<li><a href="/posts/tutorials/underfitting-and-overfitting-exercise/#orgc81b573">Preliminary 5: Calculate the Mean Absolute Error in Validation Data</a></li>
<li><a href="/posts/tutorials/underfitting-and-overfitting-exercise/#org14d1292">Step 1: Compare Different Tree Sizes</a></li>
<li><a href="/posts/tutorials/underfitting-and-overfitting-exercise/#orgb36fb51">Step 2: Fit Model Using All Data</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/underfitting-and-overfitting-exercise/#org466b5c3">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgf2255a5">
<h2 id="orgf2255a5">Beginning</h2>
<div class="outline-text-2" id="text-orgf2255a5">
<p>This is the fourth part of kaggle's <a href="https://www.kaggle.com/learn/intro-to-machine-learning">Introduction to Machine Learning</a> tutorial - Overfitting and Underfitting.</p>
</div>
<div class="outline-3" id="outline-container-org3f04f84">
<h3 id="org3f04f84">Imports</h3>
<div class="outline-text-3" id="text-org3f04f84"></div>
<div class="outline-4" id="outline-container-orgef7762e">
<h4 id="orgef7762e">Python</h4>
<div class="outline-text-4" id="text-orgef7762e">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org9a1fc49">
<h4 id="org9a1fc49">PyPi</h4>
<div class="outline-text-4" id="text-org9a1fc49">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_absolute_error</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">cross_val_score</span><span class="p">,</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeRegressor</span>

<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">pandas</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org9c72cde">
<h4 id="org9c72cde">Others</h4>
<div class="outline-text-4" id="text-org9c72cde">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">EnvironmentLoader</span><span class="p">,</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org357baa9">
<h3 id="org357baa9">Set Up</h3>
<div class="outline-text-3" id="text-org357baa9"></div>
<div class="outline-4" id="outline-container-org798bac6">
<h4 id="org798bac6">Plottting</h4>
<div class="outline-text-4" id="text-org798bac6">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"underfitting-and-overfitting-exercise"</span>
<span class="n">OUTPUT_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"../../files/posts/tutorials/"</span><span class="p">)</span><span class="o">/</span><span class="n">SLUG</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="n">OUTPUT_PATH</span><span class="p">)</span>
<span class="n">Plot</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org176088f">
<h4 id="org176088f">The Timer</h4>
<div class="outline-text-4" id="text-org176088f">
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org0fb9924">
<h4 id="org0fb9924">Environment</h4>
<div class="outline-text-4" id="text-org0fb9924">
<div class="highlight">
<pre><span></span><span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="n">EnvironmentLoader</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org72b2813">
<h4 id="org72b2813">The Data</h4>
<div class="outline-text-4" id="text-org72b2813">
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">ENVIRONMENT</span><span class="p">[</span><span class="s2">"HOUSE-PRICES-IOWA"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">/</span><span class="s2">"train.csv"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org2a8eafa">
<h2 id="org2a8eafa">Middle</h2>
<div class="outline-text-2" id="text-org2a8eafa"></div>
<div class="outline-3" id="outline-container-org086fc0e">
<h3 id="org086fc0e">Preliminary 1: Specify Prediction Target</h3>
<div class="outline-text-3" id="text-org086fc0e">
<p>Select the target variable, which corresponds to the sales price. Save this to a new variable called `y`. You'll need to print a list of the columns to find the name of the column you need.</p>
<p>Our target is <i>SalePrice</i>.</p>
<div class="highlight">
<pre><span></span><span class="n">Y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">SalePrice</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org706d750">
<h3 id="org706d750">Preliminary 2: Create X</h3>
<div class="outline-text-3" id="text-org706d750">
<blockquote>
<p>Now you will create a DataFrame called `X` holding the predictive features.</p>
<p>Since you want only some columns from the original data, you'll first create a list with the names of the columns you want in `X`.</p>
<p>You'll use just the following columns in the list (you can copy and paste the whole list to save some typing, though you'll still need to add quotes):</p>
<ul class="org-ul">
<li>LotArea</li>
<li>YearBuilt</li>
<li>1stFlrSF</li>
<li>2ndFlrSF</li>
<li>FullBath</li>
<li>BedroomAbvGr</li>
<li>TotRmsAbvGrd</li>
</ul>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">FEATURES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"LotArea"</span><span class="p">,</span>
    <span class="s2">"YearBuilt"</span><span class="p">,</span>
    <span class="s2">"1stFlrSF"</span><span class="p">,</span>
    <span class="s2">"2ndFlrSF"</span><span class="p">,</span>
    <span class="s2">"FullBath"</span><span class="p">,</span>
    <span class="s2">"BedroomAbvGr"</span><span class="p">,</span>
    <span class="s2">"TotRmsAbvGrd"</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">FEATURES</span><span class="p">]</span>
</pre></div>
<p>Split up the data into training and validation sets.</p>
<div class="highlight">
<pre><span></span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_validate</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_validate</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org4c7942a">
<h3 id="org4c7942a">Preliminary 3: Specify and Fit Model</h3>
<div class="outline-text-3" id="text-org4c7942a"></div>
<div class="outline-4" id="outline-container-orga87fea3">
<h4 id="orga87fea3">A Linear Regression Model</h4>
<div class="outline-text-4" id="text-orga87fea3">
<p>As a baseline, I'll fit a simple <a href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LinearRegression.html">Linear Regression</a> (ordinary-least-squares) model.</p>
<div class="highlight">
<pre><span></span><span class="n">regression</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">regression</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{scores.mean():0.2f} (+/- {2 * scores.std():0.2f})"</span><span class="p">)</span>
<span class="n">regression</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Training R^2: {regression.score(x_train, y_train): 0.2f}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Validation R^2: {regression.score(x_validate, y_validate):0.2f}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
0.66 (+/- 0.17)
Training R^2:  0.68
Validation R^2: 0.77
</pre></div>
</div>
<div class="outline-4" id="outline-container-orge3f79a6">
<h4 id="orge3f79a6">Decision Tree</h4>
<div class="outline-text-4" id="text-orge3f79a6">
<blockquote>
<p>Create a <code>DecisionTreeRegressor</code> and save it as <code>iowa_model</code>. Ensure you've done the relevant import from sklearn to run this command.</p>
<p>Then fit the model you just created using the data in <code>X</code> and <code>y</code> that you saved above.</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">tree</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">()</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{scores.mean():0.2f} (+/- {2 * scores.std():0.2f})"</span><span class="p">)</span>

<span class="n">tree</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Training R^2: {tree.score(x_train, y_train): 0.2f}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Validation R^2: {tree.score(x_validate, y_validate):0.2f}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
0.54 (+/- 0.32)
Training R^2:  1.00
Validation R^2: 0.75
</pre>
<p>So our linear regression actually does better than the tree does. It looks like the tree might be overfitting on the training data.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org59d13aa">
<h3 id="org59d13aa">Preliminary 4: Make Some Predictions</h3>
<div class="outline-text-3" id="text-org59d13aa">
<div class="highlight">
<pre><span></span><span class="n">tree_predict</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_validate</span><span class="p">)</span>
<span class="n">regression_predict</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_validate</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgc81b573">
<h3 id="orgc81b573">Preliminary 5: Calculate the Mean Absolute Error in Validation Data</h3>
<div class="outline-text-3" id="text-orgc81b573">
<div class="highlight">
<pre><span></span><span class="n">tree_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">y_validate</span><span class="p">,</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">tree_predict</span><span class="p">)</span>
<span class="n">regression_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">y_validate</span><span class="p">,</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">regression_predict</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Tree MAE: {tree_mae: 0.2f}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Regression MAE: {regression_mae: 0.2f}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Tree MAE:  29371.52
Regression MAE:  27228.88
</pre>
<p>The tree's error is a little higher than the regression line's.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org14d1292">
<h3 id="org14d1292">Step 1: Compare Different Tree Sizes</h3>
<div class="outline-text-3" id="text-org14d1292">
<blockquote>
<p>Write a loop that tries the following values for <b>max_leaf_nodes</b> from a set of possible values.</p>
<p>Call the <b>get_mae</b> function on each value of max_leaf_nodes. Store the output in some way that allows you to select the value of <code>max_leaf_nodes</code> that gives the most accurate model on your data.</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">get_mae</span><span class="p">(</span><span class="n">max_leaf_nodes</span><span class="p">,</span> <span class="n">train_X</span><span class="o">=</span><span class="n">x_train</span><span class="p">,</span> <span class="n">val_X</span><span class="o">=</span><span class="n">x_validate</span><span class="p">,</span> <span class="n">train_y</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span> <span class="n">val_y</span><span class="o">=</span><span class="n">y_validate</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_leaf_nodes</span><span class="o">=</span><span class="n">max_leaf_nodes</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_X</span><span class="p">,</span> <span class="n">train_y</span><span class="p">)</span>
    <span class="n">preds_val</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">val_X</span><span class="p">)</span>
    <span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">val_y</span><span class="p">,</span> <span class="n">preds_val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mae</span>
</pre></div>
<blockquote>
<p>Write a loop to find the ideal tree size from <code>candidate_max_leaf_nodes</code>.</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">candidate_max_leaf_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>
<span class="n">outcomes</span> <span class="o">=</span> <span class="p">[(</span><span class="n">get_mae</span><span class="p">(</span><span class="n">nodes</span><span class="p">),</span> <span class="n">nodes</span><span class="p">)</span> <span class="k">for</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="n">candidate_max_leaf_nodes</span><span class="p">]</span>
<span class="n">best</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">outcomes</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">best</span><span class="p">)</span>
<span class="n">best_tree_size</span> <span class="o">=</span> <span class="n">best</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
<pre class="example">
(27282.50803885739, 100)
</pre>
<div class="highlight">
<pre><span></span><span class="n">mae</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">nodes</span><span class="o">=</span><span class="n">candidate_max_leaf_nodes</span><span class="p">,</span> <span class="n">mae</span> <span class="o">=</span> <span class="p">[</span><span class="n">outcome</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">outcome</span> <span class="ow">in</span> <span class="n">outcomes</span><span class="p">]))</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">mae</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"nodes"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"mae"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Node Mean Absolute Error"</span><span class="p">,</span>
                                           <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                                           <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"node_mean_absolute_error"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</pre></div>
: <object data="/posts/tutorials/underfitting-and-overfitting-exercise/node_mean_absolute_error.html" height="800" style="width:100%" type="text/html">:
<p>Figure Missing</p>
:</object>
<p>Looking at the plot you can see that the error drops until you hit 100 nodes and then begins to rise again as it overfits the data with more nodes.</p>
<p>Let's see how much this improves our model using \(r^2\).</p>
<div class="highlight">
<pre><span></span><span class="n">tree</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_leaf_nodes</span><span class="o">=</span><span class="n">best_tree_size</span><span class="p">)</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{scores.mean():0.2f} (+/- {2 * scores.std():0.2f})"</span><span class="p">)</span>

<span class="n">tree</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Training R^2: {tree.score(x_train, y_train): 0.2f}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Validation R^2: {tree.score(x_validate, y_validate):0.2f}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
0.60 (+/- 0.26)
Training R^2:  0.93
Validation R^2: 0.76
</pre>
<p>We've improved it slightly, it's probably still overfitting the model but not as much.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgb36fb51">
<h3 id="orgb36fb51">Step 2: Fit Model Using All Data</h3>
<div class="outline-text-3" id="text-orgb36fb51">
<blockquote>
<p>You know the best tree size. If you were going to deploy this model in practice, you would make it even more accurate by using all of the data and keeping that tree size. That is, you don't need to hold out the validation data now that you've made all your modeling decisions.</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">final_model</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_leaf_nodes</span> <span class="o">=</span> <span class="n">best_tree_size</span><span class="p">)</span>
<span class="n">final_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">predictions_first</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">predictions_final</span> <span class="o">=</span> <span class="n">final_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="n">x_y_tree</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">predicted</span><span class="o">=</span><span class="n">predictions_first</span><span class="p">,</span> <span class="n">actual</span><span class="o">=</span><span class="n">Y</span><span class="p">))</span>
<span class="n">x_y_line</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">predicted</span><span class="o">=</span><span class="n">predictions_final</span><span class="p">,</span> <span class="n">actual</span><span class="o">=</span><span class="n">Y</span><span class="p">))</span>
<span class="n">ideal</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Y</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">Y</span><span class="p">))</span>

<span class="n">tree_plot</span> <span class="o">=</span> <span class="n">x_y_tree</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"actual"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"predicted"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Default"</span><span class="p">)</span>
<span class="n">line_plot</span> <span class="o">=</span> <span class="n">x_y_line</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"actual"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"predicted"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Tuned"</span><span class="p">)</span>
<span class="n">ideal_plot</span> <span class="o">=</span> <span class="n">ideal</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">)</span>
<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">tree_plot</span> <span class="o">*</span> <span class="n">line_plot</span> <span class="o">*</span> <span class="n">ideal_plot</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Decision Tree Actual Vs Predictions"</span><span class="p">,</span>
                                    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                                    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"decision_tree_actual_vs_predicted"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</pre></div>
: <object data="/posts/tutorials/underfitting-and-overfitting-exercise/decision_tree_actual_vs_predicted.html" height="800" style="width:100%" type="text/html">:
<p>Figure Missing</p>
:</object>
<p>The tuned model seems closer to the predicted.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org466b5c3">
<h2 id="org466b5c3">End</h2>
<div class="outline-text-2" id="text-org466b5c3">
<p>That's a basic way to tune hyperparameters to improve your model. But our decision tree still isn't doing as well as the regression line. Next up we'll try an ensemble method - Random Forests.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/tutorials/model-validation-exercise/">Model Validation Exercise</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/model-validation-exercise/" rel="bookmark"><time class="published dt-published" datetime="2020-02-17T21:55:00-08:00" itemprop="datePublished" title="2020-02-17 21:55">2020-02-17 21:55</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/model-validation-exercise/#orgbbda5e8">Beginning</a>
<ul>
<li><a href="/posts/tutorials/model-validation-exercise/#org5012a41">Imports</a>
<ul>
<li><a href="/posts/tutorials/model-validation-exercise/#orga5a6d2d">Python</a></li>
<li><a href="/posts/tutorials/model-validation-exercise/#orgb7d6701">PyPi</a></li>
<li><a href="/posts/tutorials/model-validation-exercise/#orgb26552a">Others</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/model-validation-exercise/#orge8e210d">Set Up</a>
<ul>
<li><a href="/posts/tutorials/model-validation-exercise/#org4cf8f1d">Plottting</a></li>
<li><a href="/posts/tutorials/model-validation-exercise/#orgb5e3c87">The Timer</a></li>
<li><a href="/posts/tutorials/model-validation-exercise/#org8e4685b">Environment</a></li>
<li><a href="/posts/tutorials/model-validation-exercise/#orgca18a00">The Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/model-validation-exercise/#org2bff907">Middle</a>
<ul>
<li><a href="/posts/tutorials/model-validation-exercise/#orgb1a68ba">Step 1: Specify Prediction Target</a></li>
<li><a href="/posts/tutorials/model-validation-exercise/#org6237ba6">Step 2: Create X</a></li>
<li><a href="/posts/tutorials/model-validation-exercise/#orgc72b956">Step 3: Specify and Fit Model</a>
<ul>
<li><a href="/posts/tutorials/model-validation-exercise/#org255fdfe">A Linear Regression Model</a></li>
<li><a href="/posts/tutorials/model-validation-exercise/#orga2d64ba">Decision Tree</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/model-validation-exercise/#orga508e30">Make Some Predictions</a></li>
<li><a href="/posts/tutorials/model-validation-exercise/#org0340258">Step 4: Calculate the Mean Absolute Error in Validation Data</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/model-validation-exercise/#org1dad268">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgbbda5e8">
<h2 id="orgbbda5e8">Beginning</h2>
<div class="outline-text-2" id="text-orgbbda5e8">
<p>This is the third part of kaggle's <a href="https://www.kaggle.com/learn/intro-to-machine-learning">Introduction to Machine Learning</a> tutorial - Model Validation.</p>
</div>
<div class="outline-3" id="outline-container-org5012a41">
<h3 id="org5012a41">Imports</h3>
<div class="outline-text-3" id="text-org5012a41"></div>
<div class="outline-4" id="outline-container-orga5a6d2d">
<h4 id="orga5a6d2d">Python</h4>
<div class="outline-text-4" id="text-orga5a6d2d">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb7d6701">
<h4 id="orgb7d6701">PyPi</h4>
<div class="outline-text-4" id="text-orgb7d6701">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_absolute_error</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">cross_val_score</span><span class="p">,</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">ElasticNet</span><span class="p">,</span> <span class="n">Lasso</span><span class="p">,</span> <span class="n">LinearRegression</span><span class="p">,</span> <span class="n">Ridge</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeRegressor</span>

<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">pandas</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb26552a">
<h4 id="orgb26552a">Others</h4>
<div class="outline-text-4" id="text-orgb26552a">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">EnvironmentLoader</span><span class="p">,</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orge8e210d">
<h3 id="orge8e210d">Set Up</h3>
<div class="outline-text-3" id="text-orge8e210d"></div>
<div class="outline-4" id="outline-container-org4cf8f1d">
<h4 id="org4cf8f1d">Plottting</h4>
<div class="outline-text-4" id="text-org4cf8f1d">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"a-first-machine-learning-model"</span>
<span class="n">OUTPUT_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"../../files/posts/tutorials/"</span><span class="p">)</span><span class="o">/</span><span class="n">SLUG</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="n">OUTPUT_PATH</span><span class="p">)</span>
<span class="n">Plot</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb5e3c87">
<h4 id="orgb5e3c87">The Timer</h4>
<div class="outline-text-4" id="text-orgb5e3c87">
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org8e4685b">
<h4 id="org8e4685b">Environment</h4>
<div class="outline-text-4" id="text-org8e4685b">
<div class="highlight">
<pre><span></span><span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="n">EnvironmentLoader</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgca18a00">
<h4 id="orgca18a00">The Data</h4>
<div class="outline-text-4" id="text-orgca18a00">
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">ENVIRONMENT</span><span class="p">[</span><span class="s2">"HOUSE-PRICES-IOWA"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">/</span><span class="s2">"train.csv"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org2bff907">
<h2 id="org2bff907">Middle</h2>
<div class="outline-text-2" id="text-org2bff907"></div>
<div class="outline-3" id="outline-container-orgb1a68ba">
<h3 id="orgb1a68ba">Step 1: Specify Prediction Target</h3>
<div class="outline-text-3" id="text-orgb1a68ba">
<p>Select the target variable, which corresponds to the sales price. Save this to a new variable called `y`. You'll need to print a list of the columns to find the name of the column you need.</p>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"- {column} ({data[column].dtype})"</span><span class="p">)</span>
</pre></div>
<pre class="example">
- 1stFlrSF (int64)
- 2ndFlrSF (int64)
- 3SsnPorch (int64)
- Alley (object)
- BedroomAbvGr (int64)
- BldgType (object)
- BsmtCond (object)
- BsmtExposure (object)
- BsmtFinSF1 (int64)
- BsmtFinSF2 (int64)
- BsmtFinType1 (object)
- BsmtFinType2 (object)
- BsmtFullBath (int64)
- BsmtHalfBath (int64)
- BsmtQual (object)
- BsmtUnfSF (int64)
- CentralAir (object)
- Condition1 (object)
- Condition2 (object)
- Electrical (object)
- EnclosedPorch (int64)
- ExterCond (object)
- ExterQual (object)
- Exterior1st (object)
- Exterior2nd (object)
- Fence (object)
- FireplaceQu (object)
- Fireplaces (int64)
- Foundation (object)
- FullBath (int64)
- Functional (object)
- GarageArea (int64)
- GarageCars (int64)
- GarageCond (object)
- GarageFinish (object)
- GarageQual (object)
- GarageType (object)
- GarageYrBlt (float64)
- GrLivArea (int64)
- HalfBath (int64)
- Heating (object)
- HeatingQC (object)
- HouseStyle (object)
- Id (int64)
- KitchenAbvGr (int64)
- KitchenQual (object)
- LandContour (object)
- LandSlope (object)
- LotArea (int64)
- LotConfig (object)
- LotFrontage (float64)
- LotShape (object)
- LowQualFinSF (int64)
- MSSubClass (int64)
- MSZoning (object)
- MasVnrArea (float64)
- MasVnrType (object)
- MiscFeature (object)
- MiscVal (int64)
- MoSold (int64)
- Neighborhood (object)
- OpenPorchSF (int64)
- OverallCond (int64)
- OverallQual (int64)
- PavedDrive (object)
- PoolArea (int64)
- PoolQC (object)
- RoofMatl (object)
- RoofStyle (object)
- SaleCondition (object)
- SalePrice (int64)
- SaleType (object)
- ScreenPorch (int64)
- Street (object)
- TotRmsAbvGrd (int64)
- TotalBsmtSF (int64)
- Utilities (object)
- WoodDeckSF (int64)
- YearBuilt (int64)
- YearRemodAdd (int64)
- YrSold (int64)
</pre>
<p>That is a huge number of features.</p>
<p>Our target is <i>SalePrice</i>.</p>
<div class="highlight">
<pre><span></span><span class="n">Y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">SalePrice</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org6237ba6">
<h3 id="org6237ba6">Step 2: Create X</h3>
<div class="outline-text-3" id="text-org6237ba6">
<blockquote>
<p>Now you will create a DataFrame called `X` holding the predictive features.</p>
<p>Since you want only some columns from the original data, you'll first create a list with the names of the columns you want in `X`.</p>
<p>You'll use just the following columns in the list (you can copy and paste the whole list to save some typing, though you'll still need to add quotes):</p>
<ul class="org-ul">
<li>LotArea</li>
<li>YearBuilt</li>
<li>1stFlrSF</li>
<li>2ndFlrSF</li>
<li>FullBath</li>
<li>BedroomAbvGr</li>
<li>TotRmsAbvGrd</li>
</ul>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">FEATURES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"LotArea"</span><span class="p">,</span>
    <span class="s2">"YearBuilt"</span><span class="p">,</span>
    <span class="s2">"1stFlrSF"</span><span class="p">,</span>
    <span class="s2">"2ndFlrSF"</span><span class="p">,</span>
    <span class="s2">"FullBath"</span><span class="p">,</span>
    <span class="s2">"BedroomAbvGr"</span><span class="p">,</span>
    <span class="s2">"TotRmsAbvGrd"</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">FEATURES</span><span class="p">]</span>
</pre></div>
<p>Split up the data into training and validation sets.</p>
<div class="highlight">
<pre><span></span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_validate</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_validate</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgc72b956">
<h3 id="orgc72b956">Step 3: Specify and Fit Model</h3>
<div class="outline-text-3" id="text-orgc72b956"></div>
<div class="outline-4" id="outline-container-org255fdfe">
<h4 id="org255fdfe">A Linear Regression Model</h4>
<div class="outline-text-4" id="text-org255fdfe">
<p>As a baseline, I'll fit a simple <a href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LinearRegression.html">Linear Regression</a> (ordinary-least-squares) model.</p>
<div class="highlight">
<pre><span></span><span class="n">regression</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">regression</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{scores.mean():0.2f} (+/- {2 * scores.std():0.2f})"</span><span class="p">)</span>
<span class="n">regression</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Training R^2: {regression.score(x_train, y_train): 0.2f}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Validation R^2: {regression.score(x_validate, y_validate):0.2f}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
0.66 (+/- 0.17)
Training R^2:  0.68
Validation R^2: 0.77
</pre></div>
</div>
<div class="outline-4" id="outline-container-orga2d64ba">
<h4 id="orga2d64ba">Decision Tree</h4>
<div class="outline-text-4" id="text-orga2d64ba">
<blockquote>
<p>Create a <code>DecisionTreeRegressor</code> and save it as <code>iowa_model</code>. Ensure you've done the relevant import from sklearn to run this command.</p>
<p>Then fit the model you just created using the data in <code>X</code> and <code>y</code> that you saved above.</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">tree</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">()</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{scores.mean():0.2f} (+/- {2 * scores.std():0.2f})"</span><span class="p">)</span>

<span class="n">tree</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Training R^2: {tree.score(x_train, y_train): 0.2f}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Validation R^2: {tree.score(x_validate, y_validate):0.2f}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
0.53 (+/- 0.32)
Training R^2:  1.00
Validation R^2: 0.73
</pre>
<p>So our linear regression actually does better than the tree does. It looks like the tree might be overfitting on the training data.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orga508e30">
<h3 id="orga508e30">Make Some Predictions</h3>
<div class="outline-text-3" id="text-orga508e30">
<div class="highlight">
<pre><span></span><span class="n">tree_predict</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_validate</span><span class="p">)</span>
<span class="n">regression_predict</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_validate</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org0340258">
<h3 id="org0340258">Step 4: Calculate the Mean Absolute Error in Validation Data</h3>
<div class="outline-text-3" id="text-org0340258">
<div class="highlight">
<pre><span></span><span class="n">tree_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">y_validate</span><span class="p">,</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">tree_predict</span><span class="p">)</span>
<span class="n">regression_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_true</span><span class="o">=</span><span class="n">y_validate</span><span class="p">,</span> <span class="n">y_pred</span><span class="o">=</span><span class="n">regression_predict</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Tree MAE: {tree_mae: 0.2f}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Regression MAE: {regression_mae: 0.2f}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Tree MAE:  29853.86
Regression MAE:  27228.88
</pre>
<p>The tree's error is a little higher than the regression line's.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org1dad268">
<h2 id="org1dad268">End</h2>
<div class="outline-text-2" id="text-org1dad268">
<p>Next up is underfitting and overfitting.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/tutorials/a-first-machine-learning-model/">A First Machine Learning Model</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/a-first-machine-learning-model/" rel="bookmark"><time class="published dt-published" datetime="2020-02-17T19:52:52-08:00" itemprop="datePublished" title="2020-02-17 19:52">2020-02-17 19:52</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#orgbf0d9db">Beginning</a>
<ul>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#org74168da">Imports</a>
<ul>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#org17710d4">Python</a></li>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#orgeabe544">PyPi</a></li>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#org2ede4bc">Others</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#org5065f3a">Set Up</a>
<ul>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#org8959fd2">Plottting</a></li>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#org8bbc350">The Timer</a></li>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#org8c32766">Environment</a></li>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#org30bf268">The Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#org1d01a85">Middle</a>
<ul>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#org04965f0">Step 1: Specify Prediction Target</a></li>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#orgc903648">Step 2: Create X</a></li>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#org984d174">Step 3: Specify and Fit Model</a>
<ul>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#org803b3dd">A Linear Regression Model</a></li>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#org0249d4f">Decision Tree</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#orgee580fc">Make Predictions</a>
<ul>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#org25a352c">The whole data set</a></li>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#org90eff8f">The Validation Set</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#org24040b2">Think About Your Results</a></li>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#org891150e">Step 4: Calculate the Mean Absolute Error in Validation Data</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#orgd16de7a">End</a>
<ul>
<li><a href="/posts/tutorials/a-first-machine-learning-model/#orgd39377c">Sources</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgbf0d9db">
<h2 id="orgbf0d9db">Beginning</h2>
<div class="outline-text-2" id="text-orgbf0d9db">
<p>This part 2 of a re-do of the kaggle <a href="https://www.kaggle.com/learn/intro-to-machine-learning">Intro to Machine Learning</a> tutorial - Your First Machine Learning Model.</p>
</div>
<div class="outline-3" id="outline-container-org74168da">
<h3 id="org74168da">Imports</h3>
<div class="outline-text-3" id="text-org74168da"></div>
<div class="outline-4" id="outline-container-org17710d4">
<h4 id="org17710d4">Python</h4>
<div class="outline-text-4" id="text-org17710d4">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgeabe544">
<h4 id="orgeabe544">PyPi</h4>
<div class="outline-text-4" id="text-orgeabe544">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">cross_val_score</span><span class="p">,</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">ElasticNet</span><span class="p">,</span> <span class="n">Lasso</span><span class="p">,</span> <span class="n">LinearRegression</span><span class="p">,</span> <span class="n">Ridge</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeRegressor</span>

<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">pandas</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org2ede4bc">
<h4 id="org2ede4bc">Others</h4>
<div class="outline-text-4" id="text-org2ede4bc">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">EnvironmentLoader</span><span class="p">,</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org5065f3a">
<h3 id="org5065f3a">Set Up</h3>
<div class="outline-text-3" id="text-org5065f3a"></div>
<div class="outline-4" id="outline-container-org8959fd2">
<h4 id="org8959fd2">Plottting</h4>
<div class="outline-text-4" id="text-org8959fd2">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"a-first-machine-learning-model"</span>
<span class="n">OUTPUT_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"../../files/posts/tutorials/"</span><span class="p">)</span><span class="o">/</span><span class="n">SLUG</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="n">OUTPUT_PATH</span><span class="p">)</span>
<span class="n">Plot</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org8bbc350">
<h4 id="org8bbc350">The Timer</h4>
<div class="outline-text-4" id="text-org8bbc350">
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org8c32766">
<h4 id="org8c32766">Environment</h4>
<div class="outline-text-4" id="text-org8c32766">
<div class="highlight">
<pre><span></span><span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="n">EnvironmentLoader</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org30bf268">
<h4 id="org30bf268">The Data</h4>
<div class="outline-text-4" id="text-org30bf268">
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">ENVIRONMENT</span><span class="p">[</span><span class="s2">"HOUSE-PRICES-IOWA"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">/</span><span class="s2">"train.csv"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org1d01a85">
<h2 id="org1d01a85">Middle</h2>
<div class="outline-text-2" id="text-org1d01a85"></div>
<div class="outline-3" id="outline-container-org04965f0">
<h3 id="org04965f0">Step 1: Specify Prediction Target</h3>
<div class="outline-text-3" id="text-org04965f0">
<p>Select the target variable, which corresponds to the sales price. Save this to a new variable called `y`. You'll need to print a list of the columns to find the name of the column you need.</p>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"- {column} ({data[column].dtype})"</span><span class="p">)</span>
</pre></div>
<pre class="example">
- 1stFlrSF (int64)
- 2ndFlrSF (int64)
- 3SsnPorch (int64)
- Alley (object)
- BedroomAbvGr (int64)
- BldgType (object)
- BsmtCond (object)
- BsmtExposure (object)
- BsmtFinSF1 (int64)
- BsmtFinSF2 (int64)
- BsmtFinType1 (object)
- BsmtFinType2 (object)
- BsmtFullBath (int64)
- BsmtHalfBath (int64)
- BsmtQual (object)
- BsmtUnfSF (int64)
- CentralAir (object)
- Condition1 (object)
- Condition2 (object)
- Electrical (object)
- EnclosedPorch (int64)
- ExterCond (object)
- ExterQual (object)
- Exterior1st (object)
- Exterior2nd (object)
- Fence (object)
- FireplaceQu (object)
- Fireplaces (int64)
- Foundation (object)
- FullBath (int64)
- Functional (object)
- GarageArea (int64)
- GarageCars (int64)
- GarageCond (object)
- GarageFinish (object)
- GarageQual (object)
- GarageType (object)
- GarageYrBlt (float64)
- GrLivArea (int64)
- HalfBath (int64)
- Heating (object)
- HeatingQC (object)
- HouseStyle (object)
- Id (int64)
- KitchenAbvGr (int64)
- KitchenQual (object)
- LandContour (object)
- LandSlope (object)
- LotArea (int64)
- LotConfig (object)
- LotFrontage (float64)
- LotShape (object)
- LowQualFinSF (int64)
- MSSubClass (int64)
- MSZoning (object)
- MasVnrArea (float64)
- MasVnrType (object)
- MiscFeature (object)
- MiscVal (int64)
- MoSold (int64)
- Neighborhood (object)
- OpenPorchSF (int64)
- OverallCond (int64)
- OverallQual (int64)
- PavedDrive (object)
- PoolArea (int64)
- PoolQC (object)
- RoofMatl (object)
- RoofStyle (object)
- SaleCondition (object)
- SalePrice (int64)
- SaleType (object)
- ScreenPorch (int64)
- Street (object)
- TotRmsAbvGrd (int64)
- TotalBsmtSF (int64)
- Utilities (object)
- WoodDeckSF (int64)
- YearBuilt (int64)
- YearRemodAdd (int64)
- YrSold (int64)
</pre>
<p>That is a huge number of features.</p>
<p>Our target is <i>SalePrice</i>.</p>
<div class="highlight">
<pre><span></span><span class="n">Y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">SalePrice</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgc903648">
<h3 id="orgc903648">Step 2: Create X</h3>
<div class="outline-text-3" id="text-orgc903648">
<blockquote>
<p>Now you will create a DataFrame called `X` holding the predictive features.</p>
<p>Since you want only some columns from the original data, you'll first create a list with the names of the columns you want in `X`.</p>
<p>You'll use just the following columns in the list (you can copy and paste the whole list to save some typing, though you'll still need to add quotes):</p>
<ul class="org-ul">
<li>LotArea</li>
<li>YearBuilt</li>
<li>1stFlrSF</li>
<li>2ndFlrSF</li>
<li>FullBath</li>
<li>BedroomAbvGr</li>
<li>TotRmsAbvGrd</li>
</ul>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">FEATURES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">"1stFlrSF"</span><span class="p">,</span>
    <span class="s2">"2ndFlrSF"</span><span class="p">,</span>
    <span class="s2">"BedroomAbvGr"</span><span class="p">,</span>
    <span class="s2">"FullBath"</span><span class="p">,</span>
    <span class="s2">"LotArea"</span><span class="p">,</span>
    <span class="s2">"TotRmsAbvGrd"</span><span class="p">,</span>
    <span class="s2">"YearBuilt"</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">FEATURES</span><span class="p">]</span>
</pre></div>
<p>Split up the data into training and validation sets.</p>
<div class="highlight">
<pre><span></span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_validate</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_validate</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org984d174">
<h3 id="org984d174">Step 3: Specify and Fit Model</h3>
<div class="outline-text-3" id="text-org984d174"></div>
<div class="outline-4" id="outline-container-org803b3dd">
<h4 id="org803b3dd">A Linear Regression Model</h4>
<div class="outline-text-4" id="text-org803b3dd">
<p>As a baseline, I'll fit a simple <a href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LinearRegression.html">Linear Regression</a> (ordinary-least-squares) model.</p>
<div class="highlight">
<pre><span></span><span class="n">regression</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">regression</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{scores.mean():0.2f} (+/- {2 * scores.std():0.2f})"</span><span class="p">)</span>
<span class="n">regression</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Training R^2: {regression.score(x_train, y_train): 0.2f}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Validation R^2: {regression.score(x_validate, y_validate):0.2f}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
0.66 (+/- 0.17)
Training R^2:  0.68
Validation R^2: 0.77
</pre></div>
</div>
<div class="outline-4" id="outline-container-org0249d4f">
<h4 id="org0249d4f">Decision Tree</h4>
<div class="outline-text-4" id="text-org0249d4f">
<blockquote>
<p>Create a <code>DecisionTreeRegressor</code> and save it as <code>iowa_model</code>. Ensure you've done the relevant import from sklearn to run this command.</p>
<p>Then fit the model you just created using the data in <code>X</code> and <code>y</code> that you saved above.</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">tree</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">()</span>
<span class="n">scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{scores.mean():0.2f} (+/- {2 * scores.std():0.2f})"</span><span class="p">)</span>

<span class="n">tree</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Training R^2: {tree.score(x_train, y_train): 0.2f}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Validation R^2: {tree.score(x_validate, y_validate):0.2f}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
0.54 (+/- 0.30)
Training R^2:  1.00
Validation R^2: 0.74
</pre>
<p>So our linear regression actually does better than the tree does. It looks like the tree might be overfitting on the training data.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgee580fc">
<h3 id="orgee580fc">Make Predictions</h3>
<div class="outline-text-3" id="text-orgee580fc">
<blockquote>
<p>Make predictions with the model's <code>predict</code> command using <code>X</code> as the data. Save the results to a variable called <code>predictions</code>.</p>
</blockquote>
</div>
<div class="outline-4" id="outline-container-org25a352c">
<h4 id="org25a352c">The whole data set</h4>
<div class="outline-text-4" id="text-org25a352c">
<div class="highlight">
<pre><span></span><span class="n">predictions_tree</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">predictions_line</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="n">x_y_tree</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">predicted</span><span class="o">=</span><span class="n">predictions_tree</span><span class="p">,</span> <span class="n">actual</span><span class="o">=</span><span class="n">Y</span><span class="p">))</span>
<span class="n">x_y_line</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">predicted</span><span class="o">=</span><span class="n">predictions_line</span><span class="p">,</span> <span class="n">actual</span><span class="o">=</span><span class="n">Y</span><span class="p">))</span>
<span class="n">ideal</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">Y</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">Y</span><span class="p">))</span>

<span class="n">tree_plot</span> <span class="o">=</span> <span class="n">x_y_tree</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"actual"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"predicted"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Decision Tree"</span><span class="p">)</span>
<span class="n">line_plot</span> <span class="o">=</span> <span class="n">x_y_line</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"actual"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"predicted"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Linear Regression"</span><span class="p">)</span>
<span class="n">ideal_plot</span> <span class="o">=</span> <span class="n">ideal</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">)</span>
<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">tree_plot</span> <span class="o">*</span> <span class="n">line_plot</span> <span class="o">*</span> <span class="n">ideal_plot</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Actual Vs Predictions"</span><span class="p">,</span>
                                    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                                    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"actual_vs_predicted"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</pre></div>
: <object data="/posts/tutorials/a-first-machine-learning-model/actual_vs_predicted.html" height="800" style="width:100%" type="text/html">:
<p>Figure Missing</p>
:</object>
<p>Despite the \(r^2\) value the decision tree looks like it did better than the linear model.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org90eff8f">
<h4 id="org90eff8f">The Validation Set</h4>
</div>
</div>
<div class="outline-3" id="outline-container-org24040b2">
<h3 id="org24040b2">Think About Your Results</h3>
<div class="outline-text-3" id="text-org24040b2">
<div class="highlight">
<pre><span></span><span class="n">predictions_tree</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_validate</span><span class="p">)</span>
<span class="n">predictions_line</span> <span class="o">=</span> <span class="n">regression</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">x_validate</span><span class="p">)</span>

<span class="n">x_y_tree</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">predicted</span><span class="o">=</span><span class="n">predictions_tree</span><span class="p">,</span> <span class="n">actual</span><span class="o">=</span><span class="n">y_validate</span><span class="p">))</span>
<span class="n">x_y_line</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">predicted</span><span class="o">=</span><span class="n">predictions_line</span><span class="p">,</span> <span class="n">actual</span><span class="o">=</span><span class="n">y_validate</span><span class="p">))</span>
<span class="n">ideal</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">y_validate</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_validate</span><span class="p">))</span>
<span class="n">tree_plot</span> <span class="o">=</span> <span class="n">x_y_tree</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"actual"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"predicted"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Decision Tree"</span><span class="p">)</span>
<span class="n">line_plot</span> <span class="o">=</span> <span class="n">x_y_line</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"actual"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"predicted"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Linear Regression"</span><span class="p">)</span>
<span class="n">ideal_plot</span> <span class="o">=</span> <span class="n">ideal</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"x"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"y"</span><span class="p">)</span>
<span class="n">plot</span> <span class="o">=</span> <span class="p">(</span><span class="n">tree_plot</span> <span class="o">*</span> <span class="n">line_plot</span> <span class="o">*</span> <span class="n">ideal_plot</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Actual Vs Predictions (Validation Set)"</span><span class="p">,</span>
                                    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                                    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"actual_vs_predicted_validation"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</pre></div>
: <object data="/posts/tutorials/a-first-machine-learning-model/actual_vs_predicted_validation.html" height="800" style="width:100%" type="text/html">:
<p>Figure Missing</p>
:</object>
<p>It's hard to see which model really does better here - based on the \(r^2\) value the linear model did better, but the plot makes it look like it kind of goes off as the values get bigger.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org891150e">
<h3 id="org891150e">Step 4: Calculate the Mean Absolute Error in Validation Data</h3>
<div class="outline-text-3" id="text-org891150e">
<p>val_mae = <span class="underline">__</span></p>
<p>#print(val_mae)</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgd16de7a">
<h2 id="orgd16de7a">End</h2>
<div class="outline-text-2" id="text-orgd16de7a"></div>
<div class="outline-3" id="outline-container-orgd39377c">
<h3 id="orgd39377c">Sources</h3>
<div class="outline-text-3" id="text-orgd39377c">
<ul class="org-ul">
<li>De Cock D. Ames, Iowa: Alternative to the Boston housing data as an end of semester regression project. Journal of Statistics Education. 2011 Nov 1;19(3). <a href="http://jse.amstat.org/v19n3/decock.pdf">Link to PDF</a></li>
</ul>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/tutorials/exploring-housing-data/">Exploring Housing Data</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/exploring-housing-data/" rel="bookmark"><time class="published dt-published" datetime="2020-02-17T18:30:21-08:00" itemprop="datePublished" title="2020-02-17 18:30">2020-02-17 18:30</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/exploring-housing-data/#org7f97978">Beginning</a>
<ul>
<li><a href="/posts/tutorials/exploring-housing-data/#orgb3f6652">Imports</a>
<ul>
<li><a href="/posts/tutorials/exploring-housing-data/#org7a71200">Python</a></li>
<li><a href="/posts/tutorials/exploring-housing-data/#org110c10c">PyPi</a></li>
<li><a href="/posts/tutorials/exploring-housing-data/#org474d3fc">Others</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/exploring-housing-data/#org35f64f2">Set Up</a>
<ul>
<li><a href="/posts/tutorials/exploring-housing-data/#orgcd4a24e">Plottting</a></li>
<li><a href="/posts/tutorials/exploring-housing-data/#org5cff9e2">The Timer</a></li>
<li><a href="/posts/tutorials/exploring-housing-data/#org813479c">Environment</a></li>
<li><a href="/posts/tutorials/exploring-housing-data/#orgb0ce6b2">The Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/exploring-housing-data/#org097a8ca">Middle</a>
<ul>
<li><a href="/posts/tutorials/exploring-housing-data/#org4fe493c">Summary Statistics</a></li>
<li><a href="/posts/tutorials/exploring-housing-data/#org64a1b9c">What is the average lot size (rounded to nearest integer)?</a></li>
<li><a href="/posts/tutorials/exploring-housing-data/#org1f3bfd9">As of today, how old is the newest home (current year - the date in which it was built)</a></li>
<li><a href="/posts/tutorials/exploring-housing-data/#org90bd67c">Think About Your Data</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/exploring-housing-data/#orgf296252">End</a>
<ul>
<li><a href="/posts/tutorials/exploring-housing-data/#org124f6e0">Sources</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org7f97978">
<h2 id="org7f97978">Beginning</h2>
<div class="outline-text-2" id="text-org7f97978">
<p>This is a re-do of the kaggle <a href="https://www.kaggle.com/learn/intro-to-machine-learning">Intro to Machine Learning</a> tutorial - Explore Your data.</p>
</div>
<div class="outline-3" id="outline-container-orgb3f6652">
<h3 id="orgb3f6652">Imports</h3>
<div class="outline-text-3" id="text-orgb3f6652"></div>
<div class="outline-4" id="outline-container-org7a71200">
<h4 id="org7a71200">Python</h4>
<div class="outline-text-4" id="text-org7a71200">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org110c10c">
<h4 id="org110c10c">PyPi</h4>
<div class="outline-text-4" id="text-org110c10c">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">cross_val_score</span><span class="p">,</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">ElasticNet</span><span class="p">,</span> <span class="n">Lasso</span><span class="p">,</span> <span class="n">LinearRegression</span><span class="p">,</span> <span class="n">Ridge</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeRegressor</span>

<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">pandas</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org474d3fc">
<h4 id="org474d3fc">Others</h4>
<div class="outline-text-4" id="text-org474d3fc">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">EnvironmentLoader</span><span class="p">,</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org35f64f2">
<h3 id="org35f64f2">Set Up</h3>
<div class="outline-text-3" id="text-org35f64f2"></div>
<div class="outline-4" id="outline-container-orgcd4a24e">
<h4 id="orgcd4a24e">Plottting</h4>
<div class="outline-text-4" id="text-orgcd4a24e">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"exploring-housing-data"</span>
<span class="n">OUTPUT_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"../../files/posts/tutorials/"</span><span class="p">)</span><span class="o">/</span><span class="n">SLUG</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="n">OUTPUT_PATH</span><span class="p">)</span>
<span class="n">Plot</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org5cff9e2">
<h4 id="org5cff9e2">The Timer</h4>
<div class="outline-text-4" id="text-org5cff9e2">
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org813479c">
<h4 id="org813479c">Environment</h4>
<div class="outline-text-4" id="text-org813479c">
<div class="highlight">
<pre><span></span><span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="n">EnvironmentLoader</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb0ce6b2">
<h4 id="orgb0ce6b2">The Data</h4>
<div class="outline-text-4" id="text-orgb0ce6b2">
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">ENVIRONMENT</span><span class="p">[</span><span class="s2">"HOUSE-PRICES-IOWA"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">/</span><span class="s2">"train.csv"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org097a8ca">
<h2 id="org097a8ca">Middle</h2>
<div class="outline-text-2" id="text-org097a8ca"></div>
<div class="outline-3" id="outline-container-org4fe493c">
<h3 id="org4fe493c">Summary Statistics</h3>
<div class="outline-text-3" id="text-org4fe493c">
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</pre></div>
<pre class="example">
                Id   MSSubClass  LotFrontage        LotArea  OverallQual  \
count  1460.000000  1460.000000  1201.000000    1460.000000  1460.000000   
mean    730.500000    56.897260    70.049958   10516.828082     6.099315   
std     421.610009    42.300571    24.284752    9981.264932     1.382997   
min       1.000000    20.000000    21.000000    1300.000000     1.000000   
25%     365.750000    20.000000    59.000000    7553.500000     5.000000   
50%     730.500000    50.000000    69.000000    9478.500000     6.000000   
75%    1095.250000    70.000000    80.000000   11601.500000     7.000000   
max    1460.000000   190.000000   313.000000  215245.000000    10.000000   

       OverallCond    YearBuilt  YearRemodAdd   MasVnrArea   BsmtFinSF1  ...  \
count  1460.000000  1460.000000   1460.000000  1452.000000  1460.000000  ...   
mean      5.575342  1971.267808   1984.865753   103.685262   443.639726  ...   
std       1.112799    30.202904     20.645407   181.066207   456.098091  ...   
min       1.000000  1872.000000   1950.000000     0.000000     0.000000  ...   
25%       5.000000  1954.000000   1967.000000     0.000000     0.000000  ...   
50%       5.000000  1973.000000   1994.000000     0.000000   383.500000  ...   
75%       6.000000  2000.000000   2004.000000   166.000000   712.250000  ...   
max       9.000000  2010.000000   2010.000000  1600.000000  5644.000000  ...   

        WoodDeckSF  OpenPorchSF  EnclosedPorch    3SsnPorch  ScreenPorch  \
count  1460.000000  1460.000000    1460.000000  1460.000000  1460.000000   
mean     94.244521    46.660274      21.954110     3.409589    15.060959   
std     125.338794    66.256028      61.119149    29.317331    55.757415   
min       0.000000     0.000000       0.000000     0.000000     0.000000   
25%       0.000000     0.000000       0.000000     0.000000     0.000000   
50%       0.000000    25.000000       0.000000     0.000000     0.000000   
75%     168.000000    68.000000       0.000000     0.000000     0.000000   
max     857.000000   547.000000     552.000000   508.000000   480.000000   

          PoolArea       MiscVal       MoSold       YrSold      SalePrice  
count  1460.000000   1460.000000  1460.000000  1460.000000    1460.000000  
mean      2.758904     43.489041     6.321918  2007.815753  180921.195890  
std      40.177307    496.123024     2.703626     1.328095   79442.502883  
min       0.000000      0.000000     1.000000  2006.000000   34900.000000  
25%       0.000000      0.000000     5.000000  2007.000000  129975.000000  
50%       0.000000      0.000000     6.000000  2008.000000  163000.000000  
75%       0.000000      0.000000     8.000000  2009.000000  214000.000000  
max     738.000000  15500.000000    12.000000  2010.000000  755000.000000  

[8 rows x 38 columns]
</pre></div>
</div>
<div class="outline-3" id="outline-container-org64a1b9c">
<h3 id="org64a1b9c">What is the average lot size (rounded to nearest integer)?</h3>
<div class="outline-text-3" id="text-org64a1b9c">
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{data.LotArea.mean().round().astype(int):,}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
10,517
</pre></div>
</div>
<div class="outline-3" id="outline-container-org1f3bfd9">
<h3 id="org1f3bfd9">As of today, how old is the newest home (current year - the date in which it was built)</h3>
<div class="outline-text-3" id="text-org1f3bfd9">
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{datetime.now().year - data.YearBuilt.max()} years"</span><span class="p">)</span>
</pre></div>
<pre class="example">
10 years
</pre></div>
</div>
<div class="outline-3" id="outline-container-org90bd67c">
<h3 id="org90bd67c">Think About Your Data</h3>
<div class="outline-text-3" id="text-org90bd67c">
<blockquote>
<p>The newest house in your data isn't that new. A few potential explanations for this:</p>
<ol class="org-ol">
<li>They haven't built new houses where this data was collected.</li>
<li>The data was collected a long time ago. Houses built after the data publication wouldn't show up.</li>
</ol>
<p>If the reason is explanation #1 above, does that affect your trust in the model you build with this data? What about if it is reason #2?</p>
</blockquote>
<p>If they haven't built new homes but the data is current, then that's not a problem, the problem would come if the data is old.</p>
<blockquote>
<p>How could you dig into the data to see which explanation is more plausible?</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">YrSold</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
</pre></div>
<pre class="example">
2010
</pre>
<p>The fact that there haven't been any sales in the last ten years leans credence to the idea that the dataset is kind of old.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgf296252">
<h2 id="orgf296252">End</h2>
<div class="outline-text-2" id="text-orgf296252"></div>
<div class="outline-3" id="outline-container-org124f6e0">
<h3 id="org124f6e0">Sources</h3>
<div class="outline-text-3" id="text-org124f6e0">
<ul class="org-ul">
<li>De Cock D. Ames, Iowa: Alternative to the Boston housing data as an end of semester regression project. Journal of Statistics Education. 2011 Nov 1;19(3). <a href="http://jse.amstat.org/v19n3/decock.pdf">Link to PDF</a></li>
</ul>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/tutorials/advanced-uses-of-shap-exercise/">Advanced Uses Of SHAP Exercise</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/advanced-uses-of-shap-exercise/" rel="bookmark"><time class="published dt-published" datetime="2020-02-14T20:03:29-08:00" itemprop="datePublished" title="2020-02-14 20:03">2020-02-14 20:03</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#orgb53df0e">Beginning</a>
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#orge9c5319">Imports</a>
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#orgf7097c2">Python</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#org096464a">PyPi</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#org8f3cc57">Others</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#org9ab3cbe">Set Up</a>
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#org497b014">Plotting</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#orga56468e">The Timer</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#orgdfdcd70">The Environment</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#orgaf6af83">The Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#org2d5aa7f">Middle</a>
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#org34e8d3e">Build the Model</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#orgc24f324">Shap Values</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#orgad934d8">Summary Plot</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#orgf4b0b6f">Question 1</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#orgba4e998">Question 2</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#orgb6890fc">Question 3</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#org3c7169a">Question 4</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#org3f2865c">Question 5</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#orgc82f100">Question 6</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#orgeb137b8">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgb53df0e">
<h2 id="orgb53df0e">Beginning</h2>
<div class="outline-text-2" id="text-orgb53df0e">
<p>This is my notes on the Advanced Uses of SHAP Exercise that's part of the <a href="https://www.kaggle.com/learn/machine-learning-explainability">Machine Learning Explainability</a> tutorial on kaggle.</p>
</div>
<div class="outline-3" id="outline-container-orge9c5319">
<h3 id="orge9c5319">Imports</h3>
<div class="outline-text-3" id="text-orge9c5319"></div>
<div class="outline-4" id="outline-container-orgf7097c2">
<h4 id="orgf7097c2">Python</h4>
<div class="outline-text-4" id="text-orgf7097c2">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org096464a">
<h4 id="org096464a">PyPi</h4>
<div class="outline-text-4" id="text-org096464a">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">RandomizedSearchCV</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">seaborn</span>
<span class="kn">import</span> <span class="nn">shap</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org8f3cc57">
<h4 id="org8f3cc57">Others</h4>
<div class="outline-text-4" id="text-org8f3cc57">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EnvironmentLoader</span><span class="p">,</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org9ab3cbe">
<h3 id="org9ab3cbe">Set Up</h3>
<div class="outline-text-3" id="text-org9ab3cbe"></div>
<div class="outline-4" id="outline-container-org497b014">
<h4 id="org497b014">Plotting</h4>
<div class="outline-text-4" id="text-org497b014">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"advanced-uses-of-shap-exercise"</span>
<span class="n">OUTPUT_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"../../files/posts/tutorials"</span><span class="p">)</span><span class="o">/</span><span class="n">SLUG</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>

<span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'matplotlib'</span><span class="p">,</span> <span class="s1">'inline'</span><span class="p">)</span>
<span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'config'</span><span class="p">,</span> <span class="s2">"InlineBackend.figure_format = 'retina'"</span><span class="p">)</span>
<span class="n">FIGURE_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">"whitegrid"</span><span class="p">,</span>
            <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">"axes.grid"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                <span class="s2">"font.family"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"sans-serif"</span><span class="p">],</span>
                <span class="s2">"font.sans-serif"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Open Sans"</span><span class="p">,</span> <span class="s2">"Latin Modern Sans"</span><span class="p">,</span> <span class="s2">"Lato"</span><span class="p">],</span>
                <span class="s2">"font.size"</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
                <span class="s2">"figure.figsize"</span><span class="p">:</span> <span class="n">FIGURE_SIZE</span><span class="p">},</span>
            <span class="n">font_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orga56468e">
<h4 id="orga56468e">The Timer</h4>
<div class="outline-text-4" id="text-orga56468e">
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgdfdcd70">
<h4 id="orgdfdcd70">The Environment</h4>
<div class="outline-text-4" id="text-orgdfdcd70">
<div class="highlight">
<pre><span></span><span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="n">EnvironmentLoader</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgaf6af83">
<h4 id="orgaf6af83">The Data</h4>
<div class="outline-text-4" id="text-orgaf6af83">
<p>Once again we're going to use the <a href="https://www.kaggle.com/dansbecker/hospital-readmissions">Medical Data and Hospital Readmissions</a> dataset from kaggle.</p>
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ENVIRONMENT</span><span class="p">[</span><span class="s2">"HOSPITAL-READMISSIONS"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>
<p>We are only going to use a subset of the features.</p>
<div class="highlight">
<pre><span></span><span class="n">FEATURES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'A1Cresult_None'</span><span class="p">,</span>
    <span class="s1">'diabetesMed_Yes'</span><span class="p">,</span>
    <span class="s1">'diag_1_414'</span><span class="p">,</span> 
    <span class="s1">'diag_1_428'</span><span class="p">,</span>
    <span class="s1">'gender_Female'</span><span class="p">,</span>
    <span class="s1">'medical_specialty_?'</span><span class="p">,</span>
    <span class="s1">'num_lab_procedures'</span><span class="p">,</span> 
    <span class="s1">'num_medications'</span><span class="p">,</span>
    <span class="s1">'num_procedures'</span><span class="p">,</span>
    <span class="s1">'number_diagnoses'</span><span class="p">,</span>
    <span class="s1">'number_emergency'</span><span class="p">,</span> 
    <span class="s1">'number_inpatient'</span><span class="p">,</span>
    <span class="s1">'number_outpatient'</span><span class="p">,</span>
    <span class="s1">'payer_code_?'</span><span class="p">,</span>
    <span class="s1">'time_in_hospital'</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
<p>Now we'll split up the features and the target. According to the notebook some versions of shap don't work when you combine numeric and boolean types so we'll convert all the features to floats.</p>
<div class="highlight">
<pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">FEATURES</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">readmitted</span>
</pre></div>
<p>Now the training and validation split.</p>
<div class="highlight">
<pre><span></span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_validation</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_validation</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org2d5aa7f">
<h2 id="org2d5aa7f">Middle</h2>
<div class="outline-text-2" id="text-org2d5aa7f"></div>
<div class="outline-3" id="outline-container-org34e8d3e">
<h3 id="org34e8d3e">Build the Model</h3>
<div class="outline-text-3" id="text-org34e8d3e">
<p>For some reason the notebook switches from a classifier to a regressor, even though this seems to be a classification problem. Since I don't have an explanation for it I'll try it using a classifier instead.</p>
<div class="highlight">
<pre><span></span><span class="c1"># model = RandomForestRegressor()</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">()</span>
<span class="n">estimators</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">max_depth</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>

<span class="n">grid</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">estimators</span><span class="p">,</span>
            <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">)</span>
<span class="n">search</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                            <span class="n">param_distributions</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
                            <span class="n">n_iter</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                            <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"CV Training Accuracy: {search.best_score_:0.2f}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Training Accuracy: {model.score(x_train, y_train): 0.2f}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Validation Accuracy: {model.score(x_validation, y_validation):0.2f}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
</pre></div>
<pre class="example">
CV Training Accuracy: 0.63
Training Accuracy:  0.70
Validation Accuracy: 0.63
{'n_estimators': 140, 'max_depth': 10}
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgc24f324">
<h3 id="orgc24f324">Shap Values</h3>
<div class="outline-text-3" id="text-orgc24f324">
<div class="highlight">
<pre><span></span><span class="n">READMITTED</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">x_validation</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgad934d8">
<h3 id="orgad934d8">Summary Plot</h3>
<div class="outline-text-3" id="text-orgad934d8">
<div class="highlight">
<pre><span></span><span class="n">shap</span><span class="o">.</span><span class="n">summary_plot</span><span class="p">(</span><span class="n">shap_values</span><span class="p">[</span><span class="n">READMITTED</span><span class="p">],</span> <span class="n">x_validation</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"shap_summary.png"</span>
<span class="c1">#figure.subplots_adjust(left=0.3)</span>
<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{output}]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_summary.png" src="/posts/tutorials/advanced-uses-of-shap-exercise/shap_summary.png"></p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgf4b0b6f">
<h3 id="orgf4b0b6f">Question 1</h3>
<div class="outline-text-3" id="text-orgf4b0b6f">
<blockquote>
<p>Which of the following features has a bigger range of effects on predictions (i.e. larger difference between most positive and most negative effect)</p>
<ul class="org-ul">
<li><code>diag_1_428</code> or</li>
<li><code>payer_code_?</code></li>
</ul>
</blockquote>
<p><code>diag_1_428</code> appears to have a bigger spread than <code>payer_code</code>.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgba4e998">
<h3 id="orgba4e998">Question 2</h3>
<div class="outline-text-3" id="text-orgba4e998">
<blockquote>
<p>Do you believe the range of effects sizes (distance between smallest effect and largest effect) is a good indication of which feature will have a higher permutation importance? Why or why not?</p>
<p>If the <b>range of effect sizes</b> measures something different from <b>permutation importance</b>: which is a better answer for the question "Which of these two features does the model say is more important for us to understand when discussing readmission risks in the population?"</p>
<p>Run the following line after you've decided your answer.</p>
</blockquote>
<p>I don't think that the range of effect size is a good indication of which feature will have a higher permutation importance, because it just indicates the spread of the values, not their overall effect.</p>
<p>I think that <code>diag_1_428</code> is more important because it has a higher <i>Feature Value</i> than <code>payer_code_?</code>.</p>
<p><b>Note:</b> Although the question says "which of these two features does the model say is more important", the answer given is that permutation importance is a better measure of what's important to the model, since it's a robust measurement, while the range of effects is influenced by outliers.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgb6890fc">
<h3 id="orgb6890fc">Question 3</h3>
<div class="outline-text-3" id="text-orgb6890fc">
<blockquote>
<p>Both <code>diag_1_428</code> and <code>payer_code_?</code> are binary variables, taking values of 0 or 1.</p>
<p>From the graph, which do you think would typically have a bigger impact on predicted readmission risk:</p>
<ul class="org-ul">
<li>Changing <code>diag_1_428</code> from 0 to 1</li>
<li>Changing <code>payer_code_?</code> from 0 to 1</li>
</ul>
</blockquote>
<p>I think that changing <code>diag_1_428</code> to 1 would have a bigger impact, since the dots are more heavily right skewed for it than is the case with <code>payer_code_?</code>.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org3c7169a">
<h3 id="org3c7169a">Question 4</h3>
<div class="outline-text-3" id="text-org3c7169a">
<blockquote>
<p>Some features (like <code>number_inpatient</code>) have reasonably clear separation between the blue and pink dots. Other variables like <code>num_lab_procedures</code> have blue and pink dots jumbled together, even though the SHAP values (or impacts on prediction) aren't all 0.</p>
<p>What do you think you learn from the fact that <code>num_lab_procedures</code> has blue and pink dots jumbled together? Once you have your answer, run the line below to verify your solution.</p>
</blockquote>
<p>I think that this means that it is more difficult to make predictions based on the <code>num_lab_procedures</code> - there isn't a clear separation of outcomes based on the value of <code>num_lab_procedures</code>. The feature probably has interacting effects with other features.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org3f2865c">
<h3 id="org3f2865c">Question 5</h3>
<div class="outline-text-3" id="text-org3f2865c">
<blockquote>
<p>Consider the following SHAP contribution dependence plot.</p>
<p>The x-axis shows <code>feature_of_interest</code> and the points are colored based on <code>other_feature</code>.</p>
</blockquote>
<div class="figure">
<p><img alt="zFdHneM.png" src="https://i.imgur.com/zFdHneM.png"></p>
</div>
<blockquote>
<p>Is there an interaction between <code>feature_of_interest</code> and <code>other_feature</code>?</p>
<p>If so, does <code>feature_of_interest</code> have a more positive impact on predictions when <code>other_feature</code> is high or when <code>other_feature</code> is low?</p>
</blockquote>
<p>It looks like <code>feature_of_interest</code> has a more positive impart on predictions when the <code>other_feature</code> is high.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgc82f100">
<h3 id="orgc82f100">Question 6</h3>
<div class="outline-text-3" id="text-orgc82f100">
<blockquote>
<p>Both <b>num_medications</b> and <b>num_lab_procedures</b> share that jumbling of pink and blue dots.</p>
<p>Aside from <code>num_medications</code> having effects of greater magnitude (both more positive and more negative), it's hard to see a meaningful difference between how these two features affect readmission risk. Create the SHAP dependence contribution plots for each variable, and describe what you think is different between how these two variables affect predictions.</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZE</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"num_medications.png"</span>
<span class="n">shap</span><span class="o">.</span><span class="n">dependence_plot</span><span class="p">(</span><span class="s2">"num_medications"</span><span class="p">,</span> <span class="n">shap_values</span><span class="p">[</span><span class="n">READMITTED</span><span class="p">],</span> <span class="n">x_validation</span><span class="p">,</span>
                     <span class="n">ax</span><span class="o">=</span><span class="n">axe</span><span class="p">)</span>
<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{output}]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="num_medications.png" src="/posts/tutorials/advanced-uses-of-shap-exercise/num_medications.png"></p>
</div>
<div class="highlight">
<pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZE</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"num_lab_procedures.png"</span>
<span class="n">shap</span><span class="o">.</span><span class="n">dependence_plot</span><span class="p">(</span><span class="s2">"num_lab_procedures"</span><span class="p">,</span> <span class="n">shap_values</span><span class="p">[</span><span class="n">READMITTED</span><span class="p">],</span> <span class="n">x_validation</span><span class="p">,</span>
                     <span class="n">interaction_index</span><span class="o">=</span><span class="s2">"num_medications"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axe</span><span class="p">)</span>
<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{output}]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="num_lab_procedures.png" src="/posts/tutorials/advanced-uses-of-shap-exercise/num_lab_procedures.png"></p>
</div>
<p>The <code>num_medications</code> value appears to peak at 20 and then after that the SHAP value starts to go down as <code>num_medications</code> goes up, while <code>num_lab_procedures</code> makes a more gradual climb but appears to not have this inverted-curve shape.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgeb137b8">
<h2 id="orgeb137b8">End</h2>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/tutorials/advanced-uses-of-shap/">Advanced Uses Of SHAP</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/advanced-uses-of-shap/" rel="bookmark"><time class="published dt-published" datetime="2020-02-14T16:09:16-08:00" itemprop="datePublished" title="2020-02-14 16:09">2020-02-14 16:09</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org5d016e2">Beginning</a>
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#orga3713de">Imports</a>
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#orgf6c97a7">Python</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org878f166">PyPi</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#orge1ce0ff">Others</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#orge62d8a8">Set Up</a>
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#orgd093035">Plotting</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org8d9071e">The Environment</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org2de5318">The Dataset</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org94982f8">Middle</a>
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org1f260ac">Setup the SHAP Values</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org82bb714">Summary Plots</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org07e63bc">SHAP Dependence Contribution Plots</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org05b2cf8">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org5d016e2">
<h2 id="org5d016e2">Beginning</h2>
<div class="outline-text-2" id="text-org5d016e2">
<p>This is a re-do of the Kaggle tutorial on <a href="https://www.kaggle.com/dansbecker/advanced-uses-of-shap-values">Advanced Uses of SHAP Values</a>. SHAP values let us see how much a given feature changed our prediction for a given row of data, but it can also be used to look at groups of features to get a bigger picture look at our model.</p>
</div>
<div class="outline-3" id="outline-container-orga3713de">
<h3 id="orga3713de">Imports</h3>
<div class="outline-text-3" id="text-orga3713de"></div>
<div class="outline-4" id="outline-container-orgf6c97a7">
<h4 id="orgf6c97a7">Python</h4>
<div class="outline-text-4" id="text-orgf6c97a7">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org878f166">
<h4 id="org878f166">PyPi</h4>
<div class="outline-text-4" id="text-org878f166">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">seaborn</span>
<span class="kn">import</span> <span class="nn">shap</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orge1ce0ff">
<h4 id="orge1ce0ff">Others</h4>
<div class="outline-text-4" id="text-orge1ce0ff">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EnvironmentLoader</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orge62d8a8">
<h3 id="orge62d8a8">Set Up</h3>
<div class="outline-text-3" id="text-orge62d8a8"></div>
<div class="outline-4" id="outline-container-orgd093035">
<h4 id="orgd093035">Plotting</h4>
<div class="outline-text-4" id="text-orgd093035">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"advanced-uses-of-shap"</span>
<span class="n">OUTPUT_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"../../files/posts/tutorials"</span><span class="p">)</span><span class="o">/</span><span class="n">SLUG</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>

<span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'matplotlib'</span><span class="p">,</span> <span class="s1">'inline'</span><span class="p">)</span>
<span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'config'</span><span class="p">,</span> <span class="s2">"InlineBackend.figure_format = 'retina'"</span><span class="p">)</span>
<span class="n">FIGURE_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">"whitegrid"</span><span class="p">,</span>
            <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">"axes.grid"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                <span class="s2">"font.family"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"sans-serif"</span><span class="p">],</span>
                <span class="s2">"font.sans-serif"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Open Sans"</span><span class="p">,</span> <span class="s2">"Latin Modern Sans"</span><span class="p">,</span> <span class="s2">"Lato"</span><span class="p">],</span>
                <span class="s2">"font.size"</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
                <span class="s2">"figure.figsize"</span><span class="p">:</span> <span class="n">FIGURE_SIZE</span><span class="p">},</span>
            <span class="n">font_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org8d9071e">
<h4 id="org8d9071e">The Environment</h4>
<div class="outline-text-4" id="text-org8d9071e">
<div class="highlight">
<pre><span></span><span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="n">EnvironmentLoader</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org2de5318">
<h4 id="org2de5318">The Dataset</h4>
<div class="outline-text-4" id="text-org2de5318">
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ENVIRONMENT</span><span class="p">[</span><span class="s2">"FIFA-2018"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">"Man of the Match"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Yes"</span>

<span class="n">FEATURES</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">]</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">FEATURES</span><span class="p">]</span>
<span class="n">x_train</span><span class="p">,</span> <span class="n">x_validation</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_validation</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org94982f8">
<h2 id="org94982f8">Middle</h2>
<div class="outline-text-2" id="text-org94982f8"></div>
<div class="outline-3" id="outline-container-org1f260ac">
<h3 id="org1f260ac">Setup the SHAP Values</h3>
<div class="outline-text-3" id="text-org1f260ac">
<div class="highlight">
<pre><span></span><span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">x_validation</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org82bb714">
<h3 id="org82bb714">Summary Plots</h3>
<div class="outline-text-3" id="text-org82bb714">
<p>Like Permutation Importance, SHAP Summary Plots show you the relative importance of different features for your model, but unlike Permutation Importance, Summary Plots can show you how much more each feature influences the predictions.</p>
<div class="highlight">
<pre><span></span><span class="n">MAN_OF_THE_MATCH</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">shap</span><span class="o">.</span><span class="n">summary_plot</span><span class="p">(</span><span class="n">shap_values</span><span class="p">[</span><span class="n">MAN_OF_THE_MATCH</span><span class="p">],</span> <span class="n">x_validation</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
<span class="c1"># figure.set_size_inches(FIGURE_SIZE)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"shap_summary.png"</span>
<span class="n">figure</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{output}]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_summary.png" src="/posts/tutorials/advanced-uses-of-shap/shap_summary.png"></p>
</div>
<p>As with permutation importance, Goal Scored was the most important feature, with a greater impact on not being the man of the match than being the man of the match. This looks sort of like a combination of Permutation importance and Partial Dependence Plots (PDP) except all in one place.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org07e63bc">
<h3 id="org07e63bc">SHAP Dependence Contribution Plots</h3>
<div class="outline-text-3" id="text-org07e63bc">
<p>Dependence Contribution Plots work much like PDP plots except with more detail. Rather than showing you the means the Dependence Contribution Plot shows you the individual rows so you can get a sense of the shape of the outcomes.</p>
<div class="highlight">
<pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZE</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"ball_possession_dcp.png"</span>
<span class="n">shap</span><span class="o">.</span><span class="n">dependence_plot</span><span class="p">(</span><span class="s2">"Ball Possession %"</span><span class="p">,</span> <span class="n">shap_values</span><span class="p">[</span><span class="n">MAN_OF_THE_MATCH</span><span class="p">],</span> <span class="n">x_validation</span><span class="p">,</span>
                     <span class="n">interaction_index</span><span class="o">=</span><span class="s2">"Goal Scored"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axe</span><span class="p">)</span>
<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{output}]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="ball_possession_dcp.png" src="/posts/tutorials/advanced-uses-of-shap/ball_possession_dcp.png"></p>
</div>
<p>Interestingly, our plot doesn't look like the one in the tutorial, we appear to have much fewer points and less spread in the values. But, anyway, the way to interpret this is as you move from left to right you are increasing the percentage of the time that a team had the ball, and as you move up, you are increasing the likelihood that the team had a man of the match. Additionally, the colors tell you how many goals the team scored.</p>
<p>Looking closer, it looks like the tutorial went with the entire dataset rather than just the validation set, probably because there are so few data points. While that does reveal a more interesting pattern, I'm not sure that that's what you would do, normally.</p>
<p>Anyway, this plot shows that having a very low ball possession percentage decreases the likelihood that you would have the man of the match and generally speaking as it goes up, so does the likelihood of having man of the match, although it seems to level off around 45%.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org05b2cf8">
<h2 id="org05b2cf8">End</h2>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/tutorials/shap-values-exercise/">SHAP Values Exercise</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/shap-values-exercise/" rel="bookmark"><time class="published dt-published" datetime="2020-02-11T07:06:57-08:00" itemprop="datePublished" title="2020-02-11 07:06">2020-02-11 07:06</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#org180de97">Beginning</a>
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#org337234a">The Scenario</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org6865225">Imports</a>
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#orgea5f511">Python</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#orga8c4339">PyPi</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org68037cd">Others</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values-exercise/#org793b1bc">Set Up</a>
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#org3f46110">Plotting</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org86c818f">The Table Printer</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org51be6ab">The Timer</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org06b4048">The Environment</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org34a910b">The Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values-exercise/#org68328bb">Middle</a>
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#org5e04716">Looking At the Data</a>
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#org3ab9215">Set Up X and Y</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#orgd4da9b7">Split the Data</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values-exercise/#org18fc10c">A Simple Model</a>
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#org74d74ec">Train the Model</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org4b09dbf">Permutation Importance</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org6d52454">Partial Dependence Plot</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#orgbbdc98b">SHAP Values</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org3e67b5c">Time In Hospital</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org0d84c08">Raw Readmissions</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values-exercise/#orga52deb5">SHAP Creator</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values-exercise/#orgf3e5103">End</a>
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#orge194102">Sources</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org180de97">
<h2 id="org180de97">Beginning</h2>
<div class="outline-text-2" id="text-org180de97">
<p>This is the SHAP Exercise from the kaggle <a href="https://www.kaggle.com/learn/machine-learning-explainability">Machine Learing Explainability Tutorial</a>. It's using the kaggle <a href="https://www.kaggle.com/dansbecker/hospital-readmissions">Hospital Readmissions</a> dataset (I think).</p>
</div>
<div class="outline-3" id="outline-container-org337234a">
<h3 id="org337234a">The Scenario</h3>
<div class="outline-text-3" id="text-org337234a">
<blockquote>
<p>A hospital has struggled with "readmissions," where they release a patient before the patient has recovered enough, and the patient returns with health complications.</p>
<p>The hospital wants your help identifying patients at highest risk of being readmitted. Doctors (rather than your model) will make the final decision about when to release each patient; but they hope your model will highlight issues the doctors should consider when releasing a patient.</p>
<p>The hospital has given you relevant patient medical information.</p>
</blockquote>
</div>
</div>
<div class="outline-3" id="outline-container-org6865225">
<h3 id="org6865225">Imports</h3>
<div class="outline-text-3" id="text-org6865225"></div>
<div class="outline-4" id="outline-container-orgea5f511">
<h4 id="orgea5f511">Python</h4>
<div class="outline-text-4" id="text-orgea5f511">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">random</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orga8c4339">
<h4 id="orga8c4339">PyPi</h4>
<div class="outline-text-4" id="text-orga8c4339">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">eli5.sklearn</span> <span class="kn">import</span> <span class="n">PermutationImportance</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>
<span class="kn">from</span> <span class="nn">pdpbox</span> <span class="kn">import</span> <span class="n">pdp</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">RandomizedSearchCV</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">import</span> <span class="nn">eli5</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">shap</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org68037cd">
<h4 id="org68037cd">Others</h4>
<div class="outline-text-4" id="text-org68037cd">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">EnvironmentLoader</span><span class="p">,</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org793b1bc">
<h3 id="org793b1bc">Set Up</h3>
<div class="outline-text-3" id="text-org793b1bc"></div>
<div class="outline-4" id="outline-container-org3f46110">
<h4 id="org3f46110">Plotting</h4>
<div class="outline-text-4" id="text-org3f46110">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"shap-values-exercise"</span>
<span class="n">OUTPUT_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"../../files/posts/tutorials/"</span><span class="p">)</span><span class="o">/</span><span class="n">SLUG</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>

<span class="n">Plot</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="n">OUTPUT_PATH</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org86c818f">
<h4 id="org86c818f">The Table Printer</h4>
<div class="outline-text-4" id="text-org86c818f">
<div class="highlight">
<pre><span></span><span class="n">TABLE</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">tabulate</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">,</span> <span class="n">showindex</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org51be6ab">
<h4 id="org51be6ab">The Timer</h4>
<div class="outline-text-4" id="text-org51be6ab">
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org06b4048">
<h4 id="org06b4048">The Environment</h4>
<div class="outline-text-4" id="text-org06b4048">
<div class="highlight">
<pre><span></span><span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="n">EnvironmentLoader</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org34a910b">
<h4 id="org34a910b">The Data</h4>
<div class="outline-text-4" id="text-org34a910b">
<div class="highlight">
<pre><span></span><span class="n">PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ENVIRONMENT</span><span class="p">[</span><span class="s2">"HOSPITAL-READMISSIONS"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">PATH</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">PATH</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org68328bb">
<h2 id="org68328bb">Middle</h2>
<div class="outline-text-2" id="text-org68328bb"></div>
<div class="outline-3" id="outline-container-org5e04716">
<h3 id="org5e04716">Looking At the Data</h3>
<div class="outline-text-3" id="text-org5e04716">
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">" - {column}"</span><span class="p">)</span>
</pre></div>
<ul class="org-ul">
<li>A1Cresult_None</li>
<li>acarbose_No</li>
<li>acetohexamide_No</li>
<li>age_[40-50)</li>
<li>age_[50-60)</li>
<li>age_[60-70)</li>
<li>age_[70-80)</li>
<li>age_[80-90)</li>
<li>change_No</li>
<li>chlorpropamide_No</li>
<li>citoglipton_No</li>
<li>diabetesMed_Yes</li>
<li>diag_1_414</li>
<li>diag_1_428</li>
<li>diag_1_786</li>
<li>diag_2_250</li>
<li>diag_2_276</li>
<li>diag_2_427</li>
<li>diag_2_428</li>
<li>diag_3_250</li>
<li>diag_3_276</li>
<li>diag_3_401</li>
<li>diag_3_428</li>
<li>examide_No</li>
<li>gender_Female</li>
<li>glimepiride-pioglitazone_No</li>
<li>glimepiride_No</li>
<li>glipizide-metformin_No</li>
<li>glipizide_No</li>
<li>glyburide-metformin_No</li>
<li>glyburide_No</li>
<li>insulin_No</li>
<li>max_glu_serum_None</li>
<li>medical_specialty_?</li>
<li>medical_specialty_Cardiology</li>
<li>medical_specialty_Emergency/Trauma</li>
<li>medical_specialty_Family/GeneralPractice</li>
<li>medical_specialty_InternalMedicine</li>
<li>metformin-pioglitazone_No</li>
<li>metformin-rosiglitazone_No</li>
<li>metformin_No</li>
<li>miglitol_No</li>
<li>nateglinide_No</li>
<li>num_lab_procedures</li>
<li>num_medications</li>
<li>num_procedures</li>
<li>number_diagnoses</li>
<li>number_emergency</li>
<li>number_inpatient</li>
<li>number_outpatient</li>
<li>payer_code_?</li>
<li>payer_code_BC</li>
<li>payer_code_HM</li>
<li>payer_code_MC</li>
<li>payer_code_SP</li>
<li>pioglitazone_No</li>
<li>race_AfricanAmerican</li>
<li>race_Caucasian</li>
<li>readmitted</li>
<li>repaglinide_No</li>
<li>rosiglitazone_No</li>
<li>time_in_hospital</li>
<li>tolazamide_No</li>
<li>tolbutamide_No</li>
<li>troglitazone_No</li>
</ul>
<p>So there are a lot of columns.</p>
<blockquote>
<p>Here are some quick hints at interpreting the field names:</p>
<ul class="org-ul">
<li>Your prediction target is <code>readmitted</code></li>
<li>Columns with the word <code>diag</code> indicate the diagnostic code of the illness or illnesses the patient was admitted with. For example, <code>diag_1_428</code> means the doctor said their first illness diagnosis is number "428". What illness does 428 correspond to? You could look it up in a codebook, but without more medical background it wouldn't mean anything to you anyway.</li>
<li>A column names like <code>glimepiride_No</code> mean the patient did not have the medicine <code>glimepiride</code>. If this feature had a value of False, then the patient did take the drug <code>glimepiride</code></li>
<li>Features whose names begin with <code>medical_specialty</code> describe the specialty of the doctor seeing the patient. The values in these fields are all <code>True</code> or <code>False</code>.</li>
</ul>
</blockquote>
</div>
<div class="outline-4" id="outline-container-org3ab9215">
<h4 id="org3ab9215">Set Up X and Y</h4>
<div class="outline-text-4" id="text-org3ab9215">
<div class="highlight">
<pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">readmitted</span>
<span class="n">TARGET</span> <span class="o">=</span> <span class="s2">"readmitted"</span>
<span class="n">FEATURES</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="n">TARGET</span><span class="p">]</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">FEATURES</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgd4da9b7">
<h4 id="orgd4da9b7">Split the Data</h4>
<div class="outline-text-4" id="text-orgd4da9b7">
<div class="highlight">
<pre><span></span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_validate</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_validate</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
                                                            <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org18fc10c">
<h3 id="org18fc10c">A Simple Model</h3>
<div class="outline-text-3" id="text-org18fc10c">
<blockquote>
<p>You have built a simple model, but the doctors say they don't know how to evaluate a model, and they'd like you to show them some evidence the model is doing something in line with their medical intuition. Create any graphics or tables that will show them a quick overview of what the model is doing?</p>
<p>They are very busy. So they want you to condense your model overview into just 1 or 2 graphics, rather than a long string of graphics.</p>
</blockquote>
</div>
<div class="outline-4" id="outline-container-org74d74ec">
<h4 id="org74d74ec">Train the Model</h4>
<div class="outline-text-4" id="text-org74d74ec">
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">model_1</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Training R^2: {model_1.score(x_train, y_train): 0.2f}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Validation R^2: {model_1.score(x_validate, y_validate):0.2f}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
2020-02-14 14:02:08,392 graeae.timers.timer start: Started: 2020-02-14 14:02:08.391737
2020-02-14 14:02:09,011 graeae.timers.timer end: Ended: 2020-02-14 14:02:09.011136
2020-02-14 14:02:09,011 graeae.timers.timer end: Elapsed: 0:00:00.619399
Training R^2:  1.00
Validation R^2: 0.60
</pre>
<div class="highlight">
<pre><span></span><span class="n">model_2</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">()</span>

<span class="n">estimators</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">max_depth</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>

<span class="n">grid</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">estimators</span><span class="p">,</span>
            <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">)</span>
<span class="n">search</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">model_2</span><span class="p">,</span>
                            <span class="n">param_distributions</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
                            <span class="n">n_iter</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                            <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">first_model</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"CV Training R^2: {search.best_score_:0.2f}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Training R^2: {first_model.score(x_train, y_train): 0.2f}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Validation R^2: {first_model.score(x_validate, y_validate):0.2f}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
</pre></div>
<pre class="example">
2020-02-14 14:02:10,418 graeae.timers.timer start: Started: 2020-02-14 14:02:10.418784
2020-02-14 14:04:09,802 graeae.timers.timer end: Ended: 2020-02-14 14:04:09.802077
2020-02-14 14:04:09,802 graeae.timers.timer end: Elapsed: 0:01:59.383293
CV Training R^2: 0.63
Training R^2:  0.70
Validation R^2: 0.63
{'n_estimators': 90, 'max_depth': 10}
</pre>
<p>We get a slight improvement with a much more complex model, but not a lot. Our validation \(r^2\) is nearly as good as the training \(r^2\) so it looks like we aren't overfitting.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org4b09dbf">
<h4 id="org4b09dbf">Permutation Importance</h4>
<div class="outline-text-4" id="text-org4b09dbf">
<div class="highlight">
<pre><span></span><span class="n">permutor</span> <span class="o">=</span> <span class="n">PermutationImportance</span><span class="p">(</span><span class="n">first_model</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">x_validate</span><span class="p">,</span> <span class="n">y_validate</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">ipython_html</span> <span class="o">=</span> <span class="n">eli5</span><span class="o">.</span><span class="n">show_weights</span><span class="p">(</span><span class="n">permutor</span><span class="p">,</span>
                                 <span class="n">feature_names</span><span class="o">=</span><span class="n">x_validate</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="n">ipython_html</span><span class="o">.</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">table</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Weight</th>
<th class="org-left" scope="col">Feature</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">0.0640 Â± 0.0071</td>
<td class="org-left">number_inpatient</td>
</tr>
<tr>
<td class="org-left">0.0108 Â± 0.0046</td>
<td class="org-left">number_emergency</td>
</tr>
<tr>
<td class="org-left">0.0084 Â± 0.0058</td>
<td class="org-left">number_outpatient</td>
</tr>
<tr>
<td class="org-left">0.0025 Â± 0.0034</td>
<td class="org-left">number_diagnoses</td>
</tr>
<tr>
<td class="org-left">0.0021 Â± 0.0010</td>
<td class="org-left">diabetesMed_Yes</td>
</tr>
<tr>
<td class="org-left">0.0020 Â± 0.0017</td>
<td class="org-left">payer_code_?</td>
</tr>
<tr>
<td class="org-left">0.0019 Â± 0.0015</td>
<td class="org-left">race_AfricanAmerican</td>
</tr>
<tr>
<td class="org-left">0.0015 Â± 0.0015</td>
<td class="org-left">num_lab_procedures</td>
</tr>
<tr>
<td class="org-left">0.0013 Â± 0.0008</td>
<td class="org-left">age_[80-90)</td>
</tr>
<tr>
<td class="org-left">0.0011 Â± 0.0030</td>
<td class="org-left">diag_1_428</td>
</tr>
<tr>
<td class="org-left">0.0011 Â± 0.0023</td>
<td class="org-left">medical_specialty_?</td>
</tr>
<tr>
<td class="org-left">0.0010 Â± 0.0012</td>
<td class="org-left">payer_code_HM</td>
</tr>
<tr>
<td class="org-left">0.0008 Â± 0.0043</td>
<td class="org-left">num_procedures</td>
</tr>
<tr>
<td class="org-left">0.0008 Â± 0.0012</td>
<td class="org-left">payer_code_BC</td>
</tr>
<tr>
<td class="org-left">0.0008 Â± 0.0008</td>
<td class="org-left">age_[40-50)</td>
</tr>
<tr>
<td class="org-left">0.0008 Â± 0.0010</td>
<td class="org-left">max_glu_serum_None</td>
</tr>
<tr>
<td class="org-left">0.0008 Â± 0.0015</td>
<td class="org-left">race_Caucasian</td>
</tr>
<tr>
<td class="org-left">0.0005 Â± 0.0032</td>
<td class="org-left">num_medications</td>
</tr>
<tr>
<td class="org-left">0.0005 Â± 0.0022</td>
<td class="org-left">diag_2_250</td>
</tr>
<tr>
<td class="org-left">0.0004 Â± 0.0006</td>
<td class="org-left">rosiglitazone_No</td>
</tr>
<tr>
<td class="org-left">â€¦ 44 more â€¦</td>
<td class="org-left">â€¦ 44 more â€¦</td>
</tr>
</tbody>
</table>
<p>The most important features weren't in the data description. What is <code>number_inpatient</code>?</p>
</div>
</div>
<div class="outline-4" id="outline-container-org6d52454">
<h4 id="org6d52454">Partial Dependence Plot</h4>
<div class="outline-text-4" id="text-org6d52454">
<p>Since the most important feature is the "number_inpatient" let's see how much it changes the re-admissions.</p>
<div class="highlight">
<pre><span></span><span class="n">FEATURE</span> <span class="o">=</span> <span class="s2">"number_inpatient"</span>
<span class="n">pdp_dist</span> <span class="o">=</span> <span class="n">pdp</span><span class="o">.</span><span class="n">pdp_isolate</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">first_model</span><span class="p">,</span>
                           <span class="n">dataset</span><span class="o">=</span><span class="n">x_validate</span><span class="p">,</span>
                           <span class="n">model_features</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                           <span class="n">feature</span><span class="o">=</span><span class="n">FEATURE</span><span class="p">)</span>
<span class="n">pdp</span><span class="o">.</span><span class="n">pdp_plot</span><span class="p">(</span><span class="n">pdp_dist</span><span class="p">,</span> <span class="n">FEATURE</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">f</span><span class="s2">"{FEATURE}_pdp_plot.png"</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
<span class="n">figure</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{output}]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="number_inpatient_pdp_plot.png" src="/posts/tutorials/shap-values-exercise/number_inpatient_pdp_plot.png"></p>
</div>
</div>
</div>
<div class="outline-4" id="outline-container-orgbbdc98b">
<h4 id="orgbbdc98b">SHAP Values</h4>
<div class="outline-text-4" id="text-orgbbdc98b">
<div class="highlight">
<pre><span></span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ROW</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_validate</span><span class="p">))</span>
<span class="n">row_data</span> <span class="o">=</span> <span class="n">x_validate</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ROW</span><span class="p">]</span>
<span class="n">row_data_matrix</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">))</span>
</pre></div>
<pre class="example">
[0 1]
[[0.49342394 0.50657606]]
</pre>
<div class="highlight">
<pre><span></span>explainer = shap.TreeExplainer(first_model)
shap_values = explainer.shap_values(row_data_matrix)
</pre></div>
<div class="highlight">
<pre><span></span>READMIT = 1
figure = shap.force_plot(explainer.expected_value[READMIT],
                         shap_values[READMIT],
                         row_data_matrix,
                         feature_names=FEATURES,
                         matplotlib=True, show=False)
filename = "shap_zero.png"

figure.savefig(OUTPUT_PATH/filename)
print(f"[[file:{filename}]]")
</pre></div>
<div class="figure">
<p><img alt="shap_zero.png" src="/posts/tutorials/shap-values-exercise/shap_zero.png"></p>
</div>
</div>
<ul class="org-ul">
<li><a id="orgf3e7278"></a>Try one where num_inpatients was 1<br>
<div class="outline-text-5" id="text-orgf3e7278">
<div class="highlight">
<pre><span></span><span class="n">row_data</span> <span class="o">=</span> <span class="n">x_validate</span><span class="p">[</span><span class="n">x_validate</span><span class="o">.</span><span class="n">number_inpatient</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">row_data_matrix</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">))</span>
</pre></div>
<pre class="example">
[0 1]
[[0.36731038 0.63268962]]
</pre>
<div class="highlight">
<pre><span></span><span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">first_model</span><span class="p">)</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">force_plot</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">shap_values</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">row_data_matrix</span><span class="p">,</span>
                         <span class="n">feature_names</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                         <span class="n">matplotlib</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s2">"shap_one.png"</span>

<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">filename</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{filename}]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_one.png" src="/posts/tutorials/shap-values-exercise/shap_one.png"></p>
</div>
</div>
</li>
<li><a id="org52fdce0"></a>Try one where num_inpatients was 2<br>
<div class="outline-text-5" id="text-org52fdce0">
<div class="highlight">
<pre><span></span><span class="n">INPATIENTS</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">row_data</span> <span class="o">=</span> <span class="n">x_validate</span><span class="p">[</span><span class="n">x_validate</span><span class="o">.</span><span class="n">number_inpatient</span><span class="o">==</span><span class="n">INPATIENTS</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">row_data_matrix</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">))</span>
</pre></div>
<pre class="example">
[0 1]
[[0.38485607 0.61514393]]
</pre>
<div class="highlight">
<pre><span></span><span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">first_model</span><span class="p">)</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">force_plot</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">shap_values</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">row_data_matrix</span><span class="p">,</span>
                         <span class="n">feature_names</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                         <span class="n">matplotlib</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s2">"shap_two.png"</span>

<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">filename</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{filename}]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_two.png" src="/posts/tutorials/shap-values-exercise/shap_two.png"></p>
</div>
</div>
</li>
<li><a id="org9158d8e"></a>Try one where num_inpatients was 3<br>
<div class="outline-text-5" id="text-org9158d8e">
<div class="highlight">
<pre><span></span><span class="n">INPATIENTS</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">row_data</span> <span class="o">=</span> <span class="n">x_validate</span><span class="p">[</span><span class="n">x_validate</span><span class="o">.</span><span class="n">number_inpatient</span><span class="o">==</span><span class="n">INPATIENTS</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">row_data_matrix</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">))</span>
</pre></div>
<pre class="example">
[0 1]
[[0.47141351 0.52858649]]
</pre>
<div class="highlight">
<pre><span></span><span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">first_model</span><span class="p">)</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">force_plot</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">shap_values</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">row_data_matrix</span><span class="p">,</span>
                         <span class="n">feature_names</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                         <span class="n">matplotlib</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s2">"shap_three.png"</span>

<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">filename</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{filename}]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_three.png" src="/posts/tutorials/shap-values-exercise/shap_three.png"></p>
</div>
</div>
</li>
<li><a id="org1e9872c"></a>Try one where num_inpatients was the Maximum<br>
<div class="outline-text-5" id="text-org1e9872c">
<div class="highlight">
<pre><span></span><span class="n">INPATIENTS</span> <span class="o">=</span> <span class="n">x_validate</span><span class="o">.</span><span class="n">number_inpatient</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">row_data</span> <span class="o">=</span> <span class="n">x_validate</span><span class="p">[</span><span class="n">x_validate</span><span class="o">.</span><span class="n">number_inpatient</span><span class="o">==</span><span class="n">INPATIENTS</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">row_data_matrix</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">))</span>
</pre></div>
<pre class="example">
[0 1]
[[0.19208238 0.80791762]]
</pre>
<div class="highlight">
<pre><span></span><span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">first_model</span><span class="p">)</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">force_plot</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">shap_values</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">row_data_matrix</span><span class="p">,</span>
                         <span class="n">feature_names</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                         <span class="n">matplotlib</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s2">"shap_max.png"</span>

<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">filename</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{filename}]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_max.png" src="/posts/tutorials/shap-values-exercise/shap_max.png"></p>
</div>
<p>So it seems to be that the greater <code>number_inpatient</code> the more it contributes to re-admission (although note that since we're only using one row the cases with small values doesn't always look like what I plotted above - it depends on the patient).</p>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org3e67b5c">
<h4 id="org3e67b5c">Time In Hospital</h4>
<div class="outline-text-4" id="text-org3e67b5c">
<blockquote>
<p>The doctors think it's a good sign that increasing the number of inpatient procedures leads to increased predictions. But they can't tell from this plot whether that change in the plot is big or small. They'd like you to create something similar for <code>time_in_hospital</code> to see how that compares.</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">FEATURE</span> <span class="o">=</span> <span class="s2">"time_in_hospital"</span>
<span class="n">pdp_dist</span> <span class="o">=</span> <span class="n">pdp</span><span class="o">.</span><span class="n">pdp_isolate</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">first_model</span><span class="p">,</span>
                           <span class="n">dataset</span><span class="o">=</span><span class="n">x_validate</span><span class="p">,</span>
                           <span class="n">model_features</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                           <span class="n">feature</span><span class="o">=</span><span class="n">FEATURE</span><span class="p">)</span>
<span class="n">pdp</span><span class="o">.</span><span class="n">pdp_plot</span><span class="p">(</span><span class="n">pdp_dist</span><span class="p">,</span> <span class="n">FEATURE</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">f</span><span class="s2">"{FEATURE}_pdp_plot.png"</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{output}]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="time_in_hospital_pdp_plot.png" src="/posts/tutorials/shap-values-exercise/time_in_hospital_pdp_plot.png"></p>
</div>
<div class="highlight">
<pre><span></span><span class="n">TIME_IN_HOSPITAL</span> <span class="o">=</span> <span class="mi">8</span>

<span class="n">row_data</span> <span class="o">=</span> <span class="n">x_validate</span><span class="p">[</span><span class="n">x_validate</span><span class="o">.</span><span class="n">time_in_hospital</span><span class="o">==</span><span class="n">TIME_IN_HOSPITAL</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">row_data_matrix</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">))</span>
</pre></div>
<pre class="example">
[0 1]
[[0.39445183 0.60554817]]
</pre>
<div class="highlight">
<pre><span></span><span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">first_model</span><span class="p">)</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">force_plot</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">shap_values</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">row_data_matrix</span><span class="p">,</span>
                         <span class="n">feature_names</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                         <span class="n">matplotlib</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s2">"shap_hospital_one.png"</span>

<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">filename</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{filename}]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_hospital_one.png" src="/posts/tutorials/shap-values-exercise/shap_hospital_one.png"></p>
</div>
<p>It looks like time in hospital has an effect - but it is a small one.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org0d84c08">
<h4 id="org0d84c08">Raw Readmissions</h4>
<div class="outline-text-4" id="text-org0d84c08">
<blockquote>
<p>Whoa! It seems like <code>time_in_hospital</code> doesn't matter at all. The difference between the lowest value on the partial dependence plot and the highest value is about 5%.</p>
<p>If that is what your model concluded, the doctors will believe it. But it seems so low. Could the data be wrong, or is your model doing something more complex than they expect?</p>
<p>They'd like you to show them the raw readmission rate for each value of <code>time_in_hospital</code> to see how it compares to the partial dependence plot.</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">training</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s2">"columns"</span><span class="p">)</span>
<span class="n">grouped</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">"time_in_hospital"</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">"readmitted"</span><span class="p">:</span> <span class="s2">"mean"</span><span class="p">})</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">bar</span><span class="p">()</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Readmission Rates for time_in_hospital"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span>
<span class="p">)</span>

<span class="n">source</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"time_in_hospital_readmission_rates"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</pre></div>
: <object data="/posts/tutorials/shap-values-exercise/time_in_hospital_readmission_rates.html" height="800" style="width:100%" type="text/html">:
<p>Figure Missing</p>
:</object>
<p>It sort of looks like <code>time_in_hospital</code> does affect readmission rates, just not as much as the number of admissions, I guess.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orga52deb5">
<h3 id="orga52deb5">SHAP Creator</h3>
<div class="outline-text-3" id="text-orga52deb5">
<blockquote>
<p>Now the doctors are convinced you have the right data, and the model overview looked reasonable. It's time to turn this into a finished product they can use. Specifically, the hospital wants you to create a function <code>patient_risk_factors</code> that does the following</p>
<ul class="org-ul">
<li>Takes a single row with patient data (of the same format you as your raw data)</li>
<li>Creates a visualization showing what features of that patient increased their risk of readmission, what features decreased it, and how much those features mattered.</li>
</ul>
<p>It's not important to show every feature with every miniscule impact on the readmission risk. It's fine to focus on only the most important features for that patient.</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">patient_risk_factors</span><span class="p">(</span><span class="n">row_data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">row_data_matrix</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">first_model</span><span class="p">)</span>
    <span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">)</span>
    <span class="n">figure</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">force_plot</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                             <span class="n">shap_values</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                             <span class="n">row_data_matrix</span><span class="p">,</span>
                             <span class="n">feature_names</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                             <span class="n">matplotlib</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">f</span><span class="s2">"shap_{tag}.png"</span>
    <span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{filename}]]"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">row_data_matrix</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">row</span> <span class="o">=</span> <span class="n">x_validate</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<span class="n">row_matrix</span> <span class="o">=</span> <span class="n">patient_risk_factors</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s2">"random_one"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_random_one.png" src="/posts/tutorials/shap-values-exercise/shap_random_one.png"></p>
</div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">row_matrix</span><span class="p">))</span>
</pre></div>
<pre class="example">
[[0.70043997 0.29956003]]
</pre>
<p>In this case it looks like the number of diagnoses was the most important - having many diagnoses with no hospital admissions predicts you won't be readmitted. Should people who were never admitted be considered? Perhaps "readmission" just means admitted later.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgf3e5103">
<h2 id="orgf3e5103">End</h2>
<div class="outline-text-2" id="text-orgf3e5103"></div>
<div class="outline-3" id="outline-container-orge194102">
<h3 id="orge194102">Sources</h3>
<div class="outline-text-3" id="text-orge194102">
<ul class="org-ul">
<li>Lundberg, S.M., Erion, G., Chen, H. et al. From local explanations to global understanding with explainable AI for trees. Nat Mach Intell 2, 56â€“67 (2020). <a href="https://doi.org/10.1038/s42256-019-0138-9">https://doi.org/10.1038/s42256-019-0138-9</a> (<a href="https://www.nature.com/articles/s42256-019-0138-9">TreeExplainer</a>)</li>
<li>Lundberg, S.M., Nair, B., Vavilala, M.S. et al. Explainable machine-learning predictions for the prevention of hypoxaemia during surgery. Nat Biomed Eng 2, 749â€“760 (2018). <a href="https://doi.org/10.1038/s41551-018-0304-0">https://doi.org/10.1038/s41551-018-0304-0</a> (<a href="https://www.nature.com/articles/s41551-018-0304-0"><code>force_plot</code></a>)</li>
</ul>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/tutorials/shap-values/">SHAP Values</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/shap-values/" rel="bookmark"><time class="published dt-published" datetime="2020-02-09T17:07:12-08:00" itemprop="datePublished" title="2020-02-09 17:07">2020-02-09 17:07</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/shap-values/#org30e60aa">Beginning</a>
<ul>
<li><a href="/posts/tutorials/shap-values/#orgcea5116">Imports</a>
<ul>
<li><a href="/posts/tutorials/shap-values/#org9131f9d">Python</a></li>
<li><a href="/posts/tutorials/shap-values/#org4822a65">PyPi</a></li>
<li><a href="/posts/tutorials/shap-values/#orgb5904e2">Others</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values/#org1005bb0">Set Up</a>
<ul>
<li><a href="/posts/tutorials/shap-values/#orga70ac75">Plotting</a></li>
<li><a href="/posts/tutorials/shap-values/#org06added">The Timer</a></li>
<li><a href="/posts/tutorials/shap-values/#org850627a">Environment</a></li>
<li><a href="/posts/tutorials/shap-values/#org9785c3e">The Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values/#org691ac7a">Middle</a>
<ul>
<li><a href="/posts/tutorials/shap-values/#org8db6bcc">A Single Row</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values/#org58aee5d">End</a>
<ul>
<li><a href="/posts/tutorials/shap-values/#org80b379e">See Also</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org30e60aa">
<h2 id="org30e60aa">Beginning</h2>
<div class="outline-text-2" id="text-org30e60aa">
<p>SHAP values interpret the impact of a certain value for a given feature when compared to the prediction you'd make if that feature instead took a baseline value. This helps us interpret predictions given specific values for our features. We'll do this using the <a href="https://github.com/slundberg/shap">SHAP</a> library, naturally.</p>
</div>
<div class="outline-3" id="outline-container-orgcea5116">
<h3 id="orgcea5116">Imports</h3>
<div class="outline-text-3" id="text-orgcea5116"></div>
<div class="outline-4" id="outline-container-org9131f9d">
<h4 id="org9131f9d">Python</h4>
<div class="outline-text-4" id="text-org9131f9d">
<div class="highlight">
<pre><span></span>from argparse import Namespace
from pathlib import Path
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org4822a65">
<h4 id="org4822a65">PyPi</h4>
<div class="outline-text-4" id="text-org4822a65">
<div class="highlight">
<pre><span></span>from matplotlib import pyplot
from sklearn.model_selection import train_test_split, RandomizedSearchCV
from sklearn.ensemble import RandomForestClassifier

import numpy
import pandas
import seaborn
import shap
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb5904e2">
<h4 id="orgb5904e2">Others</h4>
<div class="outline-text-4" id="text-orgb5904e2">
<div class="highlight">
<pre><span></span>from graeae import EnvironmentLoader, Timer
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org1005bb0">
<h3 id="org1005bb0">Set Up</h3>
<div class="outline-text-3" id="text-org1005bb0"></div>
<div class="outline-4" id="outline-container-orga70ac75">
<h4 id="orga70ac75">Plotting</h4>
<div class="outline-text-4" id="text-orga70ac75">
<div class="highlight">
<pre><span></span>SLUG = "shap-values"
OUTPUT_PATH = Path("../../files/posts/tutorials/")/SLUG
</pre></div>
<div class="highlight">
<pre><span></span>get_ipython().run_line_magic('matplotlib', 'inline')
get_ipython().run_line_magic('config', "InlineBackend.figure_format = 'retina'")
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org06added">
<h4 id="org06added">The Timer</h4>
<div class="outline-text-4" id="text-org06added">
<div class="highlight">
<pre><span></span>TIMER = Timer()
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org850627a">
<h4 id="org850627a">Environment</h4>
<div class="outline-text-4" id="text-org850627a">
<div class="highlight">
<pre><span></span>ENVIRONMENT = EnvironmentLoader()
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org9785c3e">
<h4 id="org9785c3e">The Data</h4>
<div class="outline-text-4" id="text-org9785c3e">
<div class="highlight">
<pre><span></span>data = pandas.read_csv(Path(ENVIRONMENT["FIFA-2018"]).expanduser())
y = data["Man of the Match"] == "Yes"
FEATURES = [column for column in data.columns if data[column].dtype == numpy.int64]
X = data[FEATURES]
x_train, x_validate, y_train, y_validate = train_test_split(X, y, random_state=1)


model = RandomForestClassifier()

estimators = list(range(50, 200, 10))
max_depth = list(range(10, 100, 10)) + [None]

grid = dict(n_estimators=estimators,
            max_depth=max_depth)
search = RandomizedSearchCV(estimator=model,
                            param_distributions=grid,
                            n_iter=40,
                            n_jobs=-1,
                            random_state=1)
with TIMER:
    search.fit(x_train, y_train)
first_model = search.best_estimator_
print(f"CV Training R^2: {search.best_score_:0.2f}")
print(f"Training R^2: {first_model.score(x_train, y_train): 0.2f}")
print(f"Validation R^2: {first_model.score(x_validate, y_validate):0.2f}")
print(search.best_params_)
</pre></div>
<pre class="example">
2020-02-10 18:09:33,716 graeae.timers.timer start: Started: 2020-02-10 18:09:33.716565
The default value of cv will change from 3 to 5 in version 0.22. Specify it explicitly to silence this warning.
2020-02-10 18:09:36,830 graeae.timers.timer end: Ended: 2020-02-10 18:09:36.830883
2020-02-10 18:09:36,832 graeae.timers.timer end: Elapsed: 0:00:03.114318
CV Training R^2: 0.70
Training R^2:  1.00
Validation R^2: 0.69
{'n_estimators': 100, 'max_depth': 30}
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org691ac7a">
<h2 id="org691ac7a">Middle</h2>
<div class="outline-text-2" id="text-org691ac7a"></div>
<div class="outline-3" id="outline-container-org8db6bcc">
<h3 id="org8db6bcc">A Single Row</h3>
<div class="outline-text-3" id="text-org8db6bcc">
<div class="highlight">
<pre><span></span>ROW = 5
row_data = x_validate.iloc[ROW]
row_data_matrix = row_data.values.reshape(1, -1)
print(first_model.classes_)
print(first_model.predict_proba(row_data_matrix))
</pre></div>
<pre class="example">
[False  True]
[[0.25 0.75]]
</pre>
<p>The <a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestClassifier.html#sklearn.ensemble.RandomForestClassifier.predict_proba"><code>predict_proba</code></a> method tells us the probability for the data for each class. So this team has a 70% chance that they do have a man of the match.</p>
<div class="highlight">
<pre><span></span>explainer = shap.TreeExplainer(first_model)
shap_values = explainer.shap_values(row_data_matrix)
</pre></div>
<div class="highlight">
<pre><span></span>print(explainer.shap_values.__doc__)
</pre></div>
<pre class="example">
Estimate the SHAP values for a set of samples.

       Parameters
       ----------
       X : numpy.array, pandas.DataFrame or catboost.Pool (for catboost)
           A matrix of samples (# samples x # features) on which to explain the model's output.

       y : numpy.array
           An array of label values for each sample. Used when explaining loss functions.

       tree_limit : None (default) or int
           Limit the number of trees used by the model. By default None means no use the limit of the
           original model, and -1 means no limit.

       approximate : bool
           Run fast, but only roughly approximate the Tree SHAP values. This runs a method
           previously proposed by Saabas which only considers a single feature ordering. Take care
           since this does not have the consistency guarantees of Shapley values and places too
           much weight on lower splits in the tree.

       check_additivity : bool
           Run a validation check that the sum of the SHAP values equals the output of the model. This
           check takes only a small amount of time, and will catch potential unforeseen errors.
           Note that this check only runs right now when explaining the margin of the model.

       Returns
       -------
       For models with a single output this returns a matrix of SHAP values
       (# samples x # features). Each row sums to the difference between the model output for that
       sample and the expected value of the model output (which is stored in the expected_value
       attribute of the explainer when it is constant). For models with vector outputs this returns
       a list of such matrices, one for each output.

</pre>
<p>The array returned by the <code>shap_values</code> method has two rows - one for each of our target classes. In this case we're asking if a team had a man of the match so we'll just look at the second array.</p>
<div class="highlight">
<pre><span></span>shap.initjs()
figure = shap.force_plot(explainer.expected_value[1],
                         shap_values[1],
                         row_data_matrix,
                         feature_names=FEATURES,
                         matplotlib=True, show=False)
filename = "shap_one.png"

figure.savefig(OUTPUT_PATH/filename)
print(f"[[file:{filename}]]")
</pre></div>
<div class="figure">
<p><img alt="shap_one.png" src="/posts/tutorials/shap-values/shap_one.png"></p>
</div>
<p>Our predicted probability that this team had a man of the match was 0.7, but the base-value for the set as a whole is 0.4979 (you can't see it in this plot for some reason), so our team is more likely to have one than most teams. The pink section of the plot shows the features that increased the probability and the part in blue shows the features that decreased the probability. The size of each feature's block is proportional to the amount the feature contributed, so the biggest block (<i>Goal Scored</i>) contributed the most. The greatest negative feature was <i>Ball Possession %</i>.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org58aee5d">
<h2 id="org58aee5d">End</h2>
<div class="outline-text-2" id="text-org58aee5d"></div>
<div class="outline-3" id="outline-container-org80b379e">
<h3 id="org80b379e">See Also</h3>
<div class="outline-text-3" id="text-org80b379e">
<ul class="org-ul">
<li>The <a href="https://shap.readthedocs.io/en/latest/">SHAP</a> Documentation</li>
<li>The <a href="https://github.com/slundberg/shap">SHAP github repository</a></li>
<li>Lundberg SM, Lee SI. A unified approach to interpreting model predictions. InAdvances in neural information processing systems 2017 (pp. 4765-4774). (<a href="https://papers.nips.cc/paper/7062-a-unified-approach-to-interpreting-model-predicti">PDF Available Here</a>)</li>
</ul>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/tutorials/exercise-in-partial-dependence-plots/">Exercise In Partial Dependence Plots</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/exercise-in-partial-dependence-plots/" rel="bookmark"><time class="published dt-published" datetime="2020-02-09T13:26:37-08:00" itemprop="datePublished" title="2020-02-09 13:26">2020-02-09 13:26</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#orge367985">Beginning</a>
<ul>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#org2aa7f78">Imports</a>
<ul>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#org40b180b">Python</a></li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#orga6f1bc2">PyPi</a></li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#org7ac8d27">Others</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#org9bfcfba">Set Up</a>
<ul>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#org0b1a4fd">The Environment</a></li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#org643086a">The Timer</a></li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#org110f291">Plotting</a></li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#org0b2b715">The Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#orga6e86b1">Middle</a>
<ul>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#org9dc70d9">The First Model</a></li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#org649345e">Question 1</a></li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#org91742b5">Question 2</a></li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#orge298a7f">Question 3</a></li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#org5d1dba0">Question 4</a></li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#orga1cd95e">Question 5</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orge367985">
<h2 id="orge367985">Beginning</h2>
<div class="outline-text-2" id="text-orge367985">
<p>This is my re-working of the Kaggle <a href="https://www.kaggle.com/learn/machine-learning-explainability">Machine Learning Explainability</a> exercise in Partial Dependece Plots. It uses data from the <a href="https://www.kaggle.com/c/new-york-city-taxi-fare-prediction">Taxi Fare Prediction</a> competition.</p>
</div>
<div class="outline-3" id="outline-container-org2aa7f78">
<h3 id="org2aa7f78">Imports</h3>
<div class="outline-text-3" id="text-org2aa7f78"></div>
<div class="outline-4" id="outline-container-org40b180b">
<h4 id="org40b180b">Python</h4>
<div class="outline-text-4" id="text-org40b180b">
<div class="highlight">
<pre><span></span>from pathlib import Path
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orga6f1bc2">
<h4 id="orga6f1bc2">PyPi</h4>
<div class="outline-text-4" id="text-orga6f1bc2">
<div class="highlight">
<pre><span></span>from matplotlib import pyplot
from matplotlib.pyplot import rcParams
from pdpbox import pdp
from sklearn.ensemble import RandomForestRegressor
from sklearn.linear_model import LinearRegression
from sklearn.model_selection import train_test_split, RandomizedSearchCV

import pandas
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org7ac8d27">
<h4 id="org7ac8d27">Others</h4>
<div class="outline-text-4" id="text-org7ac8d27">
<div class="highlight">
<pre><span></span>from graeae import EnvironmentLoader, Timer
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org9bfcfba">
<h3 id="org9bfcfba">Set Up</h3>
<div class="outline-text-3" id="text-org9bfcfba"></div>
<div class="outline-4" id="outline-container-org0b1a4fd">
<h4 id="org0b1a4fd">The Environment</h4>
<div class="outline-text-4" id="text-org0b1a4fd">
<div class="highlight">
<pre><span></span>ENVIRONMENT = EnvironmentLoader()
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org643086a">
<h4 id="org643086a">The Timer</h4>
<div class="outline-text-4" id="text-org643086a">
<div class="highlight">
<pre><span></span>TIMER = Timer()
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org110f291">
<h4 id="org110f291">Plotting</h4>
<div class="outline-text-4" id="text-org110f291">
<div class="highlight">
<pre><span></span>SLUG = "exercise-in-partial-dependence-plots"
OUTPUT_PATH = Path("../../files/posts/tutorials/")/SLUG

rcParams["figure.figsize"] = (6, 4)
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org0b2b715">
<h4 id="org0b2b715">The Data</h4>
<div class="outline-text-4" id="text-org0b2b715">
<div class="highlight">
<pre><span></span>ROWS = 5 * 10**4
data = pandas.read_csv(Path(ENVIRONMENT["NY-TAXI"]).expanduser()/"train.csv",
                       nrows=ROWS)
data = data.query('pickup_latitude &gt; 40.7 and pickup_latitude &lt; 40.8 and ' +
                  'dropoff_latitude &gt; 40.7 and dropoff_latitude &lt; 40.8 and ' +
                  'pickup_longitude &gt; -74 and pickup_longitude &lt; -73.9 and ' +
                  'dropoff_longitude &gt; -74 and dropoff_longitude &lt; -73.9 and ' +
                  'fare_amount &gt; 0'
                  )
y = data.fare_amount
base_features = ['pickup_longitude',
                 'pickup_latitude',
                 'dropoff_longitude',
                 'dropoff_latitude']

X = data[base_features]

x_train, x_validate, y_train, y_validate = train_test_split(X, y, random_state=1)
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orga6e86b1">
<h2 id="orga6e86b1">Middle</h2>
<div class="outline-text-2" id="text-orga6e86b1"></div>
<div class="outline-3" id="outline-container-org9dc70d9">
<h3 id="org9dc70d9">The First Model</h3>
<div class="outline-text-3" id="text-org9dc70d9">
<div class="highlight">
<pre><span></span>first_model = RandomForestRegressor(n_estimators=180,
                                    max_depth=50, random_state=1).fit(x_train, y_train)
print(f"Training R^2: {first_model.score(x_train, y_train):0.2f}")
print(f"Validation R^2: {first_model.score(x_validate, y_validate):0.2f}")
</pre></div>
<pre class="example">
Training R^2: 0.92
Validation R^2: 0.43
</pre></div>
</div>
<div class="outline-3" id="outline-container-org649345e">
<h3 id="org649345e">Question 1</h3>
<div class="outline-text-3" id="text-org649345e">
<div class="highlight">
<pre><span></span>FEATURE = 'pickup_longitude'
pdp_dist = pdp.pdp_isolate(model=first_model,
                           dataset=x_validate,
                           model_features=base_features,
                           feature=FEATURE)
pdp.pdp_plot(pdp_dist, FEATURE)
output = f"{FEATURE}_pdp_plot.png"
pyplot.savefig(OUTPUT_PATH/output)
print(f"[[file:{output}]]")
</pre></div>
<pre class="example">
[[file:pickup_longitude_pdp_plot.png]]
</pre>
<div class="figure">
<p><img alt="eb446225f180346680b332c924342792de7e5135.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/.ob-jupyter/eb446225f180346680b332c924342792de7e5135.png"></p>
</div>
<p><img alt="pickup_longitude_pdp_plot.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/pickup_longitude_pdp_plot.png"><img alt="eb446225f180346680b332c924342792de7e5135.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/.ob-jupyter/eb446225f180346680b332c924342792de7e5135.png"></p>
<blockquote>
<p>Why does the partial dependence plot have this U-shape?</p>
</blockquote>
<p>At the extremes you have the locations that can potentially travel the furthest, creating the biggest fairs, but as you move to the center you reduce the amount you can possibly travel - although the change isn't symmetric so this isn't the only explanation, otherwise if it were then you would expect the two ends to have the highest values and the nadir to be at the halfway point (-73.95).</p>
<blockquote>
<p>Does your explanation suggest what shape to expect in the partial dependence plots for the other features?</p>
<p>Create all other partial plots.</p>
</blockquote>
<div class="highlight">
<pre><span></span>for FEATURE in base_features:
    pdp_dist = pdp.pdp_isolate(model=first_model,
                               dataset=x_validate,
                               model_features=base_features,
                               feature=FEATURE)
    pdp.pdp_plot(pdp_dist, FEATURE)
    output = f"{FEATURE}_pdp_plot.png"
    pyplot.savefig(OUTPUT_PATH/output)
    print(f"[[file:{output}]]")
</pre></div>
<pre class="example">
[[file:pickup_longitude_pdp_plot.png]]
[[file:pickup_latitude_pdp_plot.png]]
[[file:dropoff_longitude_pdp_plot.png]]
[[file:dropoff_latitude_pdp_plot.png]]
</pre>
<p><img alt="eb446225f180346680b332c924342792de7e5135.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/.ob-jupyter/eb446225f180346680b332c924342792de7e5135.png"> <img alt="f2c9b641a0b8f044729d15efd208f672e3ecb7c1.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/.ob-jupyter/f2c9b641a0b8f044729d15efd208f672e3ecb7c1.png"> <img alt="6334156ec3931ff43161785fde6f1f27a460bccd.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/.ob-jupyter/6334156ec3931ff43161785fde6f1f27a460bccd.png"> <img alt="4417e1dcc2d023ce83c886e006ce5de690bfe97b.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/.ob-jupyter/4417e1dcc2d023ce83c886e006ce5de690bfe97b.png"></p>
<p><img alt="pickup_latitude_pdp_plot.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/pickup_latitude_pdp_plot.png"> <img alt="dropoff_longitude_pdp_plot.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/dropoff_longitude_pdp_plot.png"> <img alt="dropoff_latitude_pdp_plot.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/dropoff_latitude_pdp_plot.png"><img alt="eb446225f180346680b332c924342792de7e5135.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/.ob-jupyter/eb446225f180346680b332c924342792de7e5135.png"></p>
</div>
</div>
<div class="outline-3" id="outline-container-org91742b5">
<h3 id="org91742b5">Question 2</h3>
<div class="outline-text-3" id="text-org91742b5">
<p>Now you will run a 2D partial dependence plot. As a reminder, here is the code from the tutorial.</p>
<p>Create a 2D plot for the features <code>pickup_longitude</code> and <code>dropoff_longitude</code>.</p>
<div class="highlight">
<pre><span></span>FEATURES = "pickup_longitude dropoff_longitude".split()
interaction  =  pdp.pdp_interact(model=first_model,
                                 dataset=x_validate,
                                 model_features=base_features,
                                 features=FEATURES)
pdp.pdp_interact_plot(pdp_interact_out=interaction,
                      feature_names=FEATURES, plot_type='contour')
output = "longitude_interaction.png"
pyplot.savefig(OUTPUT_PATH/output)
print(f"[[file:{output}]]")
</pre></div>
<pre class="example">
[[file:longitude_interaction.png]]
</pre>
<div class="figure">
<p><img alt="744ca56de862b725f3b5132f1c80c9bf41837026.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/.ob-jupyter/744ca56de862b725f3b5132f1c80c9bf41837026.png"></p>
</div>
<div class="figure">
<p><img alt="longitude_interaction.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/longitude_interaction.png"></p>
</div>
<p>Our plot shows that the fares are highest at the top-left and bottom-right corners, as you might expect, since this would be the furthest distance from pickup to dropoff.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orge298a7f">
<h3 id="orge298a7f">Question 3</h3>
<div class="outline-text-3" id="text-orge298a7f">
<blockquote>
<p>Consider a ride starting at longitude -73.92 and ending at longitude -74. Using the graph from the last question, estimate how much money the rider would have saved if they'd started the ride at longitude -73.98 instead?</p>
</blockquote>
<p>I don't exactly agree with the interpretation given by the kaggle notebook. Looking at the plot, -73.92 to -74 appears to cost 27, while a -73.92 to -74 would cost 9 - but the notebook says that -73.92 to -74 costs 24. So I would say there would be a saving of 18 while the given answer is 15. To reconcile the difference (kind of) we might say that -73.92 to -74 costs 12, not 9 - it's not really easy to tell by the plot, in which case I would also say the savings is 15.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org5d1dba0">
<h3 id="org5d1dba0">Question 4</h3>
<div class="outline-text-3" id="text-org5d1dba0">
<blockquote>
<p>In the PDP's you've seen so far, location features have primarily served as a proxy to capture distance traveled. In the permutation importance lessons, you added the features `abs_lon_change` and `abs_lat_change` as a more direct measure of distance.</p>
<p>Create these features again here.</p>
<p>After you run it, identify the most important difference between this partial dependence plot and the one you got without absolute value features. The code to generate the PDP without absolute value features is at the top of this code cell.</p>
</blockquote>
<div class="highlight">
<pre><span></span>FEATURE = 'pickup_longitude'
pdp_dist_original = pdp.pdp_isolate(model=first_model,
                                    dataset=x_validate,
                                    model_features=base_features,
                                    feature=FEATURE)
pdp.pdp_plot(pdp_dist_original, FEATURE)
output = "pre_distance.png"
pyplot.savefig(OUTPUT_PATH/output)
print(f"[[file:{output}]]")
</pre></div>
<p><img alt="pre_distance.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/pre_distance.png"><img alt="eb446225f180346680b332c924342792de7e5135.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/.ob-jupyter/eb446225f180346680b332c924342792de7e5135.png"></p>
<div class="highlight">
<pre><span></span>data['abs_lon_change'] = abs(data.pickup_longitude - data.dropoff_longitude)
data['abs_lat_change'] = abs(data.pickup_latitude - data.dropoff_longitude)

features_2  = ['pickup_longitude',
               'pickup_latitude',
               'dropoff_longitude',
               'dropoff_latitude',
               'abs_lat_change',
               'abs_lon_change']

X = data[features_2]
new_x_train, new_x_validate, new_y_train, new_y_validate = train_test_split(X, y, random_state=1)

estimators = list(range(50, 200, 10))
max_depth = list(range(10, 100, 10)) + [None]

grid = dict(n_estimators=estimators,
            max_depth=max_depth)

model = RandomForestRegressor()
search = RandomizedSearchCV(estimator=model,
                            param_distributions=grid,
                            n_iter=40,
                            n_jobs=-1,
                            random_state=1)
with TIMER:
    search.fit(new_x_train, new_y_train)
second_model = search.best_estimator_
print(f"CV Training R^2: {search.best_score_:0.2f}")
print(f"Training R^2: {first_model.score(x_train, y_train): 0.2f}")
print(f"Validation R^2: {first_model.score(x_validate, y_validate):0.2f}")
print(search.best_params_)
</pre></div>
<pre class="example">
2020-02-09 17:36:14,915 graeae.timers.timer start: Started: 2020-02-09 17:36:14.915123
2020-02-09 17:43:16,053 graeae.timers.timer end: Ended: 2020-02-09 17:43:16.053011
2020-02-09 17:43:16,053 graeae.timers.timer end: Elapsed: 0:07:01.137888
CV Training R^2: 0.46
Training R^2:  0.92
Validation R^2: 0.43
{'n_estimators': 190, 'max_depth': 30}
</pre>
<div class="highlight">
<pre><span></span>FEATURE = 'pickup_longitude'
pdp_dist = pdp.pdp_isolate(model=second_model,
                           dataset=new_x_validate,
                           model_features=features_2,
                           feature=FEATURE)

pdp.pdp_plot(pdp_dist, FEATURE)
output = "pickup_longitude_with_distance_added.png"
pyplot.savefig(OUTPUT_PATH/output)
print(f"[[file:{output}]]")
</pre></div>
<p><img alt="pickup_longitude_with_distance_added.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/pickup_longitude_with_distance_added.png"><img alt="98c17657a972a412bc6d33619b6e23ee5818b884.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/.ob-jupyter/98c17657a972a412bc6d33619b6e23ee5818b884.png"></p>
</div>
</div>
<div class="outline-3" id="outline-container-orga1cd95e">
<h3 id="orga1cd95e">Question 5</h3>
<div class="outline-text-3" id="text-orga1cd95e">
<blockquote>
<p>Consider a scenario where you have only 2 predictive features, which we will call `feat_A` and `feat_B`. Both features have minimum values of -1 and maximum values of 1. The partial dependence plot for `feat_A` increases steeply over its whole range, whereas the partial dependence plot for feature B increases at a slower rate (less steeply) over its whole range. Does this guarantee that `feat_A` will have a higher permutation importance than `feat_B`. Why or why not?</p>
</blockquote>
<p>It doesn't - the partial dependence plot shows how the predictions change based on the inputs, but it isn't the same thing as the feature importance - it might be the case that a few inputs create a large difference but most points don't, in which case the feature importance won't be very large.</p>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/tutorials/partial-dependence-plots/">Partial Dependence Plots</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/partial-dependence-plots/" rel="bookmark"><time class="published dt-published" datetime="2020-02-08T12:48:50-08:00" itemprop="datePublished" title="2020-02-08 12:48">2020-02-08 12:48</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/partial-dependence-plots/#orgaebfb44">Beginning</a>
<ul>
<li><a href="/posts/tutorials/partial-dependence-plots/#orgaf84aab">What is this about?</a></li>
<li><a href="/posts/tutorials/partial-dependence-plots/#org244109b">How does it work?</a></li>
<li><a href="/posts/tutorials/partial-dependence-plots/#org8040c42">Imports</a>
<ul>
<li><a href="/posts/tutorials/partial-dependence-plots/#org3053d2c">Python</a></li>
<li><a href="/posts/tutorials/partial-dependence-plots/#orgad30f00">PyPi</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/partial-dependence-plots/#orgd192858">Set Up</a>
<ul>
<li><a href="/posts/tutorials/partial-dependence-plots/#org61d5b7d">Plotting</a></li>
<li><a href="/posts/tutorials/partial-dependence-plots/#orgdaa279e">The Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/partial-dependence-plots/#org6f96c88">Middle</a>
<ul>
<li><a href="/posts/tutorials/partial-dependence-plots/#org7d69aae">A Decision Tree Model</a>
<ul>
<li><a href="/posts/tutorials/partial-dependence-plots/#org8ebb967">Visualizing the Decision Tree</a></li>
<li><a href="/posts/tutorials/partial-dependence-plots/#org897c535">Partial Dependency Plot</a></li>
<li><a href="/posts/tutorials/partial-dependence-plots/#org291b85f">Distance Covered</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/partial-dependence-plots/#org20d6a0e">A Random Forest Model</a></li>
<li><a href="/posts/tutorials/partial-dependence-plots/#org8a39d7b">2D Partial Dependence Plots</a>
<ul>
<li><a href="/posts/tutorials/partial-dependence-plots/#orgcfa06ee">Forest From the Trees</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/partial-dependence-plots/#org576e2ae">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgaebfb44">
<h2 id="orgaebfb44">Beginning</h2>
<div class="outline-text-2" id="text-orgaebfb44"></div>
<div class="outline-3" id="outline-container-orgaf84aab">
<h3 id="orgaf84aab">What is this about?</h3>
<div class="outline-text-3" id="text-orgaf84aab">
<p>These are my notes/re-write of the <a href="https://www.kaggle.com/dansbecker/partial-plots">Partial Dependence Plots</a> tutorial on kaggle. Partial Dependence Plots are a complement to Permutation Importance in that Permutation Importance can tell you which features are contributing to the model but don't tell you how features change with different inputs. Given that they have the word "Plot" in their name you can guess that this is a visualization method and since humans have a hard time visualizing things with more than three dimensions, using them requires selecting a subset of features (or maybe just one feature) to visualize at a time, so the fact that Permutation Importance ranks features by their contribution might come in handy in deciding which features to use.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org244109b">
<h3 id="org244109b">How does it work?</h3>
<div class="outline-text-3" id="text-org244109b">
<p>In a simplistic view we might say that it takes input data and then repeatedly alters the values in our feature of choice, freezing the other values so that we can see how varying the feature changes the prediction. You can then repeat this for multiple rows of data and take the average prediction for each value of our feature.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org8040c42">
<h3 id="org8040c42">Imports</h3>
<div class="outline-text-3" id="text-org8040c42"></div>
<div class="outline-4" id="outline-container-org3053d2c">
<h4 id="org3053d2c">Python</h4>
<div class="outline-text-4" id="text-org3053d2c">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgad30f00">
<h4 id="orgad30f00">PyPi</h4>
<div class="outline-text-4" id="text-orgad30f00">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>
<span class="kn">from</span> <span class="nn">pdpbox</span> <span class="kn">import</span> <span class="n">pdp</span><span class="p">,</span> <span class="n">get_dataset</span><span class="p">,</span> <span class="n">info_plots</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">tree</span>

<span class="kn">import</span> <span class="nn">graphviz</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd192858">
<h3 id="orgd192858">Set Up</h3>
<div class="outline-text-3" id="text-orgd192858"></div>
<div class="outline-4" id="outline-container-org61d5b7d">
<h4 id="org61d5b7d">Plotting</h4>
<div class="outline-text-4" id="text-org61d5b7d">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"partial-dependence-plots"</span>
<span class="n">OUTPUT_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"../../files/posts/tutorials/"</span><span class="p">)</span><span class="o">/</span><span class="n">SLUG</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgdaa279e">
<h4 id="orgdaa279e">The Data</h4>
<div class="outline-text-4" id="text-orgdaa279e">
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"~/.env"</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">load_dotenv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"FIFA-2018"</span><span class="p">))</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org6f96c88">
<h2 id="org6f96c88">Middle</h2>
<div class="outline-text-2" id="text-org6f96c88"></div>
<div class="outline-3" id="outline-container-org7d69aae">
<h3 id="org7d69aae">A Decision Tree Model</h3>
<div class="outline-text-3" id="text-org7d69aae">
<p>The data is the same set from the Permutation Importance exercise (team data to predict whether one of them would become the <i>Budweiser Man of the Match</i>). Out initial model will be a shallow decision tree so that we can compare its structure to the plots.</p>
<div class="highlight">
<pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">"Man of the Match"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Yes"</span>
<span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">features</span><span class="p">]</span>

<span class="n">x_train</span><span class="p">,</span> <span class="n">x_validate</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_validate</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">tree_model</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-org8ebb967">
<h4 id="org8ebb967">Visualizing the Decision Tree</h4>
<div class="outline-text-4" id="text-org8ebb967">
<div class="highlight">
<pre><span></span><span class="n">tree_graph</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">export_graphviz</span><span class="p">(</span><span class="n">tree_model</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">graphviz</span><span class="o">.</span><span class="n">Source</span><span class="p">(</span><span class="n">tree_graph</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"decision_tree.dot"</span>
<span class="n">graph</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s2">"png"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{output}.png]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="decision_tree.dot.png" src="/posts/tutorials/partial-dependence-plots/decision_tree.dot.png"></p>
</div>
</div>
</div>
<div class="outline-4" id="outline-container-org897c535">
<h4 id="org897c535">Partial Dependency Plot</h4>
<div class="outline-text-4" id="text-org897c535">
<p>To create the plot we can use the <a href="https://pdpbox.readthedocs.io/en/latest/">PDPBox library</a>.</p>
</div>
<ul class="org-ul">
<li><a id="org942982e"></a>Create the Data to Plot<br>
<div class="outline-text-5" id="text-org942982e">
<div class="highlight">
<pre><span></span><span class="n">FEATURE</span> <span class="o">=</span> <span class="s2">"Goal Scored"</span>
<span class="n">pdp_goals</span> <span class="o">=</span> <span class="n">pdp</span><span class="o">.</span><span class="n">pdp_isolate</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">tree_model</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">x_validate</span><span class="p">,</span>
                            <span class="n">model_features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="n">FEATURE</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><a id="orgb8d39e8"></a>Plot It<br>
<div class="outline-text-5" id="text-orgb8d39e8">
<div class="highlight">
<pre><span></span><span class="n">pdp</span><span class="o">.</span><span class="n">pdp_plot</span><span class="p">(</span><span class="n">pdp_goals</span><span class="p">,</span> <span class="n">FEATURE</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"pdp_goals_scored.png"</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{output}]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="pdp_goals_scored.png" src="/posts/tutorials/partial-dependence-plots/pdp_goals_scored.png"></p>
</div>
<p>Looking at the plot we can interpret it as saying that scoring that first goal is helpful in getting someone on the team the Man of the Match, but after that, more goals doesn't help. The PDPBox documentation has no real information about interpreting the output (or anything they provide, really), but according to the Kaggle tutorial the y-axis is the change in the prediction from the baseline as x changes.</p>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org291b85f">
<h4 id="org291b85f">Distance Covered</h4>
<div class="outline-text-4" id="text-org291b85f">
<p>We can also look at how much the distance the players cover on the field matters.</p>
<div class="highlight">
<pre><span></span><span class="n">FEATURE</span> <span class="o">=</span> <span class="s2">"Distance Covered (Kms)"</span>
<span class="n">pdp_distance</span> <span class="o">=</span> <span class="n">pdp</span><span class="o">.</span><span class="n">pdp_isolate</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">tree_model</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">x_validate</span><span class="p">,</span>
                               <span class="n">model_features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="n">FEATURE</span><span class="p">)</span>
<span class="n">pdp</span><span class="o">.</span><span class="n">pdp_plot</span><span class="p">(</span><span class="n">pdp_distance</span><span class="p">,</span> <span class="n">FEATURE</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"pdp_distance.png"</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{output}]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="pdp_distance.png" src="/posts/tutorials/partial-dependence-plots/pdp_distance.png"></p>
</div>
<p>It looks like there's one distance at which the probabilities increase and then going further doesn't matter.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">pdp_distance</span><span class="o">.</span><span class="n">feature_grids</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
<pre class="example">
102.0
</pre>
<p>So you want your team to cover at least 102 Kilometers, but covering more won't help you.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org20d6a0e">
<h3 id="org20d6a0e">A Random Forest Model</h3>
<div class="outline-text-3" id="text-org20d6a0e">
<p>The Decision Tree was useful because the simplicity made it easy to interpret, but an ensemble method like a Random Forest probably makes a better model so let's see what it reveals.</p>
<div class="highlight">
<pre><span></span><span class="n">forest</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="n">FEATURE</span> <span class="o">=</span> <span class="s2">"Goal Scored"</span>
<span class="n">pdp_goals</span> <span class="o">=</span> <span class="n">pdp</span><span class="o">.</span><span class="n">pdp_isolate</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">forest</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">x_validate</span><span class="p">,</span>
                            <span class="n">model_features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="n">FEATURE</span><span class="p">)</span>
<span class="n">pdp</span><span class="o">.</span><span class="n">pdp_plot</span><span class="p">(</span><span class="n">pdp_goals</span><span class="p">,</span> <span class="n">FEATURE</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"pdp_forest_goals_scored.png"</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{output}]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="pdp_forest_goals_scored.png" src="/posts/tutorials/partial-dependence-plots/pdp_forest_goals_scored.png"></p>
</div>
<p>So, our random forest says that the greatest gain comes from the first goal, but there is in fact a greater probability as you increase the number of goals scored.</p>
<p>What about distance covered?</p>
<div class="highlight">
<pre><span></span><span class="n">FEATURE</span> <span class="o">=</span> <span class="s2">"Distance Covered (Kms)"</span>
<span class="n">pdp_distance</span> <span class="o">=</span> <span class="n">pdp</span><span class="o">.</span><span class="n">pdp_isolate</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">forest</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">x_validate</span><span class="p">,</span>
                               <span class="n">model_features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="n">FEATURE</span><span class="p">)</span>
<span class="n">pdp</span><span class="o">.</span><span class="n">pdp_plot</span><span class="p">(</span><span class="n">pdp_distance</span><span class="p">,</span> <span class="n">FEATURE</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"pdp_forest_distance.png"</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{output}]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="pdp_forest_distance.png" src="/posts/tutorials/partial-dependence-plots/pdp_forest_distance.png"></p>
</div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">pdp_distance</span><span class="o">.</span><span class="n">feature_grids</span><span class="p">[</span><span class="n">pdp_distance</span><span class="o">.</span><span class="n">pdp</span><span class="o">.</span><span class="n">argmax</span><span class="p">()])</span>
</pre></div>
<pre class="example">
102.0
</pre>
<p>Our forest says that, once again, covering 102 kilometers maximizes the probability, but in this case it appears that going beyond that actually decreases the probability that your team would have the man of the match.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org8a39d7b">
<h3 id="org8a39d7b">2D Partial Dependence Plots</h3>
<div class="outline-text-3" id="text-org8a39d7b">
<p>Rather than plot a single feature against the probability of becoming the man of the match you can plot how two features interact to affect the probability.</p>
<div class="highlight">
<pre><span></span><span class="n">FEATURES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Goal Scored"</span><span class="p">,</span> <span class="s2">"Distance Covered (Kms)"</span><span class="p">]</span>
<span class="n">interaction</span> <span class="o">=</span> <span class="n">pdp</span><span class="o">.</span><span class="n">pdp_interact</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">tree_model</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">x_validate</span><span class="p">,</span>
                               <span class="n">model_features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
                               <span class="n">features</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">)</span>

<span class="n">pdp</span><span class="o">.</span><span class="n">pdp_interact_plot</span><span class="p">(</span><span class="n">pdp_interact_out</span><span class="o">=</span><span class="n">interaction</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                      <span class="n">plot_type</span><span class="o">=</span><span class="s2">"contour"</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"goals_vs_distance.png"</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{output}]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="goals_vs_distance.png" src="/posts/tutorials/partial-dependence-plots/goals_vs_distance.png"></p>
</div>
<p><b>Note:</b> The version of PDPBox on pypi currently has a bug (as of February 8, 2020) that won't let you create the previous plot, install it from github instead.</p>
<p>The plot shows a more succinct version of the two plots we had seen before - the optimal point for these two features is 1 goal and 102 Kms covered.</p>
</div>
<div class="outline-4" id="outline-container-orgcfa06ee">
<h4 id="orgcfa06ee">Forest From the Trees</h4>
<div class="outline-text-4" id="text-orgcfa06ee">
<p>Let's re-run the same plot using the Random Forest instead of the Decision Tree.</p>
<div class="highlight">
<pre><span></span><span class="n">FEATURES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Goal Scored"</span><span class="p">,</span> <span class="s2">"Distance Covered (Kms)"</span><span class="p">]</span>
<span class="n">interaction</span> <span class="o">=</span> <span class="n">pdp</span><span class="o">.</span><span class="n">pdp_interact</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">forest</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">x_validate</span><span class="p">,</span>
                               <span class="n">model_features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
                               <span class="n">features</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">)</span>

<span class="n">pdp</span><span class="o">.</span><span class="n">pdp_interact_plot</span><span class="p">(</span><span class="n">pdp_interact_out</span><span class="o">=</span><span class="n">interaction</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                      <span class="n">plot_type</span><span class="o">=</span><span class="s2">"contour"</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"forest_goals_vs_distance.png"</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{output}]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="forest_goals_vs_distance.png" src="/posts/tutorials/partial-dependence-plots/forest_goals_vs_distance.png"></p>
</div>
<p>The random forest suggests a slightly different scenario - here you want 2 gooalds and between 100 and 110 Kms (or thereabouts) covered to get the best probability.</p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org576e2ae">
<h2 id="org576e2ae">End</h2>
<div class="outline-text-2" id="text-org576e2ae">
<p>This showed how to use the PDPBox library to create Partial Dependence Plots to look at how input values for features affects the predicted outcomes. Unfortunately it looks like PDPBox might have been abandoned, but while it works it's a nice library.</p>
</div>
</div>
</div>
</article>
</div>
<ul class="pager postindexpager clearfix">
<li class="previous"><a href="/" rel="prev">Newer posts</a></li>
<li class="next"><a href="/index-5.html" rel="next">Older posts</a></li>
</ul>
<!--End of body content-->
<footer id="footer">Contents Â© 2020 <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="/assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
</script> 
</body>
</html>
