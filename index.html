<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Adumbrations of data." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Visions, Voices, Data</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="rss.xml" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Visions-Voices-Data/" rel="canonical">
<link href="index-5.html" rel="next" type="text/html"><!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript"></script><!--
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.min.js"
</script>
-->
<script async src="javascript/p5.min.js" type="text/javascript"></script>
<link href="/posts/tutorials/advanced-uses-of-shap-exercise/" rel="prefetch" type="text/html">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="https://necromuralist.github.io/Visions-Voices-Data/"><span id="blog-title">Visions, Voices, Data</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="/archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="/categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="/rss.xml">RSS feed</a></li>
<li class="nav-item dropdown"><a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Pages</a>
<div class="dropdown-menu"><a class="dropdown-item active" href="/">Cloistered Monkey <span class="sr-only">(active)</span></a> <a class="dropdown-item" href="/pages/giss/giss-yearly-anomalies-by-climate-zone">GISS Anomalies</a></div>
</li>
</ul>
<!-- DuckDuckGo custom search -->
<form action="https://duckduckgo.com/" class="navbar-form pull-left" id="search" method="get" name="search"><input name="sites" type="hidden" value="https://necromuralist.github.io/Visions-Voices-Data/"> <input name="k8" type="hidden" value="#444444"> <input name="k9" type="hidden" value="#D51920"> <input name="kt" type="hidden" value="h"> <input class="span2" maxlength="255" name="q" placeholder="Search…" type="text"> <input style="visibility: hidden;display:none" type="submit" value="DuckDuckGo Search"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<div class="postindex">
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/tutorials/advanced-uses-of-shap-exercise/">Advanced Uses Of SHAP Exercise</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/advanced-uses-of-shap-exercise/" rel="bookmark"><time class="published dt-published" datetime="2020-02-14T20:03:29-08:00" itemprop="datePublished" title="2020-02-14 20:03">2020-02-14 20:03</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#orgdc3c9b8">Beginning</a>
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#org9e83025">Imports</a>
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#orga589cce">Python</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#org437020e">PyPi</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#org8fcfc85">Others</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#orgd8ea0c0">Set Up</a>
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#org868e469">Plotting</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#org79ce9ef">The Timer</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#org561bed3">The Environment</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#orgee3d425">The Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#orgc09f422">Middle</a>
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#orgbb9b8bc">Build the Model</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#org7bd49a3">Shap Values</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#org084c5da">Summary Plot</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#orge57fb88">Question 1</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#org829bd06">Question 2</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#org02183bd">Question 3</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#org51c0829">Question 4</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#orgf2f1892">Question 5</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#org95d8519">Question 6</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/advanced-uses-of-shap-exercise/#org2b97967">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgdc3c9b8">
<h2 id="orgdc3c9b8">Beginning</h2>
<div class="outline-text-2" id="text-orgdc3c9b8">
<p>This is my notes on the Advanced Uses of SHAP Exercise that's part of the <a href="https://www.kaggle.com/learn/machine-learning-explainability">Machine Learning Explainability</a> tutorial on kaggle.</p>
</div>
<div class="outline-3" id="outline-container-org9e83025">
<h3 id="org9e83025">Imports</h3>
<div class="outline-text-3" id="text-org9e83025"></div>
<div class="outline-4" id="outline-container-orga589cce">
<h4 id="orga589cce">Python</h4>
<div class="outline-text-4" id="text-orga589cce">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org437020e">
<h4 id="org437020e">PyPi</h4>
<div class="outline-text-4" id="text-org437020e">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">RandomizedSearchCV</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">seaborn</span>
<span class="kn">import</span> <span class="nn">shap</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org8fcfc85">
<h4 id="org8fcfc85">Others</h4>
<div class="outline-text-4" id="text-org8fcfc85">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EnvironmentLoader</span><span class="p">,</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd8ea0c0">
<h3 id="orgd8ea0c0">Set Up</h3>
<div class="outline-text-3" id="text-orgd8ea0c0"></div>
<div class="outline-4" id="outline-container-org868e469">
<h4 id="org868e469">Plotting</h4>
<div class="outline-text-4" id="text-org868e469">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"advanced-uses-of-shap-exercise"</span>
<span class="n">OUTPUT_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"../../files/posts/tutorials"</span><span class="p">)</span><span class="o">/</span><span class="n">SLUG</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>

<span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'matplotlib'</span><span class="p">,</span> <span class="s1">'inline'</span><span class="p">)</span>
<span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'config'</span><span class="p">,</span> <span class="s2">"InlineBackend.figure_format = 'retina'"</span><span class="p">)</span>
<span class="n">FIGURE_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">"whitegrid"</span><span class="p">,</span>
            <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">"axes.grid"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">"font.family"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"sans-serif"</span><span class="p">],</span>
                <span class="s2">"font.sans-serif"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Open Sans"</span><span class="p">,</span> <span class="s2">"Latin Modern Sans"</span><span class="p">,</span> <span class="s2">"Lato"</span><span class="p">],</span>
                <span class="s2">"font.size"</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
                <span class="s2">"figure.figsize"</span><span class="p">:</span> <span class="n">FIGURE_SIZE</span><span class="p">},</span>
            <span class="n">font_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org79ce9ef">
<h4 id="org79ce9ef">The Timer</h4>
<div class="outline-text-4" id="text-org79ce9ef">
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org561bed3">
<h4 id="org561bed3">The Environment</h4>
<div class="outline-text-4" id="text-org561bed3">
<div class="highlight">
<pre><span></span><span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="n">EnvironmentLoader</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgee3d425">
<h4 id="orgee3d425">The Data</h4>
<div class="outline-text-4" id="text-orgee3d425">
<p>Once again we're going to use the <a href="https://www.kaggle.com/dansbecker/hospital-readmissions">Medical Data and Hospital Readmissions</a> dataset from kaggle.</p>
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ENVIRONMENT</span><span class="p">[</span><span class="s2">"HOSPITAL-READMISSIONS"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>
<p>We are only going to use a subset of the features.</p>
<div class="highlight">
<pre><span></span><span class="n">FEATURES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'A1Cresult_None'</span><span class="p">,</span>
    <span class="s1">'diabetesMed_Yes'</span><span class="p">,</span>
    <span class="s1">'diag_1_414'</span><span class="p">,</span> 
    <span class="s1">'diag_1_428'</span><span class="p">,</span>
    <span class="s1">'gender_Female'</span><span class="p">,</span>
    <span class="s1">'medical_specialty_?'</span><span class="p">,</span>
    <span class="s1">'num_lab_procedures'</span><span class="p">,</span> 
    <span class="s1">'num_medications'</span><span class="p">,</span>
    <span class="s1">'num_procedures'</span><span class="p">,</span>
    <span class="s1">'number_diagnoses'</span><span class="p">,</span>
    <span class="s1">'number_emergency'</span><span class="p">,</span> 
    <span class="s1">'number_inpatient'</span><span class="p">,</span>
    <span class="s1">'number_outpatient'</span><span class="p">,</span>
    <span class="s1">'payer_code_?'</span><span class="p">,</span>
    <span class="s1">'time_in_hospital'</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
<p>Now we'll split up the features and the target. According to the notebook some versions of shap don't work when you combine numeric and boolean types so we'll convert all the features to floats.</p>
<div class="highlight">
<pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">FEATURES</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="n">Y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">readmitted</span>
</pre></div>
<p>Now the training and validation split.</p>
<div class="highlight">
<pre><span></span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_validation</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_validation</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgc09f422">
<h2 id="orgc09f422">Middle</h2>
<div class="outline-text-2" id="text-orgc09f422"></div>
<div class="outline-3" id="outline-container-orgbb9b8bc">
<h3 id="orgbb9b8bc">Build the Model</h3>
<div class="outline-text-3" id="text-orgbb9b8bc">
<p>For some reason the notebook switches from a classifier to a regressor, even though this seems to be a classification problem. Since I don't have an explanation for it I'll try it using a classifier instead.</p>
<div class="highlight">
<pre><span></span><span class="c1"># model = RandomForestRegressor()</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">()</span>
<span class="n">estimators</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">max_depth</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

<span class="n">grid</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">estimators</span><span class="p">,</span>
            <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">)</span>
<span class="n">search</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                            <span class="n">param_distributions</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
                            <span class="n">n_iter</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                            <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"CV Training Accuracy: </span><span class="si">{search.best_score_:0.2f}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Training Accuracy: {model.score(x_train, y_train): 0.2f}"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Validation Accuracy: {model.score(x_validation, y_validation):0.2f}"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
</pre></div>
<pre class="example">
CV Training Accuracy: 0.63
Training Accuracy:  0.70
Validation Accuracy: 0.63
{'n_estimators': 140, 'max_depth': 10}
</pre></div>
</div>
<div class="outline-3" id="outline-container-org7bd49a3">
<h3 id="org7bd49a3">Shap Values</h3>
<div class="outline-text-3" id="text-org7bd49a3">
<div class="highlight">
<pre><span></span><span class="n">READMITTED</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">x_validation</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org084c5da">
<h3 id="org084c5da">Summary Plot</h3>
<div class="outline-text-3" id="text-org084c5da">
<div class="highlight">
<pre><span></span><span class="n">shap</span><span class="o">.</span><span class="n">summary_plot</span><span class="p">(</span><span class="n">shap_values</span><span class="p">[</span><span class="n">READMITTED</span><span class="p">],</span> <span class="n">x_validation</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"shap_summary.png"</span>
<span class="c1">#figure.subplots_adjust(left=0.3)</span>
<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{output}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_summary.png" src="/posts/tutorials/advanced-uses-of-shap-exercise/shap_summary.png"></p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orge57fb88">
<h3 id="orge57fb88">Question 1</h3>
<div class="outline-text-3" id="text-orge57fb88">
<blockquote>
<p>Which of the following features has a bigger range of effects on predictions (i.e. larger difference between most positive and most negative effect)</p>
<ul class="org-ul">
<li><code>diag_1_428</code> or</li>
<li><code>payer_code_?</code></li>
</ul>
</blockquote>
<p><code>diag_1_428</code> appears to have a bigger spread than <code>payer_code</code>.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org829bd06">
<h3 id="org829bd06">Question 2</h3>
<div class="outline-text-3" id="text-org829bd06">
<blockquote>
<p>Do you believe the range of effects sizes (distance between smallest effect and largest effect) is a good indication of which feature will have a higher permutation importance? Why or why not?</p>
<p>If the <b>range of effect sizes</b> measures something different from <b>permutation importance</b>: which is a better answer for the question "Which of these two features does the model say is more important for us to understand when discussing readmission risks in the population?"</p>
<p>Run the following line after you've decided your answer.</p>
</blockquote>
<p>I don't think that the range of effect size is a good indication of which feature will have a higher permutation importance, because it just indicates the spread of the values, not their overall effect.</p>
<p>I think that <code>diag_1_428</code> is more important because it has a higher <i>Feature Value</i> than <code>payer_code_?</code>.</p>
<p><b>Note:</b> Although the question says "which of these two features does the model say is more important", the answer given is that permutation importance is a better measure of what's important to the model, since it's a robust measurement, while the range of effects is influenced by outliers.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org02183bd">
<h3 id="org02183bd">Question 3</h3>
<div class="outline-text-3" id="text-org02183bd">
<blockquote>
<p>Both <code>diag_1_428</code> and <code>payer_code_?</code> are binary variables, taking values of 0 or 1.</p>
<p>From the graph, which do you think would typically have a bigger impact on predicted readmission risk:</p>
<ul class="org-ul">
<li>Changing <code>diag_1_428</code> from 0 to 1</li>
<li>Changing <code>payer_code_?</code> from 0 to 1</li>
</ul>
</blockquote>
<p>I think that changing <code>diag_1_428</code> to 1 would have a bigger impact, since the dots are more heavily right skewed for it than is the case with <code>payer_code_?</code>.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org51c0829">
<h3 id="org51c0829">Question 4</h3>
<div class="outline-text-3" id="text-org51c0829">
<blockquote>
<p>Some features (like <code>number_inpatient</code>) have reasonably clear separation between the blue and pink dots. Other variables like <code>num_lab_procedures</code> have blue and pink dots jumbled together, even though the SHAP values (or impacts on prediction) aren't all 0.</p>
<p>What do you think you learn from the fact that <code>num_lab_procedures</code> has blue and pink dots jumbled together? Once you have your answer, run the line below to verify your solution.</p>
</blockquote>
<p>I think that this means that it is more difficult to make predictions based on the <code>num_lab_procedures</code> - there isn't a clear separation of outcomes based on the value of <code>num_lab_procedures</code>. The feature probably has interacting effects with other features.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgf2f1892">
<h3 id="orgf2f1892">Question 5</h3>
<div class="outline-text-3" id="text-orgf2f1892">
<blockquote>
<p>Consider the following SHAP contribution dependence plot.</p>
<p>The x-axis shows <code>feature_of_interest</code> and the points are colored based on <code>other_feature</code>.</p>
</blockquote>
<div class="figure">
<p><img alt="zFdHneM.png" src="https://i.imgur.com/zFdHneM.png"></p>
</div>
<blockquote>
<p>Is there an interaction between <code>feature_of_interest</code> and <code>other_feature</code>?</p>
<p>If so, does <code>feature_of_interest</code> have a more positive impact on predictions when <code>other_feature</code> is high or when <code>other_feature</code> is low?</p>
</blockquote>
<p>It looks like <code>feature_of_interest</code> has a more positive impart on predictions when the <code>other_feature</code> is high.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org95d8519">
<h3 id="org95d8519">Question 6</h3>
<div class="outline-text-3" id="text-org95d8519">
<blockquote>
<p>Both <b>num_medications</b> and <b>num_lab_procedures</b> share that jumbling of pink and blue dots.</p>
<p>Aside from <code>num_medications</code> having effects of greater magnitude (both more positive and more negative), it's hard to see a meaningful difference between how these two features affect readmission risk. Create the SHAP dependence contribution plots for each variable, and describe what you think is different between how these two variables affect predictions.</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZE</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"num_medications.png"</span>
<span class="n">shap</span><span class="o">.</span><span class="n">dependence_plot</span><span class="p">(</span><span class="s2">"num_medications"</span><span class="p">,</span> <span class="n">shap_values</span><span class="p">[</span><span class="n">READMITTED</span><span class="p">],</span> <span class="n">x_validation</span><span class="p">,</span>
                     <span class="n">ax</span><span class="o">=</span><span class="n">axe</span><span class="p">)</span>
<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{output}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="num_medications.png" src="/posts/tutorials/advanced-uses-of-shap-exercise/num_medications.png"></p>
</div>
<div class="highlight">
<pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZE</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"num_lab_procedures.png"</span>
<span class="n">shap</span><span class="o">.</span><span class="n">dependence_plot</span><span class="p">(</span><span class="s2">"num_lab_procedures"</span><span class="p">,</span> <span class="n">shap_values</span><span class="p">[</span><span class="n">READMITTED</span><span class="p">],</span> <span class="n">x_validation</span><span class="p">,</span>
                     <span class="n">interaction_index</span><span class="o">=</span><span class="s2">"num_medications"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axe</span><span class="p">)</span>
<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{output}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="num_lab_procedures.png" src="/posts/tutorials/advanced-uses-of-shap-exercise/num_lab_procedures.png"></p>
</div>
<p>The <code>num_medications</code> value appears to peak at 20 and then after that the SHAP value starts to go down as <code>num_medications</code> goes up, while <code>num_lab_procedures</code> makes a more gradual climb but appears to not have this inverted-curve shape.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org2b97967">
<h2 id="org2b97967">End</h2>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/tutorials/advanced-uses-of-shap/">Advanced Uses Of SHAP</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/advanced-uses-of-shap/" rel="bookmark"><time class="published dt-published" datetime="2020-02-14T16:09:16-08:00" itemprop="datePublished" title="2020-02-14 16:09">2020-02-14 16:09</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#orgd13e527">Beginning</a>
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org9f60c90">Imports</a>
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#orgd2c9c17">Python</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org903eb6b">PyPi</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org890ab4c">Others</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org7d04a9a">Set Up</a>
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org4445d13">Plotting</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#orgcad1fb1">The Environment</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org7a5f0ef">The Dataset</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#orgeea29c5">Middle</a>
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#orgd0c61a7">Setup the SHAP Values</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org8983047">Summary Plots</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#orge519499">SHAP Dependence Contribution Plots</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#orgc3b182e">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgd13e527">
<h2 id="orgd13e527">Beginning</h2>
<div class="outline-text-2" id="text-orgd13e527">
<p>This is a re-do of the Kaggle tutorial on <a href="https://www.kaggle.com/dansbecker/advanced-uses-of-shap-values">Advanced Uses of SHAP Values</a>. SHAP values let us see how much a given feature changed our prediction for a given row of data, but it can also be used to look at groups of features to get a bigger picture look at our model.</p>
</div>
<div class="outline-3" id="outline-container-org9f60c90">
<h3 id="org9f60c90">Imports</h3>
<div class="outline-text-3" id="text-org9f60c90"></div>
<div class="outline-4" id="outline-container-orgd2c9c17">
<h4 id="orgd2c9c17">Python</h4>
<div class="outline-text-4" id="text-orgd2c9c17">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org903eb6b">
<h4 id="org903eb6b">PyPi</h4>
<div class="outline-text-4" id="text-org903eb6b">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">seaborn</span>
<span class="kn">import</span> <span class="nn">shap</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org890ab4c">
<h4 id="org890ab4c">Others</h4>
<div class="outline-text-4" id="text-org890ab4c">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EnvironmentLoader</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org7d04a9a">
<h3 id="org7d04a9a">Set Up</h3>
<div class="outline-text-3" id="text-org7d04a9a"></div>
<div class="outline-4" id="outline-container-org4445d13">
<h4 id="org4445d13">Plotting</h4>
<div class="outline-text-4" id="text-org4445d13">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"advanced-uses-of-shap"</span>
<span class="n">OUTPUT_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"../../files/posts/tutorials"</span><span class="p">)</span><span class="o">/</span><span class="n">SLUG</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>

<span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'matplotlib'</span><span class="p">,</span> <span class="s1">'inline'</span><span class="p">)</span>
<span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'config'</span><span class="p">,</span> <span class="s2">"InlineBackend.figure_format = 'retina'"</span><span class="p">)</span>
<span class="n">FIGURE_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">"whitegrid"</span><span class="p">,</span>
            <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">"axes.grid"</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">"font.family"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"sans-serif"</span><span class="p">],</span>
                <span class="s2">"font.sans-serif"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Open Sans"</span><span class="p">,</span> <span class="s2">"Latin Modern Sans"</span><span class="p">,</span> <span class="s2">"Lato"</span><span class="p">],</span>
                <span class="s2">"font.size"</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
                <span class="s2">"figure.figsize"</span><span class="p">:</span> <span class="n">FIGURE_SIZE</span><span class="p">},</span>
            <span class="n">font_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgcad1fb1">
<h4 id="orgcad1fb1">The Environment</h4>
<div class="outline-text-4" id="text-orgcad1fb1">
<div class="highlight">
<pre><span></span><span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="n">EnvironmentLoader</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org7a5f0ef">
<h4 id="org7a5f0ef">The Dataset</h4>
<div class="outline-text-4" id="text-org7a5f0ef">
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ENVIRONMENT</span><span class="p">[</span><span class="s2">"FIFA-2018"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">"Man of the Match"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Yes"</span>

<span class="n">FEATURES</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">]</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">FEATURES</span><span class="p">]</span>
<span class="n">x_train</span><span class="p">,</span> <span class="n">x_validation</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_validation</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgeea29c5">
<h2 id="orgeea29c5">Middle</h2>
<div class="outline-text-2" id="text-orgeea29c5"></div>
<div class="outline-3" id="outline-container-orgd0c61a7">
<h3 id="orgd0c61a7">Setup the SHAP Values</h3>
<div class="outline-text-3" id="text-orgd0c61a7">
<div class="highlight">
<pre><span></span><span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">x_validation</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org8983047">
<h3 id="org8983047">Summary Plots</h3>
<div class="outline-text-3" id="text-org8983047">
<p>Like Permutation Importance, SHAP Summary Plots show you the relative importance of different features for your model, but unlike Permutation Importance, Summary Plots can show you how much more each feature influences the predictions.</p>
<div class="highlight">
<pre><span></span><span class="n">MAN_OF_THE_MATCH</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">shap</span><span class="o">.</span><span class="n">summary_plot</span><span class="p">(</span><span class="n">shap_values</span><span class="p">[</span><span class="n">MAN_OF_THE_MATCH</span><span class="p">],</span> <span class="n">x_validation</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
<span class="c1"># figure.set_size_inches(FIGURE_SIZE)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"shap_summary.png"</span>
<span class="n">figure</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{output}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_summary.png" src="/posts/tutorials/advanced-uses-of-shap/shap_summary.png"></p>
</div>
<p>As with permutation importance, Goal Scored was the most important feature, with a greater impact on not being the man of the match than being the man of the match. This looks sort of like a combination of Permutation importance and Partial Dependence Plots (PDP) except all in one place.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orge519499">
<h3 id="orge519499">SHAP Dependence Contribution Plots</h3>
<div class="outline-text-3" id="text-orge519499">
<p>Dependence Contribution Plots work much like PDP plots except with more detail. Rather than showing you the means the Dependence Contribution Plot shows you the individual rows so you can get a sense of the shape of the outcomes.</p>
<div class="highlight">
<pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZE</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"ball_possession_dcp.png"</span>
<span class="n">shap</span><span class="o">.</span><span class="n">dependence_plot</span><span class="p">(</span><span class="s2">"Ball Possession %"</span><span class="p">,</span> <span class="n">shap_values</span><span class="p">[</span><span class="n">MAN_OF_THE_MATCH</span><span class="p">],</span> <span class="n">x_validation</span><span class="p">,</span>
                     <span class="n">interaction_index</span><span class="o">=</span><span class="s2">"Goal Scored"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axe</span><span class="p">)</span>
<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{output}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="ball_possession_dcp.png" src="/posts/tutorials/advanced-uses-of-shap/ball_possession_dcp.png"></p>
</div>
<p>Interestingly, our plot doesn't look like the one in the tutorial, we appear to have much fewer points and less spread in the values. But, anyway, the way to interpret this is as you move from left to right you are increasing the percentage of the time that a team had the ball, and as you move up, you are increasing the likelihood that the team had a man of the match. Additionally, the colors tell you how many goals the team scored.</p>
<p>Looking closer, it looks like the tutorial went with the entire dataset rather than just the validation set, probably because there are so few data points. While that does reveal a more interesting pattern, I'm not sure that that's what you would do, normally.</p>
<p>Anyway, this plot shows that having a very low ball possession percentage decreases the likelihood that you would have the man of the match and generally speaking as it goes up, so does the likelihood of having man of the match, although it seems to level off around 45%.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgc3b182e">
<h2 id="orgc3b182e">End</h2>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/tutorials/shap-values-exercise/">SHAP Values Exercise</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/shap-values-exercise/" rel="bookmark"><time class="published dt-published" datetime="2020-02-11T07:06:57-08:00" itemprop="datePublished" title="2020-02-11 07:06">2020-02-11 07:06</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#org1b3e8d2">Beginning</a>
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#org94dbf4e">The Scenario</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#orgc39f53a">Imports</a>
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#org1d5082d">Python</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org2a818db">PyPi</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#orgd42f25e">Others</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values-exercise/#org593c60d">Set Up</a>
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#orgbb4231f">Plotting</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org816ccfc">The Table Printer</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#orga4c7787">The Timer</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org562e01a">The Environment</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#orgd29ae47">The Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values-exercise/#org1b26e3e">Middle</a>
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#org35cb59d">Looking At the Data</a>
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#org41d77ba">Set Up X and Y</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org95ce5e0">Split the Data</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values-exercise/#orgb922b1a">A Simple Model</a>
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#org357d174">Train the Model</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org38ec7a7">Permutation Importance</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#orgc3e8edd">Partial Dependence Plot</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org584934e">SHAP Values</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#orgf567bab">Time In Hospital</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org0bce611">Raw Readmissions</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values-exercise/#orga510ac2">SHAP Creator</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values-exercise/#org4e6ba93">End</a>
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#org9d12e7b">Sources</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org1b3e8d2">
<h2 id="org1b3e8d2">Beginning</h2>
<div class="outline-text-2" id="text-org1b3e8d2">
<p>This is the SHAP Exercise from the kaggle <a href="https://www.kaggle.com/learn/machine-learning-explainability">Machine Learing Explainability Tutorial</a>. It's using the kaggle <a href="https://www.kaggle.com/dansbecker/hospital-readmissions">Hospital Readmissions</a> dataset (I think).</p>
</div>
<div class="outline-3" id="outline-container-org94dbf4e">
<h3 id="org94dbf4e">The Scenario</h3>
<div class="outline-text-3" id="text-org94dbf4e">
<blockquote>
<p>A hospital has struggled with "readmissions," where they release a patient before the patient has recovered enough, and the patient returns with health complications.</p>
<p>The hospital wants your help identifying patients at highest risk of being readmitted. Doctors (rather than your model) will make the final decision about when to release each patient; but they hope your model will highlight issues the doctors should consider when releasing a patient.</p>
<p>The hospital has given you relevant patient medical information.</p>
</blockquote>
</div>
</div>
<div class="outline-3" id="outline-container-orgc39f53a">
<h3 id="orgc39f53a">Imports</h3>
<div class="outline-text-3" id="text-orgc39f53a"></div>
<div class="outline-4" id="outline-container-org1d5082d">
<h4 id="org1d5082d">Python</h4>
<div class="outline-text-4" id="text-org1d5082d">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">random</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org2a818db">
<h4 id="org2a818db">PyPi</h4>
<div class="outline-text-4" id="text-org2a818db">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">eli5.sklearn</span> <span class="kn">import</span> <span class="n">PermutationImportance</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>
<span class="kn">from</span> <span class="nn">pdpbox</span> <span class="kn">import</span> <span class="n">pdp</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">RandomizedSearchCV</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">import</span> <span class="nn">eli5</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">shap</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgd42f25e">
<h4 id="orgd42f25e">Others</h4>
<div class="outline-text-4" id="text-orgd42f25e">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">EnvironmentLoader</span><span class="p">,</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org593c60d">
<h3 id="org593c60d">Set Up</h3>
<div class="outline-text-3" id="text-org593c60d"></div>
<div class="outline-4" id="outline-container-orgbb4231f">
<h4 id="orgbb4231f">Plotting</h4>
<div class="outline-text-4" id="text-orgbb4231f">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"shap-values-exercise"</span>
<span class="n">OUTPUT_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"../../files/posts/tutorials/"</span><span class="p">)</span><span class="o">/</span><span class="n">SLUG</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>

<span class="n">Plot</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="n">OUTPUT_PATH</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org816ccfc">
<h4 id="org816ccfc">The Table Printer</h4>
<div class="outline-text-4" id="text-org816ccfc">
<div class="highlight">
<pre><span></span><span class="n">TABLE</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">tabulate</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">,</span> <span class="n">showindex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orga4c7787">
<h4 id="orga4c7787">The Timer</h4>
<div class="outline-text-4" id="text-orga4c7787">
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org562e01a">
<h4 id="org562e01a">The Environment</h4>
<div class="outline-text-4" id="text-org562e01a">
<div class="highlight">
<pre><span></span><span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="n">EnvironmentLoader</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgd29ae47">
<h4 id="orgd29ae47">The Data</h4>
<div class="outline-text-4" id="text-orgd29ae47">
<div class="highlight">
<pre><span></span><span class="n">PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ENVIRONMENT</span><span class="p">[</span><span class="s2">"HOSPITAL-READMISSIONS"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">PATH</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">PATH</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org1b26e3e">
<h2 id="org1b26e3e">Middle</h2>
<div class="outline-text-2" id="text-org1b26e3e"></div>
<div class="outline-3" id="outline-container-org35cb59d">
<h3 id="org35cb59d">Looking At the Data</h3>
<div class="outline-text-3" id="text-org35cb59d">
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" - </span><span class="si">{column}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<ul class="org-ul">
<li>A1Cresult_None</li>
<li>acarbose_No</li>
<li>acetohexamide_No</li>
<li>age_[40-50)</li>
<li>age_[50-60)</li>
<li>age_[60-70)</li>
<li>age_[70-80)</li>
<li>age_[80-90)</li>
<li>change_No</li>
<li>chlorpropamide_No</li>
<li>citoglipton_No</li>
<li>diabetesMed_Yes</li>
<li>diag_1_414</li>
<li>diag_1_428</li>
<li>diag_1_786</li>
<li>diag_2_250</li>
<li>diag_2_276</li>
<li>diag_2_427</li>
<li>diag_2_428</li>
<li>diag_3_250</li>
<li>diag_3_276</li>
<li>diag_3_401</li>
<li>diag_3_428</li>
<li>examide_No</li>
<li>gender_Female</li>
<li>glimepiride-pioglitazone_No</li>
<li>glimepiride_No</li>
<li>glipizide-metformin_No</li>
<li>glipizide_No</li>
<li>glyburide-metformin_No</li>
<li>glyburide_No</li>
<li>insulin_No</li>
<li>max_glu_serum_None</li>
<li>medical_specialty_?</li>
<li>medical_specialty_Cardiology</li>
<li>medical_specialty_Emergency/Trauma</li>
<li>medical_specialty_Family/GeneralPractice</li>
<li>medical_specialty_InternalMedicine</li>
<li>metformin-pioglitazone_No</li>
<li>metformin-rosiglitazone_No</li>
<li>metformin_No</li>
<li>miglitol_No</li>
<li>nateglinide_No</li>
<li>num_lab_procedures</li>
<li>num_medications</li>
<li>num_procedures</li>
<li>number_diagnoses</li>
<li>number_emergency</li>
<li>number_inpatient</li>
<li>number_outpatient</li>
<li>payer_code_?</li>
<li>payer_code_BC</li>
<li>payer_code_HM</li>
<li>payer_code_MC</li>
<li>payer_code_SP</li>
<li>pioglitazone_No</li>
<li>race_AfricanAmerican</li>
<li>race_Caucasian</li>
<li>readmitted</li>
<li>repaglinide_No</li>
<li>rosiglitazone_No</li>
<li>time_in_hospital</li>
<li>tolazamide_No</li>
<li>tolbutamide_No</li>
<li>troglitazone_No</li>
</ul>
<p>So there are a lot of columns.</p>
<blockquote>
<p>Here are some quick hints at interpreting the field names:</p>
<ul class="org-ul">
<li>Your prediction target is <code>readmitted</code></li>
<li>Columns with the word <code>diag</code> indicate the diagnostic code of the illness or illnesses the patient was admitted with. For example, <code>diag_1_428</code> means the doctor said their first illness diagnosis is number "428". What illness does 428 correspond to? You could look it up in a codebook, but without more medical background it wouldn't mean anything to you anyway.</li>
<li>A column names like <code>glimepiride_No</code> mean the patient did not have the medicine <code>glimepiride</code>. If this feature had a value of False, then the patient did take the drug <code>glimepiride</code></li>
<li>Features whose names begin with <code>medical_specialty</code> describe the specialty of the doctor seeing the patient. The values in these fields are all <code>True</code> or <code>False</code>.</li>
</ul>
</blockquote>
</div>
<div class="outline-4" id="outline-container-org41d77ba">
<h4 id="org41d77ba">Set Up X and Y</h4>
<div class="outline-text-4" id="text-org41d77ba">
<div class="highlight">
<pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">readmitted</span>
<span class="n">TARGET</span> <span class="o">=</span> <span class="s2">"readmitted"</span>
<span class="n">FEATURES</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="n">TARGET</span><span class="p">]</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">FEATURES</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org95ce5e0">
<h4 id="org95ce5e0">Split the Data</h4>
<div class="outline-text-4" id="text-org95ce5e0">
<div class="highlight">
<pre><span></span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_validate</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_validate</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
                                                            <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgb922b1a">
<h3 id="orgb922b1a">A Simple Model</h3>
<div class="outline-text-3" id="text-orgb922b1a">
<blockquote>
<p>You have built a simple model, but the doctors say they don't know how to evaluate a model, and they'd like you to show them some evidence the model is doing something in line with their medical intuition. Create any graphics or tables that will show them a quick overview of what the model is doing?</p>
<p>They are very busy. So they want you to condense your model overview into just 1 or 2 graphics, rather than a long string of graphics.</p>
</blockquote>
</div>
<div class="outline-4" id="outline-container-org357d174">
<h4 id="org357d174">Train the Model</h4>
<div class="outline-text-4" id="text-org357d174">
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">model_1</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Training R^2: {model_1.score(x_train, y_train): 0.2f}"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Validation R^2: {model_1.score(x_validate, y_validate):0.2f}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
2020-02-14 14:02:08,392 graeae.timers.timer start: Started: 2020-02-14 14:02:08.391737
2020-02-14 14:02:09,011 graeae.timers.timer end: Ended: 2020-02-14 14:02:09.011136
2020-02-14 14:02:09,011 graeae.timers.timer end: Elapsed: 0:00:00.619399
Training R^2:  1.00
Validation R^2: 0.60
</pre>
<div class="highlight">
<pre><span></span><span class="n">model_2</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">()</span>

<span class="n">estimators</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">max_depth</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

<span class="n">grid</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">estimators</span><span class="p">,</span>
            <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">)</span>
<span class="n">search</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">model_2</span><span class="p">,</span>
                            <span class="n">param_distributions</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
                            <span class="n">n_iter</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                            <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">first_model</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"CV Training R^2: </span><span class="si">{search.best_score_:0.2f}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Training R^2: {first_model.score(x_train, y_train): 0.2f}"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Validation R^2: {first_model.score(x_validate, y_validate):0.2f}"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
</pre></div>
<pre class="example">
2020-02-14 14:02:10,418 graeae.timers.timer start: Started: 2020-02-14 14:02:10.418784
2020-02-14 14:04:09,802 graeae.timers.timer end: Ended: 2020-02-14 14:04:09.802077
2020-02-14 14:04:09,802 graeae.timers.timer end: Elapsed: 0:01:59.383293
CV Training R^2: 0.63
Training R^2:  0.70
Validation R^2: 0.63
{'n_estimators': 90, 'max_depth': 10}
</pre>
<p>We get a slight improvement with a much more complex model, but not a lot. Our validation \(r^2\) is nearly as good as the training \(r^2\) so it looks like we aren't overfitting.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org38ec7a7">
<h4 id="org38ec7a7">Permutation Importance</h4>
<div class="outline-text-4" id="text-org38ec7a7">
<div class="highlight">
<pre><span></span><span class="n">permutor</span> <span class="o">=</span> <span class="n">PermutationImportance</span><span class="p">(</span><span class="n">first_model</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">x_validate</span><span class="p">,</span> <span class="n">y_validate</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">ipython_html</span> <span class="o">=</span> <span class="n">eli5</span><span class="o">.</span><span class="n">show_weights</span><span class="p">(</span><span class="n">permutor</span><span class="p">,</span>
                                 <span class="n">feature_names</span><span class="o">=</span><span class="n">x_validate</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="n">ipython_html</span><span class="o">.</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">table</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Weight</th>
<th class="org-left" scope="col">Feature</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">0.0640 ± 0.0071</td>
<td class="org-left">number_inpatient</td>
</tr>
<tr>
<td class="org-left">0.0108 ± 0.0046</td>
<td class="org-left">number_emergency</td>
</tr>
<tr>
<td class="org-left">0.0084 ± 0.0058</td>
<td class="org-left">number_outpatient</td>
</tr>
<tr>
<td class="org-left">0.0025 ± 0.0034</td>
<td class="org-left">number_diagnoses</td>
</tr>
<tr>
<td class="org-left">0.0021 ± 0.0010</td>
<td class="org-left">diabetesMed_Yes</td>
</tr>
<tr>
<td class="org-left">0.0020 ± 0.0017</td>
<td class="org-left">payer_code_?</td>
</tr>
<tr>
<td class="org-left">0.0019 ± 0.0015</td>
<td class="org-left">race_AfricanAmerican</td>
</tr>
<tr>
<td class="org-left">0.0015 ± 0.0015</td>
<td class="org-left">num_lab_procedures</td>
</tr>
<tr>
<td class="org-left">0.0013 ± 0.0008</td>
<td class="org-left">age_[80-90)</td>
</tr>
<tr>
<td class="org-left">0.0011 ± 0.0030</td>
<td class="org-left">diag_1_428</td>
</tr>
<tr>
<td class="org-left">0.0011 ± 0.0023</td>
<td class="org-left">medical_specialty_?</td>
</tr>
<tr>
<td class="org-left">0.0010 ± 0.0012</td>
<td class="org-left">payer_code_HM</td>
</tr>
<tr>
<td class="org-left">0.0008 ± 0.0043</td>
<td class="org-left">num_procedures</td>
</tr>
<tr>
<td class="org-left">0.0008 ± 0.0012</td>
<td class="org-left">payer_code_BC</td>
</tr>
<tr>
<td class="org-left">0.0008 ± 0.0008</td>
<td class="org-left">age_[40-50)</td>
</tr>
<tr>
<td class="org-left">0.0008 ± 0.0010</td>
<td class="org-left">max_glu_serum_None</td>
</tr>
<tr>
<td class="org-left">0.0008 ± 0.0015</td>
<td class="org-left">race_Caucasian</td>
</tr>
<tr>
<td class="org-left">0.0005 ± 0.0032</td>
<td class="org-left">num_medications</td>
</tr>
<tr>
<td class="org-left">0.0005 ± 0.0022</td>
<td class="org-left">diag_2_250</td>
</tr>
<tr>
<td class="org-left">0.0004 ± 0.0006</td>
<td class="org-left">rosiglitazone_No</td>
</tr>
<tr>
<td class="org-left">… 44 more …</td>
<td class="org-left">… 44 more …</td>
</tr>
</tbody>
</table>
<p>The most important features weren't in the data description. What is <code>number_inpatient</code>?</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgc3e8edd">
<h4 id="orgc3e8edd">Partial Dependence Plot</h4>
<div class="outline-text-4" id="text-orgc3e8edd">
<p>Since the most important feature is the "number_inpatient" let's see how much it changes the re-admissions.</p>
<div class="highlight">
<pre><span></span><span class="n">FEATURE</span> <span class="o">=</span> <span class="s2">"number_inpatient"</span>
<span class="n">pdp_dist</span> <span class="o">=</span> <span class="n">pdp</span><span class="o">.</span><span class="n">pdp_isolate</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">first_model</span><span class="p">,</span>
                           <span class="n">dataset</span><span class="o">=</span><span class="n">x_validate</span><span class="p">,</span>
                           <span class="n">model_features</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                           <span class="n">feature</span><span class="o">=</span><span class="n">FEATURE</span><span class="p">)</span>
<span class="n">pdp</span><span class="o">.</span><span class="n">pdp_plot</span><span class="p">(</span><span class="n">pdp_dist</span><span class="p">,</span> <span class="n">FEATURE</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{FEATURE}</span><span class="s2">_pdp_plot.png"</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
<span class="n">figure</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{output}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="number_inpatient_pdp_plot.png" src="/posts/tutorials/shap-values-exercise/number_inpatient_pdp_plot.png"></p>
</div>
</div>
</div>
<div class="outline-4" id="outline-container-org584934e">
<h4 id="org584934e">SHAP Values</h4>
<div class="outline-text-4" id="text-org584934e">
<div class="highlight">
<pre><span></span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ROW</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_validate</span><span class="p">))</span>
<span class="n">row_data</span> <span class="o">=</span> <span class="n">x_validate</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ROW</span><span class="p">]</span>
<span class="n">row_data_matrix</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">))</span>
</pre></div>
<pre class="example">
[0 1]
[[0.49342394 0.50657606]]
</pre>
<div class="highlight">
<pre><span></span>explainer = shap.TreeExplainer(first_model)
shap_values = explainer.shap_values(row_data_matrix)
</pre></div>
<div class="highlight">
<pre><span></span>READMIT = 1
figure = shap.force_plot(explainer.expected_value[READMIT],
                         shap_values[READMIT],
                         row_data_matrix,
                         feature_names=FEATURES,
                         matplotlib=True, show=False)
filename = "shap_zero.png"

figure.savefig(OUTPUT_PATH/filename)
print(f"[[file:{filename}]]")
</pre></div>
<div class="figure">
<p><img alt="shap_zero.png" src="/posts/tutorials/shap-values-exercise/shap_zero.png"></p>
</div>
</div>
<ul class="org-ul">
<li><a id="orgeaef7e1"></a>Try one where num_inpatients was 1<br>
<div class="outline-text-5" id="text-orgeaef7e1">
<div class="highlight">
<pre><span></span><span class="n">row_data</span> <span class="o">=</span> <span class="n">x_validate</span><span class="p">[</span><span class="n">x_validate</span><span class="o">.</span><span class="n">number_inpatient</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">row_data_matrix</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">))</span>
</pre></div>
<pre class="example">
[0 1]
[[0.36731038 0.63268962]]
</pre>
<div class="highlight">
<pre><span></span><span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">first_model</span><span class="p">)</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">force_plot</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">shap_values</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">row_data_matrix</span><span class="p">,</span>
                         <span class="n">feature_names</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                         <span class="n">matplotlib</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s2">"shap_one.png"</span>

<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">filename</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{filename}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_one.png" src="/posts/tutorials/shap-values-exercise/shap_one.png"></p>
</div>
</div>
</li>
<li><a id="org2c3a677"></a>Try one where num_inpatients was 2<br>
<div class="outline-text-5" id="text-org2c3a677">
<div class="highlight">
<pre><span></span><span class="n">INPATIENTS</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">row_data</span> <span class="o">=</span> <span class="n">x_validate</span><span class="p">[</span><span class="n">x_validate</span><span class="o">.</span><span class="n">number_inpatient</span><span class="o">==</span><span class="n">INPATIENTS</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">row_data_matrix</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">))</span>
</pre></div>
<pre class="example">
[0 1]
[[0.38485607 0.61514393]]
</pre>
<div class="highlight">
<pre><span></span><span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">first_model</span><span class="p">)</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">force_plot</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">shap_values</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">row_data_matrix</span><span class="p">,</span>
                         <span class="n">feature_names</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                         <span class="n">matplotlib</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s2">"shap_two.png"</span>

<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">filename</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{filename}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_two.png" src="/posts/tutorials/shap-values-exercise/shap_two.png"></p>
</div>
</div>
</li>
<li><a id="org68b3fe8"></a>Try one where num_inpatients was 3<br>
<div class="outline-text-5" id="text-org68b3fe8">
<div class="highlight">
<pre><span></span><span class="n">INPATIENTS</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">row_data</span> <span class="o">=</span> <span class="n">x_validate</span><span class="p">[</span><span class="n">x_validate</span><span class="o">.</span><span class="n">number_inpatient</span><span class="o">==</span><span class="n">INPATIENTS</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">row_data_matrix</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">))</span>
</pre></div>
<pre class="example">
[0 1]
[[0.47141351 0.52858649]]
</pre>
<div class="highlight">
<pre><span></span><span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">first_model</span><span class="p">)</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">force_plot</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">shap_values</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">row_data_matrix</span><span class="p">,</span>
                         <span class="n">feature_names</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                         <span class="n">matplotlib</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s2">"shap_three.png"</span>

<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">filename</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{filename}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_three.png" src="/posts/tutorials/shap-values-exercise/shap_three.png"></p>
</div>
</div>
</li>
<li><a id="orgdcf41f3"></a>Try one where num_inpatients was the Maximum<br>
<div class="outline-text-5" id="text-orgdcf41f3">
<div class="highlight">
<pre><span></span><span class="n">INPATIENTS</span> <span class="o">=</span> <span class="n">x_validate</span><span class="o">.</span><span class="n">number_inpatient</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">row_data</span> <span class="o">=</span> <span class="n">x_validate</span><span class="p">[</span><span class="n">x_validate</span><span class="o">.</span><span class="n">number_inpatient</span><span class="o">==</span><span class="n">INPATIENTS</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">row_data_matrix</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">))</span>
</pre></div>
<pre class="example">
[0 1]
[[0.19208238 0.80791762]]
</pre>
<div class="highlight">
<pre><span></span><span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">first_model</span><span class="p">)</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">force_plot</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">shap_values</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">row_data_matrix</span><span class="p">,</span>
                         <span class="n">feature_names</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                         <span class="n">matplotlib</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s2">"shap_max.png"</span>

<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">filename</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{filename}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_max.png" src="/posts/tutorials/shap-values-exercise/shap_max.png"></p>
</div>
<p>So it seems to be that the greater <code>number_inpatient</code> the more it contributes to re-admission (although note that since we're only using one row the cases with small values doesn't always look like what I plotted above - it depends on the patient).</p>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-orgf567bab">
<h4 id="orgf567bab">Time In Hospital</h4>
<div class="outline-text-4" id="text-orgf567bab">
<blockquote>
<p>The doctors think it's a good sign that increasing the number of inpatient procedures leads to increased predictions. But they can't tell from this plot whether that change in the plot is big or small. They'd like you to create something similar for <code>time_in_hospital</code> to see how that compares.</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">FEATURE</span> <span class="o">=</span> <span class="s2">"time_in_hospital"</span>
<span class="n">pdp_dist</span> <span class="o">=</span> <span class="n">pdp</span><span class="o">.</span><span class="n">pdp_isolate</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">first_model</span><span class="p">,</span>
                           <span class="n">dataset</span><span class="o">=</span><span class="n">x_validate</span><span class="p">,</span>
                           <span class="n">model_features</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                           <span class="n">feature</span><span class="o">=</span><span class="n">FEATURE</span><span class="p">)</span>
<span class="n">pdp</span><span class="o">.</span><span class="n">pdp_plot</span><span class="p">(</span><span class="n">pdp_dist</span><span class="p">,</span> <span class="n">FEATURE</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{FEATURE}</span><span class="s2">_pdp_plot.png"</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{output}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="time_in_hospital_pdp_plot.png" src="/posts/tutorials/shap-values-exercise/time_in_hospital_pdp_plot.png"></p>
</div>
<div class="highlight">
<pre><span></span><span class="n">TIME_IN_HOSPITAL</span> <span class="o">=</span> <span class="mi">8</span>

<span class="n">row_data</span> <span class="o">=</span> <span class="n">x_validate</span><span class="p">[</span><span class="n">x_validate</span><span class="o">.</span><span class="n">time_in_hospital</span><span class="o">==</span><span class="n">TIME_IN_HOSPITAL</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">row_data_matrix</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">))</span>
</pre></div>
<pre class="example">
[0 1]
[[0.39445183 0.60554817]]
</pre>
<div class="highlight">
<pre><span></span><span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">first_model</span><span class="p">)</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">force_plot</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">shap_values</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">row_data_matrix</span><span class="p">,</span>
                         <span class="n">feature_names</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                         <span class="n">matplotlib</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s2">"shap_hospital_one.png"</span>

<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">filename</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{filename}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_hospital_one.png" src="/posts/tutorials/shap-values-exercise/shap_hospital_one.png"></p>
</div>
<p>It looks like time in hospital has an effect - but it is a small one.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org0bce611">
<h4 id="org0bce611">Raw Readmissions</h4>
<div class="outline-text-4" id="text-org0bce611">
<blockquote>
<p>Whoa! It seems like <code>time_in_hospital</code> doesn't matter at all. The difference between the lowest value on the partial dependence plot and the highest value is about 5%.</p>
<p>If that is what your model concluded, the doctors will believe it. But it seems so low. Could the data be wrong, or is your model doing something more complex than they expect?</p>
<p>They'd like you to show them the raw readmission rate for each value of <code>time_in_hospital</code> to see how it compares to the partial dependence plot.</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">training</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s2">"columns"</span><span class="p">)</span>
<span class="n">grouped</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">"time_in_hospital"</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">"readmitted"</span><span class="p">:</span> <span class="s2">"mean"</span><span class="p">})</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">bar</span><span class="p">()</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Readmission Rates for time_in_hospital"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span>
<span class="p">)</span>

<span class="n">source</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"time_in_hospital_readmission_rates"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</pre></div>
: <object data="/posts/tutorials/shap-values-exercise/time_in_hospital_readmission_rates.html" height="800" style="width:100%" type="text/html">:
<p>Figure Missing</p>
:</object>
<p>It sort of looks like <code>time_in_hospital</code> does affect readmission rates, just not as much as the number of admissions, I guess.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orga510ac2">
<h3 id="orga510ac2">SHAP Creator</h3>
<div class="outline-text-3" id="text-orga510ac2">
<blockquote>
<p>Now the doctors are convinced you have the right data, and the model overview looked reasonable. It's time to turn this into a finished product they can use. Specifically, the hospital wants you to create a function <code>patient_risk_factors</code> that does the following</p>
<ul class="org-ul">
<li>Takes a single row with patient data (of the same format you as your raw data)</li>
<li>Creates a visualization showing what features of that patient increased their risk of readmission, what features decreased it, and how much those features mattered.</li>
</ul>
<p>It's not important to show every feature with every miniscule impact on the readmission risk. It's fine to focus on only the most important features for that patient.</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">patient_risk_factors</span><span class="p">(</span><span class="n">row_data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">row_data_matrix</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">first_model</span><span class="p">)</span>
    <span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">)</span>
    <span class="n">figure</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">force_plot</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                             <span class="n">shap_values</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                             <span class="n">row_data_matrix</span><span class="p">,</span>
                             <span class="n">feature_names</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                             <span class="n">matplotlib</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"shap_</span><span class="si">{tag}</span><span class="s2">.png"</span>
    <span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">filename</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{filename}</span><span class="s2">]]"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">row_data_matrix</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">row</span> <span class="o">=</span> <span class="n">x_validate</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<span class="n">row_matrix</span> <span class="o">=</span> <span class="n">patient_risk_factors</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s2">"random_one"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_random_one.png" src="/posts/tutorials/shap-values-exercise/shap_random_one.png"></p>
</div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">row_matrix</span><span class="p">))</span>
</pre></div>
<pre class="example">
[[0.70043997 0.29956003]]
</pre>
<p>In this case it looks like the number of diagnoses was the most important - having many diagnoses with no hospital admissions predicts you won't be readmitted. Should people who were never admitted be considered? Perhaps "readmission" just means admitted later.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org4e6ba93">
<h2 id="org4e6ba93">End</h2>
<div class="outline-text-2" id="text-org4e6ba93"></div>
<div class="outline-3" id="outline-container-org9d12e7b">
<h3 id="org9d12e7b">Sources</h3>
<div class="outline-text-3" id="text-org9d12e7b">
<ul class="org-ul">
<li>Lundberg, S.M., Erion, G., Chen, H. et al. From local explanations to global understanding with explainable AI for trees. Nat Mach Intell 2, 56–67 (2020). <a href="https://doi.org/10.1038/s42256-019-0138-9">https://doi.org/10.1038/s42256-019-0138-9</a> (<a href="https://www.nature.com/articles/s42256-019-0138-9">TreeExplainer</a>)</li>
<li>Lundberg, S.M., Nair, B., Vavilala, M.S. et al. Explainable machine-learning predictions for the prevention of hypoxaemia during surgery. Nat Biomed Eng 2, 749–760 (2018). <a href="https://doi.org/10.1038/s41551-018-0304-0">https://doi.org/10.1038/s41551-018-0304-0</a> (<a href="https://www.nature.com/articles/s41551-018-0304-0"><code>force_plot</code></a>)</li>
</ul>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/tutorials/shap-values/">SHAP Values</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/shap-values/" rel="bookmark"><time class="published dt-published" datetime="2020-02-09T17:07:12-08:00" itemprop="datePublished" title="2020-02-09 17:07">2020-02-09 17:07</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/shap-values/#org6bf9a85">Beginning</a>
<ul>
<li><a href="/posts/tutorials/shap-values/#org7deee69">Imports</a>
<ul>
<li><a href="/posts/tutorials/shap-values/#org98968d4">Python</a></li>
<li><a href="/posts/tutorials/shap-values/#orgd54892f">PyPi</a></li>
<li><a href="/posts/tutorials/shap-values/#orga29719e">Others</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values/#org246bc96">Set Up</a>
<ul>
<li><a href="/posts/tutorials/shap-values/#orge93544f">Plotting</a></li>
<li><a href="/posts/tutorials/shap-values/#org663ea8b">The Timer</a></li>
<li><a href="/posts/tutorials/shap-values/#org664d413">Environment</a></li>
<li><a href="/posts/tutorials/shap-values/#orga9aac4a">The Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values/#org855984d">Middle</a>
<ul>
<li><a href="/posts/tutorials/shap-values/#org2ab88be">A Single Row</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values/#org52953ea">End</a>
<ul>
<li><a href="/posts/tutorials/shap-values/#org43f2023">See Also</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org6bf9a85">
<h2 id="org6bf9a85">Beginning</h2>
<div class="outline-text-2" id="text-org6bf9a85">
<p>SHAP values interpret the impact of a certain value for a given feature when compared to the prediction you'd make if that feature instead took a baseline value. This helps us interpret predictions given specific values for our features. We'll do this using the <a href="https://github.com/slundberg/shap">SHAP</a> library, naturally.</p>
</div>
<div class="outline-3" id="outline-container-org7deee69">
<h3 id="org7deee69">Imports</h3>
<div class="outline-text-3" id="text-org7deee69"></div>
<div class="outline-4" id="outline-container-org98968d4">
<h4 id="org98968d4">Python</h4>
<div class="outline-text-4" id="text-org98968d4">
<div class="highlight">
<pre><span></span>from argparse import Namespace
from pathlib import Path
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgd54892f">
<h4 id="orgd54892f">PyPi</h4>
<div class="outline-text-4" id="text-orgd54892f">
<div class="highlight">
<pre><span></span>from matplotlib import pyplot
from sklearn.model_selection import train_test_split, RandomizedSearchCV
from sklearn.ensemble import RandomForestClassifier

import numpy
import pandas
import seaborn
import shap
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orga29719e">
<h4 id="orga29719e">Others</h4>
<div class="outline-text-4" id="text-orga29719e">
<div class="highlight">
<pre><span></span>from graeae import EnvironmentLoader, Timer
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org246bc96">
<h3 id="org246bc96">Set Up</h3>
<div class="outline-text-3" id="text-org246bc96"></div>
<div class="outline-4" id="outline-container-orge93544f">
<h4 id="orge93544f">Plotting</h4>
<div class="outline-text-4" id="text-orge93544f">
<div class="highlight">
<pre><span></span>SLUG = "shap-values"
OUTPUT_PATH = Path("../../files/posts/tutorials/")/SLUG
</pre></div>
<div class="highlight">
<pre><span></span>get_ipython().run_line_magic('matplotlib', 'inline')
get_ipython().run_line_magic('config', "InlineBackend.figure_format = 'retina'")
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org663ea8b">
<h4 id="org663ea8b">The Timer</h4>
<div class="outline-text-4" id="text-org663ea8b">
<div class="highlight">
<pre><span></span>TIMER = Timer()
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org664d413">
<h4 id="org664d413">Environment</h4>
<div class="outline-text-4" id="text-org664d413">
<div class="highlight">
<pre><span></span>ENVIRONMENT = EnvironmentLoader()
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orga9aac4a">
<h4 id="orga9aac4a">The Data</h4>
<div class="outline-text-4" id="text-orga9aac4a">
<div class="highlight">
<pre><span></span>data = pandas.read_csv(Path(ENVIRONMENT["FIFA-2018"]).expanduser())
y = data["Man of the Match"] == "Yes"
FEATURES = [column for column in data.columns if data[column].dtype == numpy.int64]
X = data[FEATURES]
x_train, x_validate, y_train, y_validate = train_test_split(X, y, random_state=1)


model = RandomForestClassifier()

estimators = list(range(50, 200, 10))
max_depth = list(range(10, 100, 10)) + [None]

grid = dict(n_estimators=estimators,
            max_depth=max_depth)
search = RandomizedSearchCV(estimator=model,
                            param_distributions=grid,
                            n_iter=40,
                            n_jobs=-1,
                            random_state=1)
with TIMER:
    search.fit(x_train, y_train)
first_model = search.best_estimator_
print(f"CV Training R^2: {search.best_score_:0.2f}")
print(f"Training R^2: {first_model.score(x_train, y_train): 0.2f}")
print(f"Validation R^2: {first_model.score(x_validate, y_validate):0.2f}")
print(search.best_params_)
</pre></div>
<pre class="example">
2020-02-10 18:09:33,716 graeae.timers.timer start: Started: 2020-02-10 18:09:33.716565
The default value of cv will change from 3 to 5 in version 0.22. Specify it explicitly to silence this warning.
2020-02-10 18:09:36,830 graeae.timers.timer end: Ended: 2020-02-10 18:09:36.830883
2020-02-10 18:09:36,832 graeae.timers.timer end: Elapsed: 0:00:03.114318
CV Training R^2: 0.70
Training R^2:  1.00
Validation R^2: 0.69
{'n_estimators': 100, 'max_depth': 30}
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org855984d">
<h2 id="org855984d">Middle</h2>
<div class="outline-text-2" id="text-org855984d"></div>
<div class="outline-3" id="outline-container-org2ab88be">
<h3 id="org2ab88be">A Single Row</h3>
<div class="outline-text-3" id="text-org2ab88be">
<div class="highlight">
<pre><span></span>ROW = 5
row_data = x_validate.iloc[ROW]
row_data_matrix = row_data.values.reshape(1, -1)
print(first_model.classes_)
print(first_model.predict_proba(row_data_matrix))
</pre></div>
<pre class="example">
[False  True]
[[0.25 0.75]]
</pre>
<p>The <a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestClassifier.html#sklearn.ensemble.RandomForestClassifier.predict_proba"><code>predict_proba</code></a> method tells us the probability for the data for each class. So this team has a 70% chance that they do have a man of the match.</p>
<div class="highlight">
<pre><span></span>explainer = shap.TreeExplainer(first_model)
shap_values = explainer.shap_values(row_data_matrix)
</pre></div>
<div class="highlight">
<pre><span></span>print(explainer.shap_values.__doc__)
</pre></div>
<pre class="example">
Estimate the SHAP values for a set of samples.

       Parameters
       ----------
       X : numpy.array, pandas.DataFrame or catboost.Pool (for catboost)
           A matrix of samples (# samples x # features) on which to explain the model's output.

       y : numpy.array
           An array of label values for each sample. Used when explaining loss functions.

       tree_limit : None (default) or int
           Limit the number of trees used by the model. By default None means no use the limit of the
           original model, and -1 means no limit.

       approximate : bool
           Run fast, but only roughly approximate the Tree SHAP values. This runs a method
           previously proposed by Saabas which only considers a single feature ordering. Take care
           since this does not have the consistency guarantees of Shapley values and places too
           much weight on lower splits in the tree.

       check_additivity : bool
           Run a validation check that the sum of the SHAP values equals the output of the model. This
           check takes only a small amount of time, and will catch potential unforeseen errors.
           Note that this check only runs right now when explaining the margin of the model.

       Returns
       -------
       For models with a single output this returns a matrix of SHAP values
       (# samples x # features). Each row sums to the difference between the model output for that
       sample and the expected value of the model output (which is stored in the expected_value
       attribute of the explainer when it is constant). For models with vector outputs this returns
       a list of such matrices, one for each output.

</pre>
<p>The array returned by the <code>shap_values</code> method has two rows - one for each of our target classes. In this case we're asking if a team had a man of the match so we'll just look at the second array.</p>
<div class="highlight">
<pre><span></span>shap.initjs()
figure = shap.force_plot(explainer.expected_value[1],
                         shap_values[1],
                         row_data_matrix,
                         feature_names=FEATURES,
                         matplotlib=True, show=False)
filename = "shap_one.png"

figure.savefig(OUTPUT_PATH/filename)
print(f"[[file:{filename}]]")
</pre></div>
<div class="figure">
<p><img alt="shap_one.png" src="/posts/tutorials/shap-values/shap_one.png"></p>
</div>
<p>Our predicted probability that this team had a man of the match was 0.7, but the base-value for the set as a whole is 0.4979 (you can't see it in this plot for some reason), so our team is more likely to have one than most teams. The pink section of the plot shows the features that increased the probability and the part in blue shows the features that decreased the probability. The size of each feature's block is proportional to the amount the feature contributed, so the biggest block (<i>Goal Scored</i>) contributed the most. The greatest negative feature was <i>Ball Possession %</i>.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org52953ea">
<h2 id="org52953ea">End</h2>
<div class="outline-text-2" id="text-org52953ea"></div>
<div class="outline-3" id="outline-container-org43f2023">
<h3 id="org43f2023">See Also</h3>
<div class="outline-text-3" id="text-org43f2023">
<ul class="org-ul">
<li>The <a href="https://shap.readthedocs.io/en/latest/">SHAP</a> Documentation</li>
<li>The <a href="https://github.com/slundberg/shap">SHAP github repository</a></li>
<li>Lundberg SM, Lee SI. A unified approach to interpreting model predictions. InAdvances in neural information processing systems 2017 (pp. 4765-4774). (<a href="https://papers.nips.cc/paper/7062-a-unified-approach-to-interpreting-model-predicti">PDF Available Here</a>)</li>
</ul>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/tutorials/exercise-in-partial-dependence-plots/">Exercise In Partial Dependence Plots</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/exercise-in-partial-dependence-plots/" rel="bookmark"><time class="published dt-published" datetime="2020-02-09T13:26:37-08:00" itemprop="datePublished" title="2020-02-09 13:26">2020-02-09 13:26</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#orgc4b9b92">Beginning</a>
<ul>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#org28397e7">Imports</a>
<ul>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#orge120f44">Python</a></li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#orgc68d7c1">PyPi</a></li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#orge329a31">Others</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#org8755954">Set Up</a>
<ul>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#org11946ee">The Environment</a></li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#org77f0ad0">The Timer</a></li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#org29ef8e6">Plotting</a></li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#org2cdbde9">The Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#orgc1a78ad">Middle</a>
<ul>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#org9e2af56">The First Model</a></li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#orgc97feb3">Question 1</a></li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#org617fc19">Question 2</a></li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#orgfc819a7">Question 3</a></li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#orga8ada38">Question 4</a></li>
<li><a href="/posts/tutorials/exercise-in-partial-dependence-plots/#org8fba01a">Question 5</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgc4b9b92">
<h2 id="orgc4b9b92">Beginning</h2>
<div class="outline-text-2" id="text-orgc4b9b92">
<p>This is my re-working of the Kaggle <a href="https://www.kaggle.com/learn/machine-learning-explainability">Machine Learning Explainability</a> exercise in Partial Dependece Plots. It uses data from the <a href="https://www.kaggle.com/c/new-york-city-taxi-fare-prediction">Taxi Fare Prediction</a> competition.</p>
</div>
<div class="outline-3" id="outline-container-org28397e7">
<h3 id="org28397e7">Imports</h3>
<div class="outline-text-3" id="text-org28397e7"></div>
<div class="outline-4" id="outline-container-orge120f44">
<h4 id="orge120f44">Python</h4>
<div class="outline-text-4" id="text-orge120f44">
<div class="highlight">
<pre><span></span>from pathlib import Path
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgc68d7c1">
<h4 id="orgc68d7c1">PyPi</h4>
<div class="outline-text-4" id="text-orgc68d7c1">
<div class="highlight">
<pre><span></span>from matplotlib import pyplot
from matplotlib.pyplot import rcParams
from pdpbox import pdp
from sklearn.ensemble import RandomForestRegressor
from sklearn.linear_model import LinearRegression
from sklearn.model_selection import train_test_split, RandomizedSearchCV

import pandas
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orge329a31">
<h4 id="orge329a31">Others</h4>
<div class="outline-text-4" id="text-orge329a31">
<div class="highlight">
<pre><span></span>from graeae import EnvironmentLoader, Timer
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org8755954">
<h3 id="org8755954">Set Up</h3>
<div class="outline-text-3" id="text-org8755954"></div>
<div class="outline-4" id="outline-container-org11946ee">
<h4 id="org11946ee">The Environment</h4>
<div class="outline-text-4" id="text-org11946ee">
<div class="highlight">
<pre><span></span>ENVIRONMENT = EnvironmentLoader()
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org77f0ad0">
<h4 id="org77f0ad0">The Timer</h4>
<div class="outline-text-4" id="text-org77f0ad0">
<div class="highlight">
<pre><span></span>TIMER = Timer()
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org29ef8e6">
<h4 id="org29ef8e6">Plotting</h4>
<div class="outline-text-4" id="text-org29ef8e6">
<div class="highlight">
<pre><span></span>SLUG = "exercise-in-partial-dependence-plots"
OUTPUT_PATH = Path("../../files/posts/tutorials/")/SLUG

rcParams["figure.figsize"] = (6, 4)
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org2cdbde9">
<h4 id="org2cdbde9">The Data</h4>
<div class="outline-text-4" id="text-org2cdbde9">
<div class="highlight">
<pre><span></span>ROWS = 5 * 10**4
data = pandas.read_csv(Path(ENVIRONMENT["NY-TAXI"]).expanduser()/"train.csv",
                       nrows=ROWS)
data = data.query('pickup_latitude &gt; 40.7 and pickup_latitude &lt; 40.8 and ' +
                  'dropoff_latitude &gt; 40.7 and dropoff_latitude &lt; 40.8 and ' +
                  'pickup_longitude &gt; -74 and pickup_longitude &lt; -73.9 and ' +
                  'dropoff_longitude &gt; -74 and dropoff_longitude &lt; -73.9 and ' +
                  'fare_amount &gt; 0'
                  )
y = data.fare_amount
base_features = ['pickup_longitude',
                 'pickup_latitude',
                 'dropoff_longitude',
                 'dropoff_latitude']

X = data[base_features]

x_train, x_validate, y_train, y_validate = train_test_split(X, y, random_state=1)
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgc1a78ad">
<h2 id="orgc1a78ad">Middle</h2>
<div class="outline-text-2" id="text-orgc1a78ad"></div>
<div class="outline-3" id="outline-container-org9e2af56">
<h3 id="org9e2af56">The First Model</h3>
<div class="outline-text-3" id="text-org9e2af56">
<div class="highlight">
<pre><span></span>first_model = RandomForestRegressor(n_estimators=180,
                                    max_depth=50, random_state=1).fit(x_train, y_train)
print(f"Training R^2: {first_model.score(x_train, y_train):0.2f}")
print(f"Validation R^2: {first_model.score(x_validate, y_validate):0.2f}")
</pre></div>
<pre class="example">
Training R^2: 0.92
Validation R^2: 0.43
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgc97feb3">
<h3 id="orgc97feb3">Question 1</h3>
<div class="outline-text-3" id="text-orgc97feb3">
<div class="highlight">
<pre><span></span>FEATURE = 'pickup_longitude'
pdp_dist = pdp.pdp_isolate(model=first_model,
                           dataset=x_validate,
                           model_features=base_features,
                           feature=FEATURE)
pdp.pdp_plot(pdp_dist, FEATURE)
output = f"{FEATURE}_pdp_plot.png"
pyplot.savefig(OUTPUT_PATH/output)
print(f"[[file:{output}]]")
</pre></div>
<pre class="example">
[[file:pickup_longitude_pdp_plot.png]]
</pre>
<div class="figure">
<p><img alt="eb446225f180346680b332c924342792de7e5135.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/.ob-jupyter/eb446225f180346680b332c924342792de7e5135.png"></p>
</div>
<p><img alt="pickup_longitude_pdp_plot.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/pickup_longitude_pdp_plot.png"><img alt="eb446225f180346680b332c924342792de7e5135.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/.ob-jupyter/eb446225f180346680b332c924342792de7e5135.png"></p>
<blockquote>
<p>Why does the partial dependence plot have this U-shape?</p>
</blockquote>
<p>At the extremes you have the locations that can potentially travel the furthest, creating the biggest fairs, but as you move to the center you reduce the amount you can possibly travel - although the change isn't symmetric so this isn't the only explanation, otherwise if it were then you would expect the two ends to have the highest values and the nadir to be at the halfway point (-73.95).</p>
<blockquote>
<p>Does your explanation suggest what shape to expect in the partial dependence plots for the other features?</p>
<p>Create all other partial plots.</p>
</blockquote>
<div class="highlight">
<pre><span></span>for FEATURE in base_features:
    pdp_dist = pdp.pdp_isolate(model=first_model,
                               dataset=x_validate,
                               model_features=base_features,
                               feature=FEATURE)
    pdp.pdp_plot(pdp_dist, FEATURE)
    output = f"{FEATURE}_pdp_plot.png"
    pyplot.savefig(OUTPUT_PATH/output)
    print(f"[[file:{output}]]")
</pre></div>
<pre class="example">
[[file:pickup_longitude_pdp_plot.png]]
[[file:pickup_latitude_pdp_plot.png]]
[[file:dropoff_longitude_pdp_plot.png]]
[[file:dropoff_latitude_pdp_plot.png]]
</pre>
<p><img alt="eb446225f180346680b332c924342792de7e5135.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/.ob-jupyter/eb446225f180346680b332c924342792de7e5135.png"> <img alt="f2c9b641a0b8f044729d15efd208f672e3ecb7c1.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/.ob-jupyter/f2c9b641a0b8f044729d15efd208f672e3ecb7c1.png"> <img alt="6334156ec3931ff43161785fde6f1f27a460bccd.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/.ob-jupyter/6334156ec3931ff43161785fde6f1f27a460bccd.png"> <img alt="4417e1dcc2d023ce83c886e006ce5de690bfe97b.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/.ob-jupyter/4417e1dcc2d023ce83c886e006ce5de690bfe97b.png"></p>
<p><img alt="pickup_latitude_pdp_plot.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/pickup_latitude_pdp_plot.png"> <img alt="dropoff_longitude_pdp_plot.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/dropoff_longitude_pdp_plot.png"> <img alt="dropoff_latitude_pdp_plot.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/dropoff_latitude_pdp_plot.png"><img alt="eb446225f180346680b332c924342792de7e5135.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/.ob-jupyter/eb446225f180346680b332c924342792de7e5135.png"></p>
</div>
</div>
<div class="outline-3" id="outline-container-org617fc19">
<h3 id="org617fc19">Question 2</h3>
<div class="outline-text-3" id="text-org617fc19">
<p>Now you will run a 2D partial dependence plot. As a reminder, here is the code from the tutorial.</p>
<p>Create a 2D plot for the features <code>pickup_longitude</code> and <code>dropoff_longitude</code>.</p>
<div class="highlight">
<pre><span></span>FEATURES = "pickup_longitude dropoff_longitude".split()
interaction  =  pdp.pdp_interact(model=first_model,
                                 dataset=x_validate,
                                 model_features=base_features,
                                 features=FEATURES)
pdp.pdp_interact_plot(pdp_interact_out=interaction,
                      feature_names=FEATURES, plot_type='contour')
output = "longitude_interaction.png"
pyplot.savefig(OUTPUT_PATH/output)
print(f"[[file:{output}]]")
</pre></div>
<pre class="example">
[[file:longitude_interaction.png]]
</pre>
<div class="figure">
<p><img alt="744ca56de862b725f3b5132f1c80c9bf41837026.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/.ob-jupyter/744ca56de862b725f3b5132f1c80c9bf41837026.png"></p>
</div>
<div class="figure">
<p><img alt="longitude_interaction.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/longitude_interaction.png"></p>
</div>
<p>Our plot shows that the fares are highest at the top-left and bottom-right corners, as you might expect, since this would be the furthest distance from pickup to dropoff.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgfc819a7">
<h3 id="orgfc819a7">Question 3</h3>
<div class="outline-text-3" id="text-orgfc819a7">
<blockquote>
<p>Consider a ride starting at longitude -73.92 and ending at longitude -74. Using the graph from the last question, estimate how much money the rider would have saved if they'd started the ride at longitude -73.98 instead?</p>
</blockquote>
<p>I don't exactly agree with the interpretation given by the kaggle notebook. Looking at the plot, -73.92 to -74 appears to cost 27, while a -73.92 to -74 would cost 9 - but the notebook says that -73.92 to -74 costs 24. So I would say there would be a saving of 18 while the given answer is 15. To reconcile the difference (kind of) we might say that -73.92 to -74 costs 12, not 9 - it's not really easy to tell by the plot, in which case I would also say the savings is 15.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orga8ada38">
<h3 id="orga8ada38">Question 4</h3>
<div class="outline-text-3" id="text-orga8ada38">
<blockquote>
<p>In the PDP's you've seen so far, location features have primarily served as a proxy to capture distance traveled. In the permutation importance lessons, you added the features `abs_lon_change` and `abs_lat_change` as a more direct measure of distance.</p>
<p>Create these features again here.</p>
<p>After you run it, identify the most important difference between this partial dependence plot and the one you got without absolute value features. The code to generate the PDP without absolute value features is at the top of this code cell.</p>
</blockquote>
<div class="highlight">
<pre><span></span>FEATURE = 'pickup_longitude'
pdp_dist_original = pdp.pdp_isolate(model=first_model,
                                    dataset=x_validate,
                                    model_features=base_features,
                                    feature=FEATURE)
pdp.pdp_plot(pdp_dist_original, FEATURE)
output = "pre_distance.png"
pyplot.savefig(OUTPUT_PATH/output)
print(f"[[file:{output}]]")
</pre></div>
<p><img alt="pre_distance.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/pre_distance.png"><img alt="eb446225f180346680b332c924342792de7e5135.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/.ob-jupyter/eb446225f180346680b332c924342792de7e5135.png"></p>
<div class="highlight">
<pre><span></span>data['abs_lon_change'] = abs(data.pickup_longitude - data.dropoff_longitude)
data['abs_lat_change'] = abs(data.pickup_latitude - data.dropoff_longitude)

features_2  = ['pickup_longitude',
               'pickup_latitude',
               'dropoff_longitude',
               'dropoff_latitude',
               'abs_lat_change',
               'abs_lon_change']

X = data[features_2]
new_x_train, new_x_validate, new_y_train, new_y_validate = train_test_split(X, y, random_state=1)

estimators = list(range(50, 200, 10))
max_depth = list(range(10, 100, 10)) + [None]

grid = dict(n_estimators=estimators,
            max_depth=max_depth)

model = RandomForestRegressor()
search = RandomizedSearchCV(estimator=model,
                            param_distributions=grid,
                            n_iter=40,
                            n_jobs=-1,
                            random_state=1)
with TIMER:
    search.fit(new_x_train, new_y_train)
second_model = search.best_estimator_
print(f"CV Training R^2: {search.best_score_:0.2f}")
print(f"Training R^2: {first_model.score(x_train, y_train): 0.2f}")
print(f"Validation R^2: {first_model.score(x_validate, y_validate):0.2f}")
print(search.best_params_)
</pre></div>
<pre class="example">
2020-02-09 17:36:14,915 graeae.timers.timer start: Started: 2020-02-09 17:36:14.915123
2020-02-09 17:43:16,053 graeae.timers.timer end: Ended: 2020-02-09 17:43:16.053011
2020-02-09 17:43:16,053 graeae.timers.timer end: Elapsed: 0:07:01.137888
CV Training R^2: 0.46
Training R^2:  0.92
Validation R^2: 0.43
{'n_estimators': 190, 'max_depth': 30}
</pre>
<div class="highlight">
<pre><span></span>FEATURE = 'pickup_longitude'
pdp_dist = pdp.pdp_isolate(model=second_model,
                           dataset=new_x_validate,
                           model_features=features_2,
                           feature=FEATURE)

pdp.pdp_plot(pdp_dist, FEATURE)
output = "pickup_longitude_with_distance_added.png"
pyplot.savefig(OUTPUT_PATH/output)
print(f"[[file:{output}]]")
</pre></div>
<p><img alt="pickup_longitude_with_distance_added.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/pickup_longitude_with_distance_added.png"><img alt="98c17657a972a412bc6d33619b6e23ee5818b884.png" src="/posts/tutorials/exercise-in-partial-dependence-plots/.ob-jupyter/98c17657a972a412bc6d33619b6e23ee5818b884.png"></p>
</div>
</div>
<div class="outline-3" id="outline-container-org8fba01a">
<h3 id="org8fba01a">Question 5</h3>
<div class="outline-text-3" id="text-org8fba01a">
<blockquote>
<p>Consider a scenario where you have only 2 predictive features, which we will call `feat_A` and `feat_B`. Both features have minimum values of -1 and maximum values of 1. The partial dependence plot for `feat_A` increases steeply over its whole range, whereas the partial dependence plot for feature B increases at a slower rate (less steeply) over its whole range. Does this guarantee that `feat_A` will have a higher permutation importance than `feat_B`. Why or why not?</p>
</blockquote>
<p>It doesn't - the partial dependence plot shows how the predictions change based on the inputs, but it isn't the same thing as the feature importance - it might be the case that a few inputs create a large difference but most points don't, in which case the feature importance won't be very large.</p>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/tutorials/partial-dependence-plots/">Partial Dependence Plots</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/partial-dependence-plots/" rel="bookmark"><time class="published dt-published" datetime="2020-02-08T12:48:50-08:00" itemprop="datePublished" title="2020-02-08 12:48">2020-02-08 12:48</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/partial-dependence-plots/#org76bc05f">Beginning</a>
<ul>
<li><a href="/posts/tutorials/partial-dependence-plots/#orgb5fee0d">What is this about?</a></li>
<li><a href="/posts/tutorials/partial-dependence-plots/#org7f4c222">How does it work?</a></li>
<li><a href="/posts/tutorials/partial-dependence-plots/#org690f6dd">Imports</a>
<ul>
<li><a href="/posts/tutorials/partial-dependence-plots/#org7f2de4b">Python</a></li>
<li><a href="/posts/tutorials/partial-dependence-plots/#org17afb66">PyPi</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/partial-dependence-plots/#org98f74df">Set Up</a>
<ul>
<li><a href="/posts/tutorials/partial-dependence-plots/#org2097968">Plotting</a></li>
<li><a href="/posts/tutorials/partial-dependence-plots/#orgde6fbc0">The Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/partial-dependence-plots/#orgeba0831">Middle</a>
<ul>
<li><a href="/posts/tutorials/partial-dependence-plots/#org0425cac">A Decision Tree Model</a>
<ul>
<li><a href="/posts/tutorials/partial-dependence-plots/#orgcfb4b30">Visualizing the Decision Tree</a></li>
<li><a href="/posts/tutorials/partial-dependence-plots/#org19b8ecc">Partial Dependency Plot</a></li>
<li><a href="/posts/tutorials/partial-dependence-plots/#org23b0729">Distance Covered</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/partial-dependence-plots/#org96647d3">A Random Forest Model</a></li>
<li><a href="/posts/tutorials/partial-dependence-plots/#org4a9192a">2D Partial Dependence Plots</a>
<ul>
<li><a href="/posts/tutorials/partial-dependence-plots/#orga122c95">Forest From the Trees</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/partial-dependence-plots/#org99692f6">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org76bc05f">
<h2 id="org76bc05f">Beginning</h2>
<div class="outline-text-2" id="text-org76bc05f"></div>
<div class="outline-3" id="outline-container-orgb5fee0d">
<h3 id="orgb5fee0d">What is this about?</h3>
<div class="outline-text-3" id="text-orgb5fee0d">
<p>These are my notes/re-write of the <a href="https://www.kaggle.com/dansbecker/partial-plots">Partial Dependence Plots</a> tutorial on kaggle. Partial Dependence Plots are a complement to Permutation Importance in that Permutation Importance can tell you which features are contributing to the model but don't tell you how features change with different inputs. Given that they have the word "Plot" in their name you can guess that this is a visualization method and since humans have a hard time visualizing things with more than three dimensions, using them requires selecting a subset of features (or maybe just one feature) to visualize at a time, so the fact that Permutation Importance ranks features by their contribution might come in handy in deciding which features to use.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org7f4c222">
<h3 id="org7f4c222">How does it work?</h3>
<div class="outline-text-3" id="text-org7f4c222">
<p>In a simplistic view we might say that it takes input data and then repeatedly alters the values in our feature of choice, freezing the other values so that we can see how varying the feature changes the prediction. You can then repeat this for multiple rows of data and take the average prediction for each value of our feature.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org690f6dd">
<h3 id="org690f6dd">Imports</h3>
<div class="outline-text-3" id="text-org690f6dd"></div>
<div class="outline-4" id="outline-container-org7f2de4b">
<h4 id="org7f2de4b">Python</h4>
<div class="outline-text-4" id="text-org7f2de4b">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org17afb66">
<h4 id="org17afb66">PyPi</h4>
<div class="outline-text-4" id="text-org17afb66">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>
<span class="kn">from</span> <span class="nn">pdpbox</span> <span class="kn">import</span> <span class="n">pdp</span><span class="p">,</span> <span class="n">get_dataset</span><span class="p">,</span> <span class="n">info_plots</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">tree</span>

<span class="kn">import</span> <span class="nn">graphviz</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org98f74df">
<h3 id="org98f74df">Set Up</h3>
<div class="outline-text-3" id="text-org98f74df"></div>
<div class="outline-4" id="outline-container-org2097968">
<h4 id="org2097968">Plotting</h4>
<div class="outline-text-4" id="text-org2097968">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"partial-dependence-plots"</span>
<span class="n">OUTPUT_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"../../files/posts/tutorials/"</span><span class="p">)</span><span class="o">/</span><span class="n">SLUG</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgde6fbc0">
<h4 id="orgde6fbc0">The Data</h4>
<div class="outline-text-4" id="text-orgde6fbc0">
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"~/.env"</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">load_dotenv</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">override</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"FIFA-2018"</span><span class="p">))</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgeba0831">
<h2 id="orgeba0831">Middle</h2>
<div class="outline-text-2" id="text-orgeba0831"></div>
<div class="outline-3" id="outline-container-org0425cac">
<h3 id="org0425cac">A Decision Tree Model</h3>
<div class="outline-text-3" id="text-org0425cac">
<p>The data is the same set from the Permutation Importance exercise (team data to predict whether one of them would become the <i>Budweiser Man of the Match</i>). Out initial model will be a shallow decision tree so that we can compare its structure to the plots.</p>
<div class="highlight">
<pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">"Man of the Match"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Yes"</span>
<span class="n">features</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">features</span><span class="p">]</span>

<span class="n">x_train</span><span class="p">,</span> <span class="n">x_validate</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_validate</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">tree_model</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgcfb4b30">
<h4 id="orgcfb4b30">Visualizing the Decision Tree</h4>
<div class="outline-text-4" id="text-orgcfb4b30">
<div class="highlight">
<pre><span></span><span class="n">tree_graph</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">export_graphviz</span><span class="p">(</span><span class="n">tree_model</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">graphviz</span><span class="o">.</span><span class="n">Source</span><span class="p">(</span><span class="n">tree_graph</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"decision_tree.dot"</span>
<span class="n">graph</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">"png"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{output}</span><span class="s2">.png]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="decision_tree.dot.png" src="/posts/tutorials/partial-dependence-plots/decision_tree.dot.png"></p>
</div>
</div>
</div>
<div class="outline-4" id="outline-container-org19b8ecc">
<h4 id="org19b8ecc">Partial Dependency Plot</h4>
<div class="outline-text-4" id="text-org19b8ecc">
<p>To create the plot we can use the <a href="https://pdpbox.readthedocs.io/en/latest/">PDPBox library</a>.</p>
</div>
<ul class="org-ul">
<li><a id="org4efa272"></a>Create the Data to Plot<br>
<div class="outline-text-5" id="text-org4efa272">
<div class="highlight">
<pre><span></span><span class="n">FEATURE</span> <span class="o">=</span> <span class="s2">"Goal Scored"</span>
<span class="n">pdp_goals</span> <span class="o">=</span> <span class="n">pdp</span><span class="o">.</span><span class="n">pdp_isolate</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">tree_model</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">x_validate</span><span class="p">,</span>
                            <span class="n">model_features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="n">FEATURE</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><a id="org5606093"></a>Plot It<br>
<div class="outline-text-5" id="text-org5606093">
<div class="highlight">
<pre><span></span><span class="n">pdp</span><span class="o">.</span><span class="n">pdp_plot</span><span class="p">(</span><span class="n">pdp_goals</span><span class="p">,</span> <span class="n">FEATURE</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"pdp_goals_scored.png"</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{output}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="pdp_goals_scored.png" src="/posts/tutorials/partial-dependence-plots/pdp_goals_scored.png"></p>
</div>
<p>Looking at the plot we can interpret it as saying that scoring that first goal is helpful in getting someone on the team the Man of the Match, but after that, more goals doesn't help. The PDPBox documentation has no real information about interpreting the output (or anything they provide, really), but according to the Kaggle tutorial the y-axis is the change in the prediction from the baseline as x changes.</p>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org23b0729">
<h4 id="org23b0729">Distance Covered</h4>
<div class="outline-text-4" id="text-org23b0729">
<p>We can also look at how much the distance the players cover on the field matters.</p>
<div class="highlight">
<pre><span></span><span class="n">FEATURE</span> <span class="o">=</span> <span class="s2">"Distance Covered (Kms)"</span>
<span class="n">pdp_distance</span> <span class="o">=</span> <span class="n">pdp</span><span class="o">.</span><span class="n">pdp_isolate</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">tree_model</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">x_validate</span><span class="p">,</span>
                               <span class="n">model_features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="n">FEATURE</span><span class="p">)</span>
<span class="n">pdp</span><span class="o">.</span><span class="n">pdp_plot</span><span class="p">(</span><span class="n">pdp_distance</span><span class="p">,</span> <span class="n">FEATURE</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"pdp_distance.png"</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{output}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="pdp_distance.png" src="/posts/tutorials/partial-dependence-plots/pdp_distance.png"></p>
</div>
<p>It looks like there's one distance at which the probabilities increase and then going further doesn't matter.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">pdp_distance</span><span class="o">.</span><span class="n">feature_grids</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
<pre class="example">
102.0
</pre>
<p>So you want your team to cover at least 102 Kilometers, but covering more won't help you.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org96647d3">
<h3 id="org96647d3">A Random Forest Model</h3>
<div class="outline-text-3" id="text-org96647d3">
<p>The Decision Tree was useful because the simplicity made it easy to interpret, but an ensemble method like a Random Forest probably makes a better model so let's see what it reveals.</p>
<div class="highlight">
<pre><span></span><span class="n">forest</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="n">FEATURE</span> <span class="o">=</span> <span class="s2">"Goal Scored"</span>
<span class="n">pdp_goals</span> <span class="o">=</span> <span class="n">pdp</span><span class="o">.</span><span class="n">pdp_isolate</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">forest</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">x_validate</span><span class="p">,</span>
                            <span class="n">model_features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="n">FEATURE</span><span class="p">)</span>
<span class="n">pdp</span><span class="o">.</span><span class="n">pdp_plot</span><span class="p">(</span><span class="n">pdp_goals</span><span class="p">,</span> <span class="n">FEATURE</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"pdp_forest_goals_scored.png"</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{output}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="pdp_forest_goals_scored.png" src="/posts/tutorials/partial-dependence-plots/pdp_forest_goals_scored.png"></p>
</div>
<p>So, our random forest says that the greatest gain comes from the first goal, but there is in fact a greater probability as you increase the number of goals scored.</p>
<p>What about distance covered?</p>
<div class="highlight">
<pre><span></span><span class="n">FEATURE</span> <span class="o">=</span> <span class="s2">"Distance Covered (Kms)"</span>
<span class="n">pdp_distance</span> <span class="o">=</span> <span class="n">pdp</span><span class="o">.</span><span class="n">pdp_isolate</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">forest</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">x_validate</span><span class="p">,</span>
                               <span class="n">model_features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">feature</span><span class="o">=</span><span class="n">FEATURE</span><span class="p">)</span>
<span class="n">pdp</span><span class="o">.</span><span class="n">pdp_plot</span><span class="p">(</span><span class="n">pdp_distance</span><span class="p">,</span> <span class="n">FEATURE</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"pdp_forest_distance.png"</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{output}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="pdp_forest_distance.png" src="/posts/tutorials/partial-dependence-plots/pdp_forest_distance.png"></p>
</div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">pdp_distance</span><span class="o">.</span><span class="n">feature_grids</span><span class="p">[</span><span class="n">pdp_distance</span><span class="o">.</span><span class="n">pdp</span><span class="o">.</span><span class="n">argmax</span><span class="p">()])</span>
</pre></div>
<pre class="example">
102.0
</pre>
<p>Our forest says that, once again, covering 102 kilometers maximizes the probability, but in this case it appears that going beyond that actually decreases the probability that your team would have the man of the match.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org4a9192a">
<h3 id="org4a9192a">2D Partial Dependence Plots</h3>
<div class="outline-text-3" id="text-org4a9192a">
<p>Rather than plot a single feature against the probability of becoming the man of the match you can plot how two features interact to affect the probability.</p>
<div class="highlight">
<pre><span></span><span class="n">FEATURES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Goal Scored"</span><span class="p">,</span> <span class="s2">"Distance Covered (Kms)"</span><span class="p">]</span>
<span class="n">interaction</span> <span class="o">=</span> <span class="n">pdp</span><span class="o">.</span><span class="n">pdp_interact</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">tree_model</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">x_validate</span><span class="p">,</span>
                               <span class="n">model_features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
                               <span class="n">features</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">)</span>

<span class="n">pdp</span><span class="o">.</span><span class="n">pdp_interact_plot</span><span class="p">(</span><span class="n">pdp_interact_out</span><span class="o">=</span><span class="n">interaction</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                      <span class="n">plot_type</span><span class="o">=</span><span class="s2">"contour"</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"goals_vs_distance.png"</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{output}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="goals_vs_distance.png" src="/posts/tutorials/partial-dependence-plots/goals_vs_distance.png"></p>
</div>
<p><b>Note:</b> The version of PDPBox on pypi currently has a bug (as of February 8, 2020) that won't let you create the previous plot, install it from github instead.</p>
<p>The plot shows a more succinct version of the two plots we had seen before - the optimal point for these two features is 1 goal and 102 Kms covered.</p>
</div>
<div class="outline-4" id="outline-container-orga122c95">
<h4 id="orga122c95">Forest From the Trees</h4>
<div class="outline-text-4" id="text-orga122c95">
<p>Let's re-run the same plot using the Random Forest instead of the Decision Tree.</p>
<div class="highlight">
<pre><span></span><span class="n">FEATURES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Goal Scored"</span><span class="p">,</span> <span class="s2">"Distance Covered (Kms)"</span><span class="p">]</span>
<span class="n">interaction</span> <span class="o">=</span> <span class="n">pdp</span><span class="o">.</span><span class="n">pdp_interact</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">forest</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">x_validate</span><span class="p">,</span>
                               <span class="n">model_features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
                               <span class="n">features</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">)</span>

<span class="n">pdp</span><span class="o">.</span><span class="n">pdp_interact_plot</span><span class="p">(</span><span class="n">pdp_interact_out</span><span class="o">=</span><span class="n">interaction</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                      <span class="n">plot_type</span><span class="o">=</span><span class="s2">"contour"</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"forest_goals_vs_distance.png"</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{output}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="forest_goals_vs_distance.png" src="/posts/tutorials/partial-dependence-plots/forest_goals_vs_distance.png"></p>
</div>
<p>The random forest suggests a slightly different scenario - here you want 2 gooalds and between 100 and 110 Kms (or thereabouts) covered to get the best probability.</p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org99692f6">
<h2 id="org99692f6">End</h2>
<div class="outline-text-2" id="text-org99692f6">
<p>This showed how to use the PDPBox library to create Partial Dependence Plots to look at how input values for features affects the predicted outcomes. Unfortunately it looks like PDPBox might have been abandoned, but while it works it's a nice library.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/tutorials/exercise-in-permutation-importance/">Exercise in Permutation Importance</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/exercise-in-permutation-importance/" rel="bookmark"><time class="published dt-published" datetime="2020-02-06T10:45:53-08:00" itemprop="datePublished" title="2020-02-06 10:45">2020-02-06 10:45</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#orgff4f4b1">Beginning</a>
<ul>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#org8d90b27">Imports</a>
<ul>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#orgd41ba19">From Python</a></li>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#org7dcac24">From PyPi</a></li>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#org07d0ef7">Others</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#orgc1edd76">Set Up</a>
<ul>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#org5655ebb">A Timer</a></li>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#org7ddc042">Plotting</a></li>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#orgd21c70f">The Environment</a></li>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#org7511931">Table Printer</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#org7cd1f31">Middle</a>
<ul>
<li>
<ul>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#org867a504">The Dataset</a></li>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#org7332599">Set Up the Training and Test Sets</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#org26c4252">Build and Train the Model</a></li>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#org3197a2f">Questions</a>
<ul>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#orgac1e9b9">Question 1</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#org43e2099">A New Model</a>
<ul>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#org93e0df7">Question 4</a></li>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#org885887f">Feature Engineering</a></li>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#org2c476b2">The Permutation Importance</a></li>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#org5c8c6e8">Question 5</a></li>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#orgfd92676">Question 6</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#org596b4cd">Euclidean Distance</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/exercise-in-permutation-importance/#org678d685">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgff4f4b1">
<h2 id="orgff4f4b1">Beginning</h2>
<div class="outline-text-2" id="text-orgff4f4b1">
<p>This is my re-do of the <a href="https://www.kaggle.com/learn/machine-learning-explainability">Machine Learning Explainability</a> Permutation Importance exercise on kaggle. It uses the data from the <a href="https://www.kaggle.com/c/new-york-city-taxi-fare-prediction/data">New York City Taxi Fare Prediction</a> dataset on kaggle.</p>
</div>
<div class="outline-3" id="outline-container-org8d90b27">
<h3 id="org8d90b27">Imports</h3>
<div class="outline-text-3" id="text-org8d90b27"></div>
<div class="outline-4" id="outline-container-orgd41ba19">
<h4 id="orgd41ba19">From Python</h4>
<div class="outline-text-4" id="text-orgd41ba19">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org7dcac24">
<h4 id="org7dcac24">From PyPi</h4>
<div class="outline-text-4" id="text-org7dcac24">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">eli5.sklearn</span> <span class="kn">import</span> <span class="n">PermutationImportance</span>

<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">RandomizedSearchCV</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">import</span> <span class="nn">eli5</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org07d0ef7">
<h4 id="org07d0ef7">Others</h4>
<div class="outline-text-4" id="text-org07d0ef7">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">EnvironmentLoader</span><span class="p">,</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgc1edd76">
<h3 id="orgc1edd76">Set Up</h3>
<div class="outline-text-3" id="text-orgc1edd76"></div>
<div class="outline-4" id="outline-container-org5655ebb">
<h4 id="org5655ebb">A Timer</h4>
<div class="outline-text-4" id="text-org5655ebb">
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org7ddc042">
<h4 id="org7ddc042">Plotting</h4>
<div class="outline-text-4" id="text-org7ddc042">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"exercise-in-permutation-importance"</span>
<span class="n">PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"../../files/posts/tutorials/"</span><span class="p">)</span><span class="o">/</span><span class="n">SLUG</span>
<span class="n">Plot</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="n">PATH</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgd21c70f">
<h4 id="orgd21c70f">The Environment</h4>
<div class="outline-text-4" id="text-orgd21c70f">
<div class="highlight">
<pre><span></span><span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="n">EnvironmentLoader</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org7511931">
<h4 id="org7511931">Table Printer</h4>
<div class="outline-text-4" id="text-org7511931">
<div class="highlight">
<pre><span></span><span class="n">TABLE</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">tabulate</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">,</span> <span class="n">showindex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org7cd1f31">
<h2 id="org7cd1f31">Middle</h2>
<div class="outline-text-2" id="text-org7cd1f31"></div>
<div class="outline-4" id="outline-container-org867a504">
<h4 id="org867a504">The Dataset</h4>
<div class="outline-text-4" id="text-org867a504">
<p>Since this is about permutation importance we're just going to load a subset (there are over five million rows in the dataset) and use previously discovered values to get rid of outliers.</p>
<div class="highlight">
<pre><span></span><span class="n">ROWS</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">4</span>
<span class="n">PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ENVIRONMENT</span><span class="p">[</span><span class="s2">"NY-TAXI"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">PATH</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">PATH</span><span class="o">/</span><span class="s2">"train.csv"</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">ROWS</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span>
    <span class="s2">"index"</span><span class="p">:</span> <span class="s2">"Column"</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s2">"Value"</span><span class="p">})))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Column</th>
<th class="org-right" scope="col">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">key</td>
<td class="org-right">2009-06-15 17:26:21.0000001</td>
</tr>
<tr>
<td class="org-left">fare_amount</td>
<td class="org-right">4.5</td>
</tr>
<tr>
<td class="org-left">pickup_datetime</td>
<td class="org-right">2009-06-15 17:26:21 UTC</td>
</tr>
<tr>
<td class="org-left">pickup_longitude</td>
<td class="org-right">-73.844311</td>
</tr>
<tr>
<td class="org-left">pickup_latitude</td>
<td class="org-right">40.721319</td>
</tr>
<tr>
<td class="org-left">dropoff_longitude</td>
<td class="org-right">-73.84161</td>
</tr>
<tr>
<td class="org-left">dropoff_latitude</td>
<td class="org-right">40.712278000000005</td>
</tr>
<tr>
<td class="org-left">passenger_count</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>
</div>
<ul class="org-ul">
<li><a id="org4ad6cb1"></a>Trim Outliers<br>
<div class="outline-text-5" id="text-org4ad6cb1">
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">describe</span><span class="p">(),</span> <span class="n">showindex</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">fare_amount</th>
<th class="org-right" scope="col">pickup_longitude</th>
<th class="org-right" scope="col">pickup_latitude</th>
<th class="org-right" scope="col">dropoff_longitude</th>
<th class="org-right" scope="col">dropoff_latitude</th>
<th class="org-right" scope="col">passenger_count</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">count</td>
<td class="org-right">50000</td>
<td class="org-right">50000</td>
<td class="org-right">50000</td>
<td class="org-right">50000</td>
<td class="org-right">50000</td>
<td class="org-right">50000</td>
</tr>
<tr>
<td class="org-left">mean</td>
<td class="org-right">11.3642</td>
<td class="org-right">-72.5098</td>
<td class="org-right">39.9338</td>
<td class="org-right">-72.5046</td>
<td class="org-right">39.9263</td>
<td class="org-right">1.66784</td>
</tr>
<tr>
<td class="org-left">std</td>
<td class="org-right">9.68556</td>
<td class="org-right">10.3939</td>
<td class="org-right">6.22486</td>
<td class="org-right">10.4076</td>
<td class="org-right">6.01474</td>
<td class="org-right">1.28919</td>
</tr>
<tr>
<td class="org-left">min</td>
<td class="org-right">-5</td>
<td class="org-right">-75.4238</td>
<td class="org-right">-74.0069</td>
<td class="org-right">-84.6542</td>
<td class="org-right">-74.0064</td>
<td class="org-right">0</td>
</tr>
<tr>
<td class="org-left">25%</td>
<td class="org-right">6</td>
<td class="org-right">-73.9921</td>
<td class="org-right">40.7349</td>
<td class="org-right">-73.9912</td>
<td class="org-right">40.7344</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-left">50%</td>
<td class="org-right">8.5</td>
<td class="org-right">-73.9818</td>
<td class="org-right">40.7527</td>
<td class="org-right">-73.9801</td>
<td class="org-right">40.7534</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-left">75%</td>
<td class="org-right">12.5</td>
<td class="org-right">-73.9671</td>
<td class="org-right">40.7674</td>
<td class="org-right">-73.9636</td>
<td class="org-right">40.7682</td>
<td class="org-right">2</td>
</tr>
<tr>
<td class="org-left">max</td>
<td class="org-right">200</td>
<td class="org-right">40.7835</td>
<td class="org-right">401.083</td>
<td class="org-right">40.851</td>
<td class="org-right">43.4152</td>
<td class="org-right">6</td>
</tr>
</tbody>
</table>
<div class="highlight">
<pre><span></span><span class="n">to_plot</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>
                <span class="k">if</span> <span class="s2">"latitude"</span> <span class="ow">in</span> <span class="n">column</span> <span class="ow">or</span> <span class="s2">"longitude"</span> <span class="ow">in</span> <span class="n">column</span><span class="p">]]</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">to_plot</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">box</span><span class="p">()</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Column Box-Plots"</span><span class="p">,</span>
                                 <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
                                 <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
<span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"column_box_plots"</span><span class="p">)()</span>
</pre></div>
<object data="/posts/tutorials/exercise-in-permutation-importance/column_box_plots.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>So you can see that there are negative fares, which seems wrong, and some outliers.</p>
<p>This uses the pandas <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.query.html">query</a> method which let's you write slightly more readable code for boolean slicing.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"{len(data):,}"</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">"pickup_latitude &gt; 40.7 and pickup_latitude &lt; 40.8 and "</span> <span class="o">+</span>
                  <span class="s2">"dropoff_latitude &gt; 40.7 and dropoff_latitude &lt; 40.8 and "</span> <span class="o">+</span>
                  <span class="s2">"pickup_longitude &gt; -74 and pickup_longitude &lt; -73.9 and "</span> <span class="o">+</span>
                  <span class="s2">"dropoff_longitude &gt; -74 and dropoff_longitude &lt; -73.9 and "</span> <span class="o">+</span>
                  <span class="s2">"fare_amount &gt; 0"</span>
                  <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"{len(data):,}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
50,000
31,289
</pre></div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-org7332599">
<h4 id="org7332599">Set Up the Training and Test Sets</h4>
<div class="outline-text-4" id="text-org7332599">
<div class="highlight">
<pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">fare_amount</span>
<span class="n">base_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'pickup_longitude'</span><span class="p">,</span>
                 <span class="s1">'pickup_latitude'</span><span class="p">,</span>
                 <span class="s1">'dropoff_longitude'</span><span class="p">,</span>
                 <span class="s1">'dropoff_latitude'</span><span class="p">,</span>
                 <span class="s1">'passenger_count'</span><span class="p">]</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">base_features</span><span class="p">]</span>
<span class="n">x_train</span><span class="p">,</span> <span class="n">x_validate</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_validate</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"{len(x_train):,}"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"{len(x_validate):,}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
23,466
7,823
</pre></div>
</div>
<div class="outline-3" id="outline-container-org26c4252">
<h3 id="org26c4252">Build and Train the Model</h3>
<div class="outline-text-3" id="text-org26c4252">
<div class="highlight">
<pre><span></span><span class="n">estimators</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">max_depth</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

<span class="n">grid</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">estimators</span><span class="p">,</span>
            <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span>
<span class="n">search</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                            <span class="n">param_distributions</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
                            <span class="n">n_iter</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                            <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">first_model</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"CV Training R^2: </span><span class="si">{search.best_score_:0.2f}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Training R^2: {first_model.score(x_train, y_train): 0.2f}"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Validation R^2: {first_model.score(x_validate, y_validate):0.2f}"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
</pre></div>
<pre class="example">
2020-02-10 13:40:59,617 graeae.timers.timer start: Started: 2020-02-10 13:40:59.616742
/home/brunhilde/.virtualenvs/Visions-Voices-Data/lib/python3.7/site-packages/sklearn/model_selection/_split.py:1978: FutureWarning: The default value of cv will change from 3 to 5 in version 0.22. Specify it explicitly to silence this warning.
  warnings.warn(CV_WARNING, FutureWarning)
/home/brunhilde/.virtualenvs/Visions-Voices-Data/lib/python3.7/site-packages/joblib/externals/loky/process_executor.py:706: UserWarning: A worker stopped while some jobs were given to the executor. This can be caused by a too short worker timeout or by a memory leak.
  "timeout or by a memory leak.", UserWarning
2020-02-10 13:42:04,387 graeae.timers.timer end: Ended: 2020-02-10 13:42:04.387425
2020-02-10 13:42:04,390 graeae.timers.timer end: Elapsed: 0:01:04.770683
CV Training R^2: 0.45
Training R^2:  0.92
Validation R^2: 0.42
{'n_estimators': 170, 'max_depth': 70}
</pre>
<p>So it isn't really a great model, but we'll ignore that for now.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org3197a2f">
<h3 id="org3197a2f">Questions</h3>
<div class="outline-text-3" id="text-org3197a2f"></div>
<div class="outline-4" id="outline-container-orgac1e9b9">
<h4 id="orgac1e9b9">Question 1</h4>
<div class="outline-text-4" id="text-orgac1e9b9">
<blockquote>
<p>The first model uses the following features:</p>
<ul class="org-ul">
<li>pickup_longitude</li>
<li>pickup_latitude</li>
<li>dropoff_longitude</li>
<li>dropoff_latitude</li>
<li>passenger_count</li>
</ul>
<p>Before running any code… which variables seem potentially useful for predicting taxi fares? Do you think permutation importance will necessarily identify these features as important?</p>
</blockquote>
<p>I think that pickup and dropoff latitude might be important, since this would reflect where in the city the person was and wanted to go. Passenger count might make a difference as well, but I don't know if there's a greater charge for more people. Longitude might also be useful, but my guess would be that the North-South location is more indicative of the type of place you are in (uptown or downtown) and thus how far you have to travel (I have a vague notion that New York City is longer vertically than horizontally, but I don't know if this is true). This would be even more important if the fares change by location, but I don't know if that's the case.</p>
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">permutor</span> <span class="o">=</span> <span class="n">PermutationImportance</span><span class="p">(</span><span class="n">first_model</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">x_validate</span><span class="p">,</span> <span class="n">y_validate</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">ipython_html</span> <span class="o">=</span> <span class="n">eli5</span><span class="o">.</span><span class="n">show_weights</span><span class="p">(</span><span class="n">permutor</span><span class="p">,</span>
                                 <span class="n">feature_names</span><span class="o">=</span><span class="n">x_validate</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="n">ipython_html</span><span class="o">.</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">table</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Weight</th>
<th class="org-left" scope="col">Feature</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">0.8413 ± 0.0171</td>
<td class="org-left">dropoff_latitude</td>
</tr>
<tr>
<td class="org-left">0.8135 ± 0.0223</td>
<td class="org-left">pickup_latitude</td>
</tr>
<tr>
<td class="org-left">0.5723 ± 0.0370</td>
<td class="org-left">pickup_longitude</td>
</tr>
<tr>
<td class="org-left">0.5324 ± 0.0257</td>
<td class="org-left">dropoff_longitude</td>
</tr>
<tr>
<td class="org-left">-0.0014 ± 0.0015</td>
<td class="org-left">passenger_count</td>
</tr>
</tbody>
</table>
<p>So it looks like latitude and longitude are important, with latitude a little more important than longitude and passenger count isn't important.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org43e2099">
<h3 id="org43e2099">A New Model</h3>
<div class="outline-text-3" id="text-org43e2099"></div>
<div class="outline-4" id="outline-container-org93e0df7">
<h4 id="org93e0df7">Question 4</h4>
<div class="outline-text-4" id="text-org93e0df7">
<blockquote>
<p>Without detailed knowledge of New York City, it's difficult to rule out most hypotheses about why latitude features matter more than longitude.</p>
<p>A good next step is to disentangle the effect of being in certain parts of the city from the effect of total distance traveled.</p>
<p>The code below creates new features for longitudinal and latitudinal distance. It then builds a model that adds these new features to those you already had.</p>
</blockquote>
</div>
</div>
<div class="outline-4" id="outline-container-org885887f">
<h4 id="org885887f">Feature Engineering</h4>
<div class="outline-text-4" id="text-org885887f">
<p>We're going to estimate the distance traveled by using the differences in latitude and longitude from the pickup to the dropoff. This should give us a taxicab-distance estimate.</p>
<div class="highlight">
<pre><span></span><span class="n">data</span><span class="p">[</span><span class="s1">'absolute_change_longitude'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span>
    <span class="n">data</span><span class="o">.</span><span class="n">dropoff_longitude</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">pickup_longitude</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s1">'absolute_change_latitude'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span>
    <span class="n">data</span><span class="o">.</span><span class="n">dropoff_latitude</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">pickup_latitude</span><span class="p">)</span>

<span class="n">features_2</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">'pickup_longitude'</span><span class="p">,</span>
               <span class="s1">'pickup_latitude'</span><span class="p">,</span>
               <span class="s1">'dropoff_longitude'</span><span class="p">,</span>
               <span class="s1">'dropoff_latitude'</span><span class="p">,</span>
               <span class="s1">'absolute_change_latitude'</span><span class="p">,</span>
               <span class="s1">'absolute_change_longitude'</span><span class="p">]</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">features_2</span><span class="p">]</span>
<span class="n">new_x_train</span><span class="p">,</span> <span class="n">new_x_validate</span><span class="p">,</span> <span class="n">new_y_train</span><span class="p">,</span> <span class="n">new_y_validate</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">estimators</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">max_depth</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span>
<span class="n">search</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                            <span class="n">param_distributions</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
                            <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">new_x_train</span><span class="p">,</span> <span class="n">new_y_train</span><span class="p">)</span>

<span class="n">second_model</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Mean Cross-Validation Training R^2: </span><span class="si">{search.best_score_:0.2f}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Training R^2: {second_model.score(new_x_train, new_y_train): 0.2f}"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Validation R^2: "</span>
      <span class="sa">f</span><span class="s2">"{second_model.score(new_x_validate, new_y_validate):0.2f}"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
</pre></div>
<pre class="example">
2020-02-10 13:42:52,104 graeae.timers.timer start: Started: 2020-02-10 13:42:52.104493
/home/brunhilde/.virtualenvs/Visions-Voices-Data/lib/python3.7/site-packages/sklearn/model_selection/_split.py:1978: FutureWarning: The default value of cv will change from 3 to 5 in version 0.22. Specify it explicitly to silence this warning.
  warnings.warn(CV_WARNING, FutureWarning)
2020-02-10 13:43:24,554 graeae.timers.timer end: Ended: 2020-02-10 13:43:24.554581
2020-02-10 13:43:24,556 graeae.timers.timer end: Elapsed: 0:00:32.450088
Mean Cross-Validation Training R^2: 0.48
Training R^2:  0.70
Validation R^2: 0.47
{'n_estimators': 190, 'max_depth': 10}
</pre>
<p>Still a pretty bad model, but that's not the point, I guess.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org2c476b2">
<h4 id="org2c476b2">The Permutation Importance</h4>
<div class="outline-text-4" id="text-org2c476b2">
<div class="highlight">
<pre><span></span><span class="n">permutor</span> <span class="o">=</span> <span class="n">PermutationImportance</span><span class="p">(</span><span class="n">second_model</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">new_x_validate</span><span class="p">,</span> <span class="n">new_y_validate</span><span class="p">)</span>
<span class="n">ipython_html</span> <span class="o">=</span> <span class="n">eli5</span><span class="o">.</span><span class="n">show_weights</span><span class="p">(</span><span class="n">permutor</span><span class="p">,</span>
                                 <span class="n">feature_names</span><span class="o">=</span><span class="n">new_x_validate</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="n">ipython_html</span><span class="o">.</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">table</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Weight</th>
<th class="org-left" scope="col">Feature</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">0.5976 ± 0.0306</td>
<td class="org-left">absolute_change_latitude</td>
</tr>
<tr>
<td class="org-left">0.4429 ± 0.0496</td>
<td class="org-left">absolute_change_longitude</td>
</tr>
<tr>
<td class="org-left">0.0339 ± 0.0216</td>
<td class="org-left">pickup_latitude</td>
</tr>
<tr>
<td class="org-left">0.0232 ± 0.0032</td>
<td class="org-left">dropoff_latitude</td>
</tr>
<tr>
<td class="org-left">0.0214 ± 0.0068</td>
<td class="org-left">dropoff_longitude</td>
</tr>
<tr>
<td class="org-left">0.0159 ± 0.0055</td>
<td class="org-left">pickup_longitude</td>
</tr>
</tbody>
</table>
<p>The distance traveled seems to be the most important feature for the fare, even more than the actual locations, probably because taxis charge by distance.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org5c8c6e8">
<h4 id="org5c8c6e8">Question 5</h4>
<div class="outline-text-4" id="text-org5c8c6e8">
<p>This question is about the scale of the parameters. Here's a sample.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">new_x_train</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">index</th>
<th class="org-right" scope="col">31975</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">pickup_longitude</td>
<td class="org-right">-73.9706</td>
</tr>
<tr>
<td class="org-left">pickup_latitude</td>
<td class="org-right">40.7613</td>
</tr>
<tr>
<td class="org-left">dropoff_longitude</td>
<td class="org-right">-73.9806</td>
</tr>
<tr>
<td class="org-left">dropoff_latitude</td>
<td class="org-right">40.7483</td>
</tr>
<tr>
<td class="org-left">absolute_change_latitude</td>
<td class="org-right">0.01302</td>
</tr>
<tr>
<td class="org-left">absolute_change_longitude</td>
<td class="org-right">0.010067</td>
</tr>
</tbody>
</table>
<p>And here's some statistics about each.</p>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">new_x_validate</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</pre></div>
<pre class="example">
       pickup_longitude  pickup_latitude  dropoff_longitude  dropoff_latitude  \
count       7823.000000      7823.000000        7823.000000       7823.000000   
mean         -73.976957        40.756877         -73.975293         40.757591   
std            0.014663         0.018064           0.015877          0.018669   
min          -73.999977        40.700400         -73.999992         40.700293   
25%          -73.988180        40.745044         -73.987078         40.746345   
50%          -73.979933        40.757881         -73.978427         40.758602   
75%          -73.968008        40.769486         -73.966296         40.770561   
max          -73.900123        40.799865         -73.901790         40.799984   

       absolute_change_latitude  absolute_change_longitude  
count               7823.000000                7823.000000  
mean                   0.015091                   0.013029  
std                    0.012508                   0.011554  
min                    0.000000                   0.000000  
25%                    0.006089                   0.004968  
50%                    0.011745                   0.010110  
75%                    0.020781                   0.017798  
max                    0.084413                   0.087337  
</pre>
<blockquote>
<p>A colleague observes that the values for <code>absolute_change_longitude</code> and <code>absolute_change_latitude</code> are pretty small (all values are between -0.1 and 0.1), whereas other variables have larger values. Do you think this could explain why those coordinates had larger permutation importance values in this case?</p>
<p>Consider an alternative where you created and used a feature that was 100X as large for these features, and used that larger feature for training and importance calculations. Would this change the outputted permutation importance values?</p>
<p>Why or why not?</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">"pickup_longitude pickup_latitude dropoff_longitude "</span>
               <span class="s2">"dropoff_latitude absolute_change_latitude "</span>
               <span class="s2">"absolute_change_longitude"</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{column}</span><span class="s2">: {new_x_validate[column].max() - new_x_validate[column].min():0.3f}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
pickup_longitude: 0.100
pickup_latitude: 0.099
dropoff_longitude: 0.098
dropoff_latitude: 0.100
absolute_change_latitude: 0.084
absolute_change_longitude: 0.087
</pre>
<p>Intuitively I would think that the difference in the scales would make a difference.</p>
<div class="highlight">
<pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">"bigger_pickup_longitude"</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pickup_longitude</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">data</span><span class="p">[</span><span class="s2">"bigger_absolute_change_longitude"</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">absolute_change_longitude</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">features_3</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">'pickup_longitude'</span><span class="p">,</span>
               <span class="s1">'pickup_latitude'</span><span class="p">,</span>
               <span class="s1">'dropoff_longitude'</span><span class="p">,</span>
               <span class="s1">'dropoff_latitude'</span><span class="p">,</span>
               <span class="s1">'absolute_change_latitude'</span><span class="p">,</span>
               <span class="s1">'absolute_change_longitude'</span><span class="p">,</span>
               <span class="s1">'bigger_pickup_longitude'</span><span class="p">,</span>
               <span class="s1">'bigger_absolute_change_longitude'</span>
               <span class="p">]</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">features_3</span><span class="p">]</span>
<span class="n">big_x_train</span><span class="p">,</span> <span class="n">big_x_validate</span><span class="p">,</span> <span class="n">big_y_train</span><span class="p">,</span> <span class="n">big_y_validate</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span>
<span class="n">search</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                            <span class="n">param_distributions</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
                            <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">big_x_train</span><span class="p">,</span> <span class="n">big_y_train</span><span class="p">)</span>
<span class="n">big_model</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Mean Cross-Validation Training R^2: </span><span class="si">{search.best_score_:0.2f}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Training R^2: {big_model.score(big_x_train, big_y_train): 0.2f}"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Validation R^2: "</span>
      <span class="sa">f</span><span class="s2">"{big_model.score(big_x_validate, big_y_validate):0.2f}"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
</pre></div>
<pre class="example">
2020-02-09 15:06:45,693 graeae.timers.timer start: Started: 2020-02-09 15:06:45.693742
/home/athena/.virtualenvs/Visions-Voices-Data/lib/python3.7/site-packages/joblib/externals/loky/process_executor.py:706: UserWarning: A worker stopped while some jobs were given to the executor. This can be caused by a too short worker timeout or by a memory leak.
  "timeout or by a memory leak.", UserWarning
2020-02-09 15:09:15,559 graeae.timers.timer end: Ended: 2020-02-09 15:09:15.559561
2020-02-09 15:09:15,560 graeae.timers.timer end: Elapsed: 0:02:29.865819
Mean Cross-Validation Training R^2: 0.49
Training R^2:  0.70
Validation R^2: 0.47
{'n_estimators': 190, 'max_depth': 10}
</pre>
<div class="highlight">
<pre><span></span><span class="n">permutor</span> <span class="o">=</span> <span class="n">PermutationImportance</span><span class="p">(</span><span class="n">big_model</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">big_x_validate</span><span class="p">,</span> <span class="n">big_y_validate</span><span class="p">)</span>
<span class="n">ipython_html</span> <span class="o">=</span> <span class="n">eli5</span><span class="o">.</span><span class="n">show_weights</span><span class="p">(</span><span class="n">permutor</span><span class="p">,</span>
                                 <span class="n">feature_names</span><span class="o">=</span><span class="n">big_x_validate</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="n">ipython_html</span><span class="o">.</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">table</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Weight</th>
<th class="org-left" scope="col">Feature</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">0.6034 ± 0.0436</td>
<td class="org-left">absolute_change_latitude</td>
</tr>
<tr>
<td class="org-left">0.1794 ± 0.0126</td>
<td class="org-left">bigger_absolute_change_longitude</td>
</tr>
<tr>
<td class="org-left">0.1366 ± 0.0062</td>
<td class="org-left">absolute_change_longitude</td>
</tr>
<tr>
<td class="org-left">0.0326 ± 0.0217</td>
<td class="org-left">pickup_latitude</td>
</tr>
<tr>
<td class="org-left">0.0242 ± 0.0040</td>
<td class="org-left">dropoff_latitude</td>
</tr>
<tr>
<td class="org-left">0.0194 ± 0.0083</td>
<td class="org-left">dropoff_longitude</td>
</tr>
<tr>
<td class="org-left">0.0188 ± 0.0085</td>
<td class="org-left">pickup_longitude</td>
</tr>
<tr>
<td class="org-left">0.0116 ± 0.0018</td>
<td class="org-left">bigger_pickup_longitude</td>
</tr>
</tbody>
</table>
<p>Making the pickup longitude didn't change its ranking relative to the other features so I wouldn't say that the scale had an effect.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgfd92676">
<h4 id="orgfd92676">Question 6</h4>
<div class="outline-text-4" id="text-orgfd92676">
<blockquote>
<p>You've seen that the feature importance for latitudinal distance is greater than the importance of longitudinal distance. From this, can we conclude whether travelling a fixed latitudinal distance tends to be more expensive than traveling the same longitudinal distance?</p>
</blockquote>
<p>No, the feature importance indicates that it is useful in predicting fares, but it doesn't automatically mean that the fares will increase with the change in latitude. It might be the case that the change in longitude affects the cost of a change in latitude as well, so a fixed latitude distance might change depending on the longitude or latitude + longitude combination.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org596b4cd">
<h3 id="org596b4cd">Euclidean Distance</h3>
<div class="outline-text-3" id="text-org596b4cd">
<p>Instead of keeping latitudinal and longitudinal distances separate, what if we used the euclidean distance?</p>
<div class="highlight">
<pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">"euclidean_distance"</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">absolute_change_latitude</span><span class="o">**</span><span class="mi">2</span>
                                        <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">absolute_change_longitude</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">features</span>  <span class="o">=</span> <span class="p">[</span><span class="s1">'pickup_longitude'</span><span class="p">,</span>
               <span class="s1">'pickup_latitude'</span><span class="p">,</span>
               <span class="s1">'dropoff_longitude'</span><span class="p">,</span>
               <span class="s1">'dropoff_latitude'</span><span class="p">,</span>
               <span class="s1">'absolute_change_latitude'</span><span class="p">,</span>
               <span class="s1">'absolute_change_longitude'</span><span class="p">,</span>
               <span class="s2">"euclidean_distance"</span><span class="p">,</span>
               <span class="p">]</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">features</span><span class="p">]</span>
<span class="n">euclid_x_train</span><span class="p">,</span> <span class="n">euclid_x_validate</span><span class="p">,</span> <span class="n">euclid_y_train</span><span class="p">,</span> <span class="n">euclid_y_validate</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">()</span>
<span class="n">search</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                            <span class="n">param_distributions</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
                            <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">euclid_x_train</span><span class="p">,</span> <span class="n">euclid_y_train</span><span class="p">)</span>
<span class="n">euclidean_model</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Mean Cross-Validation Training R^2: </span><span class="si">{search.best_score_:0.2f}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Training R^2: {euclidean_model.score(euclid_x_train, euclid_y_train): 0.2f}"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Validation R^2: "</span>
      <span class="sa">f</span><span class="s2">"{euclidean_model.score(euclid_x_validate, euclid_y_validate):0.2f}"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
</pre></div>
<pre class="example">
2020-02-10 14:23:41,605 graeae.timers.timer start: Started: 2020-02-10 14:23:41.605310
/home/brunhilde/.virtualenvs/Visions-Voices-Data/lib/python3.7/site-packages/sklearn/model_selection/_split.py:1978: FutureWarning: The default value of cv will change from 3 to 5 in version 0.22. Specify it explicitly to silence this warning.
  warnings.warn(CV_WARNING, FutureWarning)
2020-02-10 14:24:20,385 graeae.timers.timer end: Ended: 2020-02-10 14:24:20.385580
2020-02-10 14:24:20,388 graeae.timers.timer end: Elapsed: 0:00:38.780270
Mean Cross-Validation Training R^2: 0.48
Training R^2:  0.74
Validation R^2: 0.48
{'n_estimators': 190, 'max_depth': 10}
</pre>
<p>Interestingly, the training \(R^2\) score went down although there was a slight improvement in the validation \(R^2\).</p>
<div class="highlight">
<pre><span></span><span class="n">permutor</span> <span class="o">=</span> <span class="n">PermutationImportance</span><span class="p">(</span><span class="n">euclidean_model</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
    <span class="n">euclid_x_validate</span><span class="p">,</span> <span class="n">euclid_y_validate</span><span class="p">)</span>
<span class="n">ipython_html</span> <span class="o">=</span> <span class="n">eli5</span><span class="o">.</span><span class="n">show_weights</span><span class="p">(</span>
    <span class="n">permutor</span><span class="p">,</span>
    <span class="n">feature_names</span><span class="o">=</span><span class="n">euclid_x_validate</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="n">ipython_html</span><span class="o">.</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">table</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Weight</th>
<th class="org-left" scope="col">Feature</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">1.3370 ± 0.0469</td>
<td class="org-left">euclidean_distance</td>
</tr>
<tr>
<td class="org-left">0.3031 ± 0.0076</td>
<td class="org-left">absolute_change_latitude</td>
</tr>
<tr>
<td class="org-left">0.1179 ± 0.0046</td>
<td class="org-left">absolute_change_longitude</td>
</tr>
<tr>
<td class="org-left">0.0261 ± 0.0045</td>
<td class="org-left">dropoff_latitude</td>
</tr>
<tr>
<td class="org-left">0.0224 ± 0.0140</td>
<td class="org-left">dropoff_longitude</td>
</tr>
<tr>
<td class="org-left">0.0219 ± 0.0041</td>
<td class="org-left">pickup_longitude</td>
</tr>
<tr>
<td class="org-left">0.0183 ± 0.0051</td>
<td class="org-left">pickup_latitude</td>
</tr>
</tbody>
</table>
<p>According to the permutation importance, euclidean distance is much more important than the separate distances.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org678d685">
<h2 id="org678d685">End</h2>
<div class="outline-text-2" id="text-org678d685">
<p>The suggested next tutorial is about <a href="https://www.kaggle.com/dansbecker/partial-plots">Partial Dependence Plots</a>.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/tutorials/permutation-importance/">Permutation Importance</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/permutation-importance/" rel="bookmark"><time class="published dt-published" datetime="2020-02-05T12:33:20-08:00" itemprop="datePublished" title="2020-02-05 12:33">2020-02-05 12:33</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/permutation-importance/#org6d9288b">Beginning</a>
<ul>
<li><a href="/posts/tutorials/permutation-importance/#org1b02db6">Imports</a>
<ul>
<li><a href="/posts/tutorials/permutation-importance/#org3b23d35">Python</a></li>
<li><a href="/posts/tutorials/permutation-importance/#orgf135ffb">PyPi</a></li>
<li><a href="/posts/tutorials/permutation-importance/#orgda3f5c0">Others</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/permutation-importance/#org58df24c">Set Up</a>
<ul>
<li><a href="/posts/tutorials/permutation-importance/#org94ead59">Plotting</a></li>
<li><a href="/posts/tutorials/permutation-importance/#org3617fbc">The Environment</a></li>
<li><a href="/posts/tutorials/permutation-importance/#orga64ee47">The Table Printer</a></li>
<li><a href="/posts/tutorials/permutation-importance/#orgf35ea90">The Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/permutation-importance/#orgdea3d2d">Middle</a>
<ul>
<li><a href="/posts/tutorials/permutation-importance/#org20cb4d5">Looking at the Dataset</a>
<ul>
<li><a href="/posts/tutorials/permutation-importance/#orgd3c05ef">The Target</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/permutation-importance/#orgb15040b">The Features</a></li>
<li><a href="/posts/tutorials/permutation-importance/#org39f8931">Build and Train the Model</a></li>
<li><a href="/posts/tutorials/permutation-importance/#org8e4f2b9">Permutation Importance</a>
<ul>
<li><a href="/posts/tutorials/permutation-importance/#orgaca3b2d">Plotting the Importance</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/permutation-importance/#org67cb970">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org6d9288b">
<h2 id="org6d9288b">Beginning</h2>
<div class="outline-text-2" id="text-org6d9288b">
<p>This is some notes on the kaggle tutorial on <a href="https://www.kaggle.com/dansbecker/permutation-importance">Permutation Importance</a>. <i>Permutation Importance</i> is a form of feature selection where you ask - <i>If you randomly shuffle the values one column in the dataset and leave the others in place, how does this affect the performance of the model?</i>. The idea is that if the column is important, then shuffling the values should make the model perform worse, so you can measure how much it degrades after you shuffle each column and figure out which columns are contributing to the model. Here's the rough process:</p>
<ol class="org-ol">
<li>Start with a trained model and a labeled dataset.</li>
<li>Shuffle a single column</li>
<li>Measure how much worse the model does predicting the target.</li>
<li>Restore the column and move on to the next column, repeating the steps until you have covered all the columns.</li>
</ol>
</div>
<div class="outline-3" id="outline-container-org1b02db6">
<h3 id="org1b02db6">Imports</h3>
<div class="outline-text-3" id="text-org1b02db6"></div>
<div class="outline-4" id="outline-container-org3b23d35">
<h4 id="org3b23d35">Python</h4>
<div class="outline-text-4" id="text-org3b23d35">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgf135ffb">
<h4 id="orgf135ffb">PyPi</h4>
<div class="outline-text-4" id="text-orgf135ffb"></div>
<ul class="org-ul">
<li><a id="org4cda133"></a>eli5<br>
<div class="outline-text-5" id="text-org4cda133">
<p><a href="https://eli5.readthedocs.io/en/latest/">eli5</a> (which is presumably short for <a href="https://www.dictionary.com/e/slang/eli5/">explain it like I'm five</a>) is a library to help with machine learning model debugging and visualization. You can read about the PermutationImportance class <a href="https://eli5.readthedocs.io/en/latest/autodocs/sklearn.html#eli5.sklearn.permutation_importance.PermutationImportance">here</a>.</p>
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">eli5.sklearn</span> <span class="kn">import</span> <span class="n">PermutationImportance</span>
<span class="kn">import</span> <span class="nn">eli5</span>
</pre></div>
</div>
</li>
<li><a id="orge399d29"></a>sklearn<br>
<div class="outline-text-5" id="text-orge399d29">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-orgda3f5c0">
<h4 id="orgda3f5c0">Others</h4>
<div class="outline-text-4" id="text-orgda3f5c0">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">CountPercentage</span><span class="p">,</span> <span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">EnvironmentLoader</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org58df24c">
<h3 id="org58df24c">Set Up</h3>
<div class="outline-text-3" id="text-org58df24c"></div>
<div class="outline-4" id="outline-container-org94ead59">
<h4 id="org94ead59">Plotting</h4>
<div class="outline-text-4" id="text-org94ead59">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"permutation-importance"</span>
<span class="n">PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"../../files/posts/tutorials/"</span><span class="p">)</span><span class="o">/</span><span class="n">SLUG</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="n">PATH</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org3617fbc">
<h4 id="org3617fbc">The Environment</h4>
<div class="outline-text-4" id="text-org3617fbc">
<div class="highlight">
<pre><span></span><span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="n">EnvironmentLoader</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orga64ee47">
<h4 id="orga64ee47">The Table Printer</h4>
<div class="outline-text-4" id="text-orga64ee47">
<div class="highlight">
<pre><span></span><span class="n">TABLE</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">tabulate</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">,</span> <span class="n">showindex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgf35ea90">
<h4 id="orgf35ea90">The Data</h4>
<div class="outline-text-4" id="text-orgf35ea90">
<p>The dataset here is the <a href="https://www.kaggle.com/mathan/fifa-2018-match-statistics">Predict FIFA 2018 Man of the Match</a> dataset from kaggle.</p>
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ENVIRONMENT</span><span class="p">[</span><span class="s2">"FIFA-2018"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgdea3d2d">
<h2 id="orgdea3d2d">Middle</h2>
<div class="outline-text-2" id="text-orgdea3d2d"></div>
<div class="outline-3" id="outline-container-org20cb4d5">
<h3 id="org20cb4d5">Looking at the Dataset</h3>
<div class="outline-text-3" id="text-org20cb4d5">
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(),</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"Column Value"</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Column</th>
<th class="org-right" scope="col">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Date</td>
<td class="org-right">20-06-2018</td>
</tr>
<tr>
<td class="org-left">Team</td>
<td class="org-right">Uruguay</td>
</tr>
<tr>
<td class="org-left">Opponent</td>
<td class="org-right">Saudi Arabia</td>
</tr>
<tr>
<td class="org-left">Goal Scored</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-left">Ball Possession %</td>
<td class="org-right">47</td>
</tr>
<tr>
<td class="org-left">Attempts</td>
<td class="org-right">13</td>
</tr>
<tr>
<td class="org-left">On-Target</td>
<td class="org-right">4</td>
</tr>
<tr>
<td class="org-left">Off-Target</td>
<td class="org-right">6</td>
</tr>
<tr>
<td class="org-left">Blocked</td>
<td class="org-right">3</td>
</tr>
<tr>
<td class="org-left">Corners</td>
<td class="org-right">3</td>
</tr>
<tr>
<td class="org-left">Offsides</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-left">Free Kicks</td>
<td class="org-right">15</td>
</tr>
<tr>
<td class="org-left">Saves</td>
<td class="org-right">3</td>
</tr>
<tr>
<td class="org-left">Pass Accuracy %</td>
<td class="org-right">88</td>
</tr>
<tr>
<td class="org-left">Passes</td>
<td class="org-right">521</td>
</tr>
<tr>
<td class="org-left">Distance Covered (Kms)</td>
<td class="org-right">101</td>
</tr>
<tr>
<td class="org-left">Fouls Committed</td>
<td class="org-right">10</td>
</tr>
<tr>
<td class="org-left">Yellow Card</td>
<td class="org-right">0</td>
</tr>
<tr>
<td class="org-left">Yellow & Red</td>
<td class="org-right">0</td>
</tr>
<tr>
<td class="org-left">Red</td>
<td class="org-right">0</td>
</tr>
<tr>
<td class="org-left">Man of the Match</td>
<td class="org-right">Yes</td>
</tr>
<tr>
<td class="org-left">1st Goal</td>
<td class="org-right">23.0</td>
</tr>
<tr>
<td class="org-left">Round</td>
<td class="org-right">Group Stage</td>
</tr>
<tr>
<td class="org-left">PSO</td>
<td class="org-right">No</td>
</tr>
<tr>
<td class="org-left">Goals in PSO</td>
<td class="org-right">0</td>
</tr>
<tr>
<td class="org-left">Own goals</td>
<td class="org-right">nan</td>
</tr>
<tr>
<td class="org-left">Own goal Time</td>
<td class="org-right">nan</td>
</tr>
</tbody>
</table>
<p>#+end_example</p>
</div>
<div class="outline-4" id="outline-container-orgd3c05ef">
<h4 id="orgd3c05ef">The Target</h4>
<div class="outline-text-4" id="text-orgd3c05ef">
<p>The target is "Man of the Match".</p>
<div class="highlight">
<pre><span></span><span class="n">CountPercentage</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">"Man of the Match"</span><span class="p">])()</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Value</th>
<th class="org-right" scope="col">Count</th>
<th class="org-right" scope="col">Percent (%)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">No</td>
<td class="org-right">64</td>
<td class="org-right">50.00</td>
</tr>
<tr>
<td class="org-left">Yes</td>
<td class="org-right">64</td>
<td class="org-right">50.00</td>
</tr>
</tbody>
</table>
<p>Not a particularly large dataset, but we aren't really interested in it per-se but rather how to use permutation importance with it.</p>
<p>We want it to be a True/False value rather than a string value so let's change it.</p>
<div class="highlight">
<pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">"Man of the Match"</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">"Man of the Match"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Yes"</span>
<span class="n">CountPercentage</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">"Man of the Match"</span><span class="p">])()</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Value</th>
<th class="org-right" scope="col">Count</th>
<th class="org-right" scope="col">Percent (%)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">True</td>
<td class="org-right">64</td>
<td class="org-right">50.00</td>
</tr>
<tr>
<td class="org-left">False</td>
<td class="org-right">64</td>
<td class="org-right">50.00</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgb15040b">
<h3 id="orgb15040b">The Features</h3>
<div class="outline-text-3" id="text-orgb15040b">
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
</pre></div>
<pre class="example">
&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 128 entries, 0 to 127
Data columns (total 27 columns):
Date                      128 non-null object
Team                      128 non-null object
Opponent                  128 non-null object
Goal Scored               128 non-null int64
Ball Possession %         128 non-null int64
Attempts                  128 non-null int64
On-Target                 128 non-null int64
Off-Target                128 non-null int64
Blocked                   128 non-null int64
Corners                   128 non-null int64
Offsides                  128 non-null int64
Free Kicks                128 non-null int64
Saves                     128 non-null int64
Pass Accuracy %           128 non-null int64
Passes                    128 non-null int64
Distance Covered (Kms)    128 non-null int64
Fouls Committed           128 non-null int64
Yellow Card               128 non-null int64
Yellow & Red              128 non-null int64
Red                       128 non-null int64
Man of the Match          128 non-null bool
1st Goal                  94 non-null float64
Round                     128 non-null object
PSO                       128 non-null object
Goals in PSO              128 non-null int64
Own goals                 12 non-null float64
Own goal Time             12 non-null float64
dtypes: bool(1), float64(3), int64(18), object(5)
memory usage: 26.2+ KB
None
</pre>
<p>As you can see there's both numeric and non-numeric columns. For illustration purposes let's use just the integer columns.</p>
<div class="highlight">
<pre><span></span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">]</span>
<span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" * </span><span class="si">{column}</span><span class="s2">"</span><span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span>

<span class="n">x_train</span><span class="p">,</span> <span class="n">x_validate</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_validate</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">"Man of the Match"</span><span class="p">],</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
<pre class="example">
* Attempts
* Ball Possession %
* Blocked
* Corners
* Distance Covered (Kms)
* Fouls Committed
* Free Kicks
* Goal Scored
* Goals in PSO
* Off-Target
* Offsides
* On-Target
* Pass Accuracy %
* Passes
* Red
* Saves
* Yellow & Red
* Yellow Card
</pre></div>
</div>
<div class="outline-3" id="outline-container-org39f8931">
<h3 id="org39f8931">Build and Train the Model</h3>
<div class="outline-text-3" id="text-org39f8931">
<div class="highlight">
<pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Training Accuracy: {model.score(x_train, y_train)}"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Validation Accuracy: {model.score(x_validate, y_validate)}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Training Accuracy: 1.0
Validation Accuracy: 0.6875
</pre>
<p>It didn't do particularly well on the validation set.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org8e4f2b9">
<h3 id="org8e4f2b9">Permutation Importance</h3>
<div class="outline-text-3" id="text-org8e4f2b9">
<p>As I noted previously, you can read about the <code>PermutationImportance</code> class <a href="https://eli5.readthedocs.io/en/latest/autodocs/sklearn.html#eli5.sklearn.permutation_importance.PermutationImportance">here</a>. If you read the documentation you'll see that you don't have to pass it a prefit model, and in some cases you don't want to but for our purposes we will.</p>
<div class="highlight">
<pre><span></span><span class="n">permutor</span> <span class="o">=</span> <span class="n">PermutationImportance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_validate</span><span class="p">,</span> <span class="n">y_validate</span><span class="p">)</span>
</pre></div>
<p>Now we can print out a table of the outcome.</p>
<div class="highlight">
<pre><span></span><span class="n">ipython_html</span> <span class="o">=</span> <span class="n">eli5</span><span class="o">.</span><span class="n">show_weights</span><span class="p">(</span><span class="n">permutor</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">x_validate</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="n">jupyter</span><span class="o">-</span><span class="n">python_html</span><span class="o">.</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">table</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Weight</th>
<th class="org-left" scope="col">Feature</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">0.1750 ± 0.0848</td>
<td class="org-left">Goal Scored</td>
</tr>
<tr>
<td class="org-left">0.0500 ± 0.0637</td>
<td class="org-left">Distance Covered (Kms)</td>
</tr>
<tr>
<td class="org-left">0.0437 ± 0.0637</td>
<td class="org-left">Yellow Card</td>
</tr>
<tr>
<td class="org-left">0.0187 ± 0.0500</td>
<td class="org-left">Off-Target</td>
</tr>
<tr>
<td class="org-left">0.0187 ± 0.0637</td>
<td class="org-left">Free Kicks</td>
</tr>
<tr>
<td class="org-left">0.0187 ± 0.0637</td>
<td class="org-left">Fouls Committed</td>
</tr>
<tr>
<td class="org-left">0.0125 ± 0.0637</td>
<td class="org-left">Pass Accuracy %</td>
</tr>
<tr>
<td class="org-left">0.0125 ± 0.0306</td>
<td class="org-left">Blocked</td>
</tr>
<tr>
<td class="org-left">0.0063 ± 0.0612</td>
<td class="org-left">Saves</td>
</tr>
<tr>
<td class="org-left">0.0063 ± 0.0250</td>
<td class="org-left">Ball Possession %</td>
</tr>
<tr>
<td class="org-left">0 ± 0.0000</td>
<td class="org-left">Red</td>
</tr>
<tr>
<td class="org-left">0 ± 0.0000</td>
<td class="org-left">Yellow & Red</td>
</tr>
<tr>
<td class="org-left">0.0000 ± 0.0559</td>
<td class="org-left">On-Target</td>
</tr>
<tr>
<td class="org-left">-0.0063 ± 0.0729</td>
<td class="org-left">Offsides</td>
</tr>
<tr>
<td class="org-left">-0.0063 ± 0.0919</td>
<td class="org-left">Corners</td>
</tr>
<tr>
<td class="org-left">-0.0063 ± 0.0250</td>
<td class="org-left">Goals in PSO</td>
</tr>
<tr>
<td class="org-left">-0.0187 ± 0.0306</td>
<td class="org-left">Attempts</td>
</tr>
<tr>
<td class="org-left">-0.0500 ± 0.0637</td>
<td class="org-left">Passes</td>
</tr>
</tbody>
</table>
<p>The table is ranked from most important feature to least important (based on the accuracy after shuffling the column). Anything with 0 or less essenttially contributed nothing to the model - although that doesn't mean that they might not be useful for more feature engineering.</p>
<p>The data is for the team as a whole, not an individual, so the "Man of the Match" column is telling you if any player on the team was awarded the "Budweiser Man of the Match".</p>
</div>
<div class="outline-4" id="outline-container-orgaca3b2d">
<h4 id="orgaca3b2d">Plotting the Importance</h4>
<div class="outline-text-4" id="text-orgaca3b2d">
<p>The numbers are okay, but let's take a look at a plot of the weights.</p>
<div class="highlight">
<pre><span></span><span class="n">weights</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">Weight</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="n">table</span><span class="p">[</span><span class="s2">"weights"</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Feature"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"weights"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Permutation Importance (by Accuracy)"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">xrotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"permutation_importance"</span><span class="p">)()</span>
</pre></div>
<object data="/posts/tutorials/permutation-importance/permutation_importance.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org67cb970">
<h2 id="org67cb970">End</h2>
<div class="outline-text-2" id="text-org67cb970">
<p>So that's a quick look at getting a sense of the importance of a feature using <code>eli5</code> and permutation importance. There's a more in-depth look at it on their site, but next is another look at it with a different data set.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/machine-learning/decision-trees/">Decision Trees</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/machine-learning/decision-trees/" rel="bookmark"><time class="published dt-published" datetime="2020-01-25T16:31:40-08:00" itemprop="datePublished" title="2020-01-25 16:31">2020-01-25 16:31</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/machine-learning/decision-trees/#orgbcddfe2">Beginning</a>
<ul>
<li><a href="/posts/machine-learning/decision-trees/#orgdf6db35">Imports</a></li>
<li><a href="/posts/machine-learning/decision-trees/#orgfe107b3">Set Up</a></li>
</ul>
</li>
<li><a href="/posts/machine-learning/decision-trees/#orga28221a">Splitting A Node</a>
<ul>
<li><a href="/posts/machine-learning/decision-trees/#orgd006346">Entropy</a></li>
<li><a href="/posts/machine-learning/decision-trees/#org7d9e0c9">Binary Splitting of Qualitative Attributes Using the Gini Index</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgbcddfe2">
<h2 id="orgbcddfe2">Beginning</h2>
<div class="outline-text-2" id="text-orgbcddfe2"></div>
<div class="outline-3" id="outline-container-orgdf6db35">
<h3 id="orgdf6db35">Imports</h3>
<div class="outline-text-3" id="text-orgdf6db35"></div>
<div class="outline-4" id="outline-container-org7b1dcbf">
<h4 id="org7b1dcbf">Python</h4>
<div class="outline-text-4" id="text-org7b1dcbf">
<div class="highlight">
<pre><span></span>from functools import partial
from typing import Any
from math import log2
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org9bd7238">
<h4 id="org9bd7238">PyPi</h4>
<div class="outline-text-4" id="text-org9bd7238">
<div class="highlight">
<pre><span></span>from expects import (
    be_within,
    expect,
)
from tabulate import tabulate
import attr
import pandas
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgfe107b3">
<h3 id="orgfe107b3">Set Up</h3>
<div class="outline-text-3" id="text-orgfe107b3">
<div class="highlight">
<pre><span></span>TABLE = partial(tabulate, headers="keys", tablefmt="orgtbl")
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orga28221a">
<h2 id="orga28221a">Splitting A Node</h2>
<div class="outline-text-2" id="text-orga28221a">
<p>We choose which is the next node to split by checking the amount of information we would gain for each candidate node and picking the one that gives us the highest gain. We do this by measuring the <b>impurity</b> of the nodes, which is a measurement of how dissimilar the class labels are for a node.</p>
</div>
<div class="outline-3" id="outline-container-orgd006346">
<h3 id="orgd006346">Entropy</h3>
<div class="outline-text-3" id="text-orgd006346">
<p>One measure of "impurity" is <a href="https://www.wikiwand.com/en/Entropy_(information_theory)">entropy</a>, a measurement of the information associated with our nodes.</p>
</div>
<div class="outline-4" id="outline-container-org199cb66">
<h4 id="org199cb66">Node Entropy</h4>
<div class="outline-text-4" id="text-org199cb66">
<p>Here's where we'll calculate the entropy for a node.</p>
<p>\[ Entropy = - \sum_{i=0}^{c-1} p_i(t)log_2 p_i(t) \]</p>
<p>Where \(p_1(t)\) is the fraction of training data (<i>t</i>) that has the classification <i>i</i>. We can translate that to a python function.</p>
<div class="highlight">
<pre><span></span> def node_entropy(data: pandas.Series, debug: bool=False) -&gt; float:
     """Calculate the entropy for a child node

     Args:
      data: target data filtered to match the child-node's class
      debug: emit values

     Returns:
      entropy for this node
     """
     if debug:
         print("calculating node-entropy")
     total = len(data)
     accumulated = 0
     for classification in data.unique():
         p = len(data[data == classification])/total
         if debug:
             print(f"\tclass: {classification}, p: {p} entropy: {p * log2(p)}")
         accumulated += p * log2(p)
     if debug:
         print(f"Node Entropy: {accumulated}")
     return -accumulated
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org5daa6c7">
<h4 id="org5daa6c7">Entropy of a Node's Children</h4>
<div class="outline-text-4" id="text-org5daa6c7">
<p>We'll use the entropy formula to get the entropy for an indivdual node but to get the total contribution from the possible splits we'll take a weighted sum of the node entropies.</p>
<p>\[ I(children) = \sum_{j=1}^k \frac{N(v_j)}{N} I(v_j) \]</p>
<p>Where \(\frac{N(v_j)}{N}\) is the fraction of the child data in node <i>j</i> and \(I(v_j)\) is the entropy (Impurity) of node <i>j</i>.</p>
<p>Once again, in python.</p>
<div class="highlight">
<pre><span></span>def children_impurity(data: pandas.DataFrame, column: str, target: str,
                      impurity: object=node_entropy,
            debug: bool=False) -&gt; float:
    """Calculate the entropy for the parent of child nodes

    Args:
     data: the container for the values to check
     column: the column to get the entropy
     target: the target column
     impurity: the function to calculate the impurity of the child
     debug: whether to print some intermediate values

    Returns:
     entropy for the data
    """
    if debug:
        print("Calculating entropy for child nodes")
    total = len(data)
    accumulator = 0
    for classification in data[column].unique():
        child = data[data[column] == classification][target]
        if debug:
            print(f"\tI_({classification}) = ({len(child)}/{total}) "
                  f"x {impurity(child)}")
        accumulator += (len(child)/total) * impurity(child)
    if debug:
        print(f"Child node entropy: {accumulator}")
    return accumulator
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org82a3430">
<h4 id="org82a3430">Information Gain</h4>
<div class="outline-text-4" id="text-org82a3430">
<p>The measurement of how much is gained is the difference between a parent node and its children. \[ \Delta = I(parent) - I(children) \]</p>
<div class="highlight">
<pre><span></span> def information_gain(data: pandas.Series, column: str, target: str,
                      debug: bool=False) -&gt; float:
     """See how much entropy is removed using this node

     Args:
      data: source to check
      column: name of the column representing the parent node
      target: name of the column we are trying to predict
      debug: emit messages
     """
     return node_entropy(data[target], debug=debug) - children_impurity(
         data, column=column, target=target, debug=debug)
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org53f16d8">
<h4 id="org53f16d8">Home Loans</h4>
<div class="outline-text-4" id="text-org53f16d8">
<p>To make this concrete we can look at a small dataset of people applying for a loan. We want to know if they are likely to default and we need to decide if we want our first split to be on whether they own a home or are married (we'll ignore income for this check because it's meant to illustrate splitting qualitative data).</p>
<div class="highlight">
<pre><span></span> @attr.s(auto_attribs=True, slots=True, frozen=True)
 class LoanColumns:
     owner: str = "Home Owner"
     married: str = "Marital Status"
     income: str = "Annual Income"
     defaulted: str = "Defaulted"

 LOANS = LoanColumns()
</pre></div>
<div class="highlight">
<pre><span></span> loans = pandas.DataFrame({
     LOANS.owner: [True, False, False, True, False, False, True, False, False, False],
     LOANS.married: ["Single", "Married", "Single", "Married", "Divorced", "Single", "Divorced", "Single", "Married", "Single"],
     LOANS.income: [125000, 100000, 70000, 120000, 95000, 60000, 220000, 85000, 75000, 90000],
     LOANS.defaulted: [False, False, False, False, True, False, False, True, False, True],
 })
 print(TABLE(loans))
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-right">
<col class="org-left">
<col class="org-left">
<col class="org-right">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-right" scope="col">&nbsp;</th>
<th class="org-left" scope="col">Home Owner</th>
<th class="org-left" scope="col">Marital Status</th>
<th class="org-right" scope="col">Annual Income</th>
<th class="org-left" scope="col">Defaulted</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-left">True</td>
<td class="org-left">Single</td>
<td class="org-right">125000</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-right">1</td>
<td class="org-left">False</td>
<td class="org-left">Married</td>
<td class="org-right">100000</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-right">2</td>
<td class="org-left">False</td>
<td class="org-left">Single</td>
<td class="org-right">70000</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-right">3</td>
<td class="org-left">True</td>
<td class="org-left">Married</td>
<td class="org-right">120000</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-right">4</td>
<td class="org-left">False</td>
<td class="org-left">Divorced</td>
<td class="org-right">95000</td>
<td class="org-left">True</td>
</tr>
<tr>
<td class="org-right">5</td>
<td class="org-left">False</td>
<td class="org-left">Single</td>
<td class="org-right">60000</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-right">6</td>
<td class="org-left">True</td>
<td class="org-left">Divorced</td>
<td class="org-right">220000</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-right">7</td>
<td class="org-left">False</td>
<td class="org-left">Single</td>
<td class="org-right">85000</td>
<td class="org-left">True</td>
</tr>
<tr>
<td class="org-right">8</td>
<td class="org-left">False</td>
<td class="org-left">Married</td>
<td class="org-right">75000</td>
<td class="org-left">False</td>
</tr>
<tr>
<td class="org-right">9</td>
<td class="org-left">False</td>
<td class="org-left">Single</td>
<td class="org-right">90000</td>
<td class="org-left">True</td>
</tr>
</tbody>
</table>
<p>The first step is to calculate the entropy for the entire set using whether they defaulted or not as our classification.</p>
<div class="highlight">
<pre><span></span> impurity_parent = node_entropy(loans[LOANS.defaulted])
 print(f"I_parent: {impurity_parent:0.3f}")

 expect(impurity_parent).to(be_within(0.8812, 0.8813))
</pre></div>
<pre class="example">
I_parent: 0.881
</pre>
<p>The next step is to figure out which of our two chosen attributes gives us the most information gain- whether the person was a Home Owner or their Marital Status. We could just look at which has a lower entropy, but the problem is stated so that we want to find the greatest difference between the class' entropy and the parent entropy instead.</p>
</div>
<ul class="org-ul">
<li><a id="org4eeda5d"></a>Home Owners<br>
<div class="outline-text-5" id="text-org4eeda5d">
<p>We have two child nodes - one for homeowners and one for non-homeowners.</p>
<div class="highlight">
<pre><span></span> print(loans[loans[LOANS.owner]][LOANS.defaulted].value_counts())
 print()
 print(loans[~loans[LOANS.owner]][LOANS.defaulted].value_counts())
</pre></div>
<pre class="example">
False    3
Name: Defaulted, dtype: int64

False    4
True     3
Name: Defaulted, dtype: int64
</pre>
<div class="highlight">
<pre><span></span> impurity_home_owner = children_entropy(loans,
                                        column=LOANS.owner,
                                        target=LOANS.defaulted, debug=True)
 print(f"{impurity_home_owner: 0.3f}")
 expect(impurity_home_owner).to(be_within(0.689, 0.691))
</pre></div>
<pre class="example">
Calculating entropy for child nodes
        I_(True) = (3/10) x -0.0
        I_(False) = (7/10) x 0.9852281360342515
Child node entropy: 0.6896596952239761
 0.690
</pre>
<p>Odd that python allows negative zero-values… Now we can see what the information gain will be.</p>
<div class="highlight">
<pre><span></span> gain_home_owner = information_gain(loans, LOANS.owner, LOANS.defaulted)
 print(f"Delta Home-Owner: {gain_home_owner: 0.3}")
 expect(gain_home_owner).to(be_within(0.190, 0.19165))
</pre></div>
<pre class="example">
Delta Home-Owner:  0.192
</pre>
<p>I seem to have precision differences with the book…</p>
</div>
</li>
<li><a id="org55384e0"></a>Married Applicants<br>
<div class="outline-text-5" id="text-org55384e0">
<div class="highlight">
<pre><span></span> gain_married = information_gain(loans, LOANS.married, LOANS.defaulted, debug=True)
 print(f"Delta Married: {gain_married: 0.3f}")
 expect(gain_married).to(be_within(0.194, 0.196))
 choice = max(((gain_home_owner, LOANS.owner),
               (gain_married, LOANS.married)))
 print(f"Next Node: {choice}")
</pre></div>
<pre class="example">
calculating node-entropy
        class: False, p: 0.7 entropy: -0.3602012209808308
        class: True, p: 0.3 entropy: -0.5210896782498619
Node Entropy: -0.8812908992306927
Calculating entropy for child nodes
        I_(Single) = (5/10) x 0.9709505944546686
        I_(Married) = (3/10) x -0.0
        I_(Divorced) = (2/10) x 1.0
Child node entropy: 0.6854752972273344
Delta Married:  0.196
Next Node: (0.19581560200335835, 'Marital Status')
</pre>
<p>Since we gain more information from checking whether someone was married or not, that would be the next node we would choose to split.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-org7d9e0c9">
<h3 id="org7d9e0c9">Binary Splitting of Qualitative Attributes Using the Gini Index</h3>
<div class="outline-text-3" id="text-org7d9e0c9">
<p>\[ \textit{Gini Index} = 1 - \sum_{i=0}^{c - 1} \]</p>
<div class="highlight">
<pre><span></span>def gini(data: pandas.Series) -&gt; float:
    """Calculate the gini index for the data"""
    total = len(data)
    accumulator = 0
    for classification in data.unique():
        accumulator += (len(data[data==classification])/total)**2
    return 1 - accumulator
</pre></div>
</div>
<div class="outline-4" id="outline-container-org5ec7157">
<h4 id="org5ec7157">Parent Impurity</h4>
<div class="outline-text-4" id="text-org5ec7157">
<p>First we get the gini index for the overall data.</p>
<div class="highlight">
<pre><span></span>parent_gini = gini(loans[LOANS.defaulted])
print(f"I_parent = {parent_gini: 0.3f}")
expect(parent_gini).to(be_within(0.420, 0.421))
</pre></div>
<pre class="example">
I_parent =  0.420
</pre></div>
</div>
<div class="outline-4" id="outline-container-org1454491">
<h4 id="org1454491">Home Owner Impurity</h4>
<div class="outline-text-4" id="text-org1454491">
<p>Now the homeowner attribute.</p>
<div class="highlight">
<pre><span></span>homeowner_gini = children_impurity(loans, LOANS.owner, LOANS.defaulted, gini, debug=True)
expect(homeowner_gini).to(be_within(0.342, 0.344))
</pre></div>
<pre class="example">
Calculating entropy for child nodes
        I_(True) = (3/10) x 0.0
        I_(False) = (7/10) x 0.48979591836734704
Child node entropy: 0.3428571428571429
</pre></div>
</div>
<div class="outline-4" id="outline-container-org4ddb355">
<h4 id="org4ddb355">Married Impurity</h4>
<div class="outline-text-4" id="text-org4ddb355">
<p>This is different from the entropy case because we want to do binary splits but the marital status attribute has three values (<i>Single</i>, <i>Married</i>, and <i>Divorced</i>) so we need to use a different function that does each attribute against the other (or we could add columns which turn the marital status into a binary attribute, but this seems simpler).</p>
<div class="highlight">
<pre><span></span>def binary_gini(data: pandas.Series, column: str, target: str,
                classification: object, debug: bool=False) -&gt; float:
    """Calculate the gini value for the data using one against many

    Args:
     data: source with qualitative values
     column: column with the classifications to test
     target: column with the classifications to predict
     classification: the classification to compare
     debug: whether to emit messages
    """
    total = len(data)
    classified = data[data[column] == classification]
    others = data[data[column] != classification]
    if debug:
        print(f"N({classification}/N) I({classification}) = {len(classified)/total * gini(classified[target]):0.3f}")
        print(f"N(!{classification}/N) I!({classification}) = {len(others)/total * gini(others[target]):0.3f}")
        print(f"I({classification}) = {((len(classified)/total) * gini(classified[target]) + (len(others)/total) * gini(others[target])):0.3f}")
    return ((len(classified)/total) * gini(classified[target])
            + (len(others)/total) * gini(others[target]))
</pre></div>
<div class="highlight">
<pre><span></span>@attr.s(auto_attribs=True, slots=True, frozen=True)
class MaritalStatus:
    single: str="Single"
    married: str="Married"
    divorced: str="Divorced"

status = MaritalStatus()
</pre></div>
<div class="highlight">
<pre><span></span>i_single = binary_gini(loans, LOANS.married, LOANS.defaulted, status.single,
                       debug=True)
print()
i_married = binary_gini(loans, LOANS.married, LOANS.defaulted, status.married,
                        debug=True)
print()
i_divorced = binary_gini(loans, LOANS.married, LOANS.defaulted,
                         status.divorced, debug=True)
expect(i_single).to(be_within(0.39, 0.41))
expect(i_divorced).to(be_within(0.39, 0.41))
expect(i_married).to(be_within(0.342, 0.344))
</pre></div>
<pre class="example">
N(Single/N) I(Single) = 0.240
N(!Single/N) I!(Single) = 0.160
I(Single) = 0.400

N(Married/N) I(Married) = 0.000
N(!Married/N) I!(Married) = 0.343
I(Married) = 0.343

N(Divorced/N) I(Divorced) = 0.100
N(!Divorced/N) I!(Divorced) = 0.300
I(Divorced) = 0.400
</pre>
<div class="highlight">
<pre><span></span>best = 0
best_split = None
for candidate, label in ((homeowner_gini, "Homeowner"),
                         (i_single, "Single"),
                         (i_married, "Married"),
                         (i_divorced, "Divorced")):
    delta = parent_gini - candidate
    if delta &gt; best:
        best = delta
        best_split = label
    print(f"Delta {label} = {delta:0.3f}")
print(f"Best Split: {best_split}")
</pre></div>
<pre class="example">
Delta Homeowner = 0.077
Delta Single = 0.020
Delta Married = 0.077
Delta Divorced = 0.020
Best Split: Homeowner
</pre>
<p>Either using Home Ownership or Whether someone is married would be the best candidates for the next split.</p>
</div>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/libraries/snorkel/snorkel-data-labeling/">Snorkel Data Labeling</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/libraries/snorkel/snorkel-data-labeling/" rel="bookmark"><time class="published dt-published" datetime="2020-01-09T17:07:33-08:00" itemprop="datePublished" title="2020-01-09 17:07">2020-01-09 17:07</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/libraries/snorkel/snorkel-data-labeling/#org06927e3">Beginning</a>
<ul>
<li><a href="/posts/libraries/snorkel/snorkel-data-labeling/#org7f8d1ae">Imports</a></li>
<li><a href="/posts/libraries/snorkel/snorkel-data-labeling/#orgfad0ccd">Set Up</a></li>
</ul>
</li>
<li><a href="/posts/libraries/snorkel/snorkel-data-labeling/#org1bd75e8">Middle</a>
<ul>
<li><a href="/posts/libraries/snorkel/snorkel-data-labeling/#org45a8226">Finding Labeling Functions</a></li>
<li><a href="/posts/libraries/snorkel/snorkel-data-labeling/#org0eb4199">Using TextBlob with a Preprocessor</a></li>
<li><a href="/posts/libraries/snorkel/snorkel-data-labeling/#orgba3195b">More Labeling Functions</a></li>
<li><a href="/posts/libraries/snorkel/snorkel-data-labeling/#org4575456">Adding a Spacy Preprocessor</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org06927e3">
<h2 id="org06927e3">Beginning</h2>
<div class="outline-text-2" id="text-org06927e3">
<p>This is a walk-through of the Snorkel <a href="https://www.snorkel.org/use-cases/01-spam-tutorial">Snorkel Data Labeling</a> tutorial.It uses the <a href="http://www.dt.fee.unicamp.br/~tiago//youtubespamcollection/">YouTube Spam Collection</a> data set (downloaded from the <a href="https://archive.ics.uci.edu/ml/datasets/YouTube+Spam+Collection">UCI Machine Learning Repository</a>). The data was collected in 2015 and represents comments from five of the ten most popular videos on YouTube. It is a tabular dataset with the columns <code>COMMENT_ID</code>, <code>AUTHOR</code>, <code>DATE</code>, <code>CONTENT</code>, <code>CLASS</code>. The tag represents whether it was considered <i>Spam</i> or not, so we'll pretend it isn't there for most of this walk-through.</p>
</div>
<div class="outline-3" id="outline-container-org7f8d1ae">
<h3 id="org7f8d1ae">Imports</h3>
<div class="outline-text-3" id="text-org7f8d1ae"></div>
<div class="outline-4" id="outline-container-org9173448">
<h4 id="org9173448">Python</h4>
<div class="outline-text-4" id="text-org9173448">
<div class="highlight">
<pre><span></span>from argparse import Namespace
from functools import partial
from pathlib import Path
import re
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org7d6ca41">
<h4 id="org7d6ca41">PyPi</h4>
<div class="outline-text-4" id="text-org7d6ca41">
<div class="highlight">
<pre><span></span>from snorkel.analysis import get_label_buckets
from snorkel.labeling import labeling_function, LabelingFunction, LFAnalysis, PandasLFApplier
from snorkel.preprocess import preprocessor
from snorkel.labeling.lf.nlp import nlp_labeling_function
from sklearn.model_selection import train_test_split
from tabulate import tabulate
from textblob import TextBlob

import pandas
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgfad0ccd">
<h3 id="orgfad0ccd">Set Up</h3>
<div class="outline-text-3" id="text-orgfad0ccd"></div>
<div class="outline-4" id="outline-container-org4daa77b">
<h4 id="org4daa77b">The Tabulate Table</h4>
<div class="outline-text-4" id="text-org4daa77b">
<div class="highlight">
<pre><span></span>TABLE = partial(tabulate, tablefmt="orgtbl", headers="keys")
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org1d35b54">
<h4 id="org1d35b54">Some Constants</h4>
<div class="outline-text-4" id="text-org1d35b54">
<div class="highlight">
<pre><span></span>Comment = Namespace(
    is_ambiguous = -1,
    is_ham = 0,
    is_spam = 1
)
</pre></div>
<div class="highlight">
<pre><span></span>Data = Namespace(
    test_artist = "Shakira",
    development_size = 200,
    validation_size = 0.5,
    random_seed = 666,
)
</pre></div>
<div class="highlight">
<pre><span></span>Columns = Namespace(
    comment = "CONTENT",
    classification = "CLASS",
    artist = "artist",
)
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org1bd75e8">
<h2 id="org1bd75e8">Middle</h2>
<div class="outline-text-2" id="text-org1bd75e8"></div>
<div class="outline-4" id="outline-container-org5cff5f4">
<h4 id="org5cff5f4">The Dataset</h4>
<div class="outline-text-4" id="text-org5cff5f4">
<p>The data is split up into separate files - one for each artist/video (they are named after the artist and each only appears to have one entry) so I'm going to smash them back together and add a <code>artist</code> column.</p>
<div class="highlight">
<pre><span></span>path = Path("~/data/datasets/texts/you_tube_comments/").expanduser()
sets = []
for name in path.glob("*.csv"):
    artist = name.stem.split()[-1]
    data = pandas.read_csv(name)
    data["artist"] = artist
    sets.append(data)
    print(artist)
data = pandas.concat(sets)
</pre></div>
<pre class="example">
KatyPerry
LMFAO
Eminem
Shakira
Psy
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgd0f4285">
<h4 id="orgd0f4285">Splitting the Set</h4>
<div class="outline-text-4" id="text-orgd0f4285">
<p>The tutorial takes a slightly different approach from the one I previously took. Here's their four data-set splits:</p>
<ul class="org-ul">
<li><i>train</i>: Comments from the first four videos</li>
<li><i>dev</i>: 200 comments taken from <i>train</i></li>
<li><i>valid & test</i>: A 50-50 split of the last video (actually <i>Shakira</i>, not <i>Psy</i> as listed above)</li>
</ul>
<div class="highlight">
<pre><span></span>test = data[data.artist==Data.test_artist]
train = data[data.artist != Data.test_artist]
train, development = train_test_split(train, test_size=Data.development_size)

validation, test = train_test_split(test, test_size=Data.validation_size)
print(f"Training: {train.shape}")
print(f"Development: {development.shape}")
print(f"Validation: {validation.shape}")
print(f"Testing: {test.shape}")
</pre></div>
<pre class="example">
Training: (1386, 6)
Development: (200, 6)
Validation: (185, 6)
Testing: (185, 6)
</pre></div>
</div>
<div class="outline-3" id="outline-container-org45a8226">
<h3 id="org45a8226">Finding Labeling Functions</h3>
<div class="outline-text-3" id="text-org45a8226">
<p>The place to start is with the development set - it's labeled (although in this case the training set is as well, but pretend it isn't) and we can inspect it to get ideas.</p>
<div class="highlight">
<pre><span></span>print(development.sample(random_state=Data.random_seed)[[Columns.comment, Columns.classification]])
</pre></div>
<pre class="example">
                                               CONTENT  CLASS
216  Lol...I dunno how this joke gets a lot of like...      0
</pre>
<div class="highlight">
<pre><span></span>spam = development[development[Columns.classification]==Comment.is_spam]
for count in range(10):
    print(spam.sample(random_state=count).iloc[0][Columns.comment])
</pre></div>
<pre class="example">
I #votekatyperry for the 2014 MTV #VMA Best Lyric Video! See who's in the  lead and vote:  http://on.mtv.com/Ut15kX﻿
LIKE AND SUBSCRIB IF YOU WATCH IN 2015 ;)﻿
 HI IM 14 YEAR RAPPER SUPPORT ME GUY AND CHECK OUT MY CHANNEL AND CHECK OUT MY SONG YOU MIGHT LIKE IT ALSO FOLLOW ME IN TWITTER @McAshim for follow back.
LIKE AND SUBSCRIB IF YOU WATCH IN 2015 ;)﻿
HAPPY BIRTHDAY KATY :) http://giphy.com/gifs/birthday-flowers-happy-gw3JY2uqiaXKaQXS/fullscreen  (That´s not me)﻿
plz check out fablife / welcome to fablife for diys and challenges so plz  subscribe thx!﻿
CHECK OUT MY CHANNEL BOYS AND GIRLS ;)
HAPPY BIRTHDAY KATY :) http://giphy.com/gifs/birthday-flowers-happy-gw3JY2uqiaXKaQXS/fullscreen  (That´s not me)﻿
*for 90&amp;#39;s rap fans*  check out my Big Pun - &amp;#39;Beware&amp;#39; cover!  Likes n comments very much appreciated!
Who&amp;#39;s watching in 2015 Subscribe for me !﻿
</pre>
<p>You can already see that the spam has people asking viewers to check out their sites.</p>
</div>
<div class="outline-4" id="outline-container-org823bb24">
<h4 id="org823bb24">Check vs Check Out</h4>
<div class="outline-text-4" id="text-org823bb24">
<p>Let's see which one of the strings (<i>check</i> or <i>check out</i>) does better for us.</p>
</div>
<ul class="org-ul">
<li><a id="org648df57"></a>The Labeling Functions<br>
<div class="outline-text-5" id="text-org648df57">
<div class="highlight">
<pre><span></span>@labeling_function()
def check(row: pandas.Series) -&gt; int:
    """sees if the word 'check' is in the comment"""
    return Comment.is_spam if "check" in row.CONTENT.lower() else Comment.is_ambiguous
</pre></div>
<div class="highlight">
<pre><span></span>@labeling_function()
def check_out(row: pandas.Series) -&gt; int:
    """looks for phrase 'check out'"""
    return Comment.is_spam if "check out" in row.CONTENT.lower() else Comment.is_ambiguous
</pre></div>
</div>
</li>
<li><a id="orgcf84922"></a>Applying the Functions<br>
<div class="outline-text-5" id="text-orgcf84922">
<p>The next step is to create some Labeling Matrices using our labeling functions by applying them to our training and development sets. Since our data is stored using pandas, we'll use the <code>PandasLFApplier</code>, but there are <a href="https://snorkel.readthedocs.io/en/master/packages/labeling.html">other types available</a> as well.</p>
<div class="highlight">
<pre><span></span>labeling_functions = [check, check_out]

applier = PandasLFApplier(lfs=labeling_functions)
train_labeling_matrix = applier.apply(df=train, progress_bar=False)
development_labeling_matrix = applier.apply(df=development, progress_bar=False)
print(f"Training Labeling Matrix: {train_labeling_matrix.shape}")
print(f"Development Labeling Matrix: {development_labeling_matrix.shape}")
</pre></div>
<pre class="example">
Training Labeling Matrix: (1386, 2)
Development Labeling Matrix: (200, 2)
</pre>
<p>Each matrix has one column for each of our labeling functions (so two in this case) and one row for each of the rows in the set that the functions were applied to.</p>
</div>
</li>
<li><a id="org6359522"></a>Evaluating the Labeling Functions<br>
<div class="outline-text-5" id="text-org6359522">
<p>Snorkel provides a <a href="https://snorkel.readthedocs.io/en/master/packages/_autosummary/labeling/snorkel.labeling.LFAnalysis.html">LFAnalysis</a> class to help you see how well the labeling functions do.</p>
<div class="highlight">
<pre><span></span>analysis = LFAnalysis(L=train_labeling_matrix, lfs=labeling_functions)
print(TABLE(analysis.lf_summary()))
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">j</th>
<th class="org-left" scope="col">Polarity</th>
<th class="org-right" scope="col">Coverage</th>
<th class="org-right" scope="col">Overlaps</th>
<th class="org-right" scope="col">Conflicts</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">check</td>
<td class="org-right">0</td>
<td class="org-left">[1]</td>
<td class="org-right">0.257576</td>
<td class="org-right">0.212843</td>
<td class="org-right">0</td>
</tr>
<tr>
<td class="org-left">check_out</td>
<td class="org-right">1</td>
<td class="org-left">[1]</td>
<td class="org-right">0.212843</td>
<td class="org-right">0.212843</td>
<td class="org-right">0</td>
</tr>
</tbody>
</table>
<p>This is what the table is giving us for each of the labeling functions:</p>
<ul class="org-ul">
<li><i>j</i> : I think this is just an index</li>
<li><i>Polarity</i>: The number of unique values the function puts out (other than -1, which is interpreted as an un-labeled row)</li>
<li>/Coverage: The fraction of the data-set that the function labeled</li>
<li>/Overlaps: The fraction of the data that the function labeled and at least one other function also labeled</li>
<li><i>Conflicts</i>: The fraction of the data that the function labeled something different from at least one other function</li>
</ul>
<p>So it looks like <code>check</code> covers slightly more than <code>check_out</code>, and they don't disagree with each other at all. This makes sense when you consider that <code>check</code> is a sub-string of <code>check out</code> - we can guess that all the overlaps are cases where <code>check out</code> were found in the comment.</p>
<p>We can also pass it a set of labels and it will see how well the functions did. In this case we have labels for all the rows, but in most cases we won't just for the development set so we'll use it here.</p>
<div class="highlight">
<pre><span></span>print(TABLE(LFAnalysis(
    L=development_labeling_matrix,
    lfs=labeling_functions).lf_summary(Y=development.CLASS.values)))
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">j</th>
<th class="org-left" scope="col">Polarity</th>
<th class="org-right" scope="col">Coverage</th>
<th class="org-right" scope="col">Overlaps</th>
<th class="org-right" scope="col">Conflicts</th>
<th class="org-right" scope="col">Correct</th>
<th class="org-right" scope="col">Incorrect</th>
<th class="org-right" scope="col">Emp. Acc.</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">check</td>
<td class="org-right">0</td>
<td class="org-left">[1]</td>
<td class="org-right">0.26</td>
<td class="org-right">0.225</td>
<td class="org-right">0</td>
<td class="org-right">49</td>
<td class="org-right">3</td>
<td class="org-right">0.942308</td>
</tr>
<tr>
<td class="org-left">check_out</td>
<td class="org-right">1</td>
<td class="org-left">[1]</td>
<td class="org-right">0.225</td>
<td class="org-right">0.225</td>
<td class="org-right">0</td>
<td class="org-right">45</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>
<p><b>Note:</b> The <code>LFAnalysis</code> class works with <code>numpy</code> arrays, so when I called the <code>lf_summary</code> method I had to pass in the <code>values</code> and not the <code>CLASS</code> Series.</p>
<p>With our development set, the functions cover slightly less than before (as a fraction of the total), and although <code>check</code> covers slightly more that <code>check_out</code>, it also has some false-postives, so we'd have to decide if we care about getting all the spam or not accidentally labeling non-spam as spam.</p>
<p>We can also check which ones were mis-labeled to get a better idea of how off they were.</p>
<div class="highlight">
<pre><span></span>buckets = get_label_buckets(development.CLASS.values, development_labeling_matrix[:, 0])
for key, value in buckets.items():
    print(key)
    print(value)
</pre></div>
<pre class="example">
(0, -1)
[  0   1   2   3   4   7   9  10  11  12  13  15  16  17  19  22  27  28
  33  34  35  39  41  43  44  46  48  49  50  51  52  53  55  57  58  61
  62  65  66  68  78  79  81  82  86  88  89  92  94  95  98  99 100 103
 104 105 107 108 112 113 114 120 121 122 123 124 125 128 129 131 133 135
 141 142 144 146 148 150 153 154 155 162 165 166 167 168 171 173 174 179
 182 183 184 190 191 195 196 197]
(1, 1)
[  5  14  23  25  29  36  40  42  45  59  67  69  71  73  74  75  76  77
  80  83  87  90  91  93 101 109 110 116 117 126 127 134 138 139 140 143
 149 151 157 160 163 164 169 172 186 189 192 193 198]
(1, -1)
[  6   8  18  20  21  24  26  30  31  32  38  47  54  56  60  63  64  70
  72  84  85  96  97 102 106 111 115 119 130 132 136 137 145 147 152 156
 158 159 161 175 176 177 178 180 181 185 187 188 194 199]
(0, 1)
[ 37 118 170]
</pre>
<p>Buckets is a dict whose keys are tuples of (actual classes, predicted classes) and whose values are the indices of the rows matching the keys (so the key <code>(0, 1)</code> returns the indices for rows where we labeled the comment as spam but it wasn't). Looking at the output you can see that the last key (0, 1) has the cases that we labeled as spam when they weren't, let's take a look at them.</p>
<div class="highlight">
<pre><span></span>for comment in development.iloc[buckets[(Comment.is_ham, Comment.is_spam)]]["CONTENT"]:
    print(comment)
</pre></div>
<pre class="example">
i turned it on mute as soon is i came on i just wanted to check the  views...﻿
i check back often to help reach 2x10^9 views and I avoid watching Baby﻿
Admit it you just came here to check the number of viewers ﻿
</pre>
<p>It's not obvious to me how you should handle those.</p>
</div>
</li>
<li><a id="orgb1175e3"></a>Check Out But Not Check<br>
<div class="outline-text-5" id="text-orgb1175e3">
<p>What are some training examples that <code>check</code> labels but <code>check_out</code> doesn't? We can check by feeding the columns from the labeling matrix for the <code>check</code> and <code>check_out</code> functions and see where <code>check_out</code> abstained and <code>check</code> didn't. I said earlier that the first argument to <code>get_label_buckets</code> is the actual label, but really you can feed any two arrays and it will find give you the indices for the permutations of their row-values.</p>
<div class="highlight">
<pre><span></span>buckets = get_label_buckets(train_labeling_matrix[:, 0], train_labeling_matrix[:, 1])
sampled = train.iloc[buckets[(Comment.is_spam, Comment.is_ambiguous)]].sample(10, random_state=Data.random_seed)
for sample in sampled.itertuples():
    print(sample.CONTENT)
</pre></div>
<pre class="example">
Lil m !!!!! Check hi out!!!!! Does live the way you lie and many more ! Check it out!!! And subscribe
https://soundcloud.com/artady please check my stuff; and make some feedback﻿
Hey guys can you check my channel out plz. I do mine craft videos. Let's  shoot for 20 subs﻿
┏━━━┓┏┓╋┏┓┏━━━┓┏━━━┓┏┓╋╋┏┓  ┃┏━┓┃┃┃╋┃┃┃┏━┓┃┗┓┏┓┃┃┗┓┏┛┃  ┃┗━━┓┃┗━┛┃┃┃╋┃┃╋┃┃┃┃┗┓┗┛┏  ┗━━┓┃┃┏━┓┃┃┗━┛┃╋┃┃┃┃╋┗┓┏┛  ┃┗━┛┃┃┃╋┃┃┃┏━┓┃┏┛┗┛┃╋╋┃┃  ┗━━━┛┗┛╋┗┛┗┛╋┗┛┗━━━┛╋╋┗┛ CHECK MY VIDEOS AND SUBSCRIBE AND LIKE PLZZ
if you like raw talent, raw lyrics, straight real hip hop Everyone check my newest sound  Dizzy X - Got the Juice (Prod by. Drugs the Model Citizen)   COMMENT TELL ME WHAT YOU THINK  DONT BE LAZY!!!!  - 1/7 Prophetz﻿
check it out free stuff for watching videos and filling surveys&lt;br /&gt;&lt;br /&gt;&lt;a href="http://www.prizerebel.com/index.php?r=1446084"&gt;http://www.prizerebel.com/index.php?r=1446084&lt;/a&gt;﻿
Hey! I'm NERDY PEACH and I'm a new youtuber and it would mean THE ABSOLUTE  world to me if you could check 'em out! &amp;lt;3  Hope you like them! =D﻿
Check my first video out﻿
http://tankionline.com#friend=cd92db3f4 great game check it out!﻿
hi beaties! i made a new channel please go check it out and subscribe and  enjoy!﻿
</pre>
<p>I'm going to deviate from the tutorial a little and create a regular expression to match any comment with "check" and not "view" to avoid cases where the commenter is saying that they're checking out how many views the video had.</p>
<div class="highlight">
<pre><span></span>EXPRESSION = re.compile(r"check(?!.*view)")

assert EXPRESSION.search("everyone please come check our newest song in memories of Martin Luther  King Jr.﻿")
assert EXPRESSION.search("and u should.d check my channel and tell me what I should do next!﻿")
assert not EXPRESSION.search("Admit it you just came here to check the number of viewers ﻿")

@labeling_function()
def re_check_out(row: pandas.Series) -&gt; int:
    """match cases with 'check' but not view"""
    return Comment.is_spam if EXPRESSION.search(row.CONTENT.lower()) else Comment.is_ambiguous
</pre></div>
<div class="highlight">
<pre><span></span>labeling_functions = [check, check_out, re_check_out]
applier = PandasLFApplier(lfs=labeling_functions)
train_labeling_matrix = applier.apply(df=train, progress_bar=False)
development_labeling_matrix = applier.apply(df=development, progress_bar=False)
</pre></div>
<div class="highlight">
<pre><span></span>analysis = LFAnalysis(L=train_labeling_matrix, lfs=labeling_functions)
print(TABLE(analysis.lf_summary()))
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">j</th>
<th class="org-left" scope="col">Polarity</th>
<th class="org-right" scope="col">Coverage</th>
<th class="org-right" scope="col">Overlaps</th>
<th class="org-right" scope="col">Conflicts</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">check</td>
<td class="org-right">0</td>
<td class="org-left">[1]</td>
<td class="org-right">0.257576</td>
<td class="org-right">0.248196</td>
<td class="org-right">0</td>
</tr>
<tr>
<td class="org-left">check_out</td>
<td class="org-right">1</td>
<td class="org-left">[1]</td>
<td class="org-right">0.212843</td>
<td class="org-right">0.212843</td>
<td class="org-right">0</td>
</tr>
<tr>
<td class="org-left">re_check_out</td>
<td class="org-right">2</td>
<td class="org-left">[1]</td>
<td class="org-right">0.243146</td>
<td class="org-right">0.243146</td>
<td class="org-right">0</td>
</tr>
</tbody>
</table>
<p>Our <code>re_check_out</code> function has a little less coverage than <code>check</code> as we'd expect, since it excludes reviews with "view" in them but it also covers a little more than <code>check_out</code>.</p>
<div class="highlight">
<pre><span></span>print(TABLE(LFAnalysis(
    L=development_labeling_matrix,
    lfs=labeling_functions).lf_summary(Y=development.CLASS.values)))
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">j</th>
<th class="org-left" scope="col">Polarity</th>
<th class="org-right" scope="col">Coverage</th>
<th class="org-right" scope="col">Overlaps</th>
<th class="org-right" scope="col">Conflicts</th>
<th class="org-right" scope="col">Correct</th>
<th class="org-right" scope="col">Incorrect</th>
<th class="org-right" scope="col">Emp. Acc.</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">check</td>
<td class="org-right">0</td>
<td class="org-left">[1]</td>
<td class="org-right">0.26</td>
<td class="org-right">0.245</td>
<td class="org-right">0</td>
<td class="org-right">49</td>
<td class="org-right">3</td>
<td class="org-right">0.942308</td>
</tr>
<tr>
<td class="org-left">check_out</td>
<td class="org-right">1</td>
<td class="org-left">[1]</td>
<td class="org-right">0.225</td>
<td class="org-right">0.225</td>
<td class="org-right">0</td>
<td class="org-right">45</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-left">re_check_out</td>
<td class="org-right">2</td>
<td class="org-left">[1]</td>
<td class="org-right">0.245</td>
<td class="org-right">0.245</td>
<td class="org-right">0</td>
<td class="org-right">49</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>
<p>It looks like we were able to avoid the false-positives by adding our regular expression.</p>
<div class="highlight">
<pre><span></span>buckets = get_label_buckets(development_labeling_matrix[:, 0], development_labeling_matrix[:,2])
for comment in development.iloc[buckets[(Comment.is_spam, Comment.is_ambiguous)]]["CONTENT"]:
    print(comment)
</pre></div>
<pre class="example">
i turned it on mute as soon is i came on i just wanted to check the  views...﻿
i check back often to help reach 2x10^9 views and I avoid watching Baby﻿
Admit it you just came here to check the number of viewers ﻿
</pre>
<p>So it looks like we got rid of some false positives but also missed some spam by using the regular expression. We could probably grab more by searching for "my" as well.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-org0eb4199">
<h3 id="org0eb4199">Using TextBlob with a Preprocessor</h3>
<div class="outline-text-3" id="text-org0eb4199">
<p>Here we'll use text-blobs sentiment scorer to find comments that aren't spam. To do this we'll need to use snorkel's Preprocessor, which maps data using black-box functions.</p>
<div class="highlight">
<pre><span></span>@preprocessor(memoize=True)
def textblob_sentiment(row: pandas.Series) -&gt; pandas.Series:
    """Add the polarity and subjectivity of the comment's sentiment

    This adds two columns ('polarity' and 'subjectivity') based on the comment

    """
    blob = TextBlob(row.CONTENT)
    row["polarity"] = blob.sentiment.polarity
    row["subjectivity"] = blob.sentiment.subjectivity
    return row
</pre></div>
<p>The <code>polarity</code> is a value from -1.0 to 1.0 which reflects how negative or positive the text is believed to be. The <code>subjectivity</code> is a value from 0.0 to 1.0 which reflects whether the text is objective or subjective - whether it is a statement of fact or opinion.</p>
<p>Now that we have the pre-processor we can use it with a labeling function.</p>
</div>
<div class="outline-4" id="outline-container-org3f9b491">
<h4 id="org3f9b491">Polarity</h4>
<div class="outline-text-4" id="text-org3f9b491">
<div class="highlight">
<pre><span></span>@labeling_function(pre=[textblob_sentiment])
def textblob_polarity(row: pandas.Series) -&gt; int:
    """decides if the comment is ham based on the polarity of the sentiment"""
    return Comment.is_ham if row.polarity &gt; 0.9 else Comment.is_ambiguous
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgfe2eafc">
<h4 id="orgfe2eafc">Subjectivity</h4>
<div class="outline-text-4" id="text-orgfe2eafc">
<div class="highlight">
<pre><span></span>@labeling_function(pre=[textblob_sentiment])
def textblob_subjectivity(row: pandas.Series) -&gt; int:
    """decides if the comment is ham based on the subjectivity"""
    return Comment.is_ham if row.subjectivity &gt; 0.5 else Comment.is_ambiguous
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org76d0eee">
<h4 id="org76d0eee">Analyzing the Performance</h4>
<div class="outline-text-4" id="text-org76d0eee">
<p>Once again, now that we have labeling functions we need to analyze how well they do.</p>
<div class="highlight">
<pre><span></span>labeling_functions = [textblob_polarity, textblob_subjectivity]
applier = PandasLFApplier(lfs=labeling_functions)
train_label_matrix = applier.apply(train, progress_bar=False)
development_label_matrix = applier.apply(development, progress_bar=False)
</pre></div>
<div class="highlight">
<pre><span></span>print(TABLE(LFAnalysis(train_label_matrix, labeling_functions).lf_summary()))
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">j</th>
<th class="org-left" scope="col">Polarity</th>
<th class="org-right" scope="col">Coverage</th>
<th class="org-right" scope="col">Overlaps</th>
<th class="org-right" scope="col">Conflicts</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">textblob_polarity</td>
<td class="org-right">0</td>
<td class="org-left">[0]</td>
<td class="org-right">0.033189</td>
<td class="org-right">0.0122655</td>
<td class="org-right">0</td>
</tr>
<tr>
<td class="org-left">textblob_subjectivity</td>
<td class="org-right">1</td>
<td class="org-left">[0]</td>
<td class="org-right">0.32684</td>
<td class="org-right">0.0122655</td>
<td class="org-right">0</td>
</tr>
</tbody>
</table>
<div class="highlight">
<pre><span></span>print(TABLE(LFAnalysis(development_label_matrix, labeling_functions).lf_summary(Y=development.CLASS.values)))
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">j</th>
<th class="org-left" scope="col">Polarity</th>
<th class="org-right" scope="col">Coverage</th>
<th class="org-right" scope="col">Overlaps</th>
<th class="org-right" scope="col">Conflicts</th>
<th class="org-right" scope="col">Correct</th>
<th class="org-right" scope="col">Incorrect</th>
<th class="org-right" scope="col">Emp. Acc.</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">textblob_polarity</td>
<td class="org-right">0</td>
<td class="org-left">[0]</td>
<td class="org-right">0.05</td>
<td class="org-right">0.025</td>
<td class="org-right">0</td>
<td class="org-right">9</td>
<td class="org-right">1</td>
<td class="org-right">0.9</td>
</tr>
<tr>
<td class="org-left">textblob_subjectivity</td>
<td class="org-right">1</td>
<td class="org-left">[0]</td>
<td class="org-right">0.3</td>
<td class="org-right">0.025</td>
<td class="org-right">0</td>
<td class="org-right">32</td>
<td class="org-right">28</td>
<td class="org-right">0.533333</td>
</tr>
</tbody>
</table>
<p>Subjectivity seems to have much better coverage, but it was also fairly inaccurate.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgba3195b">
<h3 id="orgba3195b">More Labeling Functions</h3>
<div class="outline-text-3" id="text-orgba3195b">
<p>We previously created a keyword-based labeling function for "check". Because using keywords is such a common thing Snorkel has a way to create them with a little less work than creating the labeling functions individually.</p>
<p>First we make a function that checks if any of a collection of keywords is in the comment.</p>
<div class="highlight">
<pre><span></span>def lookup_keyword(row: pandas.Series, keywords: list, label: int) -&gt; int:
    """check if any of the keywords are in the comment

    Args:
     row: the series with the Comment
     keywords: collection of keywords indicating spam
     label: what to return if the keyword is in the comment

    Returns:
     label if keyword in comment else -1
    """
    return label if any(keyword in row.CONTENT.lower() for keyword in keywords) else Comment.is_ambiguous
</pre></div>
<p>Now we make the labeling-function creator that uses the <code>lookup_keyword</code>.</p>
<div class="highlight">
<pre><span></span>def make_keyword_labeling_function(keywords: list, label: int=Comment.is_spam) -&gt; LabelingFunction:
    """Makes LabelingFunction objects that check keywords"""
    return LabelingFunction(
        name=f"keyword_{keywords[0]}",
        f=lookup_keyword,
        resources=dict(keywords=keywords, label=label)
    )
</pre></div>
<div class="highlight">
<pre><span></span>keyword_my = make_keyword_labeling_function(keywords=["my"])
keyword_subscribe = make_keyword_labeling_function(keywords=["subscribe"])
keyword_link = make_keyword_labeling_function(keywords=["http"])
keyword_please = make_keyword_labeling_function(keywords=["please", "plz"])
keyword_song = make_keyword_labeling_function(keywords=["song"], label=Comment.is_ham)
</pre></div>
<div class="highlight">
<pre><span></span>labeling_functions = [
    keyword_my,
    keyword_subscribe,
    keyword_link,
    keyword_please,
    keyword_song,
]
applier = PandasLFApplier(lfs=labeling_functions)
train_label_matrix = applier.apply(train, progress_bar=False)
development_label_matrix = applier.apply(development, progress_bar=False)
print(TABLE(LFAnalysis(development_label_matrix, labeling_functions).lf_summary(Y=development.CLASS.values)))
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">j</th>
<th class="org-left" scope="col">Polarity</th>
<th class="org-right" scope="col">Coverage</th>
<th class="org-right" scope="col">Overlaps</th>
<th class="org-right" scope="col">Conflicts</th>
<th class="org-right" scope="col">Correct</th>
<th class="org-right" scope="col">Incorrect</th>
<th class="org-right" scope="col">Emp. Acc.</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">keyword_my</td>
<td class="org-right">0</td>
<td class="org-left">[1]</td>
<td class="org-right">0.18</td>
<td class="org-right">0.115</td>
<td class="org-right">0.05</td>
<td class="org-right">33</td>
<td class="org-right">3</td>
<td class="org-right">0.916667</td>
</tr>
<tr>
<td class="org-left">keyword_subscribe</td>
<td class="org-right">1</td>
<td class="org-left">[1]</td>
<td class="org-right">0.125</td>
<td class="org-right">0.075</td>
<td class="org-right">0.015</td>
<td class="org-right">25</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-left">keyword_http</td>
<td class="org-right">2</td>
<td class="org-left">[1]</td>
<td class="org-right">0.09</td>
<td class="org-right">0.03</td>
<td class="org-right">0.005</td>
<td class="org-right">16</td>
<td class="org-right">2</td>
<td class="org-right">0.888889</td>
</tr>
<tr>
<td class="org-left">keyword_please</td>
<td class="org-right">3</td>
<td class="org-left">[1]</td>
<td class="org-right">0.095</td>
<td class="org-right">0.08</td>
<td class="org-right">0.02</td>
<td class="org-right">19</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-left">keyword_song</td>
<td class="org-right">4</td>
<td class="org-left">[0]</td>
<td class="org-right">0.16</td>
<td class="org-right">0.06</td>
<td class="org-right">0.06</td>
<td class="org-right">20</td>
<td class="org-right">12</td>
<td class="org-right">0.625</td>
</tr>
</tbody>
</table>
<p>There are varying degrees of coveragen and accuracy with these. Interestingly, the <code>subscribe</code> keyword was completely accurate and had pretty good coverage (compared to our check-out labelers).</p>
</div>
</div>
<div class="outline-3" id="outline-container-org4575456">
<h3 id="org4575456">Adding a Spacy Preprocessor</h3>
<div class="outline-text-3" id="text-org4575456">
<p>The purpose of the pre-processors is to do a little feature engineering to add features that aren't in the original dataset but which can be derived from it. Becaues SpaCY is used so much for this, snorkel comes with a labeling function that adds a <code>doc</code> attribute (you can also create it manually to get more control).</p>
<div class="highlight">
<pre><span></span>@nlp_labeling_function()
def short_with_person(row: pandas.Series) -&gt; int:
    """Check if the comment is short and mentions a person"""
    return (Comment.is_ham if (len(row.CONTENT) &lt; 20 and any((entity.label_=="PERSON" for entity in row.dot.ents)))
                               else Comment.is_ambiguous)
</pre></div>
</div>
</div>
</div>
</div>
</article>
</div>
<ul class="pager postindexpager clearfix">
<li class="next"><a href="/index-5.html" rel="next">Older posts</a></li>
</ul>
<!--End of body content-->
<footer id="footer">Contents © 2020 <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="/assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
</script> 
</body>
</html>
