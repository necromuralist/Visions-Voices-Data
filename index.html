<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Adumbrations of data." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Visions, Voices, Data</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Visions-Voices-Data/" rel="canonical">
<link href="index-7.html" rel="next" type="text/html"><!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]-->
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript"></script><!--
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.min.js"
</script>
-->
<script async src="javascript/p5.min.js" type="text/javascript"></script>
<link href="/posts/cpr-and-blood-thinners/" rel="prefetch" type="text/html">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="/"><span id="blog-title">Visions, Voices, Data</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="/archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="/categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="/rss.xml">RSS feed</a></li>
<li class="nav-item dropdown"><a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Pages</a>
<div class="dropdown-menu"><a class="dropdown-item active" href="/">Cloistered Monkey <span class="sr-only">(active)</span></a> <a class="dropdown-item" href="/pages/giss/giss-yearly-anomalies-by-climate-zone">GISS Anomalies</a></div>
</li>
</ul>
<!-- DuckDuckGo custom search -->
<form action="https://duckduckgo.com/" class="navbar-form pull-left" id="search" method="get" name="search"><input name="sites" type="hidden" value="https://necromuralist.github.io/Visions-Voices-Data/"> <input name="k8" type="hidden" value="#444444"> <input name="k9" type="hidden" value="#D51920"> <input name="kt" type="hidden" value="h"> <input class="span2" maxlength="255" name="q" placeholder="Searchâ€¦" type="text"> <input style="visibility: hidden;display:none" type="submit" value="DuckDuckGo Search"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<div class="postindex">
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/cpr-and-blood-thinners/">CPR and Blood Thinners</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/cpr-and-blood-thinners/" rel="bookmark"><time class="published dt-published" datetime="2020-10-01T18:16:06-07:00" itemprop="datePublished" title="2020-10-01 18:16">2020-10-01 18:16</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/cpr-and-blood-thinners/#org95926ba">Beginning</a>
<ul>
<li><a href="/posts/cpr-and-blood-thinners/#org0f6546c">Set Up</a></li>
</ul>
</li>
<li><a href="/posts/cpr-and-blood-thinners/#orgda02bc3">Middle</a>
<ul>
<li><a href="/posts/cpr-and-blood-thinners/#org66e32ff">The Study Data</a></li>
<li><a href="/posts/cpr-and-blood-thinners/#orgeadd5f7">Simulation</a></li>
</ul>
</li>
<li><a href="/posts/cpr-and-blood-thinners/#org9526158">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org95926ba">
<h2 id="org95926ba">Beginning</h2>
<div class="outline-text-2" id="text-org95926ba">
<p>We want to test the hypothesis that blood thinners administered to patients that have been give CPR has <i>some</i> kind of effect (for good or for ill) on survival rates.</p>
<ul class="org-ul">
<li>\(H_0\): Bood thinners don't have an effect on survival rate - the proportions will be the same for each group (\(p_{treatment} = p_{control}\)).</li>
<li>\(H_A\): Blood thinners impact survival, either positive or negative (\(p_{treatment} - p_{control} \neq 0\)).</li>
</ul>
<p>We're going to use a significance level of 0.05.</p>
<div class="highlight">
<pre><span></span><span class="n">ALPHA</span> <span class="o">=</span> <span class="mf">0.05</span>
</pre></div>
</div>
<div class="outline-3" id="outline-container-org0f6546c">
<h3 id="org0f6546c">Set Up</h3>
<div class="outline-text-3" id="text-org0f6546c"></div>
<div class="outline-4" id="outline-container-orgb150f46">
<h4 id="orgb150f46">Imports</h4>
<div class="outline-text-4" id="text-orgb150f46">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">default_rng</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># my stuff</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org66011a0">
<h4 id="org66011a0">Random Generator</h4>
<div class="outline-text-4" id="text-org66011a0">
<div class="highlight">
<pre><span></span><span class="n">numpy_random</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgd2b9555">
<h4 id="orgd2b9555">The Timer</h4>
<div class="outline-text-4" id="text-orgd2b9555">
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org1230dfe">
<h4 id="org1230dfe">Plotting</h4>
<div class="outline-text-4" id="text-org1230dfe">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"cpr-and-blood-thinners"</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">f</span><span class="s2">"files/posts/{SLUG}"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>

<span class="n">Plot</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">990</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">780</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">tan</span><span class="o">=</span><span class="s2">"#ddb377"</span><span class="p">,</span>
    <span class="n">blue</span><span class="o">=</span><span class="s2">"#4687b7"</span><span class="p">,</span>
    <span class="n">red</span><span class="o">=</span><span class="s2">"#ce7b6d"</span><span class="p">,</span>
    <span class="n">color_cycle</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">Cycle</span><span class="p">([</span><span class="s2">"#4687b7"</span><span class="p">,</span> <span class="s2">"#ce7b6d"</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org14f4425">
<h4 id="org14f4425">The Table Printer</h4>
<div class="outline-text-4" id="text-org14f4425">
<div class="highlight">
<pre><span></span><span class="n">TABLE</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">tabulate</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgda02bc3">
<h2 id="orgda02bc3">Middle</h2>
<div class="outline-text-2" id="text-orgda02bc3"></div>
<div class="outline-3" id="outline-container-org66e32ff">
<h3 id="org66e32ff">The Study Data</h3>
<div class="outline-text-3" id="text-org66e32ff">
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
    <span class="nb">dict</span><span class="p">(</span>
        <span class="n">Survived</span><span class="o">=</span><span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">14</span><span class="p">],</span>
        <span class="n">Died</span> <span class="o">=</span> <span class="p">[</span><span class="mi">39</span><span class="p">,</span> <span class="mi">26</span><span class="p">]))</span>
<span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Control"</span><span class="p">,</span> <span class="s2">"Treatment"</span><span class="p">]</span>
<span class="n">row</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">row</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Total"</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s2">"Total"</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">"columns"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">Survived</th>
<th class="org-right" scope="col">Died</th>
<th class="org-right" scope="col">Total</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Control</td>
<td class="org-right">11</td>
<td class="org-right">39</td>
<td class="org-right">50</td>
</tr>
<tr>
<td class="org-left">Treatment</td>
<td class="org-right">14</td>
<td class="org-right">26</td>
<td class="org-right">40</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Total</td>
<td class="org-right">25</td>
<td class="org-right">65</td>
<td class="org-right">90</td>
</tr>
</tbody>
</table>
<p>The fifty people in the Control Group didn't receive blood thinners and the forty in the Treatment Group did.</p>
<p>Now I'll plot it to see what the differences look like.</p>
<div class="highlight">
<pre><span></span><span class="c1"># put the groups into a column</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="c1"># get rid of the totals</span>
<span class="k">del</span><span class="p">(</span><span class="n">plotter</span><span class="p">[</span><span class="s2">"Total"</span><span class="p">])</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">plotter</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">"index"</span><span class="p">],</span>
                       <span class="n">value_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">"Survived"</span><span class="p">,</span> <span class="s2">"Died"</span><span class="p">])</span>

<span class="n">plotter</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="s2">"Group"</span><span class="p">,</span>
    <span class="n">variable</span><span class="o">=</span><span class="s2">"Outcome"</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="s2">"Count"</span><span class="p">))</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Group"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Count"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"Outcome"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Survived or Died"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">color_cycle</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">fontscale</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"survived_or_died"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="/posts/cpr-and-blood-thinners/survived_or_died.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>Hard to say, but it looks like more of the Treatment Group survived.</p>
</div>
<div class="outline-4" id="outline-container-org0f31697">
<h4 id="org0f31697">The Porportions</h4>
<div class="outline-text-4" id="text-org0f31697">
<p>We are interested in the difference in survival rates so we need to calculate the proprtion that survived in each group and take the difference.</p>
<div class="highlight">
<pre><span></span><span class="n">survival_rates</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">"Survived"</span><span class="p">]</span> <span class="o">/</span> <span class="n">data</span><span class="o">.</span><span class="n">Total</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">"index"</span><span class="p">:</span> <span class="s2">"Group"</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s2">"Survival Rate"</span><span class="p">})</span>
<span class="k">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">survival_rates</span><span class="p">,</span> <span class="n">showindex</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Group</th>
<th class="org-right" scope="col">Survival Rate</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Control</td>
<td class="org-right">0.22</td>
</tr>
<tr>
<td class="org-left">Treatment</td>
<td class="org-right">0.35</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Total</td>
<td class="org-right">0.277778</td>
</tr>
</tbody>
</table>
<div class="highlight">
<pre><span></span><span class="n">survival_rates</span> <span class="o">=</span> <span class="n">survival_rates</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">"Group"</span><span class="p">)</span>
<span class="n">TEST_STATISTIC</span> <span class="o">=</span> <span class="n">survival_rates</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">"Treatment"</span><span class="p">]</span> <span class="o">-</span> <span class="n">survival_rates</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">"Control"</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Difference: {TEST_STATISTIC}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Difference: Survival Rate    0.13
dtype: float64
</pre>
<p>It appears that 13% more people survive when they are given blood thinners than when they aren't.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgeadd5f7">
<h3 id="orgeadd5f7">Simulation</h3>
<div class="outline-text-3" id="text-orgeadd5f7">
<p>Now I'll run a simulation to build up the <b>null distribution</b> of the differences.</p>
</div>
<div class="outline-4" id="outline-container-org0164b42">
<h4 id="org0164b42">Set Up The Urn</h4>
<div class="outline-text-4" id="text-org0164b42">
<p>The urn will be based on the total row on the contingency table. The that number survived will be represented as ones and the number that died will be represented as zeros.</p>
<div class="highlight">
<pre><span></span><span class="n">total</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">"Total"</span><span class="p">]</span>
<span class="n">survived</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">total</span><span class="o">.</span><span class="n">Survived</span><span class="p">)</span>
<span class="n">died</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">total</span><span class="o">.</span><span class="n">Died</span><span class="p">)</span>
<span class="n">urn</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">survived</span><span class="p">,</span> <span class="n">died</span><span class="p">)</span>
</pre></div>
<p>Now we'll run the simulation to get the distribution.</p>
<div class="highlight">
<pre><span></span><span class="n">TRIALS</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
<span class="n">CONTROL_GROUP</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Total</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">"Control"</span><span class="p">]</span>
<span class="n">TREATMENT_GROUP</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">Total</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">"Treatment"</span><span class="p">]</span>
<span class="n">survived</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">"Survived"</span><span class="p">]</span>

<span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">controls</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">numpy_random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">urn</span><span class="p">,</span>
                                                <span class="n">CONTROL_GROUP</span><span class="p">,</span>
                                                <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">TRIALS</span><span class="p">)])</span>
    <span class="n">treatments</span> <span class="o">=</span> <span class="n">survived</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">"Total"</span><span class="p">]</span> <span class="o">-</span> <span class="n">controls</span>

    <span class="n">control_proportions</span> <span class="o">=</span> <span class="n">controls</span><span class="o">/</span><span class="n">CONTROL_GROUP</span>
    <span class="n">treatment_proportions</span> <span class="o">=</span> <span class="n">treatments</span><span class="o">/</span><span class="n">TREATMENT_GROUP</span>

    <span class="n">differences</span> <span class="o">=</span> <span class="n">treatment_proportions</span> <span class="o">-</span> <span class="n">control_proportions</span>
    <span class="n">differences</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s2">"Point Estimate"</span><span class="p">:</span> <span class="n">differences</span><span class="p">})</span>
</pre></div>
<pre class="example">
2020-10-01 19:38:55,370 graeae.timers.timer start: Started: 2020-10-01 19:38:55.370038
2020-10-01 19:39:31,437 graeae.timers.timer end: Ended: 2020-10-01 19:39:31.437364
2020-10-01 19:39:31,438 graeae.timers.timer end: Elapsed: 0:00:36.067326
</pre>
<p>Plot the distribution.</p>
<div class="highlight">
<pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">differences</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="s2">"Point Estimate"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Null Distribution of Point Estimate"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">tan</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">fontscale</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"null_distribution"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="/posts/cpr-and-blood-thinners/null_distribution.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>Now we want to try a two-sided hypothesis test.</p>
<div class="highlight">
<pre><span></span><span class="n">right_side</span> <span class="o">=</span> <span class="p">(</span><span class="n">differences</span> <span class="o">&gt;=</span> <span class="n">TEST_STATISTIC</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">total</span> <span class="o">=</span> <span class="n">right_side</span> <span class="o">*</span> <span class="mi">2</span>
<span class="n">p_value</span> <span class="o">=</span> <span class="n">total</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">differences</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"One-Sided p-value: {(right_side/len(differences)).values[0]}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Two-sided p-value: {p_value.values[0]}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
One-Sided p-value: 0.129026
Two-sided p-value: 0.258052
</pre>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"We reject the Null Hypothesis: {p_value.values[0] &lt; ALPHA}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
We reject the Null Hypothesis: False
</pre>
<p>Even a single-sided test wouldn't have provided enough evidence to reject the null hypothesis, but with the two-sided version it looks really like the difference was from chance.</p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org9526158">
<h2 id="org9526158">End</h2>
<div class="outline-text-2" id="text-org9526158">
<p>Although it initially looked like the use of blood thinners after someone has been given CPR helped survival rates our data does not contain evidence to say that it does.</p>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/opportunity-cost-neglect/">Opportunity Cost Neglect</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/opportunity-cost-neglect/" rel="bookmark"><time class="published dt-published" datetime="2020-09-26T18:34:45-07:00" itemprop="datePublished" title="2020-09-26 18:34">2020-09-26 18:34</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div class="outline-2" id="outline-container-org810f8a5">
<h2 id="org810f8a5">Citation</h2>
<div class="outline-text-2" id="text-org810f8a5">
<ul class="org-ul">
<li>Frederick S, Novemsky N, Wang J, Dhar R, Nowlis S. Opportunity cost neglect. Journal of Consumer Research. 2009 Dec 1;36(4):553-61.</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org1018d95">
<h2 id="org1018d95">Abstract</h2>
<div class="outline-text-2" id="text-org1018d95"></div>
<div class="outline-3" id="outline-container-orgd83bc84">
<h3 id="orgd83bc84">And</h3>
<div class="outline-text-3" id="text-orgd83bc84">
<p>To properly consider the opportunity costs of a purchase, consumers must actively generate the alternatives that it would displace.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orge75c424">
<h3 id="orge75c424">But</h3>
<div class="outline-text-3" id="text-orge75c424">
<p>The current research suggests that consumers often fail to do so. Even under conditions promoting cognitive effort, various cues to consider opportunity costs reduce purchase rates and increase the choice share of more affordable options. Sensitivity to such cues varies with chronic dispositional differences in spending attitudes.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org88cd190">
<h3 id="org88cd190">Therefore</h3>
<div class="outline-text-3" id="text-org88cd190">
<p>We discuss the implications of these results for the marketing strategies of economy and premium brands.</p>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/opportunity-cost/">Opportunity Cost</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/opportunity-cost/" rel="bookmark"><time class="published dt-published" datetime="2020-09-26T16:07:12-07:00" itemprop="datePublished" title="2020-09-26 16:07">2020-09-26 16:07</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/opportunity-cost/#orgd3dd701">Beginning</a>
<ul>
<li><a href="/posts/opportunity-cost/#orga87d4be">Imports</a></li>
<li><a href="/posts/opportunity-cost/#orgbcd59d6">Set Up</a></li>
</ul>
</li>
<li><a href="/posts/opportunity-cost/#org568ee1c">Middle</a>
<ul>
<li><a href="/posts/opportunity-cost/#org747d69d">Hypotheses</a></li>
<li><a href="/posts/opportunity-cost/#org5b6b329">The Study Data</a></li>
<li><a href="/posts/opportunity-cost/#org7bbeecb">Point Estimate of Effect</a></li>
<li><a href="/posts/opportunity-cost/#org4be2e6d">Simulating Random Chance</a></li>
</ul>
</li>
<li><a href="/posts/opportunity-cost/#org25b24b2">End</a>
<ul>
<li><a href="/posts/opportunity-cost/#org89aebac">In the Abstract</a></li>
<li><a href="/posts/opportunity-cost/#orgc0c9553">Source</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgd3dd701">
<h2 id="orgd3dd701">Beginning</h2>
<div class="outline-text-2" id="text-orgd3dd701">
<p>We want to answer the question of whether reminding college students that spending money now deprives them of money in the future will affect their spending behavior.</p>
</div>
<div class="outline-3" id="outline-container-orga87d4be">
<h3 id="orga87d4be">Imports</h3>
<div class="outline-text-3" id="text-orga87d4be">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">equal</span><span class="p">,</span>
    <span class="n">expect</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">default_rng</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># my stuff</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgbcd59d6">
<h3 id="orgbcd59d6">Set Up</h3>
<div class="outline-text-3" id="text-orgbcd59d6"></div>
<div class="outline-4" id="outline-container-orge815022">
<h4 id="orge815022">Randomness</h4>
<div class="outline-text-4" id="text-orge815022">
<div class="highlight">
<pre><span></span><span class="n">numpy_random</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org083a7f2">
<h4 id="org083a7f2">Table</h4>
<div class="outline-text-4" id="text-org083a7f2">
<div class="highlight">
<pre><span></span><span class="n">TABLE</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">tabulate</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgdfa5b54">
<h4 id="orgdfa5b54">Timer and Plotting</h4>
<div class="outline-text-4" id="text-orgdfa5b54">
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>

<span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"opportunity-cost"</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span>
                <span class="n">folder_path</span><span class="o">=</span><span class="n">f</span><span class="s2">"files/posts/{SLUG}"</span><span class="p">)</span>

<span class="n">Plot</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">990</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">780</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">tan</span><span class="o">=</span><span class="s2">"#ddb377"</span><span class="p">,</span>
    <span class="n">blue</span><span class="o">=</span><span class="s2">"#4687b7"</span><span class="p">,</span>
    <span class="n">red</span><span class="o">=</span><span class="s2">"#ce7b6d"</span><span class="p">,</span>
    <span class="n">color_cycle</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">Cycle</span><span class="p">([</span><span class="s2">"#4687b7"</span><span class="p">,</span> <span class="s2">"#ce7b6d"</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org568ee1c">
<h2 id="org568ee1c">Middle</h2>
<div class="outline-text-2" id="text-org568ee1c"></div>
<div class="outline-3" id="outline-container-org747d69d">
<h3 id="org747d69d">Hypotheses</h3>
<div class="outline-text-3" id="text-org747d69d">
<ul class="org-ul">
<li>\(H_0:\) <b>Null Hypothesis.</b> Reminding students that they can save money for future purchases won't impact their spending decisions.</li>
<li>\(H_A:\) <b>Alternative Hypothesis.</b> Reminding students that they can save money for future purchases will reduce their spending.</li>
</ul>
<p>I'll us a 95% significance level.</p>
<div class="highlight">
<pre><span></span><span class="n">ALPHA</span> <span class="o">=</span> <span class="s2">"0.05"</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org5b6b329">
<h3 id="org5b6b329">The Study Data</h3>
<div class="outline-text-3" id="text-org5b6b329">
<p>150 Students were given the following statement:</p>
<blockquote>
<p>Imagine that you have been saving some extra money on the side to make some purchases and on your most recent visit to the video store you come across a special sale on a new video. This video is one with your favorite actor or actress, and your favorite type of movie (such as comedy, drama, thriller, etc.). This particular video that you are considering is one you have been thinking about buying for a long time. It is available for a special sale price of $14.99.</p>
<p>What would you do in this situation? Please circle one of the options below.</p>
</blockquote>
<p>Video store? Are we going to have to invent a time machine to run this study? No, we'll just swipe the data published by Frederick et al. in 2009. They conducted their study at Arizona State University, which perhaps still had some DVD stores around back then. The study was building on prior work that showed that people focus exclusively on explicitly presented details and ignore the facts that the explicit statements imply but don't state. (Also, I just looked it up and there's quite a few video stores around me (here in Portland) I guess I just haven't been to one in a while).</p>
<p>The options that the subjects were given to circle depended on which group they belonged to. The control group (75 students) were given these options:</p>
<blockquote>
<p>A. Buy this entertaining video.<br>
B. Not buy this entertaining video.</p>
</blockquote>
<p>The treatment group (also 75 students) were given these options:</p>
<blockquote>
<p>A. Buy this entertaining video.<br>
B. Not buy this entertaining video. Keep the $14.99 for other purchases.</p>
</blockquote>
<p>Here's the outcome of the study.</p>
<div class="highlight">
<pre><span></span><span class="n">Outcome</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">buy</span><span class="o">=</span><span class="s2">"Buy DVD"</span><span class="p">,</span>
    <span class="n">dont_buy</span><span class="o">=</span><span class="s2">"Not Buy DVD"</span><span class="p">,</span>
    <span class="n">control</span><span class="o">=</span><span class="s2">"Control Group"</span><span class="p">,</span>
    <span class="n">treatment</span><span class="o">=</span><span class="s2">"Treatment Group"</span><span class="p">,</span>
    <span class="n">total</span><span class="o">=</span><span class="s2">"Total"</span>
<span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="n">Outcome</span><span class="o">.</span><span class="n">buy</span><span class="p">:[</span><span class="mi">56</span><span class="p">,</span> <span class="mi">41</span><span class="p">],</span>
                                   <span class="n">Outcome</span><span class="o">.</span><span class="n">dont_buy</span><span class="p">:</span> <span class="p">[</span><span class="mi">19</span><span class="p">,</span> <span class="mi">34</span><span class="p">]})</span>
<span class="n">data</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">Outcome</span><span class="o">.</span><span class="n">control</span><span class="p">,</span> <span class="n">Outcome</span><span class="o">.</span><span class="n">treatment</span><span class="p">]</span>
<span class="n">row</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">row</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">Outcome</span><span class="o">.</span><span class="n">total</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="n">Outcome</span><span class="o">.</span><span class="n">total</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">"columns"</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">Buy DVD</th>
<th class="org-right" scope="col">Not Buy DVD</th>
<th class="org-right" scope="col">Total</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Control Group</td>
<td class="org-right">56</td>
<td class="org-right">19</td>
<td class="org-right">75</td>
</tr>
<tr>
<td class="org-left">Treatment Group</td>
<td class="org-right">41</td>
<td class="org-right">34</td>
<td class="org-right">75</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Total</td>
<td class="org-right">97</td>
<td class="org-right">53</td>
<td class="org-right">150</td>
</tr>
</tbody>
</table>
<div class="highlight">
<pre><span></span><span class="n">Total</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">buy</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">Outcome</span><span class="o">.</span><span class="n">total</span><span class="p">][</span><span class="n">Outcome</span><span class="o">.</span><span class="n">buy</span><span class="p">],</span>
    <span class="n">dont_buy</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">Outcome</span><span class="o">.</span><span class="n">total</span><span class="p">][</span><span class="n">Outcome</span><span class="o">.</span><span class="n">dont_buy</span><span class="p">],</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">Outcome</span><span class="o">.</span><span class="n">control</span><span class="p">][</span><span class="n">Outcome</span><span class="o">.</span><span class="n">total</span><span class="p">],</span>
    <span class="n">students</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">Outcome</span><span class="o">.</span><span class="n">total</span><span class="p">][</span><span class="n">Outcome</span><span class="o">.</span><span class="n">total</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
<p>Now a little plotting.</p>
<div class="highlight">
<pre><span></span><span class="c1"># put the groups into a column</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="c1"># get rid of the totals</span>
<span class="k">del</span><span class="p">(</span><span class="n">plotter</span><span class="p">[</span><span class="s2">"Total"</span><span class="p">])</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># move the outcome headers into a column</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">"index"</span><span class="p">],</span>
                       <span class="n">value_vars</span><span class="o">=</span><span class="p">[</span><span class="n">Outcome</span><span class="o">.</span><span class="n">buy</span><span class="p">,</span> <span class="n">Outcome</span><span class="o">.</span><span class="n">dont_buy</span><span class="p">])</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
    <span class="n">index</span><span class="o">=</span><span class="s2">"Group"</span><span class="p">,</span>
    <span class="n">variable</span><span class="o">=</span><span class="s2">"Outcome"</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="s2">"Count"</span><span class="p">))</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Group"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Count"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"Outcome"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Buy Or Don't Buy DVD"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">color_cycle</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">fontscale</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"buy_dont_buy"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="/posts/opportunity-cost/buy_dont_buy.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>It <i>looks</i> like there was a significant difference since not only did the majority of the treatment group opt not to buy the DVD, but in the control a significant majority did.</p>
<p>Now as row-proportions.</p>
<div class="highlight">
<pre><span></span><span class="n">proportions</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">Outcome</span><span class="o">.</span><span class="n">total</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s2">"rows"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">proportions</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">Buy DVD</th>
<th class="org-right" scope="col">Not Buy DVD</th>
<th class="org-right" scope="col">Total</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Control Group</td>
<td class="org-right">0.746667</td>
<td class="org-right">0.253333</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-left">Treatment Group</td>
<td class="org-right">0.546667</td>
<td class="org-right">0.453333</td>
<td class="org-right">1</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Total</td>
<td class="org-right">0.646667</td>
<td class="org-right">0.353333</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>
<p>Looking at the proportions it looks like quite a bit more didn't buy the DVD, but let's run the experiment and see.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org7bbeecb">
<h3 id="org7bbeecb">Point Estimate of Effect</h3>
<div class="outline-text-3" id="text-org7bbeecb">
<p>The thing we are interested in is whether the wording of the second option to not buy the DVD made a difference, so our statistic of interest is the difference in proportions of the control and treatment group participants who didn't buy the DVD.</p>
\begin{align} \hat{p}_{control} &amp;= \frac{\textrm{Control Group that wouldn't buy}}{\textrm{size of Control Group}}\\ \hat{p}_{treatment} &amp;= \frac{\textrm{Treatment Group that wouldn't buy}}{\textrm{size of Treament Group}}\\ \hat{p} &amp;= \hat{p}_{treatment} - \hat{p}_{control} \end{align}
<div class="highlight">
<pre><span></span><span class="n">POINT_ESTIMATE</span> <span class="o">=</span> <span class="p">(</span><span class="n">proportions</span><span class="p">[</span><span class="n">Outcome</span><span class="o">.</span><span class="n">dont_buy</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">Outcome</span><span class="o">.</span><span class="n">treatment</span><span class="p">]</span>
                  <span class="o">-</span> <span class="n">proportions</span><span class="p">[</span><span class="n">Outcome</span><span class="o">.</span><span class="n">dont_buy</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">Outcome</span><span class="o">.</span><span class="n">control</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{POINT_ESTIMATE * 100:.2f} %"</span><span class="p">)</span>
</pre></div>
<pre class="example">
20.00 %
</pre>
<p>About twenty percent more of the treatment group said they would abstain from the purchase than control group.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org4be2e6d">
<h3 id="org4be2e6d">Simulating Random Chance</h3>
<div class="outline-text-3" id="text-org4be2e6d">
<p>In a previous post looking at <a href="/posts/gender-discrimination/">Gender Discrimination Inference</a> I split the Urn into a 50-50 split of males and females to see if there was gender bias in choosing whether to promote them. In this case it's going to work a little differently.</p>
<p>We are asking here whether our treatment had an effect. If it didn't then we would expect that the distribution of "buy" and "don't buy" that we saw represents the distribution of the underlying population of ASU students, so we need to split our urn up to match the counts in the "Buy" and "Don't Buy" columns and then randomly split it into two equal groups. If the difference we saw was the result of random chance then we would expect that the difference between "buy" and "don't buy" group would be equal most of the time. This doesn't seem as intuitive a way to set it up as the previous method, but we'll see how it goes.</p>
</div>
<div class="outline-4" id="outline-container-org6600c6b">
<h4 id="org6600c6b">Set Up the Urn</h4>
<div class="outline-text-4" id="text-org6600c6b">
<div class="highlight">
<pre><span></span><span class="n">buy</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">Outcome</span><span class="o">.</span><span class="n">total</span><span class="p">][</span><span class="n">Outcome</span><span class="o">.</span><span class="n">buy</span><span class="p">]</span>
<span class="n">dont</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">Outcome</span><span class="o">.</span><span class="n">total</span><span class="p">][</span><span class="n">Outcome</span><span class="o">.</span><span class="n">dont_buy</span><span class="p">]</span>

<span class="n">bought</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">buy</span><span class="p">)</span>
<span class="n">didnt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">dont</span><span class="p">)</span>

<span class="n">URN</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bought</span><span class="p">,</span> <span class="n">didnt</span><span class="p">)</span>

<span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">URN</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">STUDENTS</span><span class="p">))</span>
<span class="n">expect</span><span class="p">(</span><span class="n">buy</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="mi">97</span><span class="p">))</span>
<span class="n">expect</span><span class="p">(</span><span class="n">dont</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="mi">53</span><span class="p">))</span>
<span class="n">expect</span><span class="p">(</span><span class="n">URN</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">dont</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgad8c65e">
<h4 id="orgad8c65e">Simulate</h4>
<div class="outline-text-4" id="text-orgad8c65e">
<p>The Process:</p>
<ol class="org-ol">
<li>Shuffle the urn</li>
<li>Split the shuffled urn in half (control and treatment)</li>
<li>Count the proportion of each half that said they would not buy the DVD</li>
<li>Record the differences between the proportions of the control that wouldn't buy and the treatment that wouldn't buy</li>
</ol>
<p>But, since I'm doing this with numpy it works a little different.</p>
<p>My process:</p>
<ol class="org-ol">
<li>Randomly choose half the urn (without replacement) to get the control group</li>
<li>Sum the choices (this gives the count of the control that said they wouldn't buy)</li>
<li>Subtract the previous sum from the total that said they wouldn't buy (to get the treatment count)</li>
<li>Calculate the proportion of each group that said they wouldn't buy</li>
<li>Find the difference in proportion for each group</li>
</ol>
<div class="highlight">
<pre><span></span><span class="n">TRIALS</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>

<span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">controls</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">numpy_random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">URN</span><span class="p">,</span>
                                                <span class="n">Total</span><span class="o">.</span><span class="n">group</span><span class="p">,</span>
                                                <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                            <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">TRIALS</span><span class="p">)])</span>
    <span class="n">treatments</span> <span class="o">=</span> <span class="n">Total</span><span class="o">.</span><span class="n">dont_buy</span> <span class="o">-</span> <span class="n">controls</span>

    <span class="n">control_proportions</span> <span class="o">=</span> <span class="n">controls</span><span class="o">/</span><span class="n">Total</span><span class="o">.</span><span class="n">group</span>
    <span class="n">treatment_proportions</span> <span class="o">=</span> <span class="n">treatments</span><span class="o">/</span><span class="n">Total</span><span class="o">.</span><span class="n">group</span>

    <span class="n">differences</span> <span class="o">=</span> <span class="n">control_proportions</span> <span class="o">-</span> <span class="n">treatment_proportions</span>
    <span class="n">simulation</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span>
        <span class="s2">"Point Estimate"</span><span class="p">:</span> <span class="n">differences</span><span class="p">,</span>
        <span class="s2">"Control"</span><span class="p">:</span> <span class="n">control_proportions</span><span class="p">,</span>
        <span class="s2">"Treatment"</span><span class="p">:</span> <span class="n">treatment_proportions</span><span class="p">,</span>
    <span class="p">})</span>
</pre></div>
<pre class="example">
2020-09-26 20:02:52,224 graeae.timers.timer start: Started: 2020-09-26 20:02:52.224515
2020-09-26 20:03:29,174 graeae.timers.timer end: Ended: 2020-09-26 20:03:29.174373
2020-09-26 20:03:29,175 graeae.timers.timer end: Elapsed: 0:00:36.949858
</pre></div>
</div>
<div class="outline-4" id="outline-container-org79c0bef">
<h4 id="org79c0bef">Plot the Distribution</h4>
<div class="outline-text-4" id="text-org79c0bef">
<div class="highlight">
<pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">simulation</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="s2">"Point Estimate"</span><span class="p">,</span>
                              <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Opportunity Cost Don't Buy Difference"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">tan</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"opportunity_cost_simulation"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="/posts/opportunity-cost/opportunity_cost_simulation.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>The distribution appears to be reasonably normal, if a bit peaked in the middle.</p>
<div class="highlight">
<pre><span></span><span class="n">matched</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">simulation</span><span class="p">[</span><span class="n">simulation</span><span class="p">[</span><span class="s2">"Point Estimate"</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">POINT_ESTIMATE</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">simulation</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Percent of trials &gt;= Point Estimate of Study: {100 * matched:0.3f} %"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Percent of trials &gt;= Point Estimate of Study: 0.817 %
</pre>
<p>According to our simulation, less than one percent of the time we would see a difference like the study found by random chance alone.</p>
</div>
</div>
<div class="outline-4" id="outline-container-orgead7e12">
<h4 id="orgead7e12">Test Our Hypothesis</h4>
<div class="outline-text-4" id="text-orgead7e12">
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Null Hypothesis is {matched &gt;= POINT_ESTIMATE}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Null Hypothesis is False
</pre>
<p>So we'll conclude that the Null Hypothesis is false and that the Alternative Hypothesis that telling students about the opportunity cost of buying a DVD does have an effecte in getting them to not buy the DVD.</p>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org25b24b2">
<h2 id="org25b24b2">End</h2>
<div class="outline-text-2" id="text-org25b24b2">
<p>So here we have a walk through of Inference using simulation and an experiment with Control and Treatment groups. Although the conclusion reached is that reminding students of the money they would have in the future if they didn't spend it is "causal", since this was an experiment, I'm not 100% convinced that asking studnents what the</p>
</div>
<div class="outline-3" id="outline-container-org89aebac">
<h3 id="org89aebac">In the Abstract</h3>
<div class="outline-text-3" id="text-org89aebac">
<ol class="org-ol">
<li>Create an urn where the ones and zeros are equal to the totals for each of the outcome columns</li>
<li>Sample from the urn a simulated control group and treatment group (matching the sizes of the original groups)</li>
<li>Find the difference between the proportion of the control group and the treatment group that match the "success" outcome</li>
<li>Calculate the fraction of the differences that are equal to or greater than the differences in the study</li>
<li>Check if the fraction in the simulation meets your confidence level</li>
</ol>
</div>
</div>
<div class="outline-3" id="outline-container-orgc0c9553">
<h3 id="orgc0c9553">Source</h3>
<div class="outline-text-3" id="text-orgc0c9553">
<ul class="org-ul">
<li><a href="/posts/introductory-statistics-with-randomization-and-simulation/">Introductory Statistics with Randomization and Simulation</a></li>
<li><a href="/posts/opportunity-cost-neglect/">Opportunity Cost Neglect</a></li>
</ul>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/gender-discrimination/">Gender Discrimination Inference</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/gender-discrimination/" rel="bookmark"><time class="published dt-published" datetime="2020-09-22T17:04:38-07:00" itemprop="datePublished" title="2020-09-22 17:04">2020-09-22 17:04</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/gender-discrimination/#org3e75510">Beginning</a>
<ul>
<li><a href="/posts/gender-discrimination/#org2cb06b4">Imports</a></li>
<li><a href="/posts/gender-discrimination/#org6505bd0">Randomness</a></li>
<li><a href="/posts/gender-discrimination/#org19794dc">Plotting, Tables, and a Timer</a></li>
</ul>
</li>
<li><a href="/posts/gender-discrimination/#org8631ec1">Middle</a>
<ul>
<li><a href="/posts/gender-discrimination/#orgb151e7e">The Original Study</a></li>
<li><a href="/posts/gender-discrimination/#org98a7e9e">The Experiment</a></li>
<li><a href="/posts/gender-discrimination/#orgb3f0a26">Looking at the Distribution</a></li>
</ul>
</li>
<li><a href="/posts/gender-discrimination/#org627f1f8">End</a>
<ul>
<li><a href="/posts/gender-discrimination/#orgbb990b3">In Abstract</a></li>
<li><a href="/posts/gender-discrimination/#org51be7e5">Source</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org3e75510">
<h2 id="org3e75510">Beginning</h2>
<div class="outline-text-2" id="text-org3e75510"></div>
<div class="outline-3" id="outline-container-org2cb06b4">
<h3 id="org2cb06b4">Imports</h3>
<div class="outline-text-3" id="text-org2cb06b4">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">expects</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">equal</span><span class="p">,</span>
    <span class="n">expect</span><span class="p">,</span>    
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">default_rng</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">import</span> <span class="nn">holoviews</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># my stuff</span>
<span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org6505bd0">
<h3 id="org6505bd0">Randomness</h3>
<div class="outline-text-3" id="text-org6505bd0">
<div class="highlight">
<pre><span></span><span class="n">numpy_random</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org19794dc">
<h3 id="org19794dc">Plotting, Tables, and a Timer</h3>
<div class="outline-text-3" id="text-org19794dc"></div>
<div class="outline-4" id="outline-container-orgd9b279d">
<h4 id="orgd9b279d">Plotting</h4>
<div class="outline-text-4" id="text-orgd9b279d">
<div class="highlight">
<pre><span></span><span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span>
                <span class="n">folder_path</span><span class="o">=</span><span class="s2">"files/posts/gender-discrimination/"</span><span class="p">)</span>
<span class="n">Plot</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">990</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">780</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">tan</span><span class="o">=</span><span class="s2">"#ddb377"</span><span class="p">,</span>
    <span class="n">blue</span><span class="o">=</span><span class="s2">"#4687b7"</span><span class="p">,</span>
    <span class="n">red</span><span class="o">=</span><span class="s2">"#ce7b6d"</span><span class="p">,</span>
    <span class="n">color_cycle</span> <span class="o">=</span> <span class="n">holoviews</span><span class="o">.</span><span class="n">Cycle</span><span class="p">([</span><span class="s2">"#4687b7"</span><span class="p">,</span> <span class="s2">"#ce7b6d"</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org8021db5">
<h4 id="org8021db5">The Table</h4>
<div class="outline-text-4" id="text-org8021db5">
<div class="highlight">
<pre><span></span><span class="n">TABLE</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">tabulate</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orge825ed6">
<h4 id="orge825ed6">The Timer</h4>
<div class="outline-text-4" id="text-orge825ed6">
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org8631ec1">
<h2 id="org8631ec1">Middle</h2>
<div class="outline-text-2" id="text-org8631ec1"></div>
<div class="outline-3" id="outline-container-orgb151e7e">
<h3 id="orgb151e7e">The Original Study</h3>
<div class="outline-text-3" id="text-orgb151e7e">
<p>This starts with a study where bank managers were each given a personnel file and asked to decide if they would promote the person represented by the file to branch manager. The files were identical but half of them were filled out as male and half as female. The researchers wanted to know if these manager were biased in favor of men. The table below shows their resuts.</p>
<div class="highlight">
<pre><span></span><span class="n">study</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"Promoted"</span><span class="p">:</span> <span class="p">[</span><span class="mi">21</span><span class="p">,</span> <span class="mi">14</span><span class="p">],</span>
                          <span class="s2">"Not Promoted"</span><span class="p">:[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">]},</span>
                         <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">"Male"</span><span class="p">,</span> <span class="s2">"Female"</span><span class="p">])</span>
<span class="n">row</span> <span class="o">=</span> <span class="n">study</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">row</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">"Total"</span>
<span class="n">study</span> <span class="o">=</span> <span class="n">study</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
<span class="n">column</span> <span class="o">=</span> <span class="n">study</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">"columns"</span><span class="p">)</span>
<span class="n">study</span><span class="p">[</span><span class="s2">"Total"</span><span class="p">]</span> <span class="o">=</span> <span class="n">column</span>
<span class="k">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">study</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">Promoted</th>
<th class="org-right" scope="col">Not Promoted</th>
<th class="org-right" scope="col">Total</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Male</td>
<td class="org-right">21</td>
<td class="org-right">3</td>
<td class="org-right">24</td>
</tr>
<tr>
<td class="org-left">Female</td>
<td class="org-right">14</td>
<td class="org-right">10</td>
<td class="org-right">24</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">Total</td>
<td class="org-right">35</td>
<td class="org-right">13</td>
<td class="org-right">48</td>
</tr>
</tbody>
</table>
<p>Let's look at the values (without the totals) as a plot.</p>
<div class="highlight">
<pre><span></span><span class="n">plotter</span> <span class="o">=</span> <span class="n">study</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="k">del</span><span class="p">(</span><span class="n">plotter</span><span class="p">[</span><span class="s2">"Total"</span><span class="p">])</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">"index"</span><span class="p">],</span>
                       <span class="n">value_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">"Promoted"</span><span class="p">,</span> <span class="s2">"Not Promoted"</span><span class="p">])</span>
<span class="n">plotter</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">"Gender"</span><span class="p">,</span>
                                      <span class="n">value</span><span class="o">=</span><span class="s2">"Count"</span><span class="p">,</span>
                                      <span class="n">variable</span><span class="o">=</span><span class="s2">"Decision"</span><span class="p">))</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Gender"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Count"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"Decision"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Outcome by Gender"</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">fontscale</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">color_cycle</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"promotions_by_gender"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="/posts/gender-discrimination/promotions_by_gender.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>It looks like a considerable majority of the males were promoted whereas for the females only a slight majority were promoted.</p>
<div class="highlight">
<pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Decision"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"Count"</span><span class="p">,</span> <span class="n">by</span><span class="o">=</span><span class="s2">"Gender"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Male Vs Female by Decision"</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">fontscale</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">color_cycle</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"decision_by_gender"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="/posts/gender-discrimination/decision_by_gender.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>This plot doesn't make the disparity look quite as extreme as the previous plot did, I think.</p>
</div>
<div class="outline-4" id="outline-container-org7ccb9ec">
<h4 id="org7ccb9ec">About the Variables</h4>
<div class="outline-text-4" id="text-org7ccb9ec">
<p>I started using them without explicity stating it but we have two variable here - <code>Promoted</code> and <code>Not Promoted</code> are part of the <code>decision</code> variable and <code>Male</code> and <code>Female</code> are part of the <code>gender</code> variable.</p>
<p>Anywayâ€¦ so more males were chosen for promotion than female, but by what proportion?</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">study</span><span class="o">/</span><span class="n">study</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">"Total"</span><span class="p">]))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">Promoted</th>
<th class="org-right" scope="col">Not Promoted</th>
<th class="org-right" scope="col">Total</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Male</td>
<td class="org-right">0.6</td>
<td class="org-right">0.230769</td>
<td class="org-right">0.5</td>
</tr>
<tr>
<td class="org-left">Female</td>
<td class="org-right">0.4</td>
<td class="org-right">0.769231</td>
<td class="org-right">0.5</td>
</tr>
<tr>
<td class="org-left">Total</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>
<p>So 60% of the promoted were male and 40% of the promoted were female.</p>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{.6/.4:.2f}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
1.50
</pre>
<p>If you were promoted you were one and a half times more likely to be male. Another way to look at it is to ask - <i>What proportion of each gender was promoted?</i></p>
<div class="highlight">
<pre><span></span><span class="n">fractions</span> <span class="o">=</span> <span class="n">study</span><span class="o">/</span><span class="n">study</span><span class="o">.</span><span class="n">Total</span><span class="o">.</span><span class="n">values</span>
<span class="k">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">fractions</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">Promoted</th>
<th class="org-right" scope="col">Not Promoted</th>
<th class="org-right" scope="col">Total</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">Male</td>
<td class="org-right">0.875</td>
<td class="org-right">0.125</td>
<td class="org-right">0.5</td>
</tr>
<tr>
<td class="org-left">Female</td>
<td class="org-right">0.583333</td>
<td class="org-right">0.416667</td>
<td class="org-right">0.5</td>
</tr>
<tr>
<td class="org-left">Total</td>
<td class="org-right">1.45833</td>
<td class="org-right">0.541667</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>
<p>So about 88% of the males were promoted while only 58% of the females were promoted.</p>
<div class="highlight">
<pre><span></span><span class="n">POINT_ESTIMATE</span> <span class="o">=</span> <span class="n">fractions</span><span class="o">.</span><span class="n">Promoted</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'Male'</span><span class="p">]</span> <span class="o">-</span> <span class="n">fractions</span><span class="o">.</span><span class="n">Promoted</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'Female'</span><span class="p">]</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"{POINT_ESTIMATE:0.2f}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
0.29
</pre>
<p>There was a 30% difference between the rate of male promotion and the rate of female promotion. The question we have now is - <i>could this difference have happened by random chance or is this evidence of bias?</i>.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org98a7e9e">
<h3 id="org98a7e9e">The Experiment</h3>
<div class="outline-text-3" id="text-org98a7e9e">
<p>We have a <b>point estimate</b> of the difference of 0.29 - is this evidence of bias?</p>
</div>
<div class="outline-4" id="outline-container-orga0b30fb">
<h4 id="orga0b30fb">Our Hypotheses</h4>
<div class="outline-text-4" id="text-orga0b30fb">
<ul class="org-ul">
<li>\(H_0\): <b>Null Hypothesis.</b> The variables <code>gender</code> and =decision are independent and the observed difference was due to chance.</li>
<li>\(H_A\): <b>Alternative Hypothesis.</b> The variables <code>gender</code> and <code>decision</code> are not independent and the difference was not due to chance, but rather women were less likely to be promoted than men.</li>
</ul>
<p>I'm going to pick an arbitrary confidence interval of 0.95.</p>
<div class="highlight">
<pre><span></span><span class="n">ALPHA</span> <span class="o">=</span> <span class="mf">0.05</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org8a2ba69">
<h4 id="org8a2ba69">The Simulation</h4>
<div class="outline-text-4" id="text-org8a2ba69">
<p>The basic method here is we'll create an "urn" with an equal number of "balls" for men and women (24 of each in this case) and then randomly select 35 balls representing the number that were promoted and see the difference in the fraction of males promoted vs the number of females. To make the math simple I'll run it a number of times that is a power of 10.</p>
</div>
<ul class="org-ul">
<li><a id="org66d3394"></a>Some Setup<br>
<div class="outline-text-5" id="text-org66d3394">
<p>To make the counting easier I'll set males to be 1 and females to be 0 (so the number of males promoted is the sum and the females is the remainder).</p>
<div class="highlight">
<pre><span></span><span class="n">NUMBER_OF_MALES</span> <span class="o">=</span> <span class="n">NUMBER_OF_FEMALES</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">MALE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">FEMALE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">PROMOTED</span> <span class="o">=</span> <span class="mi">35</span>
<span class="n">MALES</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">NUMBER_OF_MALES</span><span class="p">)</span>
<span class="n">FEMALES</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NUMBER_OF_FEMALES</span><span class="p">)</span>
<span class="n">URN</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MALES</span><span class="p">,</span> <span class="n">FEMALES</span><span class="p">)</span>

<span class="n">expect</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">URN</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">NUMBER_OF_MALES</span> <span class="o">+</span> <span class="n">NUMBER_OF_FEMALES</span><span class="p">))</span>
<span class="n">expect</span><span class="p">(</span><span class="n">URN</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">equal</span><span class="p">(</span><span class="n">NUMBER_OF_MALES</span><span class="p">))</span>
</pre></div>
</div>
</li>
<li><a id="org07efa92"></a>The Trials<br>
<div class="outline-text-5" id="text-org07efa92">
<div class="highlight">
<pre><span></span><span class="n">TRIALS</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">7</span>
<span class="n">males_promoted</span> <span class="o">=</span> <span class="p">[</span><span class="n">numpy_random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">URN</span><span class="p">,</span> <span class="n">PROMOTED</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                  <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">TRIALS</span><span class="p">)]</span>
<span class="n">females_promoted</span> <span class="o">=</span> <span class="p">[</span><span class="n">PROMOTED</span> <span class="o">-</span> <span class="n">males</span> <span class="k">for</span> <span class="n">males</span> <span class="ow">in</span> <span class="n">males_promoted</span><span class="p">]</span>
<span class="n">proportion_males_promoted</span> <span class="o">=</span> <span class="p">[</span><span class="n">males</span><span class="o">/</span><span class="n">NUMBER_OF_MALES</span> <span class="k">for</span> <span class="n">males</span> <span class="ow">in</span> <span class="n">males_promoted</span><span class="p">]</span>
<span class="n">proportion_females_promoted</span> <span class="o">=</span> <span class="p">[</span><span class="n">females</span><span class="o">/</span><span class="n">NUMBER_OF_FEMALES</span> <span class="k">for</span> <span class="n">females</span> <span class="ow">in</span> <span class="n">females_promoted</span><span class="p">]</span>
<span class="n">pairs</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">proportion_males_promoted</span><span class="p">,</span> <span class="n">proportion_females_promoted</span><span class="p">)</span>
<span class="n">differences</span> <span class="o">=</span> <span class="p">[</span><span class="n">males</span> <span class="o">-</span> <span class="n">females</span> <span class="k">for</span> <span class="n">males</span><span class="p">,</span> <span class="n">females</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">]</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-orgb3f0a26">
<h3 id="orgb3f0a26">Looking at the Distribution</h3>
<div class="outline-text-3" id="text-orgb3f0a26">
<div class="highlight">
<pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span>
    <span class="s2">"Point Estimate"</span><span class="p">:</span> <span class="n">differences</span><span class="p">,</span>
    <span class="s2">"Males Promoted"</span><span class="p">:</span> <span class="n">males_promoted</span><span class="p">,</span>
    <span class="s2">"Females Promoted"</span><span class="p">:</span> <span class="n">females_promoted</span><span class="p">,</span>
    <span class="s2">"Proportion Males Promoted"</span><span class="p">:</span> <span class="n">proportion_males_promoted</span><span class="p">,</span>
    <span class="s2">"Proportion Females Promoted"</span><span class="p">:</span> <span class="n">proportion_females_promoted</span><span class="p">,</span>
<span class="p">})</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="s2">"Point Estimate"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Distribution of Differences in Gender Promotion"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">,</span>
    <span class="n">fontscale</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">fontscale</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">outcome</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"difference_distribution"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">outcome</span><span class="p">)</span>
</pre></div>
<object data="/posts/gender-discrimination/difference_distribution.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>The distribution looks <i>mostly</i> normal. As you might guess the distribution is centered around 0 (cases where exactly the same number of males and females were promoted - although 35 were promoted each time so the trials are never exactly 0). The cases where the difference in proportion is as great or greater than as it was in the original study are in the rightmost two bins.</p>
<p>I should note that because the sample size is so small, there's a weird distribution of the points - there's not enough variation in the differences to make a smooth curve (thus the gaps in the histogram).</p>
<p>But anyway, what proportion of our simulations had as much or more of a difference than that found in the study?</p>
<div class="highlight">
<pre><span></span><span class="n">proportion</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s2">"Point Estimate"</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">POINT_ESTIMATE</span><span class="p">])</span><span class="o">/</span><span class="n">TRIALS</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Proportion: {100 * proportion:0.3f} %"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Proportion: 2.450 %
</pre>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Probability of our study's difference in promotion between genders by chance alone: {proportion:0.2f}."</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Our tolerance was {ALPHA:0.2f}."</span><span class="p">)</span>
</pre></div>
<pre class="example">
Probability of our study's difference in promotion between genders by chance alone: 0.02.
Our tolerance was 0.05.
</pre>
<p>So we reject the null hypothesis and conclude that there is a statistically significant chance that the number of women promoted vs men in the original study was the result of bias.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org627f1f8">
<h2 id="org627f1f8">End</h2>
<div class="outline-text-2" id="text-org627f1f8">
<p>Well, that was the replication (sort of) of this problem from <a href="/posts/introductory-statistics-with-randomization-and-simulation/">Introductory Statistics with Randomization and Simulation</a>. The point of it was to both review Hypothesis Testing and see how it can be done using simulation rather than a p-test.</p>
</div>
<div class="outline-3" id="outline-container-orgbb990b3">
<h3 id="orgbb990b3">In Abstract</h3>
<div class="outline-text-3" id="text-orgbb990b3">
<ol class="org-ol">
<li>Is your problem that you suspect some kind of bias in outcomes for two groups?</li>
<li>Get the <b>Point Estimate</b> for the value you want to test</li>
<li>State the <b>Null Hypothesis</b> that what happened could happen by chance and the <b>Alternative Hypothesis</b> that there was bias involved.</li>
<li>Decide on a tolerance level for the probability that it happened by chance.</li>
<li>Set up your urn</li>
<li>Simulate random selections for a large number of trials.</li>
<li>Calculate the proporiton of the trials that were greater than the original studies Point Estimate.</li>
<li>Make a conclusion whether the original outcome could have happened by random chance or not.</li>
</ol>
</div>
</div>
<div class="outline-3" id="outline-container-org51be7e5">
<h3 id="org51be7e5">Source</h3>
<div class="outline-text-3" id="text-org51be7e5">
<ul class="org-ul">
<li><a href="/posts/introductory-statistics-with-randomization-and-simulation/">Introductory Statistics with Randomization and Simulation</a></li>
</ul>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/introductory-statistics-with-randomization-and-simulation/">Introductory Statistics with Randomization and Simulation</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/introductory-statistics-with-randomization-and-simulation/" rel="bookmark"><time class="published dt-published" datetime="2020-09-22T16:53:36-07:00" itemprop="datePublished" title="2020-09-22 16:53">2020-09-22 16:53</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div class="outline-2" id="outline-container-org2f21626">
<h2 id="org2f21626">Citation</h2>
<div class="outline-text-2" id="text-org2f21626">
<ul class="org-ul">
<li>Diez DM, Barr CD, Ã‡etinkaya-Rundel M. Introductory statistics with randomization and simulation. OpenIntro.org; 2014. 348 p.</li>
</ul>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/pulling-oregon-covid-19-data/">Pulling Oregon Covid-19 Data</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/pulling-oregon-covid-19-data/" rel="bookmark"><time class="published dt-published" datetime="2020-08-04T22:59:37-07:00" itemprop="datePublished" title="2020-08-04 22:59">2020-08-04 22:59</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/pulling-oregon-covid-19-data/#org828cfb1">Beginning</a>
<ul>
<li><a href="/posts/pulling-oregon-covid-19-data/#org7d04b17">Set Up</a></li>
</ul>
</li>
<li><a href="/posts/pulling-oregon-covid-19-data/#org0005e5d">Middle</a>
<ul>
<li><a href="/posts/pulling-oregon-covid-19-data/#orgf60c5a9">Starting the Dates</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org828cfb1">
<h2 id="org828cfb1">Beginning</h2>
<div class="outline-text-2" id="text-org828cfb1">
<p>This is a look at pulling Oregon Covid-19 data from their weekly update PDFs. There are datasets for Oregon Covid-19 cases published by the <a href="https://govstatus.egov.com/OR-OHA-COVID-19">Oregon Health Authority</a> but for some reason I can't find the raw data sources matching what they have in their weekly reports so I thought maybe instead of just endlessly searching I'd pull them from the PDFs themselves.</p>
</div>
<div class="outline-3" id="outline-container-org7d04b17">
<h3 id="org7d04b17">Set Up</h3>
<div class="outline-text-3" id="text-org7d04b17"></div>
<div class="outline-4" id="outline-container-org5ccee4f">
<h4 id="org5ccee4f">Imports</h4>
<div class="outline-text-4" id="text-org5ccee4f">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="kn">import</span> <span class="n">relativedelta</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="kn">import</span> <span class="nn">requests</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org49c1b02">
<h4 id="org49c1b02">The Path</h4>
<div class="outline-text-4" id="text-org49c1b02">
<p>This is where I'm going to save the PDFs - to make it portable I usually keep the path in a file with <code>dotenv</code> loads as an environment variable. This wayif things get moved around I can edit the file to change the path but the code that uses it doesn't have to change.</p>
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">"~/.local/share/env"</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>
<span class="n">FOLDER</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"OREGON_COVID"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">FOLDER</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="n">FOLDER</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org0005e5d">
<h2 id="org0005e5d">Middle</h2>
<div class="outline-text-2" id="text-org0005e5d"></div>
<div class="outline-3" id="outline-container-orgf60c5a9">
<h3 id="orgf60c5a9">Starting the Dates</h3>
<div class="outline-text-3" id="text-orgf60c5a9">
<p>I could only find a link to the current PDF on their page (as of August 4, 2020). The URL embeds the date in it so to work backwards (and maybe later forwards) we need an easy way to set it. Here's what the URL looks like.</p>
<div class="highlight">
<pre><span></span><span class="n">EXAMPLE_URL</span> <span class="o">=</span> <span class="s2">"https://www.oregon.gov/oha/PH/DISEASESCONDITIONS/DISEASESAZ/Emerging%20Respitory%20Infections/COVID-19-Weekly-Report-2020-07-29-FINAL.pdf"</span>
</pre></div>
<p>So to work with it I'll find out what day of the week July 29, 2020 was (the date in the URL).</p>
<div class="highlight">
<pre><span></span><span class="n">START</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">29</span><span class="p">)</span>
<span class="n">WEEKDAY</span> <span class="o">=</span> <span class="n">START</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">WEEKDAY</span> <span class="o">==</span> <span class="n">calendar</span><span class="o">.</span><span class="n">WEDNESDAY</span>
<span class="k">print</span><span class="p">(</span><span class="n">WEEKDAY</span><span class="p">)</span>
</pre></div>
<pre class="example">
2
</pre>
<p>So, it looks like it came out on a Wednesday, which I'm going to assume is going to be the same every week. Now we can find the most recent Wednesday, which will be the start (or end, depending on how you look at it) of our date-ragen.</p>
<div class="highlight">
<pre><span></span><span class="n">TODAY</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
<span class="n">LAST</span> <span class="o">=</span> <span class="n">TODAY</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">weekday</span><span class="o">=</span><span class="n">WEEKDAY</span><span class="p">)</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
<span class="k">print</span><span class="p">(</span><span class="n">LAST</span><span class="p">)</span>
</pre></div>
<pre class="example">
2020-08-12
</pre>
<p>Now I'm going to work backwards one week at a time to create the URLS and file-names. Using the <code>relativedelta</code> makes it easy-peasey to get prior weeks from a given date. Here's the Wednesday before the most recent one.</p>
<div class="highlight">
<pre><span></span><span class="n">one_week</span> <span class="o">=</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">weeks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">LAST</span> <span class="o">-</span> <span class="n">one_week</span><span class="p">)</span>
</pre></div>
<pre class="example">
2020-08-05
</pre>
<p>Now, I don't actually know when these PDFs started so I'm just going to work backwards until I get an error message from my HTTP request and then stop.</p>
<div class="highlight">
<pre><span></span><span class="n">FILE_NAME</span> <span class="o">=</span> <span class="s2">"COVID-19-Weekly-Report-{}-FINAL.pdf"</span>
<span class="n">BASE_URL</span> <span class="o">=</span> <span class="s2">"https://www.oregon.gov/oha/PH/DISEASESCONDITIONS/DISEASESAZ/Emerging%20Respitory%20Infections/{}"</span>

<span class="k">for</span> <span class="n">week</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Checking back {week} weeks from this past Wednesday"</span><span class="p">)</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">LAST</span> <span class="o">-</span> <span class="p">(</span><span class="n">one_week</span> <span class="o">*</span> <span class="n">week</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">FILE_NAME</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="n">FOLDER</span><span class="o">/</span><span class="n">filename</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">output_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">BASE_URL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Bad week: {week}</span><span class="se">\t</span><span class="s2">Date: {date}"</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Saving {filename}"</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">output_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>            
            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</pre></div>
<pre class="example">
Checking back 0 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-08-12-FINAL.pdf
Checking back 1 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-08-05-FINAL.pdf
Checking back 2 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-07-29-FINAL.pdf
Checking back 3 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-07-22-FINAL.pdf
Checking back 4 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-07-15-FINAL.pdf
Checking back 5 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-07-08-FINAL.pdf
Checking back 6 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-07-01-FINAL.pdf
Checking back 7 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-06-24-FINAL.pdf
Checking back 8 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-06-17-FINAL.pdf
Checking back 9 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-06-10-FINAL.pdf
Checking back 10 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-06-03-FINAL.pdf
Checking back 11 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-05-27-FINAL.pdf
Checking back 12 weeks from this past Wednesday
Bad week: 12    Date: 2020-05-20
</pre>
<p>So, there are eleven weeks of PDFs going back to May 27, 2020. Which seems a little short, given that Oregon started telling people to stay home in March, but maybe they have the data somewhere else. Anyway, next up is pulling the data from the PDFs from the files using <a href="https://tabula-py.readthedocs.io/en/latest/tabula.html">tabula-py</a>.</p>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/tutorials/data-leakage/">Data Leakage</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/data-leakage/" rel="bookmark"><time class="published dt-published" datetime="2020-02-20T21:26:31-08:00" itemprop="datePublished" title="2020-02-20 21:26">2020-02-20 21:26</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/data-leakage/#org008757e">Beginning</a>
<ul>
<li><a href="/posts/tutorials/data-leakage/#org7092d8e">1. The Data Science of Shoelaces</a></li>
<li><a href="/posts/tutorials/data-leakage/#org364f1c7">2. Return of the Shoelaces</a></li>
<li><a href="/posts/tutorials/data-leakage/#org88678b1">3. Getting Rich With Cryptocurrencies?</a></li>
<li><a href="/posts/tutorials/data-leakage/#org55610ba">4. Preventing Infections</a></li>
<li><a href="/posts/tutorials/data-leakage/#org9af45ff">5. Housing Prices</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org008757e">
<h2 id="org008757e">Beginning</h2>
<div class="outline-text-2" id="text-org008757e">
<blockquote>
<p>Most people find target leakage very tricky until they've thought about it for a long time.</p>
<p>So, before trying to think about leakage in the housing price example, we'll go through a few examples in other applications. Things will feel more familiar once you come back to a question about house prices.</p>
</blockquote>
</div>
<div class="outline-3" id="outline-container-org7092d8e">
<h3 id="org7092d8e">1. The Data Science of Shoelaces</h3>
<div class="outline-text-3" id="text-org7092d8e">
<blockquote>
<p>Nike has hired you as a data science consultant to help them save money on shoe materials. Your first assignment is to review a model one of their employees built to predict how many shoelaces they'll need each month. The features going into the machine learning model include:</p>
<ul class="org-ul">
<li>The current month (January, February, etc)</li>
<li>Advertising expenditures in the previous month</li>
<li>Various macroeconomic features (like the unemployment rate) as of the beginning of the current month</li>
<li>The amount of leather they ended up using in the current month</li>
</ul>
<p>The results show the model is almost perfectly accurate if you include the feature about how much leather they used. But it is only moderately accurate if you leave that feature out. You realize this is because the amount of leather they use is a perfect indicator of how many shoes they produce, which in turn tells you how many shoelaces they need.</p>
<p>Do you think the <code>leather used</code> feature constitutes a source of data leakage? If your answer is "it depends," what does it depend on?</p>
</blockquote>
<p><code>leather_used</code> does seem like a leakage, but it depends on whether the value is known before the shoelace predictions are made. If you won't know it in time for the predictions, then it is a leak. If there's a reason why you would always know the amount used but somehow not know how many shoes were made it might not be a data leak, but it seems odd that it would be useful. It be useable if it is a prediction of the amount of leather that will be needed, but it seems odd to use it then to predict shoelaces.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org364f1c7">
<h3 id="org364f1c7">2. Return of the Shoelaces</h3>
<div class="outline-text-3" id="text-org364f1c7">
<blockquote>
<p>You have a new idea. You could use the amount of leather Nike ordered (rather than the amount they actually used) leading up to a given month as a predictor in your shoelace model.</p>
<p>Does this change your answer about whether there is a leakage problem? If you answer "it depends," what does it depend on?</p>
</blockquote>
<p>Whether it is a leak will depend on whether the leather is always ordered before the shoelaces or not. If they are always ordered before shoelaces then it wouldn't be a leak.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org88678b1">
<h3 id="org88678b1">3. Getting Rich With Cryptocurrencies?</h3>
<div class="outline-text-3" id="text-org88678b1">
<blockquote>
<p>You saved Nike so much money that they gave you a bonus. Congratulations.</p>
<p>Your friend, who is also a data scientist, says he has built a model that will let you turn your bonus into millions of dollars. Specifically, his model predicts the price of a new cryptocurrency (like Bitcoin, but a newer one) one day ahead of the moment of prediction. His plan is to purchase the cryptocurrency whenever the model says the price of the currency (in dollars) is about to go up.</p>
<p>The most important features in his model are:</p>
<ul class="org-ul">
<li>Current price of the currency</li>
<li>Amount of the currency sold in the last 24 hours</li>
<li>Change in the currency price in the last 24 hours</li>
<li>Change in the currency price in the last 1 hour</li>
<li>Number of new tweets in the last 24 hours that mention the currency</li>
</ul>
<p>The value of the cryptocurrency in dollars has fluctuated up and down by over $100 in the last year, and yet his model's average error is less than $1. He says this is proof his model is accurate, and you should invest with him, buying the currency whenever the model says it is about to go up.</p>
<p>Is he right? If there is a problem with his model, what is it?</p>
</blockquote>
<p>The data isn't leaking.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org55610ba">
<h3 id="org55610ba">4. Preventing Infections</h3>
<div class="outline-text-3" id="text-org55610ba">
<blockquote>
<p>An agency that provides healthcare wants to predict which patients from a rare surgery are at risk of infection, so it can alert the nurses to be especially careful when following up with those patients.</p>
<p>You want to build a model. Each row in the modeling dataset will be a single patient who received the surgery, and the prediction target will be whether they got an infection.</p>
<p>Some surgeons may do the procedure in a manner that raises or lowers the risk of infection. But how can you best incorporate the surgeon information into the model?</p>
<p>You have a clever idea.</p>
<ol class="org-ol">
<li>Take all surgeries by each surgeon and calculate the infection rate among those surgeons.</li>
<li>For each patient in the data, find out who the surgeon was and plug in that surgeon's average infection rate as a feature.</li>
</ol>
<p>Does this pose any target leakage issues? Does it pose any train-test contamination issues?</p>
</blockquote>
<p>The infection rate would have a target leak if the calculated value includes the patient whose row it is added to.</p>
<p>You would have train-test contamination if you calculated this value using both the train and test set. You would have to calculate it only on the training set to avoid contamination.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org9af45ff">
<h3 id="org9af45ff">5. Housing Prices</h3>
<div class="outline-text-3" id="text-org9af45ff">
<blockquote>
<p>You will build a model to predict housing prices. The model will be deployed on an ongoing basis, to predict the price of a new house when a description is added to a website. Here are four features that could be used as predictors.</p>
<ol class="org-ol">
<li>Size of the house (in square meters)</li>
<li>Average sales price of homes in the same neighborhood</li>
<li>Latitude and longitude of the house</li>
<li>Whether the house has a basement</li>
</ol>
<p>You have historic data to train and validate the model.</p>
<p>Which of the features is most likely to be a source of leakage?</p>
</blockquote>
<p>Average sales price of homes in the same neighborhood. If the home was sold in the past, then it would contribute to the average.</p>
<blockquote>
<p>Leakage is a hard and subtle issue. You should be proud if you picked up on the issues in these examples.</p>
<p>Now you have the tools to make highly accurate models, and pick up on the most difficult practical problems that arise with applying these models to solve real problems.</p>
</blockquote>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/tutorials/xgboost/">XGBoost</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/xgboost/" rel="bookmark"><time class="published dt-published" datetime="2020-02-20T21:25:25-08:00" itemprop="datePublished" title="2020-02-20 21:25">2020-02-20 21:25</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/xgboost/#orgefd8dba">Beginning</a>
<ul>
<li><a href="/posts/tutorials/xgboost/#org3587f67">Imports</a>
<ul>
<li><a href="/posts/tutorials/xgboost/#orgb42db89">Python</a></li>
<li><a href="/posts/tutorials/xgboost/#orgdac0f4a">PyPi</a></li>
<li><a href="/posts/tutorials/xgboost/#org2753e5b">Others</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/xgboost/#org2e800a8">Set Up</a>
<ul>
<li><a href="/posts/tutorials/xgboost/#org089ed82">Table</a></li>
<li><a href="/posts/tutorials/xgboost/#org750c4e5">Plottting</a></li>
<li><a href="/posts/tutorials/xgboost/#org584e62c">The Timer</a></li>
<li><a href="/posts/tutorials/xgboost/#orgb5096f6">Environment</a></li>
<li><a href="/posts/tutorials/xgboost/#orgf55da59">The Data</a></li>
<li><a href="/posts/tutorials/xgboost/#org15b4908">Some Constants</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/xgboost/#org17655fd">Setup The Data</a>
<ul>
<li><a href="/posts/tutorials/xgboost/#orgd884a23">Selecting columns</a></li>
<li><a href="/posts/tutorials/xgboost/#orgf328a22">One-Hot Encoding</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/xgboost/#org7838ad1">Step 1: Build model</a></li>
<li><a href="/posts/tutorials/xgboost/#org864a389">Step 2: Improve the model</a></li>
<li><a href="/posts/tutorials/xgboost/#orgd76934f">Step 3: Break the model</a></li>
<li><a href="/posts/tutorials/xgboost/#orgbce526e">Numeric Values Only</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/xgboost/#org8ccbf48">End</a>
<ul>
<li>
<ul>
<li><a href="/posts/tutorials/xgboost/#orgedeaad2">Make a Submission using the XGB early-stopping model</a></li>
<li><a href="/posts/tutorials/xgboost/#org6e536d6">Random Search CV</a></li>
<li><a href="/posts/tutorials/xgboost/#org37728c3">Early Stopping with Imputation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgefd8dba">
<h2 id="orgefd8dba">Beginning</h2>
<div class="outline-text-2" id="text-orgefd8dba">
<blockquote>
<p>In this exercise, you will leverage what you've learned to tune a machine learning model with <b>cross-validation</b>.</p>
</blockquote>
</div>
<div class="outline-3" id="outline-container-org3587f67">
<h3 id="org3587f67">Imports</h3>
<div class="outline-text-3" id="text-org3587f67"></div>
<div class="outline-4" id="outline-container-orgb42db89">
<h4 id="orgb42db89">Python</h4>
<div class="outline-text-4" id="text-orgb42db89">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">random</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgdac0f4a">
<h4 id="orgdac0f4a">PyPi</h4>
<div class="outline-text-4" id="text-orgdac0f4a">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">eli5.sklearn</span> <span class="kn">import</span> <span class="n">PermutationImportance</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>

<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.experimental</span> <span class="kn">import</span> <span class="n">enable_iterative_imputer</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">IterativeImputer</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_absolute_error</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">cross_val_score</span><span class="p">,</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">RandomizedSearchCV</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span>

<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBRegressor</span>

<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">import</span> <span class="nn">eli5</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">shap</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org2753e5b">
<h4 id="org2753e5b">Others</h4>
<div class="outline-text-4" id="text-org2753e5b">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">CountPercentage</span><span class="p">,</span> <span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">EnvironmentLoader</span><span class="p">,</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org2e800a8">
<h3 id="org2e800a8">Set Up</h3>
<div class="outline-text-3" id="text-org2e800a8"></div>
<div class="outline-4" id="outline-container-org089ed82">
<h4 id="org089ed82">Table</h4>
<div class="outline-text-4" id="text-org089ed82">
<div class="highlight">
<pre><span></span><span class="n">TABLE</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">tabulate</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">,</span> <span class="n">showindex</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org750c4e5">
<h4 id="org750c4e5">Plottting</h4>
<div class="outline-text-4" id="text-org750c4e5">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"xgboost"</span>
<span class="n">OUTPUT_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"../../files/posts/tutorials/"</span><span class="p">)</span><span class="o">/</span><span class="n">SLUG</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="n">OUTPUT_PATH</span><span class="p">)</span>
<span class="n">Plot</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org584e62c">
<h4 id="org584e62c">The Timer</h4>
<div class="outline-text-4" id="text-org584e62c">
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb5096f6">
<h4 id="orgb5096f6">Environment</h4>
<div class="outline-text-4" id="text-orgb5096f6">
<div class="highlight">
<pre><span></span><span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="n">EnvironmentLoader</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgf55da59">
<h4 id="orgf55da59">The Data</h4>
<div class="outline-text-4" id="text-orgf55da59">
<div class="highlight">
<pre><span></span><span class="n">DATA_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ENVIRONMENT</span><span class="p">[</span><span class="s2">"HOUSE-PRICES-IOWA"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">DATA_PATH</span><span class="o">/</span><span class="s2">"train.csv"</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s2">"Id"</span><span class="p">)</span>

<span class="n">test_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">DATA_PATH</span><span class="o">/</span><span class="s2">"test.csv"</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s2">"Id"</span>
<span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">test_data</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org15b4908">
<h4 id="org15b4908">Some Constants</h4>
<div class="outline-text-4" id="text-org15b4908">
<div class="highlight">
<pre><span></span><span class="n">Data</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">target</span><span class="o">=</span><span class="s2">"SalePrice"</span><span class="p">,</span>
    <span class="n">train_size</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">random_seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org17655fd">
<h3 id="org17655fd">Setup The Data</h3>
<div class="outline-text-3" id="text-org17655fd">
<p>Split up the target and features.</p>
<div class="highlight">
<pre><span></span><span class="k">assert</span> <span class="ow">not</span> <span class="n">train_data</span><span class="p">[</span><span class="n">Data</span><span class="o">.</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">hasnans</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="n">Data</span><span class="o">.</span><span class="n">target</span><span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">Data</span><span class="o">.</span><span class="n">target</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s2">"columns"</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_validate</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_validate</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
    <span class="n">train_size</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">train_size</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">test_size</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgd884a23">
<h4 id="orgd884a23">Selecting columns</h4>
<div class="outline-text-4" id="text-orgd884a23">
<p>"Cardinality" means the number of unique values in a column. Select categorical columns with relatively low cardinality (convenient but arbitrary).</p>
<div class="highlight">
<pre><span></span><span class="n">low_cardinality_cols</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">cname</span> <span class="k">for</span> <span class="n">cname</span> <span class="ow">in</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">X_train</span><span class="p">[</span><span class="n">cname</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="ow">and</span>
    <span class="n">X_train</span><span class="p">[</span><span class="n">cname</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">"object"</span><span class="p">]</span>
</pre></div>
<p>Select numeric columns.</p>
<div class="highlight">
<pre><span></span><span class="n">numeric_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span>
                   <span class="k">if</span> <span class="n">X_train</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'int64'</span><span class="p">,</span> <span class="s1">'float64'</span><span class="p">]]</span>
</pre></div>
<p>Keep selected columns only</p>
<div class="highlight">
<pre><span></span><span class="n">keep_columns</span> <span class="o">=</span> <span class="n">low_cardinality_cols</span> <span class="o">+</span> <span class="n">numeric_columns</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">keep_columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">X_valid</span> <span class="o">=</span> <span class="n">X_validate</span><span class="p">[</span><span class="n">keep_columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">keep_columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgf328a22">
<h4 id="orgf328a22">One-Hot Encoding</h4>
<div class="outline-text-4" id="text-orgf328a22">
<p>One-hot encode the data (to shorten the code, we use pandas).</p>
<div class="highlight">
<pre><span></span><span class="n">X_train</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_validate</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_validate</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_validate</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">X_validate</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">'left'</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">'left'</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org7838ad1">
<h3 id="org7838ad1">Step 1: Build model</h3>
<div class="outline-text-3" id="text-org7838ad1">
<blockquote>
<p>In this step, you'll build and train your first model with gradient boosting.</p>
<ul class="org-ul">
<li>Begin by setting <code>my_model_1</code> to an XGBoost model. Use the <a href="https://xgboost.readthedocs.io/en/latest/python/python_api.html#xgboost.XGBRegressor">XGBRegressor</a> class, and set the random seed to 0 (<code>random_state=0</code>). <b>Leave all other parameters as default.</b></li>
<li>Then, fit the model to the training data in <code>X_train</code> and <code>y_train</code>.</li>
</ul>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">XGBRegressor</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">predictions_1</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_validate</span><span class="p">)</span>
</pre></div>
<blockquote>
<p>Finally, use the <code>mean_absolute_error()</code> function to calculate the mean absolute error (MAE) corresponding to the predictions for the validation set. Recall that the labels for the validation data are stored in <code>y_valid</code>.</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">mae_1</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">predictions_1</span><span class="p">,</span> <span class="n">y_validate</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Mean Absolute Error: {mae_1}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Mean Absolute Error: 17662.736729452055
</pre></div>
</div>
<div class="outline-3" id="outline-container-org864a389">
<h3 id="org864a389">Step 2: Improve the model</h3>
<div class="outline-text-3" id="text-org864a389">
<blockquote>
<p>Now that you've trained a default model as baseline, it's time to tinker with the parameters, to see if you can get better performance.</p>
<ul class="org-ul">
<li>Begin by setting <code>my_model_2</code> to an XGBoost model, using the <a href="https://xgboost.readthedocs.io/en/latest/python/python_api.html#xgboost.XGBRegressor">XGBRegressor</a> class. Use what you learned in the previous tutorial to figure out how to change the default parameters (like <code>n_estimators</code> and <code>learning_rate</code>) to get better results.</li>
<li>Then, fit the model to the training data in <code>X_train</code> and <code>y_train</code>.</li>
<li>Set <code>predictions_2</code> to the model's predictions for the validation data. Recall that the validation features are stored in <code>X_valid</code>.</li>
<li>Finally, use the <code>mean_absolute_error()</code> function to calculate the mean absolute error (MAE) corresponding to the predictions on the validation set. Recall that the labels for the validation data are stored in <code>y_valid</code>.</li>
</ul>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">estimators</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">max_depth</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>
<span class="n">learning_rate</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="n">grid</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">estimators</span><span class="p">,</span>
            <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">)</span>
            <span class="c1">#learning_rate=learning_rate)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">XGBRegressor</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span> <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">search</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                            <span class="n">param_distributions</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
                            <span class="n">n_iter</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                            <span class="n">scoring</span><span class="o">=</span><span class="s2">"neg_mean_absolute_error"</span><span class="p">,</span>
                            <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">X_cv</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_validate</span><span class="p">])</span>
<span class="n">y_cv</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_validate</span><span class="p">])</span>
<span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_cv</span><span class="p">,</span> <span class="n">y_cv</span><span class="p">)</span>
<span class="n">first_model</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"CV Training MAE: {-search.best_score_:0.2f}"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
</pre></div>
<pre class="example">
2020-03-01 21:34:37,418 graeae.timers.timer start: Started: 2020-03-01 21:34:37.418449
2020-03-01 21:36:24,107 graeae.timers.timer end: Ended: 2020-03-01 21:36:24.107671
2020-03-01 21:36:24,109 graeae.timers.timer end: Elapsed: 0:01:46.689222
CV Training MAE: 16048.16
{'n_estimators': 160, 'max_depth': None}
</pre>
<div class="highlight">
<pre><span></span><span class="n">outcome</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">"Score"</span><span class="p">:</span> <span class="n">search</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s2">"mean_test_score"</span><span class="p">]})</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">early_stopping_model</span> <span class="o">=</span> <span class="n">XGBRegressor</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span>
                                    <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                                    <span class="n">early_stopping_rounds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="n">early_stopping_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">eval_set</span><span class="o">=</span><span class="p">[(</span><span class="n">X_validate</span><span class="p">,</span> <span class="n">y_validate</span><span class="p">)],</span>
                         <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">early_stopping_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_validate</span><span class="p">),</span>
                          <span class="n">y_validate</span><span class="p">))</span>
</pre></div>
<pre class="example">
16728.27523009418
</pre>
<div class="highlight">
<pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_params</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Trees: {params['n_estimators']}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Trees: 100
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgd76934f">
<h3 id="orgd76934f">Step 3: Break the model</h3>
<div class="outline-text-3" id="text-orgd76934f">
<blockquote>
<p>In this step, you will create a model that performs worse than the original model in Step 1. This will help you to develop your intuition for how to set parameters. You might even find that you accidentally get better performance, which is ultimately a nice problem to have and a valuable learning experience!</p>
<ul class="org-ul">
<li>Begin by setting <code>my_model_3</code> to an XGBoost model, using the <a href="https://xgboost.readthedocs.io/en/latest/python/python_api.html#xgboost.XGBRegressor">XGBRegressor</a> class. Use what you learned in the previous tutorial to figure out how to change the default parameters (like <code>n_estimators</code> and <code>learning_rate</code>) to design a model to get high MAE.</li>
<li>Then, fit the model to the training data in <code>X_train</code> and <code>y_train</code>.</li>
<li>Set <code>predictions_3</code> to the model's predictions for the validation data. Recall that the validation features are stored in <code>X_valid</code>.</li>
<li>Finally, use the <code>mean_absolute_error()</code> function to calculate the mean absolute error (MAE) corresponding to the predictions on the validation set. Recall that the labels for the validation data are stored in <code>y_valid</code>.</li>
</ul>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">parameters</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">search</span><span class="o">.</span><span class="n">cv_results_</span><span class="p">[</span><span class="s2">"params"</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">XGBRegressor</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span> <span class="o">**</span><span class="n">parameters</span><span class="p">)</span>
<span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"MAE: {mean_absolute_error(model.predict(X_validate), y_validate)}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
2020-02-29 20:55:54,573 graeae.timers.timer start: Started: 2020-02-29 20:55:54.573008
{'n_estimators': 60, 'max_depth': 20, 'learning_rate': 0.7000000000000001}
2020-02-29 20:55:55,019 graeae.timers.timer end: Ended: 2020-02-29 20:55:55.019335
2020-02-29 20:55:55,020 graeae.timers.timer end: Elapsed: 0:00:00.446327
MAE: 25077.38005672089
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgbce526e">
<h3 id="orgbce526e">Numeric Values Only</h3>
<div class="outline-text-3" id="text-orgbce526e">
<div class="highlight">
<pre><span></span><span class="n">imputer</span> <span class="o">=</span> <span class="n">IterativeImputer</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>

<span class="n">final_x_train</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">imputer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">),</span>
                                 <span class="n">columns</span><span class="o">=</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
<span class="n">early_stopping_model_2</span> <span class="o">=</span> <span class="n">XGBRegressor</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span>
                                      <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                                      <span class="n">early_stopping_rounds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                      <span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="n">early_stopping_model_2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">final_x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">eval_set</span><span class="o">=</span><span class="p">[(</span><span class="n">X_validate</span><span class="p">,</span> <span class="n">y_validate</span><span class="p">)],</span>
                         <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">early_stopping_model_2</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_validate</span><span class="p">),</span>
                          <span class="n">y_validate</span><span class="p">))</span>
</pre></div>
<pre class="example">
16516.399373929795
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org8ccbf48">
<h2 id="org8ccbf48">End</h2>
<div class="outline-text-2" id="text-org8ccbf48"></div>
<div class="outline-4" id="outline-container-orgedeaad2">
<h4 id="orgedeaad2">Make a Submission using the XGB early-stopping model</h4>
<div class="outline-text-4" id="text-orgedeaad2">
<div class="highlight">
<pre><span></span><span class="n">predictions</span> <span class="o">=</span> <span class="n">early_stopping_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'Id'</span><span class="p">:</span> <span class="n">X_test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                           <span class="s1">'SalePrice'</span><span class="p">:</span> <span class="n">predictions</span><span class="p">})</span>
<span class="n">output</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="o">/</span><span class="s1">'submission.csv'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
<p>This got a score of <i>14777.96266</i> on the kaggle submissions page.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org6e536d6">
<h4 id="org6e536d6">Random Search CV</h4>
<div class="outline-text-4" id="text-org6e536d6">
<div class="highlight">
<pre><span></span><span class="n">predictions</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'Id'</span><span class="p">:</span> <span class="n">X_test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                           <span class="s1">'SalePrice'</span><span class="p">:</span> <span class="n">predictions</span><span class="p">})</span>
<span class="n">output</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="o">/</span><span class="s1">'submission.csv'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
<p>This one got a score of <i>14976.55345</i>, so the early stopping model is the best one so farâ€¦ It had fewer trees than the model that the RandomSearch CV ended up with, maybe the Random Search overfit the data.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org37728c3">
<h4 id="org37728c3">Early Stopping with Imputation</h4>
<div class="outline-text-4" id="text-org37728c3">
<div class="highlight">
<pre><span></span><span class="n">predictions</span> <span class="o">=</span> <span class="n">early_stopping_model_2</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">'Id'</span><span class="p">:</span> <span class="n">X_test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                           <span class="s1">'SalePrice'</span><span class="p">:</span> <span class="n">predictions</span><span class="p">})</span>
<span class="n">output</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">DATA_PATH</span><span class="o">/</span><span class="s1">'submission.csv'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
<p>This gets a score of <i>14965.20801</i> so it looks like the XGBoost model without imputation is the best one.</p>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/tutorials/cross-validation/">Cross Validation</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/cross-validation/" rel="bookmark"><time class="published dt-published" datetime="2020-02-20T21:15:04-08:00" itemprop="datePublished" title="2020-02-20 21:15">2020-02-20 21:15</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/cross-validation/#org2c0d97c">Beginning</a>
<ul>
<li><a href="/posts/tutorials/cross-validation/#orgc348d8d">Imports</a>
<ul>
<li><a href="/posts/tutorials/cross-validation/#orgc15ea3c">Python</a></li>
<li><a href="/posts/tutorials/cross-validation/#org5a9dfe2">PyPi</a></li>
<li><a href="/posts/tutorials/cross-validation/#org17c4f9c">Others</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/cross-validation/#org1493f28">Set Up</a>
<ul>
<li><a href="/posts/tutorials/cross-validation/#orgaf9ac5e">Table</a></li>
<li><a href="/posts/tutorials/cross-validation/#org50047f2">Plottting</a></li>
<li><a href="/posts/tutorials/cross-validation/#org673a2ec">The Timer</a></li>
<li><a href="/posts/tutorials/cross-validation/#org4dd48d8">Environment</a></li>
<li><a href="/posts/tutorials/cross-validation/#org6ba5be4">The Data</a></li>
<li><a href="/posts/tutorials/cross-validation/#org105fb41">Some Constants</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/cross-validation/#orge55663e">Setup The Data</a>
<ul>
<li><a href="/posts/tutorials/cross-validation/#org2980046">Drop Categorical Columns</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/cross-validation/#org7bb234e">Middle</a>
<ul>
<li><a href="/posts/tutorials/cross-validation/#orgadc44eb">Some Pipelines</a></li>
<li><a href="/posts/tutorials/cross-validation/#orgbb1e1ee">Step 1: Write a useful function</a></li>
<li><a href="/posts/tutorials/cross-validation/#org842c342">Step 2: Test different parameter values</a></li>
<li><a href="/posts/tutorials/cross-validation/#org378d00d">Step 3: Find the best parameter value</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org2c0d97c">
<h2 id="org2c0d97c">Beginning</h2>
<div class="outline-text-2" id="text-org2c0d97c">
<blockquote>
<p>In this exercise, you will leverage what you've learned to tune a machine learning model with <b>cross-validation</b>.</p>
</blockquote>
</div>
<div class="outline-3" id="outline-container-orgc348d8d">
<h3 id="orgc348d8d">Imports</h3>
<div class="outline-text-3" id="text-orgc348d8d"></div>
<div class="outline-4" id="outline-container-orgc15ea3c">
<h4 id="orgc15ea3c">Python</h4>
<div class="outline-text-4" id="text-orgc15ea3c">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org5a9dfe2">
<h4 id="org5a9dfe2">PyPi</h4>
<div class="outline-text-4" id="text-org5a9dfe2">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">eli5.sklearn</span> <span class="kn">import</span> <span class="n">PermutationImportance</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>

<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.experimental</span> <span class="kn">import</span> <span class="n">enable_iterative_imputer</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">IterativeImputer</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_absolute_error</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">cross_val_score</span><span class="p">,</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span>

<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">import</span> <span class="nn">eli5</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">shap</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org17c4f9c">
<h4 id="org17c4f9c">Others</h4>
<div class="outline-text-4" id="text-org17c4f9c">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">CountPercentage</span><span class="p">,</span> <span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">EnvironmentLoader</span><span class="p">,</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org1493f28">
<h3 id="org1493f28">Set Up</h3>
<div class="outline-text-3" id="text-org1493f28"></div>
<div class="outline-4" id="outline-container-orgaf9ac5e">
<h4 id="orgaf9ac5e">Table</h4>
<div class="outline-text-4" id="text-orgaf9ac5e">
<div class="highlight">
<pre><span></span><span class="n">TABLE</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">tabulate</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">,</span> <span class="n">showindex</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org50047f2">
<h4 id="org50047f2">Plottting</h4>
<div class="outline-text-4" id="text-org50047f2">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"cross-validation"</span>
<span class="n">OUTPUT_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"../../files/posts/tutorials/"</span><span class="p">)</span><span class="o">/</span><span class="n">SLUG</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="n">OUTPUT_PATH</span><span class="p">)</span>
<span class="n">Plot</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org673a2ec">
<h4 id="org673a2ec">The Timer</h4>
<div class="outline-text-4" id="text-org673a2ec">
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org4dd48d8">
<h4 id="org4dd48d8">Environment</h4>
<div class="outline-text-4" id="text-org4dd48d8">
<div class="highlight">
<pre><span></span><span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="n">EnvironmentLoader</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org6ba5be4">
<h4 id="org6ba5be4">The Data</h4>
<div class="outline-text-4" id="text-org6ba5be4">
<div class="highlight">
<pre><span></span><span class="n">DATA_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ENVIRONMENT</span><span class="p">[</span><span class="s2">"HOUSE-PRICES-IOWA"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">DATA_PATH</span><span class="o">/</span><span class="s2">"train.csv"</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s2">"Id"</span><span class="p">)</span>

<span class="n">test_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">DATA_PATH</span><span class="o">/</span><span class="s2">"test.csv"</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s2">"Id"</span>
<span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">test_data</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org105fb41">
<h4 id="org105fb41">Some Constants</h4>
<div class="outline-text-4" id="text-org105fb41">
<div class="highlight">
<pre><span></span><span class="n">Data</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">target</span><span class="o">=</span><span class="s2">"SalePrice"</span><span class="p">,</span>
    <span class="n">train_size</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">random_seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orge55663e">
<h3 id="orge55663e">Setup The Data</h3>
<div class="outline-text-3" id="text-orge55663e">
<p>Split up the target and features.</p>
<div class="highlight">
<pre><span></span><span class="k">assert</span> <span class="ow">not</span> <span class="n">train_data</span><span class="p">[</span><span class="n">Data</span><span class="o">.</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">hasnans</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="n">Data</span><span class="o">.</span><span class="n">target</span><span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">Data</span><span class="o">.</span><span class="n">target</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s2">"columns"</span><span class="p">)</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-org2980046">
<h4 id="org2980046">Drop Categorical Columns</h4>
<div class="outline-text-4" id="text-org2980046">
<p>To make it simpler (since we're only looking at cross-validation, and having them didn't seem to help) we're going to drop the categorical columns.</p>
<div class="highlight">
<pre><span></span><span class="n">numeric_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">X</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="s2">"object"</span><span class="p">]</span>
<span class="n">rows_0</span><span class="p">,</span> <span class="n">columns_0</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">numeric_columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">row</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Keeping {columns} columns, dropped ({columns_0 - columns})"</span><span class="p">)</span>
</pre></div>
<pre class="example">
Keeping 36 columns, dropped (43)
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org7bb234e">
<h2 id="org7bb234e">Middle</h2>
<div class="outline-text-2" id="text-org7bb234e"></div>
<div class="outline-3" id="outline-container-orgadc44eb">
<h3 id="orgadc44eb">Some Pipelines</h3>
<div class="outline-text-3" id="text-orgadc44eb">
<blockquote>
<p>So far, you've learned how to build pipelines with scikit-learn. For instance, the pipeline below will use <a href="https://scikit-learn.org/stable/modules/generated/sklearn.impute.SimpleImputer.html"><code>SimpleImputer()</code></a> to replace missing values in the data, before using <a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestRegressor.html"><code>RandomForestRegressor()</code></a> to train a random forest model to make predictions. We set the number of trees in the random forest model with the <code>n_estimators</code> parameter, and setting <code>random_state</code> ensures reproducibility.</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">'preprocessor'</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">()),</span>
    <span class="p">(</span><span class="s1">'model'</span><span class="p">,</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">random_seed</span><span class="p">))</span>
<span class="p">])</span>
</pre></div>
<blockquote>
<p>You have also learned how to use pipelines in cross-validation. The code below uses the <a href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.cross_val_score.html"><code>cross_val_score()</code></a> function to obtain the mean absolute error (MAE), averaged across five different folds. Recall we set the number of folds with the <code>cv</code> parameter.</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="c1"># Multiply by -1 since sklearn calculates *negative* MAE</span>
<span class="n">scores</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
                              <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                              <span class="n">scoring</span><span class="o">=</span><span class="s1">'neg_mean_absolute_error'</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"Average MAE score:"</span><span class="p">,</span> <span class="n">scores</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>
<pre class="example">
Average MAE score: 18276.410356164386
</pre></div>
</div>
<div class="outline-3" id="outline-container-orgbb1e1ee">
<h3 id="orgbb1e1ee">Step 1: Write a useful function</h3>
<div class="outline-text-3" id="text-orgbb1e1ee">
<blockquote>
<p>In this exercise, you'll use cross-validation to select parameters for a machine learning model.</p>
<p>Begin by writing a function <code>get_score()</code> that reports the average (over three cross-validation folds) MAE of a machine learning pipeline that uses:</p>
<ul class="org-ul">
<li>the data in <code>X</code> and <code>y</code> to create folds,</li>
<li><code>SimpleImputer()</code> (with all parameters left as default) to replace missing values, and</li>
<li><code>RandomForestRegressor()</code> (with <code>random_state=0</code>) to fit a random forest model.</li>
</ul>
<p>The <code>n_estimators</code> parameter supplied to <code>get_score()</code> is used when setting the number of trees in the random forest model.</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">get_score</span><span class="p">(</span><span class="n">n_estimators</span><span class="p">):</span>
    <span class="sd">"""Return the average MAE over 3 CV folds of random forest model.</span>

<span class="sd">    Args:</span>
<span class="sd">     n_estimators: the number of trees in the forest</span>
<span class="sd">    """</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">'preprocessor'</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">()),</span>
        <span class="p">(</span><span class="s1">'model'</span><span class="p">,</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">n_estimators</span><span class="p">,</span>
                                        <span class="n">random_state</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">random_seed</span><span class="p">))</span>
    <span class="p">])</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
                                  <span class="n">cv</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                  <span class="n">scoring</span><span class="o">=</span><span class="s1">'neg_mean_absolute_error'</span><span class="p">)</span>
    <span class="c1"># Replace this body with your own code</span>
    <span class="k">return</span> <span class="n">scores</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org842c342">
<h3 id="org842c342">Step 2: Test different parameter values</h3>
<div class="outline-text-3" id="text-org842c342">
<blockquote>
<p>Now, you will use the function that you defined in Step 1 to evaluate the model performance corresponding to eight different values for the number of trees in the random forest: 50, 100, 150, â€¦, 300, 350, 400. Store your results in a Python dictionary <code>results</code>, where <code>results[i]</code> is the average MAE returned by <code>get_scores(i)</code>.</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="n">trees</span><span class="p">:</span> <span class="n">get_score</span><span class="p">(</span><span class="n">trees</span><span class="p">)</span> <span class="k">for</span> <span class="n">trees</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">450</span><span class="p">,</span> <span class="mi">50</span><span class="p">)}</span>

<span class="n">results_frame</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">({</span><span class="s2">"Trees"</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="s2">"MAE"</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">())})</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org378d00d">
<h3 id="org378d00d">Step 3: Find the best parameter value</h3>
<div class="outline-text-3" id="text-org378d00d">
<div class="highlight">
<pre><span></span><span class="n">plot</span> <span class="o">=</span> <span class="n">results_frame</span><span class="o">.</span><span class="n">hvplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">"Trees"</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">"MAE"</span><span class="p">)</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Cross-Validation Mean Absolute Error"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>

<span class="n">source</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"mean_absolute_error"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="k">print</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</pre></div>
: <object data="/posts/tutorials/cross-validation/mean_absolute_error.html" height="800" style="width:100%" type="text/html">:
<p>Figure Missing</p>
:</object>
<p>200 appears to be the best number of trees for our forest.</p>
</div>
</div>
</div>
</div>
</article>
<article class="h-entry post-text" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title"><a class="u-url" href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/">Pipelines</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/" rel="bookmark"><time class="published dt-published" datetime="2020-02-20T21:14:10-08:00" itemprop="datePublished" title="2020-02-20 21:14">2020-02-20 21:14</time></a></p>
</div>
</header>
<div class="e-content entry-content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#org438a2f3">Beginning</a>
<ul>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#orgef62d9c">Imports</a>
<ul>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#orgfe5c892">Python</a></li>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#org3431273">PyPi</a></li>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#org07af93c">Others</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#orga9af0b6">Set Up</a>
<ul>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#org1ca2726">Table</a></li>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#org2dfa3b3">Plottting</a></li>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#org178ff23">The Timer</a></li>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#org7554289">Environment</a></li>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#orge450937">The Data</a></li>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#orgbc2836e">Some Constants</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#orgda95a25">Setup The Data</a>
<ul>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#org79d4d8a">Trim the columns</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#org4c1ca2f">Middle</a>
<ul>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#org747f45f">Preprocess Data and Train the Model</a>
<ul>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#orga7d3059">Define The Model</a></li>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#org4dfccc5">Build the Pipeline</a></li>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#org025c016">Fit the Model</a></li>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#org54414c7">Score the Model</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#org261b2b8">Improving the Performance</a></li>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#org6470438">SHAP</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/#orgcea3578">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org438a2f3">
<h2 id="org438a2f3">Beginning</h2>
<div class="outline-text-2" id="text-org438a2f3">
<blockquote>
<p>In this exercise, you will use <b>pipelines</b> to improve the efficiency of your machine learning code.</p>
</blockquote>
</div>
<div class="outline-3" id="outline-container-orgef62d9c">
<h3 id="orgef62d9c">Imports</h3>
<div class="outline-text-3" id="text-orgef62d9c"></div>
<div class="outline-4" id="outline-container-orgfe5c892">
<h4 id="orgfe5c892">Python</h4>
<div class="outline-text-4" id="text-orgfe5c892">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org3431273">
<h4 id="org3431273">PyPi</h4>
<div class="outline-text-4" id="text-org3431273">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">eli5.sklearn</span> <span class="kn">import</span> <span class="n">PermutationImportance</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>

<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.experimental</span> <span class="kn">import</span> <span class="n">enable_iterative_imputer</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">IterativeImputer</span>
<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">SimpleImputer</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_absolute_error</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">OneHotEncoder</span>

<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">import</span> <span class="nn">eli5</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">shap</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org07af93c">
<h4 id="org07af93c">Others</h4>
<div class="outline-text-4" id="text-org07af93c">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">CountPercentage</span><span class="p">,</span> <span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">EnvironmentLoader</span><span class="p">,</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orga9af0b6">
<h3 id="orga9af0b6">Set Up</h3>
<div class="outline-text-3" id="text-orga9af0b6"></div>
<div class="outline-4" id="outline-container-org1ca2726">
<h4 id="org1ca2726">Table</h4>
<div class="outline-text-4" id="text-org1ca2726">
<div class="highlight">
<pre><span></span><span class="n">TABLE</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">tabulate</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">,</span> <span class="n">showindex</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org2dfa3b3">
<h4 id="org2dfa3b3">Plottting</h4>
<div class="outline-text-4" id="text-org2dfa3b3">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"kaggle-intermediate-machine-learning-pipelines"</span>
<span class="n">OUTPUT_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"../../files/posts/tutorials/"</span><span class="p">)</span><span class="o">/</span><span class="n">SLUG</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="n">OUTPUT_PATH</span><span class="p">)</span>
<span class="n">Plot</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org178ff23">
<h4 id="org178ff23">The Timer</h4>
<div class="outline-text-4" id="text-org178ff23">
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org7554289">
<h4 id="org7554289">Environment</h4>
<div class="outline-text-4" id="text-org7554289">
<div class="highlight">
<pre><span></span><span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="n">EnvironmentLoader</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orge450937">
<h4 id="orge450937">The Data</h4>
<div class="outline-text-4" id="text-orge450937">
<div class="highlight">
<pre><span></span><span class="n">DATA_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ENVIRONMENT</span><span class="p">[</span><span class="s2">"HOUSE-PRICES-IOWA"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">train_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">DATA_PATH</span><span class="o">/</span><span class="s2">"train.csv"</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s2">"Id"</span><span class="p">)</span>

<span class="n">test_data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
    <span class="n">DATA_PATH</span><span class="o">/</span><span class="s2">"test.csv"</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s2">"Id"</span>
<span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">test_data</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgbc2836e">
<h4 id="orgbc2836e">Some Constants</h4>
<div class="outline-text-4" id="text-orgbc2836e">
<div class="highlight">
<pre><span></span><span class="n">Data</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">target</span><span class="o">=</span><span class="s2">"SalePrice"</span><span class="p">,</span>
    <span class="n">train_size</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">random_seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgda95a25">
<h3 id="orgda95a25">Setup The Data</h3>
<div class="outline-text-3" id="text-orgda95a25">
<p>Split up the target and features.</p>
<div class="highlight">
<pre><span></span><span class="k">assert</span> <span class="ow">not</span> <span class="n">train_data</span><span class="p">[</span><span class="n">Data</span><span class="o">.</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">hasnans</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">train_data</span><span class="p">[</span><span class="n">Data</span><span class="o">.</span><span class="n">target</span><span class="p">]</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">train_data</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">Data</span><span class="o">.</span><span class="n">target</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s2">"columns"</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_validate</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_validate</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
    <span class="n">train_size</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">train_size</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">test_size</span><span class="p">,</span>
    <span class="n">random_state</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-org79d4d8a">
<h4 id="org79d4d8a">Trim the columns</h4>
<div class="outline-text-4" id="text-org79d4d8a">
<div class="highlight">
<pre><span></span><span class="c1"># Select categorical columns with relatively low cardinality (convenient but arbitrary)</span>
<span class="n">categorical_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span>
                       <span class="n">X_train</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="ow">and</span> 
                       <span class="n">X_train</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">object</span><span class="p">]</span>

<span class="c1"># Select numerical columns</span>
<span class="n">numerical_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> 
                     <span class="n">X_train</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'int64'</span><span class="p">,</span> <span class="s1">'float64'</span><span class="p">]]</span>

<span class="c1"># Keep selected columns only</span>
<span class="n">columns</span> <span class="o">=</span> <span class="n">categorical_columns</span> <span class="o">+</span> <span class="n">numerical_columns</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">X_validate</span> <span class="o">=</span> <span class="n">X_validate</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org4c1ca2f">
<h2 id="org4c1ca2f">Middle</h2>
<div class="outline-text-2" id="text-org4c1ca2f"></div>
<div class="outline-3" id="outline-container-org747f45f">
<h3 id="org747f45f">Preprocess Data and Train the Model</h3>
<div class="outline-text-3" id="text-org747f45f">
<p>The missing numeric values will be filled in with a simple imputer. When the <code>strategy</code> is set to constant then it will fill missing values with a single value (which is 0 by default).</p>
<div class="highlight">
<pre><span></span><span class="n">numerical_transformer</span> <span class="o">=</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">'constant'</span><span class="p">)</span>
</pre></div>
<p>Now the categorical data transformer. We'll use the most frequent value in any column with missing values to fill them in and the do one-hot encoding.</p>
<div class="highlight">
<pre><span></span><span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">'imputer'</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">'most_frequent'</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">'onehot'</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">'ignore'</span><span class="p">))</span>
<span class="p">])</span>
</pre></div>
<p>Now we can bundle them together into a single transformer.</p>
<div class="highlight">
<pre><span></span><span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
    <span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">'num'</span><span class="p">,</span> <span class="n">numerical_transformer</span><span class="p">,</span> <span class="n">numerical_columns</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'cat'</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_columns</span><span class="p">)</span>
    <span class="p">])</span>
</pre></div>
</div>
<div class="outline-4" id="outline-container-orga7d3059">
<h4 id="orga7d3059">Define The Model</h4>
<div class="outline-text-4" id="text-orga7d3059">
<div class="highlight">
<pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org4dfccc5">
<h4 id="org4dfccc5">Build the Pipeline</h4>
<div class="outline-text-4" id="text-org4dfccc5">
<div class="highlight">
<pre><span></span><span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[(</span><span class="s1">'preprocessor'</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
                      <span class="p">(</span><span class="s1">'model'</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
                     <span class="p">])</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org025c016">
<h4 id="org025c016">Fit the Model</h4>
<div class="outline-text-4" id="text-org025c016">
<div class="highlight">
<pre><span></span><span class="c1"># Preprocessing of training data, fit model </span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org54414c7">
<h4 id="org54414c7">Score the Model</h4>
<div class="outline-text-4" id="text-org54414c7">
<div class="highlight">
<pre><span></span><span class="n">preds</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_validate</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"MAE: {mean_absolute_error(y_validate, preds):,}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
MAE: 17,861.780102739725
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org261b2b8">
<h3 id="org261b2b8">Improving the Performance</h3>
<div class="outline-text-3" id="text-org261b2b8">
<blockquote>
<p>Now, it's your turn! In the code cell below, define your own preprocessing steps and random forest model. Fill in values for the following variables:</p>
<ul class="org-ul">
<li><code>numerical_transformer</code></li>
<li><code>categorical_transformer</code></li>
<li><code>model</code></li>
</ul>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">numerical_transformer</span> <span class="o">=</span> <span class="n">IterativeImputer</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">Data</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
</pre></div>
<p>I'll use the same categorical imputer.</p>
<div class="highlight">
<pre><span></span><span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">'imputer'</span><span class="p">,</span> <span class="n">SimpleImputer</span><span class="p">(</span><span class="n">strategy</span><span class="o">=</span><span class="s1">'most_frequent'</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">'onehot'</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">handle_unknown</span><span class="o">=</span><span class="s1">'ignore'</span><span class="p">))</span>
<span class="p">])</span>
</pre></div>
<p>And now we bundle them together.</p>
<div class="highlight">
<pre><span></span><span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
    <span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">'numeric'</span><span class="p">,</span> <span class="n">numerical_transformer</span><span class="p">,</span> <span class="n">numerical_columns</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'categorical'</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_columns</span><span class="p">)</span>
    <span class="p">])</span>
</pre></div>
<p>Now build and train the model.</p>
<div class="highlight">
<pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">steps</span><span class="o">=</span><span class="p">[(</span><span class="s1">'preprocessor'</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">),</span>
                           <span class="p">(</span><span class="s1">'model'</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
                           <span class="p">])</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">predictions</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_validate</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"MAE: {mean_absolute_error(y_validate, predictions):,}"</span><span class="p">)</span>
</pre></div>
<pre class="example">
MAE: 17,556.51404109589
</pre>
<p>So we improved slightly, but we're still not doing as well as with the numeric only dataset.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org6470438">
<h3 id="org6470438">SHAP</h3>
<div class="outline-text-3" id="text-org6470438">
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">training</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">numerical_columns</span> <span class="o">+</span> <span class="n">categorical_columns</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">training</span><span class="p">)</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">(</span><span class="n">numerical_columns</span>
               <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="s2">"categorical"</span><span class="p">][</span><span class="s2">"onehot"</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names</span><span class="p">()))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
<pre class="example">
2020-03-01 19:25:58,515 graeae.timers.timer start: Started: 2020-03-01 19:25:58.514631
Setting feature_perturbation = "tree_path_dependent" because no background data was given.
2020-03-01 19:26:16,103 graeae.timers.timer end: Ended: 2020-03-01 19:26:16.103820
2020-03-01 19:26:16,104 graeae.timers.timer end: Elapsed: 0:00:17.589189
</pre>
<div class="highlight">
<pre><span></span><span class="n">shap</span><span class="o">.</span><span class="n">summary_plot</span><span class="p">(</span><span class="n">shap_values</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"shap_summary.png"</span>

<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{output}]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="52fc9fa36e385cc6b1cc5a40b4505610a7dd6c65.png" src="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/.ob-jupyter/52fc9fa36e385cc6b1cc5a40b4505610a7dd6c65.png"></p>
</div>
<pre class="example">
[[file:shap_summary.png]]
&lt;Figure size 432x288 with 0 Axes&gt;
</pre>
<div class="figure">
<p><img alt="shap_summary.png" src="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/shap_summary.png"></p>
</div>
<div class="highlight">
<pre><span></span><span class="n">shap</span><span class="o">.</span><span class="n">initjs</span><span class="p">()</span>
<span class="n">html</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">force_plot</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">,</span> <span class="n">shap_values</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="n">output_file</span> <span class="o">=</span> <span class="s2">"force_plot.html"</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output_file</span>
<span class="k">with</span> <span class="n">output</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>
    <span class="n">shap</span><span class="o">.</span><span class="n">save_html</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span> <span class="n">html</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"""</span>
<span class="s2">#+begin_export html</span>
<span class="s2">: &lt;object type="text/html" data="{output_file}" style="width:100%" height=800&gt;</span>
<span class="s2">:   &lt;p&gt;Figure Missing&lt;/p&gt;</span>
<span class="s2">: &lt;/object&gt;</span>
<span class="s2">#+end_export</span>
<span class="s2">"""</span><span class="p">)</span>
</pre></div>
: <object data="/posts/tutorials/kaggle-intermediate-machine-learning-pipelines/force_plot.html" height="800" style="width:100%" type="text/html">:
<p>Figure Missing</p>
:</object></div>
</div>
</div>
<div class="outline-2" id="outline-container-orgcea3578">
<h2 id="orgcea3578">End</h2>
</div>
</div>
</article>
</div>
<ul class="pager postindexpager clearfix">
<li class="next"><a href="/index-7.html" rel="next">Older posts</a></li>
</ul>
<script crossorigin="anonymous" integrity="sha384-3lJUsx1TJHt7BA4udB5KPnDrlkO8T6J6v/op7ui0BbCjvZ9WqV4Xm6DTP6kQ/iBH" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">

        MathJax.Hub.Config({tex2jax: {inlineMath: [['$latex ','$'], ['\\(','\\)']]}});
</script><!--End of body content-->
<footer id="footer">Contents Â© 2020 <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
<script src="assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
</script> </div>
</div>
</body>
</html>
