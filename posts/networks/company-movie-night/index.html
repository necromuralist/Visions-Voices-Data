<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="An introductiton to creating and manipulating graphs in networkx." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Company Movie Night | Visions, Voices, Data</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../../rss.xml" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Visions-Voices-Data/posts/networks/company-movie-night/" rel="canonical"><!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]-->
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript"></script><!--
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.min.js"
</script>
-->
<script async src="../../../assets/javascript/p5.min.js" type="text/javascript"></script>
<meta content="Cloistered Monkey" name="author">
<link href="/posts/libraries/prophet/getting-started-with-prophet/" rel="prev" title="Getting Started With Prophet" type="text/html">
<link href="/posts/networks/some-networkx-examples/" rel="next" title="Some Networkx Examples" type="text/html">
<meta content="Visions, Voices, Data" property="og:site_name">
<meta content="Company Movie Night" property="og:title">
<meta content="https://necromuralist.github.io/Visions-Voices-Data/posts/networks/company-movie-night/" property="og:url">
<meta content="An introductiton to creating and manipulating graphs in networkx." property="og:description">
<meta content="article" property="og:type">
<meta content="2019-04-11T13:04:23-07:00" property="article:published_time">
<meta content="networks" property="article:tag">
<meta content="networkx" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="https://necromuralist.github.io/Visions-Voices-Data/"><span id="blog-title">Visions, Voices, Data</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="/archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="/categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="/rss.xml">RSS feed</a></li>
<li class="nav-item dropdown"><a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Pages</a>
<div class="dropdown-menu"><a class="dropdown-item" href="https://necromuralist.github.io/">Cloistered Monkey</a> <a class="dropdown-item" href="/pages/giss/giss-yearly-anomalies-by-climate-zone">GISS Anomalies</a></div>
</li>
</ul>
<!-- DuckDuckGo custom search -->
<form action="https://duckduckgo.com/" class="navbar-form pull-left" id="search" method="get" name="search"><input name="sites" type="hidden" value="https://necromuralist.github.io/Visions-Voices-Data/"> <input name="k8" type="hidden" value="#444444"> <input name="k9" type="hidden" value="#D51920"> <input name="kt" type="hidden" value="h"> <input class="span2" maxlength="255" name="q" placeholder="Search…" type="text"> <input style="visibility: hidden;display:none" type="submit" value="DuckDuckGo Search"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="/posts/networks/company-movie-night/index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href="/posts/networks/company-movie-night/">Company Movie Night</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/networks/company-movie-night/" rel="bookmark"><time class="published dt-published" datetime="2019-04-11T13:04:23-07:00" itemprop="datePublished" title="2019-04-11 13:04">2019-04-11 13:04</time></a></p>
<p class="sourceline"><a class="sourcelink" href="/posts/networks/company-movie-night/index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/networks/company-movie-night/#org7a2ee65">The Departure</a>
<ul>
<li><a href="/posts/networks/company-movie-night/#org4a2dc7b">Imports</a></li>
<li><a href="/posts/networks/company-movie-night/#org40a59f9">Set Up</a></li>
<li><a href="/posts/networks/company-movie-night/#org417b0b6">The Plotting</a></li>
</ul>
</li>
<li><a href="/posts/networks/company-movie-night/#orgd1f0c41">The Initiation</a>
<ul>
<li><a href="/posts/networks/company-movie-night/#org2146ef1">The Data</a></li>
<li><a href="/posts/networks/company-movie-night/#org7d75fec">Plotting</a></li>
<li><a href="/posts/networks/company-movie-night/#org99c6a5d">Question 2</a></li>
<li><a href="/posts/networks/company-movie-night/#orgfb6444d">Question 3</a></li>
<li><a href="/posts/networks/company-movie-night/#orgfb5a9c0">Question 4</a></li>
</ul>
</li>
<li><a href="/posts/networks/company-movie-night/#org89551da">The Return</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org7a2ee65">
<h2 id="org7a2ee65">The Departure</h2>
<div class="outline-text-2" id="text-org7a2ee65">
<p>This is a look at working with networks using <a href="https://networkx.github.io">networkx</a>. Our scene - eight employees are trying to choose three movies to watch for company movie nights. We have two sources of data - the <i>candidate movies</i> and the <i>relationship</i> between pairs of employees. The relationships are on a scale from -100 to 100, with -100 being the strongest of enemies and 100 meaning they are best of friends. Zero either means they have no relationship (don't interact) or are indifferent about the other person.</p>
</div>
<div class="outline-3" id="outline-container-org4a2dc7b">
<h3 id="org4a2dc7b">Imports</h3>
<div class="outline-text-3" id="text-org4a2dc7b"></div>
<div class="outline-4" id="outline-container-org04c33ca">
<h4 id="org04c33ca">From Python</h4>
<div class="outline-text-4" id="text-org04c33ca">
<div class="highlight">
<pre><span></span>from argparse import Namespace
from functools import partial
from pathlib import Path
import copy
import os
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb462b4c">
<h4 id="orgb462b4c">From PyPi</h4>
<div class="outline-text-4" id="text-orgb462b4c">
<div class="highlight">
<pre><span></span>from dotenv import load_dotenv
from bokeh.models import (
    BoxSelectTool,
    Circle,
    HoverTool, 
    MultiLine,
    PanTool,
    Range1d,
    TapTool,
    WheelZoomTool,
)
from bokeh.models import Plot as BokehPlot
from bokeh.models.graphs import (from_networkx, 
                                 EdgesAndLinkedNodes, 
                                 NodesAndLinkedEdges)
from bokeh.palettes import RdBu, Spectral4
from bokeh.transform import linear_cmap
import holoviews
from holoviews import dim
import hvplot.pandas
import networkx
import pandas
import numpy
from networkx.algorithms import bipartite
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org81d5064">
<h4 id="org81d5064">My Stuff</h4>
<div class="outline-text-4" id="text-org81d5064">
<div class="highlight">
<pre><span></span>from graeae.visualization import EmbedBokeh, EmbedHoloview
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org40a59f9">
<h3 id="org40a59f9">Set Up</h3>
<div class="outline-text-3" id="text-org40a59f9"></div>
<div class="outline-4" id="outline-container-org5717df7">
<h4 id="org5717df7">Load Dotenv</h4>
<div class="outline-text-4" id="text-org5717df7">
<div class="highlight">
<pre><span></span>load_dotenv(".env", override=True)
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org417b0b6">
<h3 id="org417b0b6">The Plotting</h3>
<div class="outline-text-3" id="text-org417b0b6">
<div class="highlight">
<pre><span></span>SLUG = 'company-movie-night/'
OUTPUT = Path("../../files/posts/networks/" + SLUG)
Embed = partial(EmbedHoloview, folder_path=OUTPUT)
EmbedB = partial(EmbedBokeh, folder_path=OUTPUT)
holoviews.extension("bokeh")
</pre></div>
<div class="highlight">
<pre><span></span>Plot = Namespace(
    node_size=15,
    edge_alpha=0.8,
    edge_color="#CCCCCC",
    edge_width=5,
    width=800,
    height=800,
    fontsize=18,
    padding=dict(x=(-1, 1), y=(-1, 1))
)
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgd1f0c41">
<h2 id="orgd1f0c41">The Initiation</h2>
<div class="outline-text-2" id="text-orgd1f0c41"></div>
<div class="outline-3" id="outline-container-org2146ef1">
<h3 id="org2146ef1">The Data</h3>
<div class="outline-text-3" id="text-org2146ef1"></div>
<div class="outline-4" id="outline-container-orgfb6331c">
<h4 id="orgfb6331c">This Is the Set Of Employee-Relationships</h4>
<div class="outline-text-4" id="text-orgfb6331c">
<div class="highlight">
<pre><span></span>employee_relationships_path = Path(os.environ.get("EMPLOYEE_RELATIONSHIPS"))
relationships_data = pandas.read_csv(
    employee_relationships_path, 
    delimiter="\t", 
    header=None,
    names="employee_1 employee_2 relationship".split())
</pre></div>
<div class="highlight">
<pre><span></span>table = holoviews.Table(relationships_data).opts(height=Plot.height)
Embed(plot=table, file_name="relationships_data")()
</pre></div>
<object data="/posts/networks/company-movie-night/relationships_data.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<div class="highlight">
<pre><span></span>employees = set(relationships_data.employee_1.unique()) | set(relationships_data.employee_2.unique())
print(employees)
</pre></div>
<pre class="example">
{'Pablo', 'Georgia', 'Andy', 'Claude', 'Vincent', 'Joan', 'Lee', 'Frida'}

</pre>
<div class="highlight">
<pre><span></span>print(len(employees))
</pre></div>
<pre class="example">
8

</pre>
<div class="highlight">
<pre><span></span>print(len(relationships_data))
</pre></div>
<pre class="example">
28

</pre>
<p>We have eight employees and twenty-eight links. Is this a fully connected graph? The handshake problem says that the amount of links in a fully-connected network is:</p>
<p>\[ links = \frac{n(n-1)}{2} \]</p>
<div class="highlight">
<pre><span></span>print(len(employees) * (len(employees) - 1)/2)
</pre></div>
<pre class="example">
28.0

</pre>
<p>It looks like our relationships data creates a fully-connected network (unless there is a duplicate which would be an error).</p>
</div>
</div>
<div class="outline-4" id="outline-container-org497717f">
<h4 id="org497717f">These Are the Movie Choices</h4>
<div class="outline-text-4" id="text-org497717f">
<div class="highlight">
<pre><span></span>employee_movies_path = Path(os.environ.get("EMPLOYEE_MOVIE_CHOICES"))
movies_data = pandas.read_csv(
    employee_movies_path, 
    delimiter="\t", 
    header=None,
    skiprows=1,
    names="employee movie".split())
print(f"Employee To Movie Edges: {len(movies_data)}")
print(movies_data.head())
</pre></div>
<pre class="example">
Employee To Movie Edges: 24
  employee                            movie
0     Andy                         Anaconda
1     Andy                       Mean Girls
2     Andy                       The Matrix
3   Claude                         Anaconda
4   Claude  Monty Python and the Holy Grail

</pre>
<div class="highlight">
<pre><span></span>movies = set(movies_data.movie.unique())
for movie in sorted(movies):
    print(f" - {movie}")
</pre></div>
<ul class="org-ul">
<li>Anaconda</li>
<li>Forrest Gump</li>
<li>Kung Fu Panda</li>
<li>Mean Girls</li>
<li>Monty Python and the Holy Grail</li>
<li>Snakes on a Plane</li>
<li>The Dark Knight</li>
<li>The Godfather</li>
<li>The Matrix</li>
<li>The Shawshank Redemption</li>
<li>The Social Network</li>
</ul>
<p>The eight employees chose 11 movies between them.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org37e00b3">
<h4 id="org37e00b3">Converting the DataFrames to Graphs</h4>
<div class="outline-text-4" id="text-org37e00b3"></div>
<div class="outline-5" id="outline-container-orgbacc1e8">
<h5 id="orgbacc1e8">The Relationship Graph</h5>
<div class="outline-text-5" id="text-orgbacc1e8">
<div class="highlight">
<pre><span></span>relationship_graph = networkx.from_pandas_edgelist(relationships_data, 
                                                   "employee_1", "employee_2", 
                                                   edge_attr="relationship")
for index, row in relationships_data.sample(5).iterrows():
    assert relationship_graph[row["employee_1"]][row["employee_2"]]["relationship"] == row["relationship"]
</pre></div>
<div class="highlight">
<pre><span></span>expected_edges = len(relationships_data)
expected_nodes = len(employees)
print("Expected Edges: {}".format(expected_edges))
print("Expected Nodes: {}".format(expected_nodes))
assert expected_nodes == len(relationship_graph.nodes)
assert expected_edges == len(relationship_graph.edges)
</pre></div>
<pre class="example">
Expected Edges: 28
Expected Nodes: 8

</pre></div>
</div>
<div class="outline-5" id="outline-container-org19bbcc6">
<h5 id="org19bbcc6">The Movie Graph</h5>
<div class="outline-text-5" id="text-org19bbcc6">
<div class="highlight">
<pre><span></span>movie_graph = networkx.from_pandas_edgelist(movies_data, "employee", "movie")
</pre></div>
<div class="highlight">
<pre><span></span>for index, row in movies_data.iterrows():
    movie_graph[row.employee][row.movie]["employee"] = row.employee
    movie_graph[row.employee][row.movie]["movie"] = row.movie

for employee in movies_data.employee:    
    movie_graph.nodes[employee]["type"] = "employee"
for movie in movies_data.movie:
    movie_graph.nodes[movie]["type"] = "movie"
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org7d75fec">
<h3 id="org7d75fec">Plotting</h3>
<div class="outline-text-3" id="text-org7d75fec">
<div class="highlight">
<pre><span></span>def graph_plot(graph: networkx.Graph, 
               title:str,
               file_name: str,
               hover: HoverTool,
               layout=networkx.circular_layout) -&gt; None:
    """Plot the graph in bokeh

    Args:
     graph: the graph to plot
     layout: function to layout the plot
     title: title for the plot
     hover: defined hover tool
     file_name: name to save the bokeh file (without extension)
    """
    plot = BokehPlot(plot_width=Plot.width,
                     plot_height=Plot.height,
                     x_range=Range1d(-1, 1),
                     y_range=Range1d(-1, 1)
    )

    plot.title.text = title
    plot.title.text_font_size = f"{Plot.fontsize}pt"
    plot.add_tools(hover, TapTool(), BoxSelectTool(), PanTool(), WheelZoomTool())

    renderer = from_networkx(relationship_graph, layout, 
                             scale=1, center=(0,0))
    renderer.node_renderer.glyph = Circle(size=Plot.node_size, 
                                          fill_color=Spectral4[0])
    renderer.node_renderer.selection_glyph = Circle(size=Plot.node_size, 
                                                    fill_color=Spectral4[2])
    renderer.node_renderer.hover_glyph = Circle(size=Plot.node_size, 
                                                fill_color=Spectral4[1])

    color_map = linear_cmap(field_name="relationship", 
                            palette=RdBu[11], 
                            low=100, high=-100)
    renderer.edge_renderer.glyph = MultiLine(line_color=color_map, 
                                             line_alpha=0.5,
                                             line_width=3)
    renderer.edge_renderer.selection_glyph = MultiLine(line_color=color_map, 
                                                       line_width=Plot.edge_width)
    renderer.edge_renderer.hover_glyph = MultiLine(line_color=color_map, 
                                                   line_width=Plot.edge_width)
    renderer.selection_policy = NodesAndLinkedEdges()
    renderer.inspection_policy = EdgesAndLinkedNodes()
    plot.renderers.append(renderer)
    EmbedB(plot=plot, file_name=file_name)()
    return
</pre></div>
<div class="highlight">
<pre><span></span>class RelationshipGraphPlot:
    """Plots a graph and keeps the parts so you can inspect them

    Args:
     graph: the graph to plot
     layout: function to layout the plot
     title: title for the plot
     hover: defined hover tool
     settings: namespace with the plot settings
     file_name: name to save the bokeh file (without extension)
    """
    def __init__(self, graph: networkx.Graph, 
                 title:str,
                 file_name: str,
                 hover: HoverTool,
                 settings: Namespace=Plot,
                 layout=networkx.circular_layout) -&gt; None:
        self.graph = graph
        self.title = title
        self.file_name = file_name
        self.hover = hover
        self.settings = settings
        self.layout = layout
        self._tap_tool = None
        self._box_select_tool = None
        self._pan_tool = None
        self._wheel_zoom_tool = None
        self._plot = None
        self._renderer = None
        self._color_map = None
        return

    @property
    def tap_tool(self) -&gt; TapTool:
        if self._tap_tool is None:
            self._tap_tool = TapTool()
        return self._tap_tool

    @property
    def box_select_tool(self) -&gt; BoxSelectTool:
        if self._box_select_tool is None:
            self._box_select_tool = BoxSelectTool()
        return self._box_select_tool

    @property
    def pan_tool(self) -&gt; PanTool:
        if self._pan_tool is None:
            self._pan_tool = PanTool()
        return self._pan_tool

    @property
    def wheel_zoom_tool(self) -&gt; WheelZoomTool:
        if self._wheel_zoom_tool is None:
            self._wheel_zoom_tool = WheelZoomTool()
        return self._wheel_zoom_tool

    @property
    def plot(self) -&gt; BokehPlot:
        if self._plot is None:
            self._plot = BokehPlot(plot_width=self.settings.width,
                                   plot_height=self.settings.height,
                                   x_range=Range1d(-1, 1),
                                   y_range=Range1d(-1, 1)
            )

            self._plot.title.text = self.title
            self._plot.title.text_font_size = f"{Plot.fontsize}pt"
            self._plot.add_tools(self.hover, 
                                 self.tap_tool, 
                                 self.box_select_tool, 
                                 self.pan_tool,
                                 self.wheel_zoom_tool)
            self._plot.renderers.append(self.renderer)
        return self._plot

    @property
    def color_map(self):
        if self._color_map is None:
            self._color_map = linear_cmap(field_name="relationship", 
                                          palette=RdBu[11], 
                                          low=100, high=-100)
        return self._color_map

    @property
    def renderer(self):
        if self._renderer is None:
            self._renderer = from_networkx(self.graph, self.layout, 
                                          scale=1, center=(0,0))
            self._renderer.node_renderer.glyph = Circle(
                size=Plot.node_size, 
                fill_color=Spectral4[0])
            self._renderer.node_renderer.selection_glyph = Circle(
                size=Plot.node_size, 
                fill_color=Spectral4[2])
            self._renderer.node_renderer.hover_glyph = Circle(
                size=Plot.node_size, 
                fill_color=Spectral4[1])

            self._renderer.edge_renderer.glyph = MultiLine(
                line_color=self.color_map, 
                line_alpha=0.5,
                line_width=3)
            self._renderer.edge_renderer.selection_glyph = MultiLine(
                line_color=self.color_map, 
                line_width=Plot.edge_width)
            self._renderer.edge_renderer.hover_glyph = MultiLine(
                line_color=self._color_map,
                line_width=Plot.edge_width)
            self._renderer.selection_policy = NodesAndLinkedEdges()
            self._renderer.inspection_policy = EdgesAndLinkedNodes()
        return self._renderer

    def __call__(self) -&gt; None:
        EmbedB(plot=self.plot, file_name=self.file_name)()
        return
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgf8f1ad6">
<h4 id="orgf8f1ad6">The Employee Relationship Plot</h4>
<div class="outline-text-4" id="text-orgf8f1ad6"></div>
<div class="outline-5" id="outline-container-orga444fca">
<h5 id="orga444fca">HoloViews</h5>
<div class="outline-text-5" id="text-orga444fca">
<p>The employee relationship graph consists of employees as nodes and their relationshp-level as weights on the edges.</p>
<div class="highlight">
<pre><span></span>plot = holoviews.Graph.from_networkx(relationship_graph,
                                     networkx.circular_layout).opts(
                                         cmap="Set1",
                                         fontsize=Plot.fontsize,
                                         width=800,
                                         height=800,
                                         title="Company Relationship Graph",
                                         xaxis=None, yaxis=None).options(
                                             edge_color_index="relationship", 
                                             edge_cmap="Spectral").redim.range(**Plot.padding)
renderer = holoviews.render(plot)
renderer.renderers[-1].selection_policy = EdgesAndLinkedNodes()
EmbedB(plot=renderer, file_name="employee_relationships")()
</pre></div>
<script id="620da89f-412b-4c15-b555-58f0dd1c4fd8" src="/posts/networks/company-movie-night/employee_relationships"></script>
<div class="outline-5" id="outline-container-orga813678">
<h5 id="orga813678">Bokeh</h5>
<div class="outline-text-5" id="text-orga813678">
<p>This is the same plot using <a href="https://bokeh.pydata.org/en/latest/">bokeh</a> directly instead of holoviews. I wanted both the nodes and edges to trigger the <code>HoverTool</code> but HoloViews doesn't support this. There might be a way to add it later, but their documentation is so opaque that I decided it wasn't worth it to keep trying to figure it out, since bokeh isn't that hard to use (although their documentation isn't the best either).</p>
<p>Since bokeh is so verbose I'm going to step through this instead of putting it into one block.</p>
</div>
<div class="outline-6" id="outline-container-org95bf9b7">
<h6 id="org95bf9b7">Hover Tool</h6>
<div class="outline-text-6" id="text-org95bf9b7">
<p>When the <code>EdgesAndLinkedNodes</code> class is used only the edge data is available to the hovertool (or at least I couldn't figure out how to make the Node attributes work). So these have to be available to it. You can see what's available once you've created the graph renderer (the output of <code>from_networkx</code>) by looking at one of the data attributes</p>
<pre class="example">
renderer.edge_renderer.data_source.data.keys()
</pre>
<p>Which in this case returned this.</p>
<pre class="example">
dict_keys(['relationship', 'start', 'end'])
</pre>
<p><code>relationship</code> was a data-attribute I added through <code>networkx</code>, something else (presumably bokeh) created the start and end.</p>
<div class="highlight">
<pre><span></span>hover = HoverTool(
    tooltips=[
        ("Employee", "@start"),
        ("Employee", "@end"),
        ("Relationship", "@relationship"),
    ]
)
</pre></div>
</div>
</div>
<div class="outline-6" id="outline-container-org5349ee4">
<h6 id="org5349ee4">The Plot</h6>
<div class="outline-text-6" id="text-org5349ee4">
<p>This is the bokeh plot (I don't know how it differs from a figure). It's normally called <code>Plot</code> but I already used that name for my settings object so I called it <code>BokehPlot</code>.</p>
<div class="highlight">
<pre><span></span>plot = BokehPlot(plot_width=Plot.width,
                 plot_height=Plot.height,
                 x_range=Range1d(-1, 1),
                 y_range=Range1d(-1, 1)
)

plot.title.text = "Company Relationships"
plot.title.text_font_size = f"{Plot.fontsize}pt"
plot.add_tools(hover, TapTool(), BoxSelectTool(), PanTool(), WheelZoomTool())
</pre></div>
</div>
</div>
<div class="outline-6" id="outline-container-org8030358">
<h6 id="org8030358">The Graph Renderer</h6>
<div class="outline-text-6" id="text-org8030358">
<p>This part converts the networkx Graph into a bokeh Graph. This is what I was referring to earlier when I talked about inspecting the <code>renderer</code> to look at the available edge attributes.</p>
<div class="highlight">
<pre><span></span>renderer = from_networkx(relationship_graph, networkx.circular_layout, 
                         scale=1, center=(0,0))
</pre></div>
</div>
</div>
<div class="outline-6" id="outline-container-orgb54bfe1">
<h6 id="orgb54bfe1">Nodes</h6>
<div class="outline-text-6" id="text-orgb54bfe1">
<p>You have to set up the shapes for the nodes - I think - there might be defaults but the few examples I found set it up. It's probably not a bad idea in any case. The <code>Spectral4</code> object is a list of four hex-colors. Here's the ones I used.</p>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Object</th>
<th class="org-right" scope="col">Index</th>
<th class="org-left" scope="col">Color</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">glyph</td>
<td class="org-right">0</td>
<td class="org-left">Medium Blue</td>
</tr>
<tr>
<td class="org-left">selection_glyph</td>
<td class="org-right">2</td>
<td class="org-left">Orange</td>
</tr>
<tr>
<td class="org-left">hover_glyph</td>
<td class="org-right">1</td>
<td class="org-left">Pastel Green</td>
</tr>
</tbody>
</table>
<div class="highlight">
<pre><span></span>renderer.node_renderer.glyph = Circle(size=Plot.node_size, fill_color=Spectral4[0])
renderer.node_renderer.selection_glyph = Circle(size=Plot.node_size, fill_color=Spectral4[2])
renderer.node_renderer.hover_glyph = Circle(size=Plot.node_size, fill_color=Spectral4[1])
</pre></div>
</div>
</div>
<div class="outline-6" id="outline-container-org0d8693a">
<h6 id="org0d8693a">Color Map</h6>
<div class="outline-text-6" id="text-org0d8693a">
<p>The <code>linear_cmap</code> maps a range of values to a palette of colors. In this case I'm mapping the relationship values to the red-blue palette (<code>RdBu</code>). Two things to note:</p>
<ul class="org-ul">
<li>I chose a red-blue palette with 11 values because the odd-number puts white at the center (it goes from blue to white to red)</li>
<li>Althouh the name suggests a palette form red to blue it goes from blue to red so I had to make -100 the 'high' value so red would be a bad relationship.</li>
</ul>
<div class="highlight">
<pre><span></span>color_map = linear_cmap(field_name="relationship", palette=RdBu[11], low=100, high=-100)
</pre></div>
</div>
</div>
<div class="outline-6" id="outline-container-orgef7d5cf">
<h6 id="orgef7d5cf">The Edges</h6>
<div class="outline-text-6" id="text-orgef7d5cf">
<p>Like the nodes you define the edges for the plot. This is where we get to use the color-map to make the edges match the relationship between the employees.</p>
<div class="highlight">
<pre><span></span>renderer.edge_renderer.glyph = MultiLine(line_color=color_map, 
                                         line_alpha=0.5,
                                         line_width=3)
renderer.edge_renderer.selection_glyph = MultiLine(line_color=color_map, 
                                                   line_width=Plot.edge_width)
renderer.edge_renderer.hover_glyph = MultiLine(line_color=color_map, 
                                               line_width=Plot.edge_width)
</pre></div>
</div>
</div>
<div class="outline-6" id="outline-container-org2c5a41f">
<h6 id="org2c5a41f">The Selection and Inspection Policies</h6>
<div class="outline-text-6" id="text-org2c5a41f">
<p>This was the reason for doing it in bokeh in the first place. Adding these two lines makes both the edge and attached notes highlight when selected or hovered over.</p>
<div class="highlight">
<pre><span></span>renderer.selection_policy = NodesAndLinkedEdges()
renderer.inspection_policy = EdgesAndLinkedNodes()
</pre></div>
</div>
</div>
<div class="outline-6" id="outline-container-org90e3641">
<h6 id="org90e3641">Put It All Together</h6>
<div class="outline-text-6" id="text-org90e3641">
<p>Now we just add the graph-renderer to the plot and have bokeh convert it to JavaScript and HTML.</p>
<div class="highlight">
<pre><span></span>plot.renderers.append(renderer)
EmbedB(plot=plot, file_name="company_relationships_bokeh")()
</pre></div>
<script id="b871a597-f39e-4ca0-9303-dffb029b90ec" src="company_relationships_bokeh"></script>
<p>It looks like Andy might have some kind of personality problem (maybe he's the boss), while Georgia and Claude are unusually close.</p>
</div>
</div>
</div>
<div class="outline-5" id="outline-container-orgb88265a">
<h5 id="orgb88265a">Spring loaded</h5>
<div class="outline-text-5" id="text-orgb88265a">
<p>Bokeh raises an error if you try to re-use the hover-tool for some reason so I had to make a copy.</p>
<div class="highlight">
<pre><span></span>hover = HoverTool(
    tooltips=[
        ("Employee", "@start"),
        ("Employee", "@end"),
        ("Relationship", "@relationship"),
    ]
)

graph_plot(relationship_graph, 
           "Company Relationships", 
           "company_relationships_spring", 
           hover,
           networkx.spring_layout)
</pre></div>
<script id="b9aee303-a400-4bef-a454-729bba29b2b5" src="company_relationships_spring"></script>
<p>This didn't produce as interesting a result as I thought.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org2dc0c64">
<h4 id="org2dc0c64">The Movie Plot</h4>
<div class="outline-text-4" id="text-org2dc0c64">
<div class="highlight">
<pre><span></span>movie_hover = HoverTool(
    tooltips = [
        ("Employee", "@employee"),
        ("Movie", "@movie"),
    ]

)
plot = holoviews.Graph.from_networkx(movie_graph,
                                     networkx.circular_layout).opts(
                                         node_color=dim("type"),
                                         cmap="Set1",
                                         fontsize=Plot.fontsize,
                                         width=Plot.width,
                                         height=Plot.height,
                                         tools=[movie_hover, TapTool()],
                                         title="Company Movies Graph",
                                         xaxis=None, yaxis=None).options(
                                             inspection_policy="edges",
                                             edge_cmap="Spectral").redim.range(**Plot.padding)
Embed(plot=plot, file_name="company_movies_circle")()
</pre></div>
<object data="company_movies_circle.html" height="800" style="width:100%" type="text/html">
<p>Figure Missing</p>
</object>
<p>The Blue nodes are employees and the red nodes are movies.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org99c6a5d">
<h3 id="org99c6a5d">Question 2</h3>
<div class="outline-text-3" id="text-org99c6a5d">
<p>Using the graph from the previous question, add nodes attributes named `'type'` where movies have the value `'movie'` and employees have the value `'employee'` and return that graph.</p>
<p><b>This function should return a networkx graph with node attributes `{'type': 'movie'}` or `{'type': 'employee'}`</b></p>
<div class="highlight">
<pre><span></span>def answer_two():
    """Adds 'type' to nodes from movie-graph

    Returns:
     Graph: answer_one with 'type' attribute added (employee or movie)
    """
    graph = answer_one()
    new_graph = networkx.Graph()
    nodes = graph.nodes()
    employee_nodes = [node for node in nodes if node in employees]
    movie_nodes = [node for node in nodes if node in movies]
    new_graph.add_nodes_from(employee_nodes, bipartite=0, type='employee')
    new_graph.add_nodes_from(movie_nodes, bipartite=1, type="movie")
    new_graph.add_edges_from(graph.edges())
    return new_graph
</pre></div>
<div class="highlight">
<pre><span></span>two = answer_two()
two.nodes(data=True)
</pre></div>
<div class="highlight">
<pre><span></span>plot_graph(two)
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgfb6444d">
<h3 id="orgfb6444d">Question 3</h3>
<div class="outline-text-3" id="text-orgfb6444d">
<p>Find a weighted projection of the graph from `answer_two` which tells us how many movies different pairs of employees have in common.</p>
<p><b>This function should return a weighted projected graph.</b></p>
<div class="highlight">
<pre><span></span>def answer_three():
    graph = answer_two()
    assert networkx.is_bipartite(graph)
    return bipartite.weighted_projected_graph(graph, employees)
</pre></div>
<div class="highlight">
<pre><span></span>three = answer_three()
plot_graph(three)
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-orgfb5a9c0">
<h3 id="orgfb5a9c0">Question 4</h3>
<div class="outline-text-3" id="text-orgfb5a9c0">
<p>Suppose you'd like to find out if people that have a high relationship score also like the same types of movies.</p>
<p>Find the Pearson correlation ( using `DataFrame.corr()` ) between employee relationship scores and the number of movies they have in common. If two employees have no movies in common it should be treated as a 0, not a missing value, and should be included in the correlation calculation.</p>
<p><b>This function should return a float.</b></p>
<div class="highlight">
<pre><span></span>def answer_four():
    """calculates the pearson correlation for data

    Returns:
     float: Pearson correlation for weight and relationship_score
    """
    three = answer_three()
    relationships = pandas.read_table(
        "Employee_Relationships.txt",
        names="employee_left employee_right relationship_score".split())
    relationships["employees"] = relationships.apply(
        lambda row: tuple(sorted((row["employee_left"],
                                  row['employee_right']))), axis=1)

    weights = pandas.DataFrame(
        three.edges(data=True),
        columns="employee_left employee_right weight".split())
    weights["weight"] = weights.weight.map(lambda row: row["weight"])
    weights["employees"] = weights.apply(lambda row: tuple(sorted(
        (row["employee_left"],
         row["employee_right"]))),
                                         axis=1)

    joined = pandas.merge(relationships, weights, how="outer", 
                          on=['employees'])
    assert len(joined) == len(relationships)
    joined['weight'] = joined["weight"].fillna(0)

    data = joined[["relationship_score", "weight"]]
    correlation = data.corr()
    return correlation.relationship_score.weight
</pre></div>
<div class="highlight">
<pre><span></span>print(answer_four())
</pre></div>
</div>
</div>
<div class="outline-2" id="outline-container-org89551da">
<h2 id="org89551da">The Return</h2>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="../../../categories/networks/" rel="tag">networks</a></li>
<li><a class="tag p-category" href="../../../categories/networkx/" rel="tag">networkx</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="../../libraries/prophet/getting-started-with-prophet/" rel="prev" title="Getting Started With Prophet">Previous post</a></li>
<li class="next"><a href="../some-networkx-examples/" rel="next" title="Some Networkx Examples">Next post</a></li>
</ul>
</nav>
</aside>
<!--End of body content-->
<footer id="footer">Contents © 2020 <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
<script src="../../../assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
</script> </div>
</div>
</div>
</div>
</div>
</div>
</article>
</div>
</div>
</body>
</html>
