<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Pulling Oregon Covid-19 data from PDFs." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Pulling Oregon Covid-19 Data | Visions, Voices, Data</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Visions-Voices-Data/posts/pulling-oregon-covid-19-data/" rel="canonical"><!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]-->
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript"></script><!--
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.min.js"
</script>
-->
<script async src="../../javascript/p5.min.js" type="text/javascript"></script>
<meta content="Cloistered Monkey" name="author">
<link href="/posts/tutorials/data-leakage/" rel="prev" title="Data Leakage" type="text/html">
<link href="/posts/introductory-statistics-with-randomization-and-simulation/" rel="next" title="Introductory Statistics with Randomization and Simulation" type="text/html">
<meta content="Visions, Voices, Data" property="og:site_name">
<meta content="Pulling Oregon Covid-19 Data" property="og:title">
<meta content="https://necromuralist.github.io/Visions-Voices-Data/posts/pulling-oregon-covid-19-data/" property="og:url">
<meta content="Pulling Oregon Covid-19 data from PDFs." property="og:description">
<meta content="article" property="og:type">
<meta content="2020-08-04T22:59:37-07:00" property="article:published_time">
<meta content="covid-19" property="article:tag">
<meta content="data" property="article:tag">
<meta content="oregon" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="/"><span id="blog-title">Visions, Voices, Data</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="/archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="/categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="/rss.xml">RSS feed</a></li>
<li class="nav-item dropdown"><a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Pages</a>
<div class="dropdown-menu"><a class="dropdown-item" href="https://necromuralist.github.io/">Cloistered Monkey</a> <a class="dropdown-item" href="/pages/giss/giss-yearly-anomalies-by-climate-zone">GISS Anomalies</a></div>
</li>
</ul>
<!-- DuckDuckGo custom search -->
<form action="https://duckduckgo.com/" class="navbar-form pull-left" id="search" method="get" name="search"><input name="sites" type="hidden" value="https://necromuralist.github.io/Visions-Voices-Data/"> <input name="k8" type="hidden" value="#444444"> <input name="k9" type="hidden" value="#D51920"> <input name="kt" type="hidden" value="h"> <input class="span2" maxlength="255" name="q" placeholder="Searchâ€¦" type="text"> <input style="visibility: hidden;display:none" type="submit" value="DuckDuckGo Search"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="/posts/pulling-oregon-covid-19-data/index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href="/posts/pulling-oregon-covid-19-data/">Pulling Oregon Covid-19 Data</a></h1>
<div class="metadata">
<p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/pulling-oregon-covid-19-data/" rel="bookmark"><time class="published dt-published" datetime="2020-08-04T22:59:37-07:00" itemprop="datePublished" title="2020-08-04 22:59">2020-08-04 22:59</time></a></p>
<p class="sourceline"><a class="sourcelink" href="/posts/pulling-oregon-covid-19-data/index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/pulling-oregon-covid-19-data/#org828cfb1">Beginning</a>
<ul>
<li><a href="/posts/pulling-oregon-covid-19-data/#org7d04b17">Set Up</a></li>
</ul>
</li>
<li><a href="/posts/pulling-oregon-covid-19-data/#org0005e5d">Middle</a>
<ul>
<li><a href="/posts/pulling-oregon-covid-19-data/#orgf60c5a9">Starting the Dates</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org828cfb1">
<h2 id="org828cfb1">Beginning</h2>
<div class="outline-text-2" id="text-org828cfb1">
<p>This is a look at pulling Oregon Covid-19 data from their weekly update PDFs. There are datasets for Oregon Covid-19 cases published by the <a href="https://govstatus.egov.com/OR-OHA-COVID-19">Oregon Health Authority</a> but for some reason I can't find the raw data sources matching what they have in their weekly reports so I thought maybe instead of just endlessly searching I'd pull them from the PDFs themselves.</p>
</div>
<div class="outline-3" id="outline-container-org7d04b17">
<h3 id="org7d04b17">Set Up</h3>
<div class="outline-text-3" id="text-org7d04b17"></div>
<div class="outline-4" id="outline-container-org5ccee4f">
<h4 id="org5ccee4f">Imports</h4>
<div class="outline-text-4" id="text-org5ccee4f">
<div class="highlight">
<pre><span></span><span class="c1"># python</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">calendar</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># pypi</span>
<span class="kn">from</span> <span class="nn">dateutil.relativedelta</span> <span class="kn">import</span> <span class="n">relativedelta</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>

<span class="kn">import</span> <span class="nn">requests</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org49c1b02">
<h4 id="org49c1b02">The Path</h4>
<div class="outline-text-4" id="text-org49c1b02">
<p>This is where I'm going to save the PDFs - to make it portable I usually keep the path in a file with <code>dotenv</code> loads as an environment variable. This wayif things get moved around I can edit the file to change the path but the code that uses it doesn't have to change.</p>
<div class="highlight">
<pre><span></span><span class="n">load_dotenv</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">"~/.local/share/env"</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">())</span>
<span class="n">FOLDER</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">"OREGON_COVID"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">FOLDER</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="n">FOLDER</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org0005e5d">
<h2 id="org0005e5d">Middle</h2>
<div class="outline-text-2" id="text-org0005e5d"></div>
<div class="outline-3" id="outline-container-orgf60c5a9">
<h3 id="orgf60c5a9">Starting the Dates</h3>
<div class="outline-text-3" id="text-orgf60c5a9">
<p>I could only find a link to the current PDF on their page (as of August 4, 2020). The URL embeds the date in it so to work backwards (and maybe later forwards) we need an easy way to set it. Here's what the URL looks like.</p>
<div class="highlight">
<pre><span></span><span class="n">EXAMPLE_URL</span> <span class="o">=</span> <span class="s2">"https://www.oregon.gov/oha/PH/DISEASESCONDITIONS/DISEASESAZ/Emerging%20Respitory%20Infections/COVID-19-Weekly-Report-2020-07-29-FINAL.pdf"</span>
</pre></div>
<p>So to work with it I'll find out what day of the week July 29, 2020 was (the date in the URL).</p>
<div class="highlight">
<pre><span></span><span class="n">START</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">29</span><span class="p">)</span>
<span class="n">WEEKDAY</span> <span class="o">=</span> <span class="n">START</span><span class="o">.</span><span class="n">weekday</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">WEEKDAY</span> <span class="o">==</span> <span class="n">calendar</span><span class="o">.</span><span class="n">WEDNESDAY</span>
<span class="k">print</span><span class="p">(</span><span class="n">WEEKDAY</span><span class="p">)</span>
</pre></div>
<pre class="example">
2
</pre>
<p>So, it looks like it came out on a Wednesday, which I'm going to assume is going to be the same every week. Now we can find the most recent Wednesday, which will be the start (or end, depending on how you look at it) of our date-ragen.</p>
<div class="highlight">
<pre><span></span><span class="n">TODAY</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
<span class="n">LAST</span> <span class="o">=</span> <span class="n">TODAY</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">weekday</span><span class="o">=</span><span class="n">WEEKDAY</span><span class="p">)</span> <span class="o">-</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">weeks</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
<span class="k">print</span><span class="p">(</span><span class="n">LAST</span><span class="p">)</span>
</pre></div>
<pre class="example">
2020-08-12
</pre>
<p>Now I'm going to work backwards one week at a time to create the URLS and file-names. Using the <code>relativedelta</code> makes it easy-peasey to get prior weeks from a given date. Here's the Wednesday before the most recent one.</p>
<div class="highlight">
<pre><span></span><span class="n">one_week</span> <span class="o">=</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">weeks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">LAST</span> <span class="o">-</span> <span class="n">one_week</span><span class="p">)</span>
</pre></div>
<pre class="example">
2020-08-05
</pre>
<p>Now, I don't actually know when these PDFs started so I'm just going to work backwards until I get an error message from my HTTP request and then stop.</p>
<div class="highlight">
<pre><span></span><span class="n">FILE_NAME</span> <span class="o">=</span> <span class="s2">"COVID-19-Weekly-Report-{}-FINAL.pdf"</span>
<span class="n">BASE_URL</span> <span class="o">=</span> <span class="s2">"https://www.oregon.gov/oha/PH/DISEASESCONDITIONS/DISEASESAZ/Emerging%20Respitory%20Infections/{}"</span>

<span class="k">for</span> <span class="n">week</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Checking back {week} weeks from this past Wednesday"</span><span class="p">)</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">LAST</span> <span class="o">-</span> <span class="p">(</span><span class="n">one_week</span> <span class="o">*</span> <span class="n">week</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">FILE_NAME</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
    <span class="n">output_path</span> <span class="o">=</span> <span class="n">FOLDER</span><span class="o">/</span><span class="n">filename</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">output_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">BASE_URL</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Bad week: {week}</span><span class="se">\t</span><span class="s2">Date: {date}"</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"Saving {filename}"</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">output_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">writer</span><span class="p">:</span>            
            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</pre></div>
<pre class="example">
Checking back 0 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-08-12-FINAL.pdf
Checking back 1 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-08-05-FINAL.pdf
Checking back 2 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-07-29-FINAL.pdf
Checking back 3 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-07-22-FINAL.pdf
Checking back 4 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-07-15-FINAL.pdf
Checking back 5 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-07-08-FINAL.pdf
Checking back 6 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-07-01-FINAL.pdf
Checking back 7 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-06-24-FINAL.pdf
Checking back 8 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-06-17-FINAL.pdf
Checking back 9 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-06-10-FINAL.pdf
Checking back 10 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-06-03-FINAL.pdf
Checking back 11 weeks from this past Wednesday
Saving COVID-19-Weekly-Report-2020-05-27-FINAL.pdf
Checking back 12 weeks from this past Wednesday
Bad week: 12    Date: 2020-05-20
</pre>
<p>So, there are eleven weeks of PDFs going back to May 27, 2020. Which seems a little short, given that Oregon started telling people to stay home in March, but maybe they have the data somewhere else. Anyway, next up is pulling the data from the PDFs from the files using <a href="https://tabula-py.readthedocs.io/en/latest/tabula.html">tabula-py</a>.</p>
</div>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="/categories/covid-19/" rel="tag">covid-19</a></li>
<li><a class="tag p-category" href="/categories/data/" rel="tag">data</a></li>
<li><a class="tag p-category" href="/categories/oregon/" rel="tag">oregon</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="/posts/tutorials/data-leakage/" rel="prev" title="Data Leakage">Previous post</a></li>
<li class="next"><a href="/posts/introductory-statistics-with-randomization-and-simulation/" rel="next" title="Introductory Statistics with Randomization and Simulation">Next post</a></li>
</ul>
</nav>
</aside>
</article>
<!--End of body content-->
<footer id="footer">Contents Â© 2020 <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="/assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
</script> 
</body>
</html>
