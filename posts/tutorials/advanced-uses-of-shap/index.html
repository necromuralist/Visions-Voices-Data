<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Using SHAP beyond single rows." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Advanced Uses Of SHAP | Visions, Voices, Data</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../../rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Visions-Voices-Data/posts/tutorials/advanced-uses-of-shap/" rel="canonical"><!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]-->
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript"></script><!--
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.min.js"
</script>
-->
<script async src="../../../assets/javascript/p5.min.js" type="text/javascript"></script>
<meta content="Cloistered Monkey" name="author">
<link href="/posts/tutorials/shap-values-exercise/" rel="prev" title="SHAP Values Exercise" type="text/html">
<link href="/posts/tutorials/advanced-uses-of-shap-exercise/" rel="next" title="Advanced Uses Of SHAP Exercise" type="text/html">
<meta content="Visions, Voices, Data" property="og:site_name">
<meta content="Advanced Uses Of SHAP" property="og:title">
<meta content="https://necromuralist.github.io/Visions-Voices-Data/posts/tutorials/advanced-uses-of-shap/" property="og:url">
<meta content="Using SHAP beyond single rows." property="og:description">
<meta content="article" property="og:type">
<meta content="2020-02-14T16:09:16-08:00" property="article:published_time">
<meta content="machine learning" property="article:tag">
<meta content="shap" property="article:tag">
<meta content="tutorial" property="article:tag">
<meta content="visualization" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="/"><span id="blog-title">Visions, Voices, Data</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="/archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="/categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="/rss.xml">RSS feed</a></li>
<li class="nav-item dropdown"><a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Pages</a>
<div class="dropdown-menu"><a class="dropdown-item" href="https://necromuralist.github.io/">Cloistered Monkey</a> <a class="dropdown-item" href="/pages/giss/giss-yearly-anomalies-by-climate-zone">GISS Anomalies</a></div>
</li>
</ul>
<!-- DuckDuckGo custom search -->
<form action="https://duckduckgo.com/" class="navbar-form pull-left" id="search" method="get" name="search"><input name="sites" type="hidden" value="https://necromuralist.github.io/Visions-Voices-Data/"> <input name="k8" type="hidden" value="#444444"> <input name="k9" type="hidden" value="#D51920"> <input name="kt" type="hidden" value="h"> <input class="span2" maxlength="255" name="q" placeholder="Search…" type="text"> <input style="visibility: hidden;display:none" type="submit" value="DuckDuckGo Search"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="/posts/tutorials/advanced-uses-of-shap/index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href="/posts/tutorials/advanced-uses-of-shap/">Advanced Uses Of SHAP</a></h1>
<div class="metadata">
<p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/advanced-uses-of-shap/" rel="bookmark"><time class="published dt-published" datetime="2020-02-14T16:09:16-08:00" itemprop="datePublished" title="2020-02-14 16:09">2020-02-14 16:09</time></a></p>
<p class="sourceline"><a class="sourcelink" href="/posts/tutorials/advanced-uses-of-shap/index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#orgb5c3d1d">Beginning</a>
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org23d2d19">Imports</a>
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org688417a">Python</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org9787684">PyPi</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#orgf6fde8a">Others</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org62584fd">Set Up</a>
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org29d8c69">Plotting</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org53bbabe">The Environment</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#orgc875836">The Dataset</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#orgb78c8d6">Middle</a>
<ul>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#orgc9d74ea">Setup the SHAP Values</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#org016efd3">Summary Plots</a></li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#orgbd3d6e1">SHAP Dependence Contribution Plots</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/advanced-uses-of-shap/#orgad17136">End</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgb5c3d1d">
<h2 id="orgb5c3d1d">Beginning</h2>
<div class="outline-text-2" id="text-orgb5c3d1d">
<p>This is a re-do of the Kaggle tutorial on <a href="https://www.kaggle.com/dansbecker/advanced-uses-of-shap-values">Advanced Uses of SHAP Values</a>. SHAP values let us see how much a given feature changed our prediction for a given row of data, but it can also be used to look at groups of features to get a bigger picture look at our model.</p>
</div>
<div class="outline-3" id="outline-container-org23d2d19">
<h3 id="org23d2d19">Imports</h3>
<div class="outline-text-3" id="text-org23d2d19"></div>
<div class="outline-4" id="outline-container-org688417a">
<h4 id="org688417a">Python</h4>
<div class="outline-text-4" id="text-org688417a">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org9787684">
<h4 id="org9787684">PyPi</h4>
<div class="outline-text-4" id="text-org9787684">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">seaborn</span>
<span class="kn">import</span> <span class="nn">shap</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgf6fde8a">
<h4 id="orgf6fde8a">Others</h4>
<div class="outline-text-4" id="text-orgf6fde8a">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EnvironmentLoader</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org62584fd">
<h3 id="org62584fd">Set Up</h3>
<div class="outline-text-3" id="text-org62584fd"></div>
<div class="outline-4" id="outline-container-org29d8c69">
<h4 id="org29d8c69">Plotting</h4>
<div class="outline-text-4" id="text-org29d8c69">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"advanced-uses-of-shap"</span>
<span class="n">OUTPUT_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"../../files/posts/tutorials"</span><span class="p">)</span><span class="o">/</span><span class="n">SLUG</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>

<span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'matplotlib'</span><span class="p">,</span> <span class="s1">'inline'</span><span class="p">)</span>
<span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">'config'</span><span class="p">,</span> <span class="s2">"InlineBackend.figure_format = 'retina'"</span><span class="p">)</span>
<span class="n">FIGURE_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s2">"whitegrid"</span><span class="p">,</span>
            <span class="n">rc</span><span class="o">=</span><span class="p">{</span><span class="s2">"axes.grid"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                <span class="s2">"font.family"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"sans-serif"</span><span class="p">],</span>
                <span class="s2">"font.sans-serif"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"Open Sans"</span><span class="p">,</span> <span class="s2">"Latin Modern Sans"</span><span class="p">,</span> <span class="s2">"Lato"</span><span class="p">],</span>
                <span class="s2">"font.size"</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
                <span class="s2">"figure.figsize"</span><span class="p">:</span> <span class="n">FIGURE_SIZE</span><span class="p">},</span>
            <span class="n">font_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org53bbabe">
<h4 id="org53bbabe">The Environment</h4>
<div class="outline-text-4" id="text-org53bbabe">
<div class="highlight">
<pre><span></span><span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="n">EnvironmentLoader</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgc875836">
<h4 id="orgc875836">The Dataset</h4>
<div class="outline-text-4" id="text-orgc875836">
<div class="highlight">
<pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ENVIRONMENT</span><span class="p">[</span><span class="s2">"FIFA-2018"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">"Man of the Match"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"Yes"</span>

<span class="n">FEATURES</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">]</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">FEATURES</span><span class="p">]</span>
<span class="n">x_train</span><span class="p">,</span> <span class="n">x_validation</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_validation</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgb78c8d6">
<h2 id="orgb78c8d6">Middle</h2>
<div class="outline-text-2" id="text-orgb78c8d6"></div>
<div class="outline-3" id="outline-container-orgc9d74ea">
<h3 id="orgc9d74ea">Setup the SHAP Values</h3>
<div class="outline-text-3" id="text-orgc9d74ea">
<div class="highlight">
<pre><span></span><span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">x_validation</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-3" id="outline-container-org016efd3">
<h3 id="org016efd3">Summary Plots</h3>
<div class="outline-text-3" id="text-org016efd3">
<p>Like Permutation Importance, SHAP Summary Plots show you the relative importance of different features for your model, but unlike Permutation Importance, Summary Plots can show you how much more each feature influences the predictions.</p>
<div class="highlight">
<pre><span></span><span class="n">MAN_OF_THE_MATCH</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">shap</span><span class="o">.</span><span class="n">summary_plot</span><span class="p">(</span><span class="n">shap_values</span><span class="p">[</span><span class="n">MAN_OF_THE_MATCH</span><span class="p">],</span> <span class="n">x_validation</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
<span class="c1"># figure.set_size_inches(FIGURE_SIZE)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"shap_summary.png"</span>
<span class="n">figure</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{output}]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_summary.png" src="/posts/tutorials/advanced-uses-of-shap/shap_summary.png"></p>
</div>
<p>As with permutation importance, Goal Scored was the most important feature, with a greater impact on not being the man of the match than being the man of the match. This looks sort of like a combination of Permutation importance and Partial Dependence Plots (PDP) except all in one place.</p>
</div>
</div>
<div class="outline-3" id="outline-container-orgbd3d6e1">
<h3 id="orgbd3d6e1">SHAP Dependence Contribution Plots</h3>
<div class="outline-text-3" id="text-orgbd3d6e1">
<p>Dependence Contribution Plots work much like PDP plots except with more detail. Rather than showing you the means the Dependence Contribution Plot shows you the individual rows so you can get a sense of the shape of the outcomes.</p>
<div class="highlight">
<pre><span></span><span class="n">figure</span><span class="p">,</span> <span class="n">axe</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">FIGURE_SIZE</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="s2">"ball_possession_dcp.png"</span>
<span class="n">shap</span><span class="o">.</span><span class="n">dependence_plot</span><span class="p">(</span><span class="s2">"Ball Possession %"</span><span class="p">,</span> <span class="n">shap_values</span><span class="p">[</span><span class="n">MAN_OF_THE_MATCH</span><span class="p">],</span> <span class="n">x_validation</span><span class="p">,</span>
                     <span class="n">interaction_index</span><span class="o">=</span><span class="s2">"Goal Scored"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axe</span><span class="p">)</span>
<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s2">"[[file:{output}]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="ball_possession_dcp.png" src="/posts/tutorials/advanced-uses-of-shap/ball_possession_dcp.png"></p>
</div>
<p>Interestingly, our plot doesn't look like the one in the tutorial, we appear to have much fewer points and less spread in the values. But, anyway, the way to interpret this is as you move from left to right you are increasing the percentage of the time that a team had the ball, and as you move up, you are increasing the likelihood that the team had a man of the match. Additionally, the colors tell you how many goals the team scored.</p>
<p>Looking closer, it looks like the tutorial went with the entire dataset rather than just the validation set, probably because there are so few data points. While that does reveal a more interesting pattern, I'm not sure that that's what you would do, normally.</p>
<p>Anyway, this plot shows that having a very low ball possession percentage decreases the likelihood that you would have the man of the match and generally speaking as it goes up, so does the likelihood of having man of the match, although it seems to level off around 45%.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgad17136">
<h2 id="orgad17136">End</h2>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="/categories/machine-learning/" rel="tag">machine learning</a></li>
<li><a class="tag p-category" href="/categories/shap/" rel="tag">shap</a></li>
<li><a class="tag p-category" href="/categories/tutorial/" rel="tag">tutorial</a></li>
<li><a class="tag p-category" href="/categories/visualization/" rel="tag">visualization</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="/posts/tutorials/shap-values-exercise/" rel="prev" title="SHAP Values Exercise">Previous post</a></li>
<li class="next"><a href="/posts/tutorials/advanced-uses-of-shap-exercise/" rel="next" title="Advanced Uses Of SHAP Exercise">Next post</a></li>
</ul>
</nav>
</aside>
</article>
<!--End of body content-->
<footer id="footer">Contents © 2020 <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="/assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
</script> 
</body>
</html>
