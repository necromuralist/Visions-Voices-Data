<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="SHapley Additive exPlanations" name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>SHAP Values | Visions, Voices, Data</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../../rss.xml" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Visions-Voices-Data/posts/tutorials/shap-values/" rel="canonical"><!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]-->
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript"></script><!--
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.min.js"
</script>
-->
<script async src="../../../assets/javascript/p5.min.js" type="text/javascript"></script>
<meta content="Cloistered Monkey" name="author">
<link href="/posts/tutorials/exercise-in-partial-dependence-plots/" rel="prev" title="Exercise In Partial Dependence Plots" type="text/html">
<link href="/posts/tutorials/shap-values-exercise/" rel="next" title="SHAP Values Exercise" type="text/html">
<meta content="Visions, Voices, Data" property="og:site_name">
<meta content="SHAP Values" property="og:title">
<meta content="https://necromuralist.github.io/Visions-Voices-Data/posts/tutorials/shap-values/" property="og:url">
<meta content="SHapley Additive exPlanations" property="og:description">
<meta content="article" property="og:type">
<meta content="2020-02-09T17:07:12-08:00" property="article:published_time">
<meta content="interpret" property="article:tag">
<meta content="machine learning" property="article:tag">
<meta content="tutorial" property="article:tag">
<meta content="visualization" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="https://necromuralist.github.io/Visions-Voices-Data/"><span id="blog-title">Visions, Voices, Data</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="/archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="/categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="/rss.xml">RSS feed</a></li>
<li class="nav-item dropdown"><a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Pages</a>
<div class="dropdown-menu"><a class="dropdown-item" href="https://necromuralist.github.io/">Cloistered Monkey</a> <a class="dropdown-item" href="/pages/giss/giss-yearly-anomalies-by-climate-zone">GISS Anomalies</a></div>
</li>
</ul>
<!-- DuckDuckGo custom search -->
<form action="https://duckduckgo.com/" class="navbar-form pull-left" id="search" method="get" name="search"><input name="sites" type="hidden" value="https://necromuralist.github.io/Visions-Voices-Data/"> <input name="k8" type="hidden" value="#444444"> <input name="k9" type="hidden" value="#D51920"> <input name="kt" type="hidden" value="h"> <input class="span2" maxlength="255" name="q" placeholder="Search…" type="text"> <input style="visibility: hidden;display:none" type="submit" value="DuckDuckGo Search"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="/posts/tutorials/shap-values/index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href="/posts/tutorials/shap-values/">SHAP Values</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/shap-values/" rel="bookmark"><time class="published dt-published" datetime="2020-02-09T17:07:12-08:00" itemprop="datePublished" title="2020-02-09 17:07">2020-02-09 17:07</time></a></p>
<p class="sourceline"><a class="sourcelink" href="/posts/tutorials/shap-values/index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/shap-values/#orgbf5a1db">Beginning</a>
<ul>
<li><a href="/posts/tutorials/shap-values/#org9adb6bf">Imports</a>
<ul>
<li><a href="/posts/tutorials/shap-values/#org9abe452">Python</a></li>
<li><a href="/posts/tutorials/shap-values/#org0274dc8">PyPi</a></li>
<li><a href="/posts/tutorials/shap-values/#org5b8ff1f">Others</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values/#org6af839f">Set Up</a>
<ul>
<li><a href="/posts/tutorials/shap-values/#orgd8f1bdf">Plotting</a></li>
<li><a href="/posts/tutorials/shap-values/#org05eea2d">The Timer</a></li>
<li><a href="/posts/tutorials/shap-values/#orgf5d86bd">Environment</a></li>
<li><a href="/posts/tutorials/shap-values/#org0eb96ed">The Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values/#org04517dd">Middle</a>
<ul>
<li><a href="/posts/tutorials/shap-values/#org51a0223">A Single Row</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values/#org00492b4">End</a>
<ul>
<li><a href="/posts/tutorials/shap-values/#orgb02e110">See Also</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgbf5a1db">
<h2 id="orgbf5a1db">Beginning</h2>
<div class="outline-text-2" id="text-orgbf5a1db">
<p>SHAP values interpret the impact of a certain value for a given feature when compared to the prediction you'd make if that feature instead took a baseline value. This helps us interpret predictions given specific values for our features. We'll do this using the <a href="https://github.com/slundberg/shap">SHAP</a> library, naturally.</p>
</div>
<div class="outline-3" id="outline-container-org9adb6bf">
<h3 id="org9adb6bf">Imports</h3>
<div class="outline-text-3" id="text-org9adb6bf"></div>
<div class="outline-4" id="outline-container-org9abe452">
<h4 id="org9abe452">Python</h4>
<div class="outline-text-4" id="text-org9abe452">
<div class="highlight">
<pre><span></span>from argparse import Namespace
from pathlib import Path
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org0274dc8">
<h4 id="org0274dc8">PyPi</h4>
<div class="outline-text-4" id="text-org0274dc8">
<div class="highlight">
<pre><span></span>from matplotlib import pyplot
from sklearn.model_selection import train_test_split, RandomizedSearchCV
from sklearn.ensemble import RandomForestClassifier

import numpy
import pandas
import seaborn
import shap
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org5b8ff1f">
<h4 id="org5b8ff1f">Others</h4>
<div class="outline-text-4" id="text-org5b8ff1f">
<div class="highlight">
<pre><span></span>from graeae import EnvironmentLoader, Timer
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org6af839f">
<h3 id="org6af839f">Set Up</h3>
<div class="outline-text-3" id="text-org6af839f"></div>
<div class="outline-4" id="outline-container-orgd8f1bdf">
<h4 id="orgd8f1bdf">Plotting</h4>
<div class="outline-text-4" id="text-orgd8f1bdf">
<div class="highlight">
<pre><span></span>SLUG = "shap-values"
OUTPUT_PATH = Path("../../files/posts/tutorials/")/SLUG
</pre></div>
<div class="highlight">
<pre><span></span>get_ipython().run_line_magic('matplotlib', 'inline')
get_ipython().run_line_magic('config', "InlineBackend.figure_format = 'retina'")
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org05eea2d">
<h4 id="org05eea2d">The Timer</h4>
<div class="outline-text-4" id="text-org05eea2d">
<div class="highlight">
<pre><span></span>TIMER = Timer()
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgf5d86bd">
<h4 id="orgf5d86bd">Environment</h4>
<div class="outline-text-4" id="text-orgf5d86bd">
<div class="highlight">
<pre><span></span>ENVIRONMENT = EnvironmentLoader()
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org0eb96ed">
<h4 id="org0eb96ed">The Data</h4>
<div class="outline-text-4" id="text-org0eb96ed">
<div class="highlight">
<pre><span></span>data = pandas.read_csv(Path(ENVIRONMENT["FIFA-2018"]).expanduser())
y = data["Man of the Match"] == "Yes"
FEATURES = [column for column in data.columns if data[column].dtype == numpy.int64]
X = data[FEATURES]
x_train, x_validate, y_train, y_validate = train_test_split(X, y, random_state=1)


model = RandomForestClassifier()

estimators = list(range(50, 200, 10))
max_depth = list(range(10, 100, 10)) + [None]

grid = dict(n_estimators=estimators,
            max_depth=max_depth)
search = RandomizedSearchCV(estimator=model,
                            param_distributions=grid,
                            n_iter=40,
                            n_jobs=-1,
                            random_state=1)
with TIMER:
    search.fit(x_train, y_train)
first_model = search.best_estimator_
print(f"CV Training R^2: {search.best_score_:0.2f}")
print(f"Training R^2: {first_model.score(x_train, y_train): 0.2f}")
print(f"Validation R^2: {first_model.score(x_validate, y_validate):0.2f}")
print(search.best_params_)
</pre></div>
<pre class="example">
2020-02-10 18:09:33,716 graeae.timers.timer start: Started: 2020-02-10 18:09:33.716565
The default value of cv will change from 3 to 5 in version 0.22. Specify it explicitly to silence this warning.
2020-02-10 18:09:36,830 graeae.timers.timer end: Ended: 2020-02-10 18:09:36.830883
2020-02-10 18:09:36,832 graeae.timers.timer end: Elapsed: 0:00:03.114318
CV Training R^2: 0.70
Training R^2:  1.00
Validation R^2: 0.69
{'n_estimators': 100, 'max_depth': 30}
</pre></div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org04517dd">
<h2 id="org04517dd">Middle</h2>
<div class="outline-text-2" id="text-org04517dd"></div>
<div class="outline-3" id="outline-container-org51a0223">
<h3 id="org51a0223">A Single Row</h3>
<div class="outline-text-3" id="text-org51a0223">
<div class="highlight">
<pre><span></span>ROW = 5
row_data = x_validate.iloc[ROW]
row_data_matrix = row_data.values.reshape(1, -1)
print(first_model.classes_)
print(first_model.predict_proba(row_data_matrix))
</pre></div>
<pre class="example">
[False  True]
[[0.25 0.75]]
</pre>
<p>The <a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestClassifier.html#sklearn.ensemble.RandomForestClassifier.predict_proba"><code>predict_proba</code></a> method tells us the probability for the data for each class. So this team has a 70% chance that they do have a man of the match.</p>
<div class="highlight">
<pre><span></span>explainer = shap.TreeExplainer(first_model)
shap_values = explainer.shap_values(row_data_matrix)
</pre></div>
<div class="highlight">
<pre><span></span>print(explainer.shap_values.__doc__)
</pre></div>
<pre class="example">
Estimate the SHAP values for a set of samples.

       Parameters
       ----------
       X : numpy.array, pandas.DataFrame or catboost.Pool (for catboost)
           A matrix of samples (# samples x # features) on which to explain the model's output.

       y : numpy.array
           An array of label values for each sample. Used when explaining loss functions.

       tree_limit : None (default) or int
           Limit the number of trees used by the model. By default None means no use the limit of the
           original model, and -1 means no limit.

       approximate : bool
           Run fast, but only roughly approximate the Tree SHAP values. This runs a method
           previously proposed by Saabas which only considers a single feature ordering. Take care
           since this does not have the consistency guarantees of Shapley values and places too
           much weight on lower splits in the tree.

       check_additivity : bool
           Run a validation check that the sum of the SHAP values equals the output of the model. This
           check takes only a small amount of time, and will catch potential unforeseen errors.
           Note that this check only runs right now when explaining the margin of the model.

       Returns
       -------
       For models with a single output this returns a matrix of SHAP values
       (# samples x # features). Each row sums to the difference between the model output for that
       sample and the expected value of the model output (which is stored in the expected_value
       attribute of the explainer when it is constant). For models with vector outputs this returns
       a list of such matrices, one for each output.

</pre>
<p>The array returned by the <code>shap_values</code> method has two rows - one for each of our target classes. In this case we're asking if a team had a man of the match so we'll just look at the second array.</p>
<div class="highlight">
<pre><span></span>shap.initjs()
figure = shap.force_plot(explainer.expected_value[1],
                         shap_values[1],
                         row_data_matrix,
                         feature_names=FEATURES,
                         matplotlib=True, show=False)
filename = "shap_one.png"

figure.savefig(OUTPUT_PATH/filename)
print(f"[[file:{filename}]]")
</pre></div>
<div class="figure">
<p><img alt="shap_one.png" src="/posts/tutorials/shap-values/shap_one.png"></p>
</div>
<p>Our predicted probability that this team had a man of the match was 0.7, but the base-value for the set as a whole is 0.4979 (you can't see it in this plot for some reason), so our team is more likely to have one than most teams. The pink section of the plot shows the features that increased the probability and the part in blue shows the features that decreased the probability. The size of each feature's block is proportional to the amount the feature contributed, so the biggest block (<i>Goal Scored</i>) contributed the most. The greatest negative feature was <i>Ball Possession %</i>.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org00492b4">
<h2 id="org00492b4">End</h2>
<div class="outline-text-2" id="text-org00492b4"></div>
<div class="outline-3" id="outline-container-orgb02e110">
<h3 id="orgb02e110">See Also</h3>
<div class="outline-text-3" id="text-orgb02e110">
<ul class="org-ul">
<li>The <a href="https://shap.readthedocs.io/en/latest/">SHAP</a> Documentation</li>
<li>The <a href="https://github.com/slundberg/shap">SHAP github repository</a></li>
<li>Lundberg SM, Lee SI. A unified approach to interpreting model predictions. InAdvances in neural information processing systems 2017 (pp. 4765-4774). (<a href="https://papers.nips.cc/paper/7062-a-unified-approach-to-interpreting-model-predicti">PDF Available Here</a>)</li>
</ul>
</div>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="/categories/interpret/" rel="tag">interpret</a></li>
<li><a class="tag p-category" href="/categories/machine-learning/" rel="tag">machine learning</a></li>
<li><a class="tag p-category" href="/categories/tutorial/" rel="tag">tutorial</a></li>
<li><a class="tag p-category" href="/categories/visualization/" rel="tag">visualization</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="/posts/tutorials/exercise-in-partial-dependence-plots/" rel="prev" title="Exercise In Partial Dependence Plots">Previous post</a></li>
<li class="next"><a href="/posts/tutorials/shap-values-exercise/" rel="next" title="SHAP Values Exercise">Next post</a></li>
</ul>
</nav>
</aside>
</article>
<!--End of body content-->
<footer id="footer">Contents © 2020 <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="/assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
</script> 
</body>
</html>
