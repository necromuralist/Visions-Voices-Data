<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>SHAP Values Exercise | Visions, Voices, Data</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../../rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Visions-Voices-Data/posts/tutorials/shap-values-exercise/" rel="canonical"><!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]-->
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript"></script><!--
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.min.js"
</script>
-->
<script async src="../../../assets/javascript/p5.min.js" type="text/javascript"></script>
<meta content="Cloistered Monkey" name="author">
<link href="/posts/tutorials/shap-values/" rel="prev" title="SHAP Values" type="text/html">
<link href="/posts/tutorials/advanced-uses-of-shap/" rel="next" title="Advanced Uses Of SHAP" type="text/html">
<meta content="Visions, Voices, Data" property="og:site_name">
<meta content="SHAP Values Exercise" property="og:title">
<meta content="https://necromuralist.github.io/Visions-Voices-Data/posts/tutorials/shap-values-exercise/" property="og:url">
<meta content="Table of Contents Beginning The Scenario Imports Python PyPi Others Set Up Plotting The Table Printer The Timer The Environment The Data Middle Looking At the Data Set Up X and Y Split th" property="og:description">
<meta content="article" property="og:type">
<meta content="2020-02-11T07:06:57-08:00" property="article:published_time">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="/"><span id="blog-title">Visions, Voices, Data</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="/archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="/categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="/rss.xml">RSS feed</a></li>
<li class="nav-item dropdown"><a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Monkey Pages</a>
<div class="dropdown-menu"><a class="dropdown-item" href="https://necromuralist.github.io/">Cloistered Monkey</a> <a class="dropdown-item" href="https://necromuralist.github.io/Ape-Iron/">Ape Iron</a> <a class="dropdown-item" href="https://necromuralist.github.io/Beach-Pig-Thigh/">Beach Pig Rump & Thigh</a> <a class="dropdown-item" href="https://necromuralist.github.io/Bowling-For-Data/">Bowling For Data</a> <a class="dropdown-item" href="https://necromuralist.github.io/Give-The-Fish/">Give the Fish</a> <a class="dropdown-item" href="https://necromuralist.github.io/Neurotic-Networking/">Neurotic Networking</a> <a class="dropdown-item" href="https://necromuralist.github.io/Terribilis-Ludum/">Terribilis Ludum</a> <a class="dropdown-item" href="https://necromuralist.github.io/Visions-Voices-Data/">Visions, Voices, Data</a></div>
</li>
</ul>
<!-- DuckDuckGo custom search -->
<form action="https://duckduckgo.com/" class="navbar-form pull-left" id="search" method="get" name="search"><input name="sites" type="hidden" value="https://necromuralist.github.io/Visions-Voices-Data/"> <input name="k8" type="hidden" value="#444444"> <input name="k9" type="hidden" value="#D51920"> <input name="kt" type="hidden" value="h"> <input class="span2" maxlength="255" name="q" placeholder="Search…" type="text"> <input style="visibility: hidden;display:none" type="submit" value="DuckDuckGo Search"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="/posts/tutorials/shap-values-exercise/index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href="/posts/tutorials/shap-values-exercise/">SHAP Values Exercise</a></h1>
<div class="metadata">
<p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/tutorials/shap-values-exercise/" rel="bookmark"><time class="published dt-published" datetime="2020-02-11T07:06:57-08:00" itemprop="datePublished" title="2020-02-11 07:06">2020-02-11 07:06</time></a></p>
<p class="sourceline"><a class="sourcelink" href="/posts/tutorials/shap-values-exercise/index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#org9999f3c">Beginning</a>
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#org6809939">The Scenario</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org2ab4f95">Imports</a>
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#orge5316c7">Python</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org3eb2ec8">PyPi</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#orga64b42f">Others</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values-exercise/#orgcf5acaa">Set Up</a>
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#orgc342ef9">Plotting</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org01ee37f">The Table Printer</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org7233d57">The Timer</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org514f07f">The Environment</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#orgad31134">The Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values-exercise/#orgec59811">Middle</a>
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#orgbd340ab">Looking At the Data</a>
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#org71798df">Set Up X and Y</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#orga660ff1">Split the Data</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values-exercise/#org0c33cdc">A Simple Model</a>
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#orgf3612c4">Train the Model</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org9cd9197">Permutation Importance</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#orge10a3ee">Partial Dependence Plot</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org4d2f821">SHAP Values</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#orgbff7bd1">Time In Hospital</a></li>
<li><a href="/posts/tutorials/shap-values-exercise/#org9ccd682">Raw Readmissions</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values-exercise/#orgd6ec881">SHAP Creator</a></li>
</ul>
</li>
<li><a href="/posts/tutorials/shap-values-exercise/#org994a6cc">End</a>
<ul>
<li><a href="/posts/tutorials/shap-values-exercise/#org08559bf">Sources</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org9999f3c">
<h2 id="org9999f3c">Beginning</h2>
<div class="outline-text-2" id="text-org9999f3c">
<p>This is the SHAP Exercise from the kaggle <a href="https://www.kaggle.com/learn/machine-learning-explainability">Machine Learing Explainability Tutorial</a>. It's using the kaggle <a href="https://www.kaggle.com/dansbecker/hospital-readmissions">Hospital Readmissions</a> dataset (I think).</p>
</div>
<div class="outline-3" id="outline-container-org6809939">
<h3 id="org6809939">The Scenario</h3>
<div class="outline-text-3" id="text-org6809939">
<blockquote>
<p>A hospital has struggled with "readmissions," where they release a patient before the patient has recovered enough, and the patient returns with health complications.</p>
<p>The hospital wants your help identifying patients at highest risk of being readmitted. Doctors (rather than your model) will make the final decision about when to release each patient; but they hope your model will highlight issues the doctors should consider when releasing a patient.</p>
<p>The hospital has given you relevant patient medical information.</p>
</blockquote>
</div>
</div>
<div class="outline-3" id="outline-container-org2ab4f95">
<h3 id="org2ab4f95">Imports</h3>
<div class="outline-text-3" id="text-org2ab4f95"></div>
<div class="outline-4" id="outline-container-orge5316c7">
<h4 id="orge5316c7">Python</h4>
<div class="outline-text-4" id="text-orge5316c7">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">argparse</span> <span class="kn">import</span> <span class="n">Namespace</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">random</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org3eb2ec8">
<h4 id="org3eb2ec8">PyPi</h4>
<div class="outline-text-4" id="text-org3eb2ec8">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">eli5.sklearn</span> <span class="kn">import</span> <span class="n">PermutationImportance</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span>
<span class="kn">from</span> <span class="nn">pdpbox</span> <span class="kn">import</span> <span class="n">pdp</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">RandomizedSearchCV</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="kn">import</span> <span class="nn">eli5</span>
<span class="kn">import</span> <span class="nn">hvplot.pandas</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">shap</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orga64b42f">
<h4 id="orga64b42f">Others</h4>
<div class="outline-text-4" id="text-orga64b42f">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">graeae</span> <span class="kn">import</span> <span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">EnvironmentLoader</span><span class="p">,</span> <span class="n">Timer</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgcf5acaa">
<h3 id="orgcf5acaa">Set Up</h3>
<div class="outline-text-3" id="text-orgcf5acaa"></div>
<div class="outline-4" id="outline-container-orgc342ef9">
<h4 id="orgc342ef9">Plotting</h4>
<div class="outline-text-4" id="text-orgc342ef9">
<div class="highlight">
<pre><span></span><span class="n">SLUG</span> <span class="o">=</span> <span class="s2">"shap-values-exercise"</span>
<span class="n">OUTPUT_PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">"../../files/posts/tutorials/"</span><span class="p">)</span><span class="o">/</span><span class="n">SLUG</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
    <span class="n">OUTPUT_PATH</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>

<span class="n">Plot</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span>
    <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">Embed</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">EmbedHoloviews</span><span class="p">,</span> <span class="n">folder_path</span><span class="o">=</span><span class="n">OUTPUT_PATH</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org01ee37f">
<h4 id="org01ee37f">The Table Printer</h4>
<div class="outline-text-4" id="text-org01ee37f">
<div class="highlight">
<pre><span></span><span class="n">TABLE</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">tabulate</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="s2">"orgtbl"</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="s2">"keys"</span><span class="p">,</span> <span class="n">showindex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org7233d57">
<h4 id="org7233d57">The Timer</h4>
<div class="outline-text-4" id="text-org7233d57">
<div class="highlight">
<pre><span></span><span class="n">TIMER</span> <span class="o">=</span> <span class="n">Timer</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-org514f07f">
<h4 id="org514f07f">The Environment</h4>
<div class="outline-text-4" id="text-org514f07f">
<div class="highlight">
<pre><span></span><span class="n">ENVIRONMENT</span> <span class="o">=</span> <span class="n">EnvironmentLoader</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgad31134">
<h4 id="orgad31134">The Data</h4>
<div class="outline-text-4" id="text-orgad31134">
<div class="highlight">
<pre><span></span><span class="n">PATH</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ENVIRONMENT</span><span class="p">[</span><span class="s2">"HOSPITAL-READMISSIONS"</span><span class="p">])</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">PATH</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">PATH</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orgec59811">
<h2 id="orgec59811">Middle</h2>
<div class="outline-text-2" id="text-orgec59811"></div>
<div class="outline-3" id="outline-container-orgbd340ab">
<h3 id="orgbd340ab">Looking At the Data</h3>
<div class="outline-text-3" id="text-orgbd340ab">
<div class="highlight">
<pre><span></span><span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">" - </span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<ul class="org-ul">
<li>A1Cresult_None</li>
<li>acarbose_No</li>
<li>acetohexamide_No</li>
<li>age_[40-50)</li>
<li>age_[50-60)</li>
<li>age_[60-70)</li>
<li>age_[70-80)</li>
<li>age_[80-90)</li>
<li>change_No</li>
<li>chlorpropamide_No</li>
<li>citoglipton_No</li>
<li>diabetesMed_Yes</li>
<li>diag_1_414</li>
<li>diag_1_428</li>
<li>diag_1_786</li>
<li>diag_2_250</li>
<li>diag_2_276</li>
<li>diag_2_427</li>
<li>diag_2_428</li>
<li>diag_3_250</li>
<li>diag_3_276</li>
<li>diag_3_401</li>
<li>diag_3_428</li>
<li>examide_No</li>
<li>gender_Female</li>
<li>glimepiride-pioglitazone_No</li>
<li>glimepiride_No</li>
<li>glipizide-metformin_No</li>
<li>glipizide_No</li>
<li>glyburide-metformin_No</li>
<li>glyburide_No</li>
<li>insulin_No</li>
<li>max_glu_serum_None</li>
<li>medical_specialty_?</li>
<li>medical_specialty_Cardiology</li>
<li>medical_specialty_Emergency/Trauma</li>
<li>medical_specialty_Family/GeneralPractice</li>
<li>medical_specialty_InternalMedicine</li>
<li>metformin-pioglitazone_No</li>
<li>metformin-rosiglitazone_No</li>
<li>metformin_No</li>
<li>miglitol_No</li>
<li>nateglinide_No</li>
<li>num_lab_procedures</li>
<li>num_medications</li>
<li>num_procedures</li>
<li>number_diagnoses</li>
<li>number_emergency</li>
<li>number_inpatient</li>
<li>number_outpatient</li>
<li>payer_code_?</li>
<li>payer_code_BC</li>
<li>payer_code_HM</li>
<li>payer_code_MC</li>
<li>payer_code_SP</li>
<li>pioglitazone_No</li>
<li>race_AfricanAmerican</li>
<li>race_Caucasian</li>
<li>readmitted</li>
<li>repaglinide_No</li>
<li>rosiglitazone_No</li>
<li>time_in_hospital</li>
<li>tolazamide_No</li>
<li>tolbutamide_No</li>
<li>troglitazone_No</li>
</ul>
<p>So there are a lot of columns.</p>
<blockquote>
<p>Here are some quick hints at interpreting the field names:</p>
<ul class="org-ul">
<li>Your prediction target is <code>readmitted</code></li>
<li>Columns with the word <code>diag</code> indicate the diagnostic code of the illness or illnesses the patient was admitted with. For example, <code>diag_1_428</code> means the doctor said their first illness diagnosis is number "428". What illness does 428 correspond to? You could look it up in a codebook, but without more medical background it wouldn't mean anything to you anyway.</li>
<li>A column names like <code>glimepiride_No</code> mean the patient did not have the medicine <code>glimepiride</code>. If this feature had a value of False, then the patient did take the drug <code>glimepiride</code></li>
<li>Features whose names begin with <code>medical_specialty</code> describe the specialty of the doctor seeing the patient. The values in these fields are all <code>True</code> or <code>False</code>.</li>
</ul>
</blockquote>
</div>
<div class="outline-4" id="outline-container-org71798df">
<h4 id="org71798df">Set Up X and Y</h4>
<div class="outline-text-4" id="text-org71798df">
<div class="highlight">
<pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">readmitted</span>
<span class="n">TARGET</span> <span class="o">=</span> <span class="s2">"readmitted"</span>
<span class="n">FEATURES</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">!=</span> <span class="n">TARGET</span><span class="p">]</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">FEATURES</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orga660ff1">
<h4 id="orga660ff1">Split the Data</h4>
<div class="outline-text-4" id="text-orga660ff1">
<div class="highlight">
<pre><span></span><span class="n">x_train</span><span class="p">,</span> <span class="n">x_validate</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_validate</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
                                                            <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org0c33cdc">
<h3 id="org0c33cdc">A Simple Model</h3>
<div class="outline-text-3" id="text-org0c33cdc">
<blockquote>
<p>You have built a simple model, but the doctors say they don't know how to evaluate a model, and they'd like you to show them some evidence the model is doing something in line with their medical intuition. Create any graphics or tables that will show them a quick overview of what the model is doing?</p>
<p>They are very busy. So they want you to condense your model overview into just 1 or 2 graphics, rather than a long string of graphics.</p>
</blockquote>
</div>
<div class="outline-4" id="outline-container-orgf3612c4">
<h4 id="orgf3612c4">Train the Model</h4>
<div class="outline-text-4" id="text-orgf3612c4">
<div class="highlight">
<pre><span></span><span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">model_1</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Training R^2: </span><span class="si">{</span><span class="n">model_1</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span><span class="si">:</span><span class="s2"> 0.2f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Validation R^2: </span><span class="si">{</span><span class="n">model_1</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">x_validate</span><span class="p">,</span> <span class="n">y_validate</span><span class="p">)</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
<pre class="example">
2020-02-14 14:02:08,392 graeae.timers.timer start: Started: 2020-02-14 14:02:08.391737
2020-02-14 14:02:09,011 graeae.timers.timer end: Ended: 2020-02-14 14:02:09.011136
2020-02-14 14:02:09,011 graeae.timers.timer end: Elapsed: 0:00:00.619399
Training R^2:  1.00
Validation R^2: 0.60
</pre>
<div class="highlight">
<pre><span></span><span class="n">model_2</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">()</span>

<span class="n">estimators</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">max_depth</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

<span class="n">grid</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="n">estimators</span><span class="p">,</span>
            <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">)</span>
<span class="n">search</span> <span class="o">=</span> <span class="n">RandomizedSearchCV</span><span class="p">(</span><span class="n">estimator</span><span class="o">=</span><span class="n">model_2</span><span class="p">,</span>
                            <span class="n">param_distributions</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
                            <span class="n">n_iter</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                            <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">with</span> <span class="n">TIMER</span><span class="p">:</span>
    <span class="n">search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">first_model</span> <span class="o">=</span> <span class="n">search</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"CV Training R^2: </span><span class="si">{</span><span class="n">search</span><span class="o">.</span><span class="n">best_score_</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Training R^2: </span><span class="si">{</span><span class="n">first_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span><span class="si">:</span><span class="s2"> 0.2f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Validation R^2: </span><span class="si">{</span><span class="n">first_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">x_validate</span><span class="p">,</span> <span class="n">y_validate</span><span class="p">)</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">search</span><span class="o">.</span><span class="n">best_params_</span><span class="p">)</span>
</pre></div>
<pre class="example">
2020-02-14 14:02:10,418 graeae.timers.timer start: Started: 2020-02-14 14:02:10.418784
2020-02-14 14:04:09,802 graeae.timers.timer end: Ended: 2020-02-14 14:04:09.802077
2020-02-14 14:04:09,802 graeae.timers.timer end: Elapsed: 0:01:59.383293
CV Training R^2: 0.63
Training R^2:  0.70
Validation R^2: 0.63
{'n_estimators': 90, 'max_depth': 10}
</pre>
<p>We get a slight improvement with a much more complex model, but not a lot. Our validation \(r^2\) is nearly as good as the training \(r^2\) so it looks like we aren't overfitting.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org9cd9197">
<h4 id="org9cd9197">Permutation Importance</h4>
<div class="outline-text-4" id="text-org9cd9197">
<div class="highlight">
<pre><span></span><span class="n">permutor</span> <span class="o">=</span> <span class="n">PermutationImportance</span><span class="p">(</span><span class="n">first_model</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">x_validate</span><span class="p">,</span> <span class="n">y_validate</span><span class="p">)</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">ipython_html</span> <span class="o">=</span> <span class="n">eli5</span><span class="o">.</span><span class="n">show_weights</span><span class="p">(</span><span class="n">permutor</span><span class="p">,</span>
                                 <span class="n">feature_names</span><span class="o">=</span><span class="n">x_validate</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="n">table</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="n">ipython_html</span><span class="o">.</span><span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">TABLE</span><span class="p">(</span><span class="n">table</span><span class="p">))</span>
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-left"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">Weight</th>
<th class="org-left" scope="col">Feature</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">0.0640 ± 0.0071</td>
<td class="org-left">number_inpatient</td>
</tr>
<tr>
<td class="org-left">0.0108 ± 0.0046</td>
<td class="org-left">number_emergency</td>
</tr>
<tr>
<td class="org-left">0.0084 ± 0.0058</td>
<td class="org-left">number_outpatient</td>
</tr>
<tr>
<td class="org-left">0.0025 ± 0.0034</td>
<td class="org-left">number_diagnoses</td>
</tr>
<tr>
<td class="org-left">0.0021 ± 0.0010</td>
<td class="org-left">diabetesMed_Yes</td>
</tr>
<tr>
<td class="org-left">0.0020 ± 0.0017</td>
<td class="org-left">payer_code_?</td>
</tr>
<tr>
<td class="org-left">0.0019 ± 0.0015</td>
<td class="org-left">race_AfricanAmerican</td>
</tr>
<tr>
<td class="org-left">0.0015 ± 0.0015</td>
<td class="org-left">num_lab_procedures</td>
</tr>
<tr>
<td class="org-left">0.0013 ± 0.0008</td>
<td class="org-left">age_[80-90)</td>
</tr>
<tr>
<td class="org-left">0.0011 ± 0.0030</td>
<td class="org-left">diag_1_428</td>
</tr>
<tr>
<td class="org-left">0.0011 ± 0.0023</td>
<td class="org-left">medical_specialty_?</td>
</tr>
<tr>
<td class="org-left">0.0010 ± 0.0012</td>
<td class="org-left">payer_code_HM</td>
</tr>
<tr>
<td class="org-left">0.0008 ± 0.0043</td>
<td class="org-left">num_procedures</td>
</tr>
<tr>
<td class="org-left">0.0008 ± 0.0012</td>
<td class="org-left">payer_code_BC</td>
</tr>
<tr>
<td class="org-left">0.0008 ± 0.0008</td>
<td class="org-left">age_[40-50)</td>
</tr>
<tr>
<td class="org-left">0.0008 ± 0.0010</td>
<td class="org-left">max_glu_serum_None</td>
</tr>
<tr>
<td class="org-left">0.0008 ± 0.0015</td>
<td class="org-left">race_Caucasian</td>
</tr>
<tr>
<td class="org-left">0.0005 ± 0.0032</td>
<td class="org-left">num_medications</td>
</tr>
<tr>
<td class="org-left">0.0005 ± 0.0022</td>
<td class="org-left">diag_2_250</td>
</tr>
<tr>
<td class="org-left">0.0004 ± 0.0006</td>
<td class="org-left">rosiglitazone_No</td>
</tr>
<tr>
<td class="org-left">… 44 more …</td>
<td class="org-left">… 44 more …</td>
</tr>
</tbody>
</table>
<p>The most important features weren't in the data description. What is <code>number_inpatient</code>?</p>
</div>
</div>
<div class="outline-4" id="outline-container-orge10a3ee">
<h4 id="orge10a3ee">Partial Dependence Plot</h4>
<div class="outline-text-4" id="text-orge10a3ee">
<p>Since the most important feature is the "number_inpatient" let's see how much it changes the re-admissions.</p>
<div class="highlight">
<pre><span></span><span class="n">FEATURE</span> <span class="o">=</span> <span class="s2">"number_inpatient"</span>
<span class="n">pdp_dist</span> <span class="o">=</span> <span class="n">pdp</span><span class="o">.</span><span class="n">pdp_isolate</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">first_model</span><span class="p">,</span>
                           <span class="n">dataset</span><span class="o">=</span><span class="n">x_validate</span><span class="p">,</span>
                           <span class="n">model_features</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                           <span class="n">feature</span><span class="o">=</span><span class="n">FEATURE</span><span class="p">)</span>
<span class="n">pdp</span><span class="o">.</span><span class="n">pdp_plot</span><span class="p">(</span><span class="n">pdp_dist</span><span class="p">,</span> <span class="n">FEATURE</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">FEATURE</span><span class="si">}</span><span class="s2">_pdp_plot.png"</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">pyplot</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
<span class="n">figure</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="number_inpatient_pdp_plot.png" src="/posts/tutorials/shap-values-exercise/number_inpatient_pdp_plot.png"></p>
</div>
</div>
</div>
<div class="outline-4" id="outline-container-org4d2f821">
<h4 id="org4d2f821">SHAP Values</h4>
<div class="outline-text-4" id="text-org4d2f821">
<div class="highlight">
<pre><span></span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ROW</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_validate</span><span class="p">))</span>
<span class="n">row_data</span> <span class="o">=</span> <span class="n">x_validate</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ROW</span><span class="p">]</span>
<span class="n">row_data_matrix</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">))</span>
</pre></div>
<pre class="example">
[0 1]
[[0.49342394 0.50657606]]
</pre>
<div class="highlight">
<pre><span></span>explainer = shap.TreeExplainer(first_model)
shap_values = explainer.shap_values(row_data_matrix)
</pre></div>
<div class="highlight">
<pre><span></span>READMIT = 1
figure = shap.force_plot(explainer.expected_value[READMIT],
                         shap_values[READMIT],
                         row_data_matrix,
                         feature_names=FEATURES,
                         matplotlib=True, show=False)
filename = "shap_zero.png"

figure.savefig(OUTPUT_PATH/filename)
print(f"[[file:{filename}]]")
</pre></div>
<div class="figure">
<p><img alt="shap_zero.png" src="/posts/tutorials/shap-values-exercise/shap_zero.png"></p>
</div>
</div>
<ul class="org-ul">
<li><a id="orgd314366"></a>Try one where num_inpatients was 1<br>
<div class="outline-text-5" id="text-orgd314366">
<div class="highlight">
<pre><span></span><span class="n">row_data</span> <span class="o">=</span> <span class="n">x_validate</span><span class="p">[</span><span class="n">x_validate</span><span class="o">.</span><span class="n">number_inpatient</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">row_data_matrix</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">))</span>
</pre></div>
<pre class="example">
[0 1]
[[0.36731038 0.63268962]]
</pre>
<div class="highlight">
<pre><span></span><span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">first_model</span><span class="p">)</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">force_plot</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">shap_values</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">row_data_matrix</span><span class="p">,</span>
                         <span class="n">feature_names</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                         <span class="n">matplotlib</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s2">"shap_one.png"</span>

<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">filename</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_one.png" src="/posts/tutorials/shap-values-exercise/shap_one.png"></p>
</div>
</div>
</li>
<li><a id="org153f009"></a>Try one where num_inpatients was 2<br>
<div class="outline-text-5" id="text-org153f009">
<div class="highlight">
<pre><span></span><span class="n">INPATIENTS</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">row_data</span> <span class="o">=</span> <span class="n">x_validate</span><span class="p">[</span><span class="n">x_validate</span><span class="o">.</span><span class="n">number_inpatient</span><span class="o">==</span><span class="n">INPATIENTS</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">row_data_matrix</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">))</span>
</pre></div>
<pre class="example">
[0 1]
[[0.38485607 0.61514393]]
</pre>
<div class="highlight">
<pre><span></span><span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">first_model</span><span class="p">)</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">force_plot</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">shap_values</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">row_data_matrix</span><span class="p">,</span>
                         <span class="n">feature_names</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                         <span class="n">matplotlib</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s2">"shap_two.png"</span>

<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">filename</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_two.png" src="/posts/tutorials/shap-values-exercise/shap_two.png"></p>
</div>
</div>
</li>
<li><a id="org173c5cd"></a>Try one where num_inpatients was 3<br>
<div class="outline-text-5" id="text-org173c5cd">
<div class="highlight">
<pre><span></span><span class="n">INPATIENTS</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">row_data</span> <span class="o">=</span> <span class="n">x_validate</span><span class="p">[</span><span class="n">x_validate</span><span class="o">.</span><span class="n">number_inpatient</span><span class="o">==</span><span class="n">INPATIENTS</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">row_data_matrix</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">))</span>
</pre></div>
<pre class="example">
[0 1]
[[0.47141351 0.52858649]]
</pre>
<div class="highlight">
<pre><span></span><span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">first_model</span><span class="p">)</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">force_plot</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">shap_values</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">row_data_matrix</span><span class="p">,</span>
                         <span class="n">feature_names</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                         <span class="n">matplotlib</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s2">"shap_three.png"</span>

<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">filename</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_three.png" src="/posts/tutorials/shap-values-exercise/shap_three.png"></p>
</div>
</div>
</li>
<li><a id="org0bb2117"></a>Try one where num_inpatients was the Maximum<br>
<div class="outline-text-5" id="text-org0bb2117">
<div class="highlight">
<pre><span></span><span class="n">INPATIENTS</span> <span class="o">=</span> <span class="n">x_validate</span><span class="o">.</span><span class="n">number_inpatient</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">row_data</span> <span class="o">=</span> <span class="n">x_validate</span><span class="p">[</span><span class="n">x_validate</span><span class="o">.</span><span class="n">number_inpatient</span><span class="o">==</span><span class="n">INPATIENTS</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">row_data_matrix</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">))</span>
</pre></div>
<pre class="example">
[0 1]
[[0.19208238 0.80791762]]
</pre>
<div class="highlight">
<pre><span></span><span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">first_model</span><span class="p">)</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">force_plot</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">shap_values</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">row_data_matrix</span><span class="p">,</span>
                         <span class="n">feature_names</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                         <span class="n">matplotlib</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s2">"shap_max.png"</span>

<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">filename</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_max.png" src="/posts/tutorials/shap-values-exercise/shap_max.png"></p>
</div>
<p>So it seems to be that the greater <code>number_inpatient</code> the more it contributes to re-admission (although note that since we're only using one row the cases with small values doesn't always look like what I plotted above - it depends on the patient).</p>
</div>
</li>
</ul>
</div>
<div class="outline-4" id="outline-container-orgbff7bd1">
<h4 id="orgbff7bd1">Time In Hospital</h4>
<div class="outline-text-4" id="text-orgbff7bd1">
<blockquote>
<p>The doctors think it's a good sign that increasing the number of inpatient procedures leads to increased predictions. But they can't tell from this plot whether that change in the plot is big or small. They'd like you to create something similar for <code>time_in_hospital</code> to see how that compares.</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">FEATURE</span> <span class="o">=</span> <span class="s2">"time_in_hospital"</span>
<span class="n">pdp_dist</span> <span class="o">=</span> <span class="n">pdp</span><span class="o">.</span><span class="n">pdp_isolate</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">first_model</span><span class="p">,</span>
                           <span class="n">dataset</span><span class="o">=</span><span class="n">x_validate</span><span class="p">,</span>
                           <span class="n">model_features</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                           <span class="n">feature</span><span class="o">=</span><span class="n">FEATURE</span><span class="p">)</span>
<span class="n">pdp</span><span class="o">.</span><span class="n">pdp_plot</span><span class="p">(</span><span class="n">pdp_dist</span><span class="p">,</span> <span class="n">FEATURE</span><span class="p">)</span>
<span class="n">output</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">FEATURE</span><span class="si">}</span><span class="s2">_pdp_plot.png"</span>
<span class="n">pyplot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">output</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="time_in_hospital_pdp_plot.png" src="/posts/tutorials/shap-values-exercise/time_in_hospital_pdp_plot.png"></p>
</div>
<div class="highlight">
<pre><span></span><span class="n">TIME_IN_HOSPITAL</span> <span class="o">=</span> <span class="mi">8</span>

<span class="n">row_data</span> <span class="o">=</span> <span class="n">x_validate</span><span class="p">[</span><span class="n">x_validate</span><span class="o">.</span><span class="n">time_in_hospital</span><span class="o">==</span><span class="n">TIME_IN_HOSPITAL</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">row_data_matrix</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">classes_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">))</span>
</pre></div>
<pre class="example">
[0 1]
[[0.39445183 0.60554817]]
</pre>
<div class="highlight">
<pre><span></span><span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">first_model</span><span class="p">)</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">)</span>
<span class="n">figure</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">force_plot</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">shap_values</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                         <span class="n">row_data_matrix</span><span class="p">,</span>
                         <span class="n">feature_names</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                         <span class="n">matplotlib</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s2">"shap_hospital_one.png"</span>

<span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">filename</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">]]"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_hospital_one.png" src="/posts/tutorials/shap-values-exercise/shap_hospital_one.png"></p>
</div>
<p>It looks like time in hospital has an effect - but it is a small one.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org9ccd682">
<h4 id="org9ccd682">Raw Readmissions</h4>
<div class="outline-text-4" id="text-org9ccd682">
<blockquote>
<p>Whoa! It seems like <code>time_in_hospital</code> doesn't matter at all. The difference between the lowest value on the partial dependence plot and the highest value is about 5%.</p>
<p>If that is what your model concluded, the doctors will believe it. But it seems so low. Could the data be wrong, or is your model doing something more complex than they expect?</p>
<p>They'd like you to show them the raw readmission rate for each value of <code>time_in_hospital</code> to see how it compares to the partial dependence plot.</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="n">training</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s2">"columns"</span><span class="p">)</span>
<span class="n">grouped</span> <span class="o">=</span> <span class="n">training</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">"time_in_hospital"</span><span class="p">])</span><span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">"readmitted"</span><span class="p">:</span> <span class="s2">"mean"</span><span class="p">})</span>
<span class="n">plot</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">hvplot</span><span class="o">.</span><span class="n">bar</span><span class="p">()</span><span class="o">.</span><span class="n">opts</span><span class="p">(</span>
    <span class="n">title</span><span class="o">=</span><span class="s2">"Readmission Rates for time_in_hospital"</span><span class="p">,</span>
    <span class="n">width</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">width</span><span class="p">,</span>
    <span class="n">height</span><span class="o">=</span><span class="n">Plot</span><span class="o">.</span><span class="n">height</span>
<span class="p">)</span>

<span class="n">source</span> <span class="o">=</span> <span class="n">Embed</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s2">"time_in_hospital_readmission_rates"</span><span class="p">)()</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</pre></div>
: <object data="/posts/tutorials/shap-values-exercise/time_in_hospital_readmission_rates.html" height="800" style="width:100%" type="text/html">:
<p>Figure Missing</p>
:</object>
<p>It sort of looks like <code>time_in_hospital</code> does affect readmission rates, just not as much as the number of admissions, I guess.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd6ec881">
<h3 id="orgd6ec881">SHAP Creator</h3>
<div class="outline-text-3" id="text-orgd6ec881">
<blockquote>
<p>Now the doctors are convinced you have the right data, and the model overview looked reasonable. It's time to turn this into a finished product they can use. Specifically, the hospital wants you to create a function <code>patient_risk_factors</code> that does the following</p>
<ul class="org-ul">
<li>Takes a single row with patient data (of the same format you as your raw data)</li>
<li>Creates a visualization showing what features of that patient increased their risk of readmission, what features decreased it, and how much those features mattered.</li>
</ul>
<p>It's not important to show every feature with every miniscule impact on the readmission risk. It's fine to focus on only the most important features for that patient.</p>
</blockquote>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">patient_risk_factors</span><span class="p">(</span><span class="n">row_data</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">row_data_matrix</span> <span class="o">=</span> <span class="n">row_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">first_model</span><span class="p">)</span>
    <span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">row_data_matrix</span><span class="p">)</span>
    <span class="n">figure</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">force_plot</span><span class="p">(</span><span class="n">explainer</span><span class="o">.</span><span class="n">expected_value</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                             <span class="n">shap_values</span><span class="p">[</span><span class="n">READMIT</span><span class="p">],</span>
                             <span class="n">row_data_matrix</span><span class="p">,</span>
                             <span class="n">feature_names</span><span class="o">=</span><span class="n">FEATURES</span><span class="p">,</span>
                             <span class="n">matplotlib</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"shap_</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s2">.png"</span>
    <span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">OUTPUT_PATH</span><span class="o">/</span><span class="n">filename</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"[[file:</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">]]"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">row_data_matrix</span>
</pre></div>
<div class="highlight">
<pre><span></span><span class="n">row</span> <span class="o">=</span> <span class="n">x_validate</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<span class="n">row_matrix</span> <span class="o">=</span> <span class="n">patient_risk_factors</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s2">"random_one"</span><span class="p">)</span>
</pre></div>
<div class="figure">
<p><img alt="shap_random_one.png" src="/posts/tutorials/shap-values-exercise/shap_random_one.png"></p>
</div>
<div class="highlight">
<pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">first_model</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">row_matrix</span><span class="p">))</span>
</pre></div>
<pre class="example">
[[0.70043997 0.29956003]]
</pre>
<p>In this case it looks like the number of diagnoses was the most important - having many diagnoses with no hospital admissions predicts you won't be readmitted. Should people who were never admitted be considered? Perhaps "readmission" just means admitted later.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org994a6cc">
<h2 id="org994a6cc">End</h2>
<div class="outline-text-2" id="text-org994a6cc"></div>
<div class="outline-3" id="outline-container-org08559bf">
<h3 id="org08559bf">Sources</h3>
<div class="outline-text-3" id="text-org08559bf">
<ul class="org-ul">
<li>Lundberg, S.M., Erion, G., Chen, H. et al. From local explanations to global understanding with explainable AI for trees. Nat Mach Intell 2, 56–67 (2020). <a href="https://doi.org/10.1038/s42256-019-0138-9">https://doi.org/10.1038/s42256-019-0138-9</a> (<a href="https://www.nature.com/articles/s42256-019-0138-9">TreeExplainer</a>)</li>
<li>Lundberg, S.M., Nair, B., Vavilala, M.S. et al. Explainable machine-learning predictions for the prevention of hypoxaemia during surgery. Nat Biomed Eng 2, 749–760 (2018). <a href="https://doi.org/10.1038/s41551-018-0304-0">https://doi.org/10.1038/s41551-018-0304-0</a> (<a href="https://www.nature.com/articles/s41551-018-0304-0"><code>force_plot</code></a>)</li>
</ul>
</div>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="pager hidden-print">
<li class="previous"><a href="/posts/tutorials/shap-values/" rel="prev" title="SHAP Values">Previous post</a></li>
<li class="next"><a href="/posts/tutorials/advanced-uses-of-shap/" rel="next" title="Advanced Uses Of SHAP">Next post</a></li>
</ul>
</nav>
</aside>
</article>
<!--End of body content-->
<footer id="footer">Contents © 2023 <a href="mailto:cloisteredmonkey.jmark@slmail.me">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="/assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script> 
</body>
</html>
