<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="The Snorkel data labeling tutorial." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Snorkel Data Labeling | Visions, Voices, Data</title>
<link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../../../rss.xml" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/Visions-Voices-Data/posts/libraries/snorkel/snorkel-data-labeling/" rel="canonical"><!--[if lt IE 9]><script src="../../../../assets/js/html5.js"></script><![endif]-->
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" type="text/javascript"></script><!--
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.min.js"
</script>
-->
<script async src="../../../assets/javascript/p5.min.js" type="text/javascript"></script>
<meta content="Cloistered Monkey" name="author">
<link href="/posts/libraries/snorkel/snorkel-example-building-a-spam-dataset/" rel="prev" title="Snorkel Example: Building a Spam Dataset" type="text/html">
<link href="/posts/machine-learning/decision-trees/" rel="next" title="Decision Trees" type="text/html">
<meta content="Visions, Voices, Data" property="og:site_name">
<meta content="Snorkel Data Labeling" property="og:title">
<meta content="https://necromuralist.github.io/Visions-Voices-Data/posts/libraries/snorkel/snorkel-data-labeling/" property="og:url">
<meta content="The Snorkel data labeling tutorial." property="og:description">
<meta content="article" property="og:type">
<meta content="2020-01-09T17:07:33-08:00" property="article:published_time">
<meta content="data" property="article:tag">
<meta content="exploration" property="article:tag">
<meta content="snorkel" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="https://necromuralist.github.io/Visions-Voices-Data/"><span id="blog-title">Visions, Voices, Data</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="/archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="/categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="/rss.xml">RSS feed</a></li>
<li class="nav-item dropdown"><a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Pages</a>
<div class="dropdown-menu"><a class="dropdown-item" href="https://necromuralist.github.io/">Cloistered Monkey</a> <a class="dropdown-item" href="/pages/giss/giss-yearly-anomalies-by-climate-zone">GISS Anomalies</a></div>
</li>
</ul>
<!-- DuckDuckGo custom search -->
<form action="https://duckduckgo.com/" class="navbar-form pull-left" id="search" method="get" name="search"><input name="sites" type="hidden" value="https://necromuralist.github.io/Visions-Voices-Data/"> <input name="k8" type="hidden" value="#444444"> <input name="k9" type="hidden" value="#D51920"> <input name="kt" type="hidden" value="h"> <input class="span2" maxlength="255" name="q" placeholder="Search…" type="text"> <input style="visibility: hidden;display:none" type="submit" value="DuckDuckGo Search"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="/posts/libraries/snorkel/snorkel-data-labeling/index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href="/posts/libraries/snorkel/snorkel-data-labeling/">Snorkel Data Labeling</a></h1>
<div class="metadata">
<p class="byline author vcard"><span class="byline-name fn" itemprop="author">Cloistered Monkey</span></p>
<p class="dateline"><a href="/posts/libraries/snorkel/snorkel-data-labeling/" rel="bookmark"><time class="published dt-published" datetime="2020-01-09T17:07:33-08:00" itemprop="datePublished" title="2020-01-09 17:07">2020-01-09 17:07</time></a></p>
<p class="sourceline"><a class="sourcelink" href="/posts/libraries/snorkel/snorkel-data-labeling/index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="/posts/libraries/snorkel/snorkel-data-labeling/#org7110700">Beginning</a>
<ul>
<li><a href="/posts/libraries/snorkel/snorkel-data-labeling/#org1eea11a">Imports</a></li>
<li><a href="/posts/libraries/snorkel/snorkel-data-labeling/#org1367a1e">Set Up</a></li>
</ul>
</li>
<li><a href="/posts/libraries/snorkel/snorkel-data-labeling/#org695e908">Middle</a>
<ul>
<li><a href="/posts/libraries/snorkel/snorkel-data-labeling/#org459bf62">Finding Labeling Functions</a></li>
<li><a href="/posts/libraries/snorkel/snorkel-data-labeling/#orgdaac3af">Using TextBlob with a Preprocessor</a></li>
<li><a href="/posts/libraries/snorkel/snorkel-data-labeling/#orgd7660b8">More Labeling Functions</a></li>
<li><a href="/posts/libraries/snorkel/snorkel-data-labeling/#org99ea299">Adding a Spacy Preprocessor</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-org7110700">
<h2 id="org7110700">Beginning</h2>
<div class="outline-text-2" id="text-org7110700">
<p>This is a walk-through of the Snorkel <a href="https://www.snorkel.org/use-cases/01-spam-tutorial">Snorkel Data Labeling</a> tutorial.It uses the <a href="http://www.dt.fee.unicamp.br/~tiago//youtubespamcollection/">YouTube Spam Collection</a> data set (downloaded from the <a href="https://archive.ics.uci.edu/ml/datasets/YouTube+Spam+Collection">UCI Machine Learning Repository</a>). The data was collected in 2015 and represents comments from five of the ten most popular videos on YouTube. It is a tabular dataset with the columns <code>COMMENT_ID</code>, <code>AUTHOR</code>, <code>DATE</code>, <code>CONTENT</code>, <code>CLASS</code>. The tag represents whether it was considered <i>Spam</i> or not, so we'll pretend it isn't there for most of this walk-through.</p>
</div>
<div class="outline-3" id="outline-container-org1eea11a">
<h3 id="org1eea11a">Imports</h3>
<div class="outline-text-3" id="text-org1eea11a"></div>
<div class="outline-4" id="outline-container-org97bc1a0">
<h4 id="org97bc1a0">Python</h4>
<div class="outline-text-4" id="text-org97bc1a0">
<div class="highlight">
<pre><span></span>from argparse import Namespace
from functools import partial
from pathlib import Path
import re
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgc38d5c3">
<h4 id="orgc38d5c3">PyPi</h4>
<div class="outline-text-4" id="text-orgc38d5c3">
<div class="highlight">
<pre><span></span>from snorkel.analysis import get_label_buckets
from snorkel.labeling import labeling_function, LabelingFunction, LFAnalysis, PandasLFApplier
from snorkel.preprocess import preprocessor
from snorkel.labeling.lf.nlp import nlp_labeling_function
from sklearn.model_selection import train_test_split
from tabulate import tabulate
from textblob import TextBlob

import pandas
</pre></div>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-org1367a1e">
<h3 id="org1367a1e">Set Up</h3>
<div class="outline-text-3" id="text-org1367a1e"></div>
<div class="outline-4" id="outline-container-org11e2015">
<h4 id="org11e2015">The Tabulate Table</h4>
<div class="outline-text-4" id="text-org11e2015">
<div class="highlight">
<pre><span></span>TABLE = partial(tabulate, tablefmt="orgtbl", headers="keys")
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgb273a95">
<h4 id="orgb273a95">Some Constants</h4>
<div class="outline-text-4" id="text-orgb273a95">
<div class="highlight">
<pre><span></span>Comment = Namespace(
    is_ambiguous = -1,
    is_ham = 0,
    is_spam = 1
)
</pre></div>
<div class="highlight">
<pre><span></span>Data = Namespace(
    test_artist = "Shakira",
    development_size = 200,
    validation_size = 0.5,
    random_seed = 666,
)
</pre></div>
<div class="highlight">
<pre><span></span>Columns = Namespace(
    comment = "CONTENT",
    classification = "CLASS",
    artist = "artist",
)
</pre></div>
</div>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-org695e908">
<h2 id="org695e908">Middle</h2>
<div class="outline-text-2" id="text-org695e908"></div>
<div class="outline-4" id="outline-container-org1650a13">
<h4 id="org1650a13">The Dataset</h4>
<div class="outline-text-4" id="text-org1650a13">
<p>The data is split up into separate files - one for each artist/video (they are named after the artist and each only appears to have one entry) so I'm going to smash them back together and add a <code>artist</code> column.</p>
<div class="highlight">
<pre><span></span>path = Path("~/data/datasets/texts/you_tube_comments/").expanduser()
sets = []
for name in path.glob("*.csv"):
    artist = name.stem.split()[-1]
    data = pandas.read_csv(name)
    data["artist"] = artist
    sets.append(data)
    print(artist)
data = pandas.concat(sets)
</pre></div>
<pre class="example">
KatyPerry
LMFAO
Eminem
Shakira
Psy
</pre></div>
</div>
<div class="outline-4" id="outline-container-org1c9ca1f">
<h4 id="org1c9ca1f">Splitting the Set</h4>
<div class="outline-text-4" id="text-org1c9ca1f">
<p>The tutorial takes a slightly different approach from the one I previously took. Here's their four data-set splits:</p>
<ul class="org-ul">
<li><i>train</i>: Comments from the first four videos</li>
<li><i>dev</i>: 200 comments taken from <i>train</i></li>
<li><i>valid & test</i>: A 50-50 split of the last video (actually <i>Shakira</i>, not <i>Psy</i> as listed above)</li>
</ul>
<div class="highlight">
<pre><span></span>test = data[data.artist==Data.test_artist]
train = data[data.artist != Data.test_artist]
train, development = train_test_split(train, test_size=Data.development_size)

validation, test = train_test_split(test, test_size=Data.validation_size)
print(f"Training: {train.shape}")
print(f"Development: {development.shape}")
print(f"Validation: {validation.shape}")
print(f"Testing: {test.shape}")
</pre></div>
<pre class="example">
Training: (1386, 6)
Development: (200, 6)
Validation: (185, 6)
Testing: (185, 6)
</pre></div>
</div>
<div class="outline-3" id="outline-container-org459bf62">
<h3 id="org459bf62">Finding Labeling Functions</h3>
<div class="outline-text-3" id="text-org459bf62">
<p>The place to start is with the development set - it's labeled (although in this case the training set is as well, but pretend it isn't) and we can inspect it to get ideas.</p>
<div class="highlight">
<pre><span></span>print(development.sample(random_state=Data.random_seed)[[Columns.comment, Columns.classification]])
</pre></div>
<pre class="example">
                                               CONTENT  CLASS
216  Lol...I dunno how this joke gets a lot of like...      0
</pre>
<div class="highlight">
<pre><span></span>spam = development[development[Columns.classification]==Comment.is_spam]
for count in range(10):
    print(spam.sample(random_state=count).iloc[0][Columns.comment])
</pre></div>
<pre class="example">
I #votekatyperry for the 2014 MTV #VMA Best Lyric Video! See who's in the  lead and vote:  http://on.mtv.com/Ut15kX﻿
LIKE AND SUBSCRIB IF YOU WATCH IN 2015 ;)﻿
 HI IM 14 YEAR RAPPER SUPPORT ME GUY AND CHECK OUT MY CHANNEL AND CHECK OUT MY SONG YOU MIGHT LIKE IT ALSO FOLLOW ME IN TWITTER @McAshim for follow back.
LIKE AND SUBSCRIB IF YOU WATCH IN 2015 ;)﻿
HAPPY BIRTHDAY KATY :) http://giphy.com/gifs/birthday-flowers-happy-gw3JY2uqiaXKaQXS/fullscreen  (That´s not me)﻿
plz check out fablife / welcome to fablife for diys and challenges so plz  subscribe thx!﻿
CHECK OUT MY CHANNEL BOYS AND GIRLS ;)
HAPPY BIRTHDAY KATY :) http://giphy.com/gifs/birthday-flowers-happy-gw3JY2uqiaXKaQXS/fullscreen  (That´s not me)﻿
*for 90&amp;#39;s rap fans*  check out my Big Pun - &amp;#39;Beware&amp;#39; cover!  Likes n comments very much appreciated!
Who&amp;#39;s watching in 2015 Subscribe for me !﻿
</pre>
<p>You can already see that the spam has people asking viewers to check out their sites.</p>
</div>
<div class="outline-4" id="outline-container-org91909ee">
<h4 id="org91909ee">Check vs Check Out</h4>
<div class="outline-text-4" id="text-org91909ee">
<p>Let's see which one of the strings (<i>check</i> or <i>check out</i>) does better for us.</p>
</div>
<ul class="org-ul">
<li><a id="orgd403fd3"></a>The Labeling Functions<br>
<div class="outline-text-5" id="text-orgd403fd3">
<div class="highlight">
<pre><span></span>@labeling_function()
def check(row: pandas.Series) -&gt; int:
    """sees if the word 'check' is in the comment"""
    return Comment.is_spam if "check" in row.CONTENT.lower() else Comment.is_ambiguous
</pre></div>
<div class="highlight">
<pre><span></span>@labeling_function()
def check_out(row: pandas.Series) -&gt; int:
    """looks for phrase 'check out'"""
    return Comment.is_spam if "check out" in row.CONTENT.lower() else Comment.is_ambiguous
</pre></div>
</div>
</li>
<li><a id="orgc76c9b2"></a>Applying the Functions<br>
<div class="outline-text-5" id="text-orgc76c9b2">
<p>The next step is to create some Labeling Matrices using our labeling functions by applying them to our training and development sets. Since our data is stored using pandas, we'll use the <code>PandasLFApplier</code>, but there are <a href="https://snorkel.readthedocs.io/en/master/packages/labeling.html">other types available</a> as well.</p>
<div class="highlight">
<pre><span></span>labeling_functions = [check, check_out]

applier = PandasLFApplier(lfs=labeling_functions)
train_labeling_matrix = applier.apply(df=train, progress_bar=False)
development_labeling_matrix = applier.apply(df=development, progress_bar=False)
print(f"Training Labeling Matrix: {train_labeling_matrix.shape}")
print(f"Development Labeling Matrix: {development_labeling_matrix.shape}")
</pre></div>
<pre class="example">
Training Labeling Matrix: (1386, 2)
Development Labeling Matrix: (200, 2)
</pre>
<p>Each matrix has one column for each of our labeling functions (so two in this case) and one row for each of the rows in the set that the functions were applied to.</p>
</div>
</li>
<li><a id="org94db4a7"></a>Evaluating the Labeling Functions<br>
<div class="outline-text-5" id="text-org94db4a7">
<p>Snorkel provides a <a href="https://snorkel.readthedocs.io/en/master/packages/_autosummary/labeling/snorkel.labeling.LFAnalysis.html">LFAnalysis</a> class to help you see how well the labeling functions do.</p>
<div class="highlight">
<pre><span></span>analysis = LFAnalysis(L=train_labeling_matrix, lfs=labeling_functions)
print(TABLE(analysis.lf_summary()))
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">j</th>
<th class="org-left" scope="col">Polarity</th>
<th class="org-right" scope="col">Coverage</th>
<th class="org-right" scope="col">Overlaps</th>
<th class="org-right" scope="col">Conflicts</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">check</td>
<td class="org-right">0</td>
<td class="org-left">[1]</td>
<td class="org-right">0.257576</td>
<td class="org-right">0.212843</td>
<td class="org-right">0</td>
</tr>
<tr>
<td class="org-left">check_out</td>
<td class="org-right">1</td>
<td class="org-left">[1]</td>
<td class="org-right">0.212843</td>
<td class="org-right">0.212843</td>
<td class="org-right">0</td>
</tr>
</tbody>
</table>
<p>This is what the table is giving us for each of the labeling functions:</p>
<ul class="org-ul">
<li><i>j</i> : I think this is just an index</li>
<li><i>Polarity</i>: The number of unique values the function puts out (other than -1, which is interpreted as an un-labeled row)</li>
<li>/Coverage: The fraction of the data-set that the function labeled</li>
<li>/Overlaps: The fraction of the data that the function labeled and at least one other function also labeled</li>
<li><i>Conflicts</i>: The fraction of the data that the function labeled something different from at least one other function</li>
</ul>
<p>So it looks like <code>check</code> covers slightly more than <code>check_out</code>, and they don't disagree with each other at all. This makes sense when you consider that <code>check</code> is a sub-string of <code>check out</code> - we can guess that all the overlaps are cases where <code>check out</code> were found in the comment.</p>
<p>We can also pass it a set of labels and it will see how well the functions did. In this case we have labels for all the rows, but in most cases we won't just for the development set so we'll use it here.</p>
<div class="highlight">
<pre><span></span>print(TABLE(LFAnalysis(
    L=development_labeling_matrix,
    lfs=labeling_functions).lf_summary(Y=development.CLASS.values)))
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">j</th>
<th class="org-left" scope="col">Polarity</th>
<th class="org-right" scope="col">Coverage</th>
<th class="org-right" scope="col">Overlaps</th>
<th class="org-right" scope="col">Conflicts</th>
<th class="org-right" scope="col">Correct</th>
<th class="org-right" scope="col">Incorrect</th>
<th class="org-right" scope="col">Emp. Acc.</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">check</td>
<td class="org-right">0</td>
<td class="org-left">[1]</td>
<td class="org-right">0.26</td>
<td class="org-right">0.225</td>
<td class="org-right">0</td>
<td class="org-right">49</td>
<td class="org-right">3</td>
<td class="org-right">0.942308</td>
</tr>
<tr>
<td class="org-left">check_out</td>
<td class="org-right">1</td>
<td class="org-left">[1]</td>
<td class="org-right">0.225</td>
<td class="org-right">0.225</td>
<td class="org-right">0</td>
<td class="org-right">45</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>
<p><b>Note:</b> The <code>LFAnalysis</code> class works with <code>numpy</code> arrays, so when I called the <code>lf_summary</code> method I had to pass in the <code>values</code> and not the <code>CLASS</code> Series.</p>
<p>With our development set, the functions cover slightly less than before (as a fraction of the total), and although <code>check</code> covers slightly more that <code>check_out</code>, it also has some false-postives, so we'd have to decide if we care about getting all the spam or not accidentally labeling non-spam as spam.</p>
<p>We can also check which ones were mis-labeled to get a better idea of how off they were.</p>
<div class="highlight">
<pre><span></span>buckets = get_label_buckets(development.CLASS.values, development_labeling_matrix[:, 0])
for key, value in buckets.items():
    print(key)
    print(value)
</pre></div>
<pre class="example">
(0, -1)
[  0   1   2   3   4   7   9  10  11  12  13  15  16  17  19  22  27  28
  33  34  35  39  41  43  44  46  48  49  50  51  52  53  55  57  58  61
  62  65  66  68  78  79  81  82  86  88  89  92  94  95  98  99 100 103
 104 105 107 108 112 113 114 120 121 122 123 124 125 128 129 131 133 135
 141 142 144 146 148 150 153 154 155 162 165 166 167 168 171 173 174 179
 182 183 184 190 191 195 196 197]
(1, 1)
[  5  14  23  25  29  36  40  42  45  59  67  69  71  73  74  75  76  77
  80  83  87  90  91  93 101 109 110 116 117 126 127 134 138 139 140 143
 149 151 157 160 163 164 169 172 186 189 192 193 198]
(1, -1)
[  6   8  18  20  21  24  26  30  31  32  38  47  54  56  60  63  64  70
  72  84  85  96  97 102 106 111 115 119 130 132 136 137 145 147 152 156
 158 159 161 175 176 177 178 180 181 185 187 188 194 199]
(0, 1)
[ 37 118 170]
</pre>
<p>Buckets is a dict whose keys are tuples of (actual classes, predicted classes) and whose values are the indices of the rows matching the keys (so the key <code>(0, 1)</code> returns the indices for rows where we labeled the comment as spam but it wasn't). Looking at the output you can see that the last key (0, 1) has the cases that we labeled as spam when they weren't, let's take a look at them.</p>
<div class="highlight">
<pre><span></span>for comment in development.iloc[buckets[(Comment.is_ham, Comment.is_spam)]]["CONTENT"]:
    print(comment)
</pre></div>
<pre class="example">
i turned it on mute as soon is i came on i just wanted to check the  views...﻿
i check back often to help reach 2x10^9 views and I avoid watching Baby﻿
Admit it you just came here to check the number of viewers ﻿
</pre>
<p>It's not obvious to me how you should handle those.</p>
</div>
</li>
<li><a id="org2b15e9b"></a>Check Out But Not Check<br>
<div class="outline-text-5" id="text-org2b15e9b">
<p>What are some training examples that <code>check</code> labels but <code>check_out</code> doesn't? We can check by feeding the columns from the labeling matrix for the <code>check</code> and <code>check_out</code> functions and see where <code>check_out</code> abstained and <code>check</code> didn't. I said earlier that the first argument to <code>get_label_buckets</code> is the actual label, but really you can feed any two arrays and it will find give you the indices for the permutations of their row-values.</p>
<div class="highlight">
<pre><span></span>buckets = get_label_buckets(train_labeling_matrix[:, 0], train_labeling_matrix[:, 1])
sampled = train.iloc[buckets[(Comment.is_spam, Comment.is_ambiguous)]].sample(10, random_state=Data.random_seed)
for sample in sampled.itertuples():
    print(sample.CONTENT)
</pre></div>
<pre class="example">
Lil m !!!!! Check hi out!!!!! Does live the way you lie and many more ! Check it out!!! And subscribe
https://soundcloud.com/artady please check my stuff; and make some feedback﻿
Hey guys can you check my channel out plz. I do mine craft videos. Let's  shoot for 20 subs﻿
┏━━━┓┏┓╋┏┓┏━━━┓┏━━━┓┏┓╋╋┏┓  ┃┏━┓┃┃┃╋┃┃┃┏━┓┃┗┓┏┓┃┃┗┓┏┛┃  ┃┗━━┓┃┗━┛┃┃┃╋┃┃╋┃┃┃┃┗┓┗┛┏  ┗━━┓┃┃┏━┓┃┃┗━┛┃╋┃┃┃┃╋┗┓┏┛  ┃┗━┛┃┃┃╋┃┃┃┏━┓┃┏┛┗┛┃╋╋┃┃  ┗━━━┛┗┛╋┗┛┗┛╋┗┛┗━━━┛╋╋┗┛ CHECK MY VIDEOS AND SUBSCRIBE AND LIKE PLZZ
if you like raw talent, raw lyrics, straight real hip hop Everyone check my newest sound  Dizzy X - Got the Juice (Prod by. Drugs the Model Citizen)   COMMENT TELL ME WHAT YOU THINK  DONT BE LAZY!!!!  - 1/7 Prophetz﻿
check it out free stuff for watching videos and filling surveys&lt;br /&gt;&lt;br /&gt;&lt;a href="http://www.prizerebel.com/index.php?r=1446084"&gt;http://www.prizerebel.com/index.php?r=1446084&lt;/a&gt;﻿
Hey! I'm NERDY PEACH and I'm a new youtuber and it would mean THE ABSOLUTE  world to me if you could check 'em out! &amp;lt;3  Hope you like them! =D﻿
Check my first video out﻿
http://tankionline.com#friend=cd92db3f4 great game check it out!﻿
hi beaties! i made a new channel please go check it out and subscribe and  enjoy!﻿
</pre>
<p>I'm going to deviate from the tutorial a little and create a regular expression to match any comment with "check" and not "view" to avoid cases where the commenter is saying that they're checking out how many views the video had.</p>
<div class="highlight">
<pre><span></span>EXPRESSION = re.compile(r"check(?!.*view)")

assert EXPRESSION.search("everyone please come check our newest song in memories of Martin Luther  King Jr.﻿")
assert EXPRESSION.search("and u should.d check my channel and tell me what I should do next!﻿")
assert not EXPRESSION.search("Admit it you just came here to check the number of viewers ﻿")

@labeling_function()
def re_check_out(row: pandas.Series) -&gt; int:
    """match cases with 'check' but not view"""
    return Comment.is_spam if EXPRESSION.search(row.CONTENT.lower()) else Comment.is_ambiguous
</pre></div>
<div class="highlight">
<pre><span></span>labeling_functions = [check, check_out, re_check_out]
applier = PandasLFApplier(lfs=labeling_functions)
train_labeling_matrix = applier.apply(df=train, progress_bar=False)
development_labeling_matrix = applier.apply(df=development, progress_bar=False)
</pre></div>
<div class="highlight">
<pre><span></span>analysis = LFAnalysis(L=train_labeling_matrix, lfs=labeling_functions)
print(TABLE(analysis.lf_summary()))
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">j</th>
<th class="org-left" scope="col">Polarity</th>
<th class="org-right" scope="col">Coverage</th>
<th class="org-right" scope="col">Overlaps</th>
<th class="org-right" scope="col">Conflicts</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">check</td>
<td class="org-right">0</td>
<td class="org-left">[1]</td>
<td class="org-right">0.257576</td>
<td class="org-right">0.248196</td>
<td class="org-right">0</td>
</tr>
<tr>
<td class="org-left">check_out</td>
<td class="org-right">1</td>
<td class="org-left">[1]</td>
<td class="org-right">0.212843</td>
<td class="org-right">0.212843</td>
<td class="org-right">0</td>
</tr>
<tr>
<td class="org-left">re_check_out</td>
<td class="org-right">2</td>
<td class="org-left">[1]</td>
<td class="org-right">0.243146</td>
<td class="org-right">0.243146</td>
<td class="org-right">0</td>
</tr>
</tbody>
</table>
<p>Our <code>re_check_out</code> function has a little less coverage than <code>check</code> as we'd expect, since it excludes reviews with "view" in them but it also covers a little more than <code>check_out</code>.</p>
<div class="highlight">
<pre><span></span>print(TABLE(LFAnalysis(
    L=development_labeling_matrix,
    lfs=labeling_functions).lf_summary(Y=development.CLASS.values)))
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">j</th>
<th class="org-left" scope="col">Polarity</th>
<th class="org-right" scope="col">Coverage</th>
<th class="org-right" scope="col">Overlaps</th>
<th class="org-right" scope="col">Conflicts</th>
<th class="org-right" scope="col">Correct</th>
<th class="org-right" scope="col">Incorrect</th>
<th class="org-right" scope="col">Emp. Acc.</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">check</td>
<td class="org-right">0</td>
<td class="org-left">[1]</td>
<td class="org-right">0.26</td>
<td class="org-right">0.245</td>
<td class="org-right">0</td>
<td class="org-right">49</td>
<td class="org-right">3</td>
<td class="org-right">0.942308</td>
</tr>
<tr>
<td class="org-left">check_out</td>
<td class="org-right">1</td>
<td class="org-left">[1]</td>
<td class="org-right">0.225</td>
<td class="org-right">0.225</td>
<td class="org-right">0</td>
<td class="org-right">45</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-left">re_check_out</td>
<td class="org-right">2</td>
<td class="org-left">[1]</td>
<td class="org-right">0.245</td>
<td class="org-right">0.245</td>
<td class="org-right">0</td>
<td class="org-right">49</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>
<p>It looks like we were able to avoid the false-positives by adding our regular expression.</p>
<div class="highlight">
<pre><span></span>buckets = get_label_buckets(development_labeling_matrix[:, 0], development_labeling_matrix[:,2])
for comment in development.iloc[buckets[(Comment.is_spam, Comment.is_ambiguous)]]["CONTENT"]:
    print(comment)
</pre></div>
<pre class="example">
i turned it on mute as soon is i came on i just wanted to check the  views...﻿
i check back often to help reach 2x10^9 views and I avoid watching Baby﻿
Admit it you just came here to check the number of viewers ﻿
</pre>
<p>So it looks like we got rid of some false positives but also missed some spam by using the regular expression. We could probably grab more by searching for "my" as well.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="outline-3" id="outline-container-orgdaac3af">
<h3 id="orgdaac3af">Using TextBlob with a Preprocessor</h3>
<div class="outline-text-3" id="text-orgdaac3af">
<p>Here we'll use text-blobs sentiment scorer to find comments that aren't spam. To do this we'll need to use snorkel's Preprocessor, which maps data using black-box functions.</p>
<div class="highlight">
<pre><span></span>@preprocessor(memoize=True)
def textblob_sentiment(row: pandas.Series) -&gt; pandas.Series:
    """Add the polarity and subjectivity of the comment's sentiment

    This adds two columns ('polarity' and 'subjectivity') based on the comment

    """
    blob = TextBlob(row.CONTENT)
    row["polarity"] = blob.sentiment.polarity
    row["subjectivity"] = blob.sentiment.subjectivity
    return row
</pre></div>
<p>The <code>polarity</code> is a value from -1.0 to 1.0 which reflects how negative or positive the text is believed to be. The <code>subjectivity</code> is a value from 0.0 to 1.0 which reflects whether the text is objective or subjective - whether it is a statement of fact or opinion.</p>
<p>Now that we have the pre-processor we can use it with a labeling function.</p>
</div>
<div class="outline-4" id="outline-container-org34bd21b">
<h4 id="org34bd21b">Polarity</h4>
<div class="outline-text-4" id="text-org34bd21b">
<div class="highlight">
<pre><span></span>@labeling_function(pre=[textblob_sentiment])
def textblob_polarity(row: pandas.Series) -&gt; int:
    """decides if the comment is ham based on the polarity of the sentiment"""
    return Comment.is_ham if row.polarity &gt; 0.9 else Comment.is_ambiguous
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orgfb221bc">
<h4 id="orgfb221bc">Subjectivity</h4>
<div class="outline-text-4" id="text-orgfb221bc">
<div class="highlight">
<pre><span></span>@labeling_function(pre=[textblob_sentiment])
def textblob_subjectivity(row: pandas.Series) -&gt; int:
    """decides if the comment is ham based on the subjectivity"""
    return Comment.is_ham if row.subjectivity &gt; 0.5 else Comment.is_ambiguous
</pre></div>
</div>
</div>
<div class="outline-4" id="outline-container-orga088176">
<h4 id="orga088176">Analyzing the Performance</h4>
<div class="outline-text-4" id="text-orga088176">
<p>Once again, now that we have labeling functions we need to analyze how well they do.</p>
<div class="highlight">
<pre><span></span>labeling_functions = [textblob_polarity, textblob_subjectivity]
applier = PandasLFApplier(lfs=labeling_functions)
train_label_matrix = applier.apply(train, progress_bar=False)
development_label_matrix = applier.apply(development, progress_bar=False)
</pre></div>
<div class="highlight">
<pre><span></span>print(TABLE(LFAnalysis(train_label_matrix, labeling_functions).lf_summary()))
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">j</th>
<th class="org-left" scope="col">Polarity</th>
<th class="org-right" scope="col">Coverage</th>
<th class="org-right" scope="col">Overlaps</th>
<th class="org-right" scope="col">Conflicts</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">textblob_polarity</td>
<td class="org-right">0</td>
<td class="org-left">[0]</td>
<td class="org-right">0.033189</td>
<td class="org-right">0.0122655</td>
<td class="org-right">0</td>
</tr>
<tr>
<td class="org-left">textblob_subjectivity</td>
<td class="org-right">1</td>
<td class="org-left">[0]</td>
<td class="org-right">0.32684</td>
<td class="org-right">0.0122655</td>
<td class="org-right">0</td>
</tr>
</tbody>
</table>
<div class="highlight">
<pre><span></span>print(TABLE(LFAnalysis(development_label_matrix, labeling_functions).lf_summary(Y=development.CLASS.values)))
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">j</th>
<th class="org-left" scope="col">Polarity</th>
<th class="org-right" scope="col">Coverage</th>
<th class="org-right" scope="col">Overlaps</th>
<th class="org-right" scope="col">Conflicts</th>
<th class="org-right" scope="col">Correct</th>
<th class="org-right" scope="col">Incorrect</th>
<th class="org-right" scope="col">Emp. Acc.</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">textblob_polarity</td>
<td class="org-right">0</td>
<td class="org-left">[0]</td>
<td class="org-right">0.05</td>
<td class="org-right">0.025</td>
<td class="org-right">0</td>
<td class="org-right">9</td>
<td class="org-right">1</td>
<td class="org-right">0.9</td>
</tr>
<tr>
<td class="org-left">textblob_subjectivity</td>
<td class="org-right">1</td>
<td class="org-left">[0]</td>
<td class="org-right">0.3</td>
<td class="org-right">0.025</td>
<td class="org-right">0</td>
<td class="org-right">32</td>
<td class="org-right">28</td>
<td class="org-right">0.533333</td>
</tr>
</tbody>
</table>
<p>Subjectivity seems to have much better coverage, but it was also fairly inaccurate.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgd7660b8">
<h3 id="orgd7660b8">More Labeling Functions</h3>
<div class="outline-text-3" id="text-orgd7660b8">
<p>We previously created a keyword-based labeling function for "check". Because using keywords is such a common thing Snorkel has a way to create them with a little less work than creating the labeling functions individually.</p>
<p>First we make a function that checks if any of a collection of keywords is in the comment.</p>
<div class="highlight">
<pre><span></span>def lookup_keyword(row: pandas.Series, keywords: list, label: int) -&gt; int:
    """check if any of the keywords are in the comment

    Args:
     row: the series with the Comment
     keywords: collection of keywords indicating spam
     label: what to return if the keyword is in the comment

    Returns:
     label if keyword in comment else -1
    """
    return label if any(keyword in row.CONTENT.lower() for keyword in keywords) else Comment.is_ambiguous
</pre></div>
<p>Now we make the labeling-function creator that uses the <code>lookup_keyword</code>.</p>
<div class="highlight">
<pre><span></span>def make_keyword_labeling_function(keywords: list, label: int=Comment.is_spam) -&gt; LabelingFunction:
    """Makes LabelingFunction objects that check keywords"""
    return LabelingFunction(
        name=f"keyword_{keywords[0]}",
        f=lookup_keyword,
        resources=dict(keywords=keywords, label=label)
    )
</pre></div>
<div class="highlight">
<pre><span></span>keyword_my = make_keyword_labeling_function(keywords=["my"])
keyword_subscribe = make_keyword_labeling_function(keywords=["subscribe"])
keyword_link = make_keyword_labeling_function(keywords=["http"])
keyword_please = make_keyword_labeling_function(keywords=["please", "plz"])
keyword_song = make_keyword_labeling_function(keywords=["song"], label=Comment.is_ham)
</pre></div>
<div class="highlight">
<pre><span></span>labeling_functions = [
    keyword_my,
    keyword_subscribe,
    keyword_link,
    keyword_please,
    keyword_song,
]
applier = PandasLFApplier(lfs=labeling_functions)
train_label_matrix = applier.apply(train, progress_bar=False)
development_label_matrix = applier.apply(development, progress_bar=False)
print(TABLE(LFAnalysis(development_label_matrix, labeling_functions).lf_summary(Y=development.CLASS.values)))
</pre></div>
<table border="2" cellpadding="6" cellspacing="0" frame="hsides" rules="groups">
<colgroup>
<col class="org-left">
<col class="org-right">
<col class="org-left">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right">
<col class="org-right"></colgroup>
<thead>
<tr>
<th class="org-left" scope="col">&nbsp;</th>
<th class="org-right" scope="col">j</th>
<th class="org-left" scope="col">Polarity</th>
<th class="org-right" scope="col">Coverage</th>
<th class="org-right" scope="col">Overlaps</th>
<th class="org-right" scope="col">Conflicts</th>
<th class="org-right" scope="col">Correct</th>
<th class="org-right" scope="col">Incorrect</th>
<th class="org-right" scope="col">Emp. Acc.</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">keyword_my</td>
<td class="org-right">0</td>
<td class="org-left">[1]</td>
<td class="org-right">0.18</td>
<td class="org-right">0.115</td>
<td class="org-right">0.05</td>
<td class="org-right">33</td>
<td class="org-right">3</td>
<td class="org-right">0.916667</td>
</tr>
<tr>
<td class="org-left">keyword_subscribe</td>
<td class="org-right">1</td>
<td class="org-left">[1]</td>
<td class="org-right">0.125</td>
<td class="org-right">0.075</td>
<td class="org-right">0.015</td>
<td class="org-right">25</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-left">keyword_http</td>
<td class="org-right">2</td>
<td class="org-left">[1]</td>
<td class="org-right">0.09</td>
<td class="org-right">0.03</td>
<td class="org-right">0.005</td>
<td class="org-right">16</td>
<td class="org-right">2</td>
<td class="org-right">0.888889</td>
</tr>
<tr>
<td class="org-left">keyword_please</td>
<td class="org-right">3</td>
<td class="org-left">[1]</td>
<td class="org-right">0.095</td>
<td class="org-right">0.08</td>
<td class="org-right">0.02</td>
<td class="org-right">19</td>
<td class="org-right">0</td>
<td class="org-right">1</td>
</tr>
<tr>
<td class="org-left">keyword_song</td>
<td class="org-right">4</td>
<td class="org-left">[0]</td>
<td class="org-right">0.16</td>
<td class="org-right">0.06</td>
<td class="org-right">0.06</td>
<td class="org-right">20</td>
<td class="org-right">12</td>
<td class="org-right">0.625</td>
</tr>
</tbody>
</table>
<p>There are varying degrees of coveragen and accuracy with these. Interestingly, the <code>subscribe</code> keyword was completely accurate and had pretty good coverage (compared to our check-out labelers).</p>
</div>
</div>
<div class="outline-3" id="outline-container-org99ea299">
<h3 id="org99ea299">Adding a Spacy Preprocessor</h3>
<div class="outline-text-3" id="text-org99ea299">
<p>The purpose of the pre-processors is to do a little feature engineering to add features that aren't in the original dataset but which can be derived from it. Becaues SpaCY is used so much for this, snorkel comes with a labeling function that adds a <code>doc</code> attribute (you can also create it manually to get more control).</p>
<div class="highlight">
<pre><span></span>@nlp_labeling_function()
def short_with_person(row: pandas.Series) -&gt; int:
    """Check if the comment is short and mentions a person"""
    return (Comment.is_ham if (len(row.CONTENT) &lt; 20 and any((entity.label_=="PERSON" for entity in row.dot.ents)))
                               else Comment.is_ambiguous)
</pre></div>
</div>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="/categories/data/" rel="tag">data</a></li>
<li><a class="tag p-category" href="/categories/exploration/" rel="tag">exploration</a></li>
<li><a class="tag p-category" href="/categories/snorkel/" rel="tag">snorkel</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="/posts/libraries/snorkel/snorkel-example-building-a-spam-dataset/" rel="prev" title="Snorkel Example: Building a Spam Dataset">Previous post</a></li>
<li class="next"><a href="/posts/machine-learning/decision-trees/" rel="next" title="Decision Trees">Next post</a></li>
</ul>
</nav>
</aside>
</article>
<!--End of body content-->
<footer id="footer">Contents © 2020 <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a></footer>
</div>
</div>
<script src="/assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
</script> 
</body>
</html>
