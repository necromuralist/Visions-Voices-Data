<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org5f23320">Introduction</a></li>
<li><a href="#orga9ee83b">Set Up</a></li>
<li><a href="#orgec6ccb4">Loading the Data</a></li>
<li><a href="#org3a90eb0">Cleaning</a></li>
<li><a href="#org125a911">Figuring Out the Missing Date</a></li>
<li><a href="#orgdf1c60c">Pivot the Metric Column</a></li>
<li><a href="#org22f4523">Updating the Columns</a></li>
<li><a href="#orgfb10cf4">Save the Message Pack</a></li>
<li><a href="#org3e51134">Looking at Some Plots</a></li>
</ul>
</div>
</div>
<div id="outline-container-org5f23320" class="outline-2">
<h2 id="org5f23320">Introduction</h2>
<div class="outline-text-2" id="text-org5f23320">
<p>
I'm going to work with the Daily Temperatures data set for Portland, Oregon (measured at the airport) taken from the <a href="https://w2.weather.gov/climate/local_data.php?wfo=pqr">National Weather Service</a>. I cleaned it up a little already, removing the extra header rows and adding a missing column header (<code>Metric</code>) but the data is arranged with the year and month as a column and then each day is given its own column, which isn't how I want to work with it, so I'm going to transform it a little to make it more like what I expect it to look like.}
</p>
</div>
</div>
<div id="outline-container-orga9ee83b" class="outline-2">
<h2 id="orga9ee83b">Set Up</h2>
<div class="outline-text-2" id="text-orga9ee83b">
</div>
<div id="outline-container-orgcbeb597" class="outline-3">
<h3 id="orgcbeb597">Imports</h3>
<div class="outline-text-3" id="text-orgcbeb597">
</div>
<div id="outline-container-orga67b095" class="outline-4">
<h4 id="orga67b095">Python</h4>
<div class="outline-text-4" id="text-orga67b095">
<div class="highlight"><pre><span></span>from datetime import datetime
from pathlib import Path
from typing import Union
import os
</pre></div>
</div>
</div>
<div id="outline-container-org13927b3" class="outline-4">
<h4 id="org13927b3">From PyPi</h4>
<div class="outline-text-4" id="text-org13927b3">
<div class="highlight"><pre><span></span>from dotenv import load_dotenv
import matplotlib.pyplot as pyplot
import pandas
import seaborn
</pre></div>
</div>
</div>
</div>
<div id="outline-container-orged9d1d2" class="outline-3">
<h3 id="orged9d1d2">Plotting</h3>
<div class="outline-text-3" id="text-orged9d1d2">
<div class="highlight"><pre><span></span>get_ipython().run_line_magic(&#39;matplotlib&#39;, &#39;inline&#39;)
get_ipython().run_line_magic(&#39;config&#39;, &quot;InlineBackend.figure_format = &#39;retina&#39;&quot;)
seaborn.set(style=&quot;whitegrid&quot;,
	    rc={&quot;axes.grid&quot;: False,
		&quot;font.family&quot;: [&quot;sans-serif&quot;],
		&quot;font.sans-serif&quot;: [&quot;Open Sans&quot;, &quot;Latin Modern Sans&quot;, &quot;Lato&quot;],
		&quot;figure.figsize&quot;: (8, 6)},
	    font_scale=1)
</pre></div>
</div>
</div>
</div>
<div id="outline-container-orgec6ccb4" class="outline-2">
<h2 id="orgec6ccb4">Loading the Data</h2>
<div class="outline-text-2" id="text-orgec6ccb4">
<div class="highlight"><pre><span></span>load_dotenv()
path = Path(os.environ.get(&quot;CSV&quot;)).expanduser()
print(path)
assert path.is_file()
</pre></div>

<pre class="example">
/home/hades/data/datasets/necromuralist/daily-climate-data/portland_1940_to_april_2018.csv

</pre>
</div>

<div id="outline-container-org20cd8d9" class="outline-3">
<h3 id="org20cd8d9">Some Preparation</h3>
<div class="outline-text-3" id="text-org20cd8d9">
<p>
The first thing to work with is that there are three characters representing "missing" data (that I noticed) - <i>M</i>, <i>T</i>, and <i>-</i> - that we have to tell pandas about when we use <a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.read_csv.html">read_csv</a>.
</p>

<div class="highlight"><pre><span></span>missing = [&quot;M&quot;, &quot;T&quot;, &quot;-&quot;]
</pre></div>

<p>
I was going to load the measurement type (e.g. "TX"), but I realized that I was planning to turn those into column headers so maybe it's not a good idea.
</p>

<div class="highlight"><pre><span></span>data = pandas.read_csv(path, na_values=missing)
print(data.shape)
</pre></div>

<pre class="example">
(3756, 35)

</pre>

<div class="highlight"><pre><span></span>print(data.columns)
</pre></div>

<pre class="example">
Index(['YR', 'MO', 'Metric', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10',
       '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22',
       '23', '24', '25', '26', '27', '28', '29', '30', '31', 'AVG or Total'],
      dtype='object')

</pre>

<div class="highlight"><pre><span></span>print(data.info())
</pre></div>

<pre class="example">
&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 3756 entries, 0 to 3755
Data columns (total 35 columns):
YR              3756 non-null int64
MO              3756 non-null int64
Metric          3756 non-null object
1               3602 non-null float64
2               3554 non-null float64
3               3583 non-null float64
4               3604 non-null float64
5               3599 non-null float64
6               3610 non-null float64
7               3587 non-null object
8               3590 non-null float64
9               3595 non-null float64
10              3614 non-null float64
11              3602 non-null float64
12              3600 non-null float64
13              3583 non-null float64
14              3582 non-null float64
15              3591 non-null float64
16              3604 non-null float64
17              3598 non-null float64
18              3615 non-null float64
19              3611 non-null float64
20              3588 non-null float64
21              3606 non-null float64
22              3609 non-null float64
23              3595 non-null float64
24              3605 non-null float64
25              3598 non-null float64
26              3600 non-null float64
27              3598 non-null float64
28              3593 non-null float64
29              3371 non-null float64
30              3294 non-null float64
31              2097 non-null float64
AVG or Total    3616 non-null float64
dtypes: float64(31), int64(2), object(2)
memory usage: 1.0+ MB
None
</pre>

<p>
For some reason column <code>7</code> wasn't converted to a float.
</p>

<div class="highlight"><pre><span></span>for index, row in enumerate(data[&quot;7&quot;]):
    try:
	float(row)
    except Exception as error:
	print(error)
	print(&quot;Row: {}&quot;.format(index))
	print(&quot;Value: {}&quot;.format(row))
</pre></div>

<pre class="example">
could not convert string to float: 
Row: 1835
Value:  

</pre>
<p>
It turns out that this one row also had a space (' ') for one of the values. Strange.
</p>

<div class="highlight"><pre><span></span>missing.append(&quot; &quot;)
data = pandas.read_csv(path, na_values=missing)
print(data.info())
</pre></div>

<pre class="example">
&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 3756 entries, 0 to 3755
Data columns (total 35 columns):
YR              3756 non-null int64
MO              3756 non-null int64
Metric          3756 non-null object
1               3602 non-null float64
2               3554 non-null float64
3               3583 non-null float64
4               3604 non-null float64
5               3599 non-null float64
6               3610 non-null float64
7               3586 non-null float64
8               3590 non-null float64
9               3595 non-null float64
10              3614 non-null float64
11              3602 non-null float64
12              3600 non-null float64
13              3583 non-null float64
14              3582 non-null float64
15              3591 non-null float64
16              3604 non-null float64
17              3598 non-null float64
18              3615 non-null float64
19              3611 non-null float64
20              3588 non-null float64
21              3606 non-null float64
22              3609 non-null float64
23              3595 non-null float64
24              3605 non-null float64
25              3598 non-null float64
26              3600 non-null float64
27              3598 non-null float64
28              3593 non-null float64
29              3371 non-null float64
30              3294 non-null float64
31              2097 non-null float64
AVG or Total    3616 non-null float64
dtypes: float64(32), int64(2), object(1)
memory usage: 1.0+ MB
None
</pre>
</div>
</div>
</div>

<div id="outline-container-org3a90eb0" class="outline-2">
<h2 id="org3a90eb0">Cleaning</h2>
<div class="outline-text-2" id="text-org3a90eb0">
</div>
<div id="outline-container-org9632ebc" class="outline-3">
<h3 id="org9632ebc">Drop the Last Column</h3>
<div class="outline-text-3" id="text-org9632ebc">
<p>
Besides the fact that the last column is a calculated one, the fact that it's ambiguous (I guess you can tell by how big it is whether it's a Total, but still) makes me think I should get rid of the last column (using <a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.drop.html">drop</a>).
</p>

<div class="highlight"><pre><span></span>cleaned = data.drop(data.columns[-1], axis=&quot;columns&quot;)
print(cleaned.shape)
assert len(cleaned.columns) == len(data.columns) - 1
</pre></div>

<pre class="example">
(3756, 34)

</pre>
</div>
</div>
<div id="outline-container-org7d64d84" class="outline-3">
<h3 id="org7d64d84">Rotate the Days</h3>
<div class="outline-text-3" id="text-org7d64d84">
<p>
Now I'm going to move the day-columns into row-values using <a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.melt.html">melt</a>.
</p>

<div class="highlight"><pre><span></span>melted = pandas.melt(cleaned, id_vars=[&quot;YR&quot;, &quot;MO&quot;, &quot;Metric&quot;], var_name=&quot;Day&quot;, value_name=&quot;Value&quot;)
print(melted.head())
</pre></div>

<pre class="example">
     YR  MO Metric Day  Value
0  1940  10     TX   1    NaN
1  1940  10     TN   1    NaN
2  1940  10     PR   1    NaN
3  1940  10     SN   1    NaN
4  1940  11     TX   1   52.0

</pre>
<div class="highlight"><pre><span></span>print(melted.shape)
assert len(melted) == len(data) * 31
</pre></div>

<pre class="example">
(116436, 5)

</pre>
</div>

<div id="outline-container-org64f622f" class="outline-4">
<h4 id="org64f622f">Casting the Days to Integers</h4>
<div class="outline-text-4" id="text-org64f622f">
<p>
Although they look like integers, the <code>Day</code> column was converted from column headers so they're strings. Maybe I could have cast them at the time of the conversion, but, oh, well.
</p>

<div class="highlight"><pre><span></span>print(type(melted.iloc[0].Day))
</pre></div>

<pre class="example">
&lt;class 'str'&gt;

</pre>

<div class="highlight"><pre><span></span>melted[&quot;Day&quot;] = melted.Day.astype(int)
print(type(melted.iloc[0].Day))
</pre></div>

<pre class="example">
&lt;class 'numpy.int64'&gt;

</pre>
</div>
</div>
</div>

<div id="outline-container-org32dae15" class="outline-3">
<h3 id="org32dae15">Make a Date Column</h3>
<div class="outline-text-3" id="text-org32dae15">
<p>
Now I'll make a single date column.
</p>

<div class="highlight"><pre><span></span>melted[&quot;date&quot;] = melted.apply(lambda row: datetime(year=row.YR,
						   month=row.MO,
						   day=row.Day),
			      axis=&quot;columns&quot;)
print(melted.head())
</pre></div>

<p>
That raised an error..
</p>

<pre class="example">
ValueError: ('day is out of range for month', 'occurred at index 105184')
</pre>

<div class="highlight"><pre><span></span>print(melted.iloc[105184])
</pre></div>

<pre class="example">
YR        1941
MO           2
Metric      TX
Day         29
Value        -
Name: 105184, dtype: object

</pre>

<p>
Okay, so here we have a problem in that not all the dates exist. Also, for some reason the '-' didn't get converted to a NaN, but one thing at a time.
</p>

<div class="highlight"><pre><span></span>def to_datetime(row: pandas.Series) -&gt; Union[datetime, None]:
    &quot;&quot;&quot;Converts the row to a datetime

    Args:
     row: row in the dataframe with year, month, and day
    Returns:
     row converted to datetime or None if it isn&#39;t valid
    &quot;&quot;&quot;
    if not pandas.isnull(row.Value):
	try:
	    return datetime(year=row.YR, month=row.MO, day=row.Day)
	except ValueError as error:
	    print(error)
    return    
</pre></div>

<div class="highlight"><pre><span></span>started = datetime.now()
melted[&quot;date&quot;] = melted.apply(to_datetime, axis=&quot;columns&quot;)
print(melted.head())
print(&quot;Elapsed: {}&quot;.format(datetime.now() - started))
</pre></div>

<pre class="example">
day is out of range for month
     YR  MO Metric  Day  Value       date
0  1940  10     TX    1    NaN        NaT
1  1940  10     TN    1    NaN        NaT
2  1940  10     PR    1    NaN        NaT
3  1940  10     SN    1    NaN        NaT
4  1940  11     TX    1   52.0 1940-11-01
Elapsed: 0:00:09.351053

</pre>

<div class="highlight"><pre><span></span>print(&quot;Fraction Missing: {:.2f}&quot;.format(
    len(melted[melted.Value.isnull()])/len(melted)))
</pre></div>

<pre class="example">
Fraction Missing: 0.06

</pre>
</div>
</div>

<div id="outline-container-orgfc06417" class="outline-3">
<h3 id="orgfc06417">Drop the Missing</h3>
<div class="outline-text-3" id="text-orgfc06417">
<p>
Here I'll drop the dates that didn't have data.
</p>

<div class="highlight"><pre><span></span>cleaned = melted.dropna(subset=[&quot;Value&quot;])
print(cleaned.head())
</pre></div>

<pre class="example">
     YR  MO Metric  Day  Value       date
4  1940  11     TX    1  52.00 1940-11-01
5  1940  11     TN    1  40.00 1940-11-01
6  1940  11     PR    1   0.17 1940-11-01
7  1940  11     SN    1   0.00 1940-11-01
8  1940  12     TX    1  51.00 1940-12-01

</pre>
</div>
</div>

<div id="outline-container-org1ed3d56" class="outline-3">
<h3 id="org1ed3d56">Drop the Extra Date Coulmns</h3>
<div class="outline-text-3" id="text-org1ed3d56">
<p>
Since we have a date column I'll get rid of the columns that made it up.
</p>

<div class="highlight"><pre><span></span>cleaned = cleaned.drop([&quot;YR&quot;, &quot;MO&quot;, &quot;Day&quot;], axis=&quot;columns&quot;)
print(cleaned.head())
</pre></div>

<pre class="example">
  Metric  Value       date
4     TX  52.00 1940-11-01
5     TN  40.00 1940-11-01
6     PR   0.17 1940-11-01
7     SN   0.00 1940-11-01
8     TX  51.00 1940-12-01

</pre>
</div>
</div>
</div>

<div id="outline-container-org125a911" class="outline-2">
<h2 id="org125a911">Figuring Out the Missing Date</h2>
<div class="outline-text-2" id="text-org125a911">
<p>
One of the entries has values but no date.
</p>

<div class="highlight"><pre><span></span>print(cleaned[cleaned.date.isnull()])
</pre></div>

<pre class="example">
       Metric  Value date
105427     SN   34.0  NaT

</pre>

<div class="highlight"><pre><span></span>print(melted.iloc[105427])
</pre></div>

<pre class="example">
YR        1946
MO           2
Metric      SN
Day         29
Value       34
date       NaT
Name: 105427, dtype: object

</pre>

<p>
I looked it up and 1946 isn't a leap-year, so there's no February 29, 1946. Did something get lost in translation?
</p>

<div class="highlight"><pre><span></span>print(data[(data.YR==1946) &amp; (data.MO==2)])
</pre></div>

<pre class="example">
       YR  MO Metric      1      2     3      4      5      6      7  \
256  1946   2     TX  48.00  47.00  45.0  43.00  48.00  48.00  43.00   
257  1946   2     TN  44.00  35.00  32.0  32.00  37.00  39.00  33.00   
258  1946   2     PR   0.05   0.02   NaN   0.01   1.54   0.63   0.06   
259  1946   2     SN   0.00   0.00   0.0   0.00   0.00   0.00   0.00   

         ...         23     24    25     26     27     28    29  30  31  \
256      ...       58.0  52.00  53.0  49.00  53.00  55.00   NaN NaN NaN   
257      ...       43.0  40.00  39.0  35.00  44.00  40.00   NaN NaN NaN   
258      ...        0.1   0.26   NaN   0.57   0.64   0.04   NaN NaN NaN   
259      ...        0.0   0.00   0.0   0.00   0.00   0.00  34.0 NaN NaN   

     AVG or Total  
256         49.40  
257         36.00  
258          4.99  
259          0.00  

[4 rows x 35 columns]
</pre>

<p>
It looks like there's something wrong with the snowfall measurement for that date, the other measurements don't have values.
</p>

<div class="highlight"><pre><span></span>print(data[(data.YR==1946) &amp; (data.MO==2) &amp; (data.Metric==&quot;SN&quot;)])
</pre></div>

<pre class="example">
       YR  MO Metric    1    2    3    4    5    6    7      ...        23  \
259  1946   2     SN  0.0  0.0  0.0  0.0  0.0  0.0  0.0      ...       0.0   

      24   25   26   27   28    29  30  31  AVG or Total  
259  0.0  0.0  0.0  0.0  0.0  34.0 NaN NaN           0.0  

[1 rows x 35 columns]

</pre>

<p>
It was just all 0's and then there's this mysterious 34 inches of snow on the 29th of February. I'm pretty sure that's a mistake. I'll have to delete that. 
</p>

<p>
Although I have the index in the original <code>data</code> frame I've already done all this cleaning so I think it's easier just to drop the missing dates.
</p>

<div class="highlight"><pre><span></span>rows, columns = cleaned.shape
cleaned = cleaned.dropna(subset=[&quot;date&quot;])
assert cleaned.shape[0] == rows - 1
</pre></div>
</div>
</div>

<div id="outline-container-orgdf1c60c" class="outline-2">
<h2 id="orgdf1c60c">Pivot the Metric Column</h2>
<div class="outline-text-2" id="text-orgdf1c60c">
<p>
So, besides getting the dates into a column one of the points of this was to get the metric types into columns by <a href="https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.pivot.html">pivoting</a>. I guess you could argue that this is just a category, but since each date gets all four of the values I think this makes sense.
</p>


<div class="highlight"><pre><span></span>pivoted = cleaned.pivot(index=&quot;date&quot;, columns=&quot;Metric&quot;, values=&quot;Value&quot;)
print(pivoted.head())
</pre></div>

<pre class="example">
Metric        PR   SN    TN    TX
date                             
1940-10-13  0.01  0.0  57.0  75.0
1940-10-14   NaN  0.0  53.0  70.0
1940-10-15   NaN  0.0  52.0  64.0
1940-10-16  0.00  0.0  50.0  72.0
1940-10-17  0.13  0.0  58.0  72.0

</pre>

<p>
It looks like there's some missing precipitation data. I don't really have a solution for that. I think decisions to imput missing values should come when the data set is being used.
</p>

<div class="highlight"><pre><span></span>for metric in (&quot;PR&quot;, &quot;SN&quot;, &quot;TN&quot;, &quot;TX&quot;):
    print(&quot;{} Missing: {:,}&quot;.format(metric, len(pivoted[pivoted[metric].isnull()])))
</pre></div>

<pre class="example">
PR Missing: 3,297
SN Missing: 523
TN Missing: 0
TX Missing: 0

</pre>

<p>
So it looks like we're okay with the temperatures but maybe not so well off with the precipitation.
</p>

<div class="highlight"><pre><span></span>missing = pivoted[pivoted.PR.isnull()]
missing.loc[:, &quot;missing&quot;] = 1
monthly = missing.missing.resample(&quot;M&quot;)
</pre></div>

<div class="highlight"><pre><span></span>figure, axe = pyplot.subplots()
figure.suptitle(&quot;Missing Monthly Precipitation&quot;, weight=&quot;bold&quot;)
counts = monthly.count()
stem = axe.stem(counts.index, counts)
</pre></div>

<p>
<img src="missing_pr.png" alt="missing_pr.png" />
So, I was expecting this to be a problem that happened early and then died out, but it appears there's an ongoing problem with collecting precipitation - or maybe they use a symbol for 0 that I'm interpreting as missing?
</p>

<div class="highlight"><pre><span></span>yearly = missing.missing.resample(&quot;Y&quot;)
</pre></div>

<div class="highlight"><pre><span></span>figure, axe = pyplot.subplots()
figure.suptitle(&quot;Missing Yearly Precipitation&quot;, weight=&quot;bold&quot;)
counts = yearly.count()
stem = axe.stem(counts.index, counts)
</pre></div>


<div class="figure">
<p><img src="missing_yearly_pr.png" alt="missing_yearly_pr.png" />
</p>
</div>

<p>
This does seem problematic, if I do anything with precipitation I'll have to figure out what's going on here.
</p>
</div>
</div>

<div id="outline-container-org22f4523" class="outline-2">
<h2 id="org22f4523">Updating the Columns</h2>
<div class="outline-text-2" id="text-org22f4523">
<p>
The whole <code>TX</code>, <code>TN</code>, etc. encoding scheme seems like it causes too much mental overhead so I'm going to rename the metric columns.
</p>

<div class="highlight"><pre><span></span>renamed = pivoted.rename(dict(PR=&quot;precipitation&quot;,
			      SN=&quot;snowfall&quot;,
			      TN=&quot;minimum_temperature&quot;,
			      TX=&quot;maximum_temperature&quot;),
			 axis=&quot;columns&quot;)
print(renamed.head())
</pre></div>

<pre class="example">
Metric      precipitation  snowfall  minimum_temperature  maximum_temperature
date                                                                         
1940-10-13           0.01       0.0                 57.0                 75.0
1940-10-14            NaN       0.0                 53.0                 70.0
1940-10-15            NaN       0.0                 52.0                 64.0
1940-10-16           0.00       0.0                 50.0                 72.0
1940-10-17           0.13       0.0                 58.0                 72.0

</pre>
</div>
</div>


<div id="outline-container-orgfb10cf4" class="outline-2">
<h2 id="orgfb10cf4">Save the Message Pack</h2>
<div class="outline-text-2" id="text-orgfb10cf4">
<p>
Now that we have the cleaned-up data, I'll save it as a message pack.
</p>

<div class="highlight"><pre><span></span>pack_path = Path(os.environ.get(&quot;MESSAGE_PACK&quot;)).expanduser()
print(pack_path)
</pre></div>

<pre class="example">
/home/hades/pCloudDrive/data/daily-climate-data/portland_1940_to_april_2018.msg

</pre>

<div class="highlight"><pre><span></span>renamed.to_msgpack(pack_path)
assert pack_path.is_file()
</pre></div>
</div>
</div>

<div id="outline-container-org3e51134" class="outline-2">
<h2 id="org3e51134">Looking at Some Plots</h2>
<div class="outline-text-2" id="text-org3e51134">
<div class="highlight"><pre><span></span>maximum_temperature = renamed.maximum_temperature.resample(&quot;Y&quot;)
medians = maximum_temperature.median()
maxes = maximum_temperature.max()
mins = maximum_temperature.min()
figure, axe = pyplot.subplots()
figure.suptitle(&quot;Portland, OR Yearly Maximum Daily Temperatures&quot;, weight=&quot;bold&quot;)
axe.stem(maxes.index, maxes, markerfmt=&quot;ro&quot;,label=&quot;Maximum&quot;)
axe.stem(mins.index, mins, markerfmt=&quot;go&quot;, label=&quot;Minimum&quot;)
stem = axe.stem(medians.index, medians, label=&quot;Median&quot;)
legend = axe.legend(bbox_to_anchor=(1, 1))
</pre></div>


<div class="figure">
<p><img src="median_yearly_temperature.png" alt="median_yearly_temperature.png" />
</p>
</div>
</div>
</div>
